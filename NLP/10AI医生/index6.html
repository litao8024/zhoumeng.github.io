<!DOCTYPE html>
<!-- saved from url=(0029)http://121.199.45.168:8888/6/ -->
<html lang="en" class="js json svg checked target dataset details fetch supports csstransforms3d no-ios" style=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
      
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://0.0.0.0:8888/6/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="./index_files/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-4.4.0">
    
    
      
        <title>第六章:命名实体识别任务 - DOCTOR</title>
      
    
    
      <link rel="stylesheet" href="./index_files/application.0284f74d.css">
      
      
    
    
      <script src="./index_files/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin="">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&amp;display=fallback">
        <link rel="stylesheet" href="./index_files/css">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="./index_files/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-36723568-3", "mkdocs.org")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async="" src="./index_files/analytics.js"></script>
      
    
    
  <script type="text/javascript">(function(){var s=document.createElement("script");var port=window.location.port;s.src="//"+window.location.hostname+":"+port+ "/livereload.js?port=" + port;document.head.appendChild(s);})();</script><script src="./index_files/livereload.js"></script></head>
  
    <body dir="ltr" data-md-state="">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#61" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header" data-md-state="shadow">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="#" title="DOCTOR" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title" data-md-state="active">
          
            <span class="md-header-nav__topic" style="width: 882px;">
              DOCTOR
            </span>
            <span class="md-header-nav__topic" style="width: 882px;">
              
                第六章:命名实体识别任务
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix="">
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" style="height: 881px;" data-md-state="lock">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="#" title="DOCTOR" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    DOCTOR
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix="">
    
      
      
      


  <li class="md-nav__item">
    <a href="./index.html" title="第一章:背景介绍与Unit的使用" class="md-nav__link">
      第一章:背景介绍与Unit的使用
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index2.html" title="第二章:在线医生的总体架构与工具介绍" class="md-nav__link">
      第二章:在线医生的总体架构与工具介绍
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index3.html" title="第三章:neo4j图数据库" class="md-nav__link">
      第三章:neo4j图数据库
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index4.html" title="第四章:离线部分" class="md-nav__link">
      第四章:离线部分
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index5.html" title="第五章:命名实体审核任务" class="md-nav__link">
      第五章:命名实体审核任务
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        第六章:命名实体识别任务
      </label>
    
    <a href="" title="第六章:命名实体识别任务" class="md-nav__link md-nav__link--active">
      第六章:命名实体识别任务
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix="">
      
        <li class="md-nav__item">
  <a href="#61" title="6.1 命名实体识别介绍" class="md-nav__link">
    6.1 命名实体识别介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#62-bilstm" title="6.2 BiLSTM介绍" class="md-nav__link">
    6.2 BiLSTM介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#63-crf" title="6.3 CRF介绍" class="md-nav__link">
    6.3 CRF介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#64-bilstmcrf" title="6.4 BiLSTM+CRF模型" class="md-nav__link">
    6.4 BiLSTM+CRF模型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#65" title="6.5 模型训练" class="md-nav__link">
    6.5 模型训练
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#66" title="6.6 模型使用" class="md-nav__link">
    6.6 模型使用
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index7.html" title="第七章:在线部分" class="md-nav__link">
      第七章:在线部分
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index8.html" title="第八章:句子主题相关任务" class="md-nav__link">
      第八章:句子主题相关任务
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index9.html" title="第九章:系统联调与测试" class="md-nav__link">
      第九章:系统联调与测试
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index10.html" title="附录:环境安装部署手册" class="md-nav__link">
      附录:环境安装部署手册
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" style="height: 881px;" data-md-state="lock">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix="">
      
        <li class="md-nav__item">
  <a href="#61" title="6.1 命名实体识别介绍" class="md-nav__link">
    6.1 命名实体识别介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#62-bilstm" title="6.2 BiLSTM介绍" class="md-nav__link">
    6.2 BiLSTM介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#63-crf" title="6.3 CRF介绍" class="md-nav__link">
    6.3 CRF介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#64-bilstmcrf" title="6.4 BiLSTM+CRF模型" class="md-nav__link">
    6.4 BiLSTM+CRF模型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#65" title="6.5 模型训练" class="md-nav__link">
    6.5 模型训练
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#66" title="6.6 模型使用" class="md-nav__link">
    6.6 模型使用
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>第六章:命名实体识别任务</h1>
                
                <h2 id="61">6.1 命名实体识别介绍<a class="headerlink" href="#61" title="Permanent link">¶</a></h2>
<ul>
<li>学习目标:<ul>
<li>了解什么是命名实体识别</li>
<li>了解命名实体识别的作用</li>
<li>了解命名实体识别常用方法</li>
<li>了解医学文本特征</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<p>什么是命名实体识别:</p>
<ul>
<li>命名实体识别(Named Entity Recognition，NER)就是从一段自然语言文本中找出相关实体，并标注出其位置以及类型。是信息提取, 问答系统, 句法分析, 机器翻译等应用领域的重要基础工具, 在自然语言处理技术走向实用化的过程中占有重要地位. 包含行业, 领域专有名词, 如人名, 地名, 公司名, 机构名, 日期, 时间, 疾病名, 症状名, 手术名称, 软件名称等。具体可参看如下示例图：</li>
</ul>
</li>
</ul>
<p><img alt="命名实体识别示例" src="./index_files/6_1_NER_demo_1.png"></p>
<p><img alt="命名实体识别示例" src="./index_files/6_1_NER_demo_2.png"></p>
<p><img alt="命名实体识别示例" src="./index_files/6_1_NER_demo_3.png"></p>
<hr>
<ul>
<li>命名实体识别的作用:<ul>
<li>识别专有名词, 为文本结构化提供支持.</li>
<li>主体识别, 辅助句法分析.</li>
<li>实体关系抽取, 有利于知识推理.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>命名实体识别常用方法:</li>
</ul>
<blockquote>
<ul>
<li>基于规则: 针对有特殊上下文的实体, 或实体本身有很多特征的文本, 使用规则的方法简单且有效. 比如抽取文本中物品价格, 如果文本中所有商品价格都是“数字+元”的形式, 则可以通过正则表达式”\d*.?\d+元”进行抽取. 但如果待抽取文本中价格的表达方式多种多样, 例如“一千八百万”, “伍佰贰拾圆”, “2000万元”, 遇到这些情况就要修改规则来满足所有可能的情况. 随着语料数量的增加, 面对的情况也越来越复杂, 规则之间也可能发生冲突, 整个系统也可能变得不可维护. 因此基于规则的方式比较适合半结构化或比较规范的文本中的进行抽取任务, 结合业务需求能够达到一定的效果.<ul>
<li>优点: 简单, 快速.</li>
<li>缺点: 适用性差, 维护成本高后期甚至不能维护.</li>
</ul>
</li>
</ul>
</blockquote>
<hr>
<blockquote>
<ul>
<li>
<p>基于模型: 从模型的角度来看, 命名实体识别问题实际上是序列标注问题. 序列标注问题指的是模型的输入是一个序列, 包括文字, 时间等, 输出也是一个序列. 针对输入序列的每一个单元, 输出一个特定的标签. 以中文分词任务进行举例, 例如输入序列是一串文字: "我是中国人", 输出序列是一串标签: "OOBII", 其中"BIO"组成了一种中文分词的标签体系: B表示这个字是词的开始, I表示词的中间到结尾, O表示其他类型词. 因此我们可以根据输出序列"OOBII"进行解码, 得到分词结果"我\是\中国人". </p>
<ul>
<li>
<p>序列标注问题涵盖了自然语言处理中的很多任务, 包括语音识别, 中文分词, 机器翻译, 命名实体识别等, 而常见的序列标注模型包括HMM, CRF, RNN, LSTM, GRU等模型. </p>
</li>
<li>
<p>其中在命名实体识别技术上, 目前主流的技术是通过BiLSTM+CRF模型进行序列标注, 也是项目中要用到的模型.</p>
</li>
</ul>
</li>
</ul>
</blockquote>
<hr>
<ul>
<li>
<p>医学文本特征:
    <img alt="命名实体识别示例" src="./index_files/6_1_NER_demo.png"></p>
<ul>
<li>简短精炼</li>
<li>形容词相对较少</li>
<li>泛化性相对较小</li>
<li>医学名词错字率比较高</li>
<li>同义词、简称比较多</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>小节总结:<ul>
<li>学习了什么是命名实体识别</li>
<li>学习了命名实体识别的作用</li>
<li>学习了命名实体识别常用方法</li>
<li>学习了医学文本特征</li>
</ul>
</li>
</ul>
<hr>
<h2 id="62-bilstm">6.2 BiLSTM介绍<a class="headerlink" href="#62-bilstm" title="Permanent link">¶</a></h2>
<ul>
<li>学习目标:<ul>
<li>了解BiLSTM网络结构.</li>
<li>掌握BiLSTM模型实现.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<p>BiLSTM网络结构:</p>
<ul>
<li>所谓的BiLSTM，就是(Bidirectional LSTM)双向LSTM. 单向的LSTM模型只能捕捉到从前向后传递的信息, 而双向的网络可以同时捕捉正向信息和反向信息, 使得对文本信息的利用更全面, 效果也更好.</li>
<li>在BiLSTM网络最终的输出层后面增加了一个线性层, 用来将BiLSTM产生的隐藏层输出结果投射到具有某种表达标签特征意义的区间, 具体如下图所示：</li>
</ul>
<p><img alt="模型结构图" src="./index_files/bilstm.jpg"></p>
</li>
</ul>
<hr>
<ul>
<li>BiLSTM模型实现:<ul>
<li>第一步: 实现类的初始化和网络结构的搭建.</li>
<li>第二步: 实现文本向量化的函数.</li>
<li>第三步: 实现网络的前向计算.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>第一步: 实现类的初始化和网络结构的搭建.</li>
</ul>
<div class="highlight"><pre id="__code_0"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_0 pre, #__code_0 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 本段代码构建类BiLSTM, 完成初始化和网络结构的搭建</span>
<span class="c1"># 总共3层: 词嵌入层, 双向LSTM层, 全连接线性层</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="kn">as</span> <span class="nn">nn</span>


<span class="k">class</span> <span class="nc">BiLSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    description: BiLSTM 模型定义</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">tag_to_id</span><span class="p">,</span> <span class="n">input_feature_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="p">,</span> <span class="n">sentence_length</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        description: 模型初始化</span>
<span class="sd">        :param vocab_size:          所有句子包含字符大小</span>
<span class="sd">        :param tag_to_id:           标签与 id 对照</span>
<span class="sd">        :param input_feature_size:  字嵌入维度( 即LSTM输入层维度 input_size )</span>
<span class="sd">        :param hidden_size:         隐藏层向量维度</span>
<span class="sd">        :param batch_size:          批训练大小</span>
<span class="sd">        :param sentence_length      句子长度</span>
<span class="sd">        :param num_layers:          堆叠 LSTM 层数</span>
<span class="sd">        :param batch_first:         是否将batch_size放置到矩阵的第一维度</span>
<span class="sd">        """</span>
        <span class="c1"># 类继承初始化函数</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BiLSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># 设置标签与id对照</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_to_id</span> <span class="o">=</span> <span class="n">tag_to_id</span>
        <span class="c1"># 设置标签大小, 对应BiLSTM最终输出分数矩阵宽度</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag_to_id</span><span class="p">)</span>
        <span class="c1"># 设定LSTM输入特征大小, 对应词嵌入的维度大小</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_size</span> <span class="o">=</span> <span class="n">input_feature_size</span>
        <span class="c1"># 设置隐藏层维度, 若为双向时想要得到同样大小的向量, 需要除以2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">hidden_size</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="c1"># 设置批次大小, 对应每个批次的样本条数, 可以理解为输入张量的第一个维度</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="c1"># 设定句子长度</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentence_length</span> <span class="o">=</span> <span class="n">sentence_length</span>
        <span class="c1"># 设定是否将batch_size放置到矩阵的第一维度, 取值True, 或False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_first</span> <span class="o">=</span> <span class="n">batch_first</span>
        <span class="c1"># 设置网络的LSTM层数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">=</span> <span class="n">num_layers</span>

        <span class="c1"># 构建词嵌入层: 字向量, 维度为总单词数量与词嵌入维度</span>
        <span class="c1"># 参数: 总体字库的单词数量, 每个字被嵌入的维度</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_size</span><span class="p">)</span>

        <span class="c1"># 构建双向LSTM层: BiLSTM (参数: input_size      字向量维度(即输入层大小),</span>
        <span class="c1">#                               hidden_size     隐藏层维度,</span>
        <span class="c1">#                               num_layers      层数,</span>
        <span class="c1">#                               bidirectional   是否为双向,</span>
        <span class="c1">#                               batch_first     是否批次大小在第一位)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bilstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">input_feature_size</span><span class="p">,</span>
                              <span class="n">hidden_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span>
                              <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">,</span>
                              <span class="n">bidirectional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                              <span class="n">batch_first</span><span class="o">=</span><span class="n">batch_first</span><span class="p">)</span>

        <span class="c1"># 构建全连接线性层: 将BiLSTM的输出层进行线性变换</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_size</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/bilstm.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_1"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_1 pre, #__code_1 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 参数1:码表与id对照</span>
<span class="n">char_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"双"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"肺"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"见"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"多"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"发"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">"斑"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">"片"</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
              <span class="s2">"状"</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">"稍"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">"高"</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">"密"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">"度"</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s2">"影"</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">:</span> <span class="mi">13</span><span class="p">}</span>

<span class="c1"># 参数2:标签码表对照</span>
<span class="n">tag_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"O"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>

<span class="c1"># 参数3:字向量维度</span>
<span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>

<span class="c1"># 参数4:隐层维度</span>
<span class="n">HIDDEN_DIM</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># 参数5:批次大小</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># 参数6:句子长度</span>
<span class="n">SENTENCE_LENGTH</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># 参数7:堆叠 LSTM 层数</span>
<span class="n">NUM_LAYERS</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_2"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_2 pre, #__code_2 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 初始化模型</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTM</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">char_to_id</span><span class="p">),</span>
               <span class="n">tag_to_id</span><span class="o">=</span><span class="n">tag_to_id</span><span class="p">,</span>
               <span class="n">input_feature_size</span><span class="o">=</span><span class="n">EMBEDDING_DIM</span><span class="p">,</span>
               <span class="n">hidden_size</span><span class="o">=</span><span class="n">HIDDEN_DIM</span><span class="p">,</span>
               <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
               <span class="n">sentence_length</span><span class="o">=</span><span class="n">SENTENCE_LENGTH</span><span class="p">,</span>
               <span class="n">num_layers</span><span class="o">=</span><span class="n">NUM_LAYERS</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_3"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_3 pre, #__code_3 code"><span class="md-clipboard__message"></span></button><code><span class="n">BiLSTM</span><span class="p">(</span>
  <span class="p">(</span><span class="n">embedding</span><span class="p">):</span> <span class="n">Embedding</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
  <span class="p">(</span><span class="n">bilstm</span><span class="p">):</span> <span class="n">LSTM</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="p">(</span><span class="n">linear</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>第二步:实现文本向量化的函数.</li>
</ul>
<div class="highlight"><pre id="__code_4"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_4 pre, #__code_4 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 本函数实现将中文文本映射为数字化的张量</span>
<span class="k">def</span> <span class="nf">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">,</span> <span class="n">char_to_id</span><span class="p">,</span> <span class="n">max_length</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    description: 将句子中的每一个字符映射到码表中</span>
<span class="sd">    :param sentence: 待映射句子, 类型为字符串或列表</span>
<span class="sd">    :param char_to_id: 码表, 类型为字典, 格式为{"字1": 1, "字2": 2}</span>
<span class="sd">    :return: 每一个字对应的编码, 类型为tensor</span>
<span class="sd">    """</span>
    <span class="c1"># 字符串按照逆序进行排序, 不是必须操作</span>
    <span class="n">sentence_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># 定义句子映射列表</span>
    <span class="n">sentence_map_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="c1"># 生成句子中每个字对应的 id 列表</span>
        <span class="n">sentence_id_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">char_to_id</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">]</span>
        <span class="c1"># 计算所要填充 0 的长度</span>
        <span class="n">padding_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">))</span>
        <span class="c1"># 组合</span>
        <span class="n">sentence_id_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">padding_list</span><span class="p">)</span>
        <span class="c1"># 将填充后的列表加入句子映射总表中</span>
        <span class="n">sentence_map_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence_id_list</span><span class="p">)</span>
    <span class="c1"># 返回句子映射集合, 转为标量</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">sentence_map_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/bilstm.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_5"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_5 pre, #__code_5 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 参数1:句子集合</span>
<span class="n">sentence_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"确诊弥漫大b细胞淋巴瘤1年"</span><span class="p">,</span>
    <span class="s2">"反复咳嗽、咳痰40年,再发伴气促5天。"</span><span class="p">,</span>
    <span class="s2">"生长发育迟缓9年。"</span><span class="p">,</span>
    <span class="s2">"右侧小细胞肺癌第三次化疗入院"</span><span class="p">,</span>
    <span class="s2">"反复气促、心悸10年,加重伴胸痛3天。"</span><span class="p">,</span>
    <span class="s2">"反复胸闷、心悸、气促2多月,加重3天"</span><span class="p">,</span>
    <span class="s2">"咳嗽、胸闷1月余, 加重1周"</span><span class="p">,</span>
    <span class="s2">"右上肢无力3年, 加重伴肌肉萎缩半年"</span><span class="p">]</span>

<span class="c1"># 参数2:码表与id对照</span>
<span class="n">char_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"&lt;PAD&gt;"</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>

<span class="c1"># 参数3:句子长度</span>
<span class="n">SENTENCE_LENGTH</span> <span class="o">=</span> <span class="mi">20</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_6"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_6 pre, #__code_6 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="c1"># 获取句子中的每一个字</span>
        <span class="k">for</span> <span class="n">_char</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
            <span class="c1"># 判断是否在码表 id 对照字典中存在</span>
            <span class="k">if</span> <span class="n">_char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">char_to_id</span><span class="p">:</span>
                <span class="c1"># 加入字符id对照字典</span>
                <span class="n">char_to_id</span><span class="p">[</span><span class="n">_char</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">char_to_id</span><span class="p">)</span>

    <span class="c1"># 将句子转为 id 并用 tensor 包装</span>
    <span class="n">sentences_sequence</span> <span class="o">=</span> <span class="n">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">,</span> <span class="n">char_to_id</span><span class="p">,</span> <span class="n">SENTENCE_LENGTH</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"sentences_sequence:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">sentences_sequence</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_7"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_7 pre, #__code_7 code"><span class="md-clipboard__message"></span></button><code><span class="n">sentences_sequence</span><span class="p">:</span>
<span class="n">tensor</span><span class="p">([[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">]])</span>
</code></pre></div>

<hr>
<ul>
<li>第三步: 实现网络的前向计算.</li>
</ul>
<div class="highlight"><pre id="__code_8"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_8 pre, #__code_8 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 本函数实现类BiLSTM中的前向计算函数forward()</span>
<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentences_sequence</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    description: 将句子利用BiLSTM进行特征计算，分别经过Embedding-&gt;BiLSTM-&gt;Linear，</span>
<span class="sd">                 获得发射矩阵（emission scores）</span>
<span class="sd">    :param sentences_sequence: 句子序列对应的编码，</span>
<span class="sd">                               若设定 batch_first 为 True，</span>
<span class="sd">                               则批量输入的 sequence 的 shape 为(batch_size, sequence_length)</span>
<span class="sd">    :return:    返回当前句子特征，转化为 tag_size 的维度的特征</span>
<span class="sd">    """</span>
    <span class="c1"># 初始化隐藏状态值</span>
    <span class="n">h0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span>
    <span class="c1"># 初始化单元状态值</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layers</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)</span>
    <span class="c1"># 生成字向量， shape 为(batch, sequence_length, input_feature_size)</span>
    <span class="c1"># 注：embedding cuda 优化仅支持 SGD 、 SparseAdam</span>
    <span class="n">input_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">sentences_sequence</span><span class="p">)</span>

    <span class="c1"># 将字向量与初始值(隐藏状态 h0 , 单元状态 c0 )传入 LSTM 结构中</span>
    <span class="c1"># 输出包含如下内容：</span>
    <span class="c1"># 1, 计算的输出特征，shape 为(batch, sentence_length, hidden_size)</span>
    <span class="c1">#    顺序为设定 batch_first 为 True 情况, 若未设定则 batch 在第二位</span>
    <span class="c1"># 2, 最后得到的隐藏状态 hn ， shape 为(num_layers * num_directions, batch, hidden_size)</span>
    <span class="c1"># 3, 最后得到的单元状态 cn ， shape 为(num_layers * num_directions, batch, hidden_size)</span>
    <span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">hn</span><span class="p">,</span> <span class="n">cn</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bilstm</span><span class="p">(</span><span class="n">input_features</span><span class="p">,</span> <span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">c0</span><span class="p">))</span>
    <span class="c1"># 将输出特征进行线性变换，转为 shape 为 (batch, sequence_length, tag_size) 大小的特征</span>
    <span class="n">sequence_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="c1"># 输出线性变换为 tag 映射长度的特征</span>
    <span class="k">return</span> <span class="n">sequence_features</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/bilstm.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_9"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_9 pre, #__code_9 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 参数1:标签码表对照</span>
<span class="n">tag_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"O"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>

<span class="c1"># 参数2:字向量维度</span>
<span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>

<span class="c1"># 参数3:隐层维度</span>
<span class="n">HIDDEN_DIM</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># 参数4:批次大小</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># 参数5:句子长度</span>
<span class="n">SENTENCE_LENGTH</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># 参数6:堆叠 LSTM 层数</span>
<span class="n">NUM_LAYERS</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">char_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"&lt;PAD&gt;"</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="n">SENTENCE_LENGTH</span> <span class="o">=</span> <span class="mi">20</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_10"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_10 pre, #__code_10 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_char</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">char_to_id</span><span class="p">:</span>
                <span class="n">char_to_id</span><span class="p">[</span><span class="n">_char</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">char_to_id</span><span class="p">)</span>
    <span class="n">sentence_sequence</span> <span class="o">=</span> <span class="n">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">,</span> <span class="n">char_to_id</span><span class="p">,</span> <span class="n">SENTENCE_LENGTH</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTM</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">char_to_id</span><span class="p">),</span> <span class="n">tag_to_id</span><span class="o">=</span><span class="n">tag_to_id</span><span class="p">,</span> <span class="n">input_feature_size</span><span class="o">=</span><span class="n">EMBEDDING_DIM</span><span class="p">,</span> \
    <span class="n">hidden_size</span><span class="o">=</span><span class="n">HIDDEN_DIM</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">sentence_length</span><span class="o">=</span><span class="n">SENTENCE_LENGTH</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">NUM_LAYERS</span><span class="p">)</span>

    <span class="n">sentence_features</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">sentence_sequence</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"sequence_features:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">sentence_features</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_11"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_11 pre, #__code_11 code"><span class="md-clipboard__message"></span></button><code><span class="n">sequence_features</span><span class="p">:</span>
<span class="n">tensor</span><span class="p">([[[</span> <span class="mf">4.0880e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.8926e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.3971e-02</span><span class="p">,</span>  <span class="mf">8.4794e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.9872e-01</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">2.9434e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5901e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0811e-01</span><span class="p">,</span>  <span class="mf">1.3794e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8743e-01</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">2.7899e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.4636e-01</span><span class="p">,</span>  <span class="mf">1.3382e-02</span><span class="p">,</span>  <span class="mf">2.2684e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2067e-01</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">1.9069e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.6668e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.7182e-02</span><span class="p">,</span>  <span class="mf">2.1566e-01</span><span class="p">,</span>  <span class="mf">1.1443e-01</span><span class="p">],</span>
                                        <span class="o">...</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">1.6844e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0699e-02</span><span class="p">,</span>  <span class="mf">2.6328e-02</span><span class="p">,</span>  <span class="mf">1.3513e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.4445e-01</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">7.3070e-02</span><span class="p">,</span>  <span class="mf">1.2032e-01</span><span class="p">,</span>  <span class="mf">2.2346e-01</span><span class="p">,</span>  <span class="mf">1.8993e-01</span><span class="p">,</span>  <span class="mf">8.3171e-02</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">1.6808e-01</span><span class="p">,</span>  <span class="mf">2.1454e-02</span><span class="p">,</span>  <span class="mf">3.2424e-01</span><span class="p">,</span>  <span class="mf">8.0905e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5961e-01</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">1.9504e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.9296e-02</span><span class="p">,</span>  <span class="mf">1.7219e-01</span><span class="p">,</span>  <span class="mf">8.9345e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4214e-01</span><span class="p">]],</span>
        <span class="o">...</span>
        <span class="p">[[</span><span class="o">-</span><span class="mf">3.4836e-03</span><span class="p">,</span>  <span class="mf">2.6217e-01</span><span class="p">,</span>  <span class="mf">1.9355e-01</span><span class="p">,</span>  <span class="mf">1.8084e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6086e-01</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">9.1231e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.4838e-04</span><span class="p">,</span>  <span class="mf">1.0575e-01</span><span class="p">,</span>  <span class="mf">2.2864e-01</span><span class="p">,</span>  <span class="mf">1.6104e-02</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">8.7726e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.6956e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.0301e-02</span><span class="p">,</span>  <span class="mf">1.7199e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.5375e-02</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">5.9306e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.4701e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.3267e-02</span><span class="p">,</span>  <span class="mf">3.2478e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0474e-02</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">1.1326e-01</span><span class="p">,</span>  <span class="mf">4.8365e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7994e-01</span><span class="p">,</span>  <span class="mf">8.1722e-02</span><span class="p">,</span>  <span class="mf">1.8604e-01</span><span class="p">],</span>
                                        <span class="o">...</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">5.8271e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.5781e-02</span><span class="p">,</span>  <span class="mf">9.9232e-02</span><span class="p">,</span>  <span class="mf">4.8524e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.2799e-02</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">6.8400e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.1515e-02</span><span class="p">,</span>  <span class="mf">1.1352e-01</span><span class="p">,</span>  <span class="mf">1.0674e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.2739e-02</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">9.1461e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2304e-01</span><span class="p">,</span>  <span class="mf">1.2540e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.2065e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.3091e-02</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">1.5834e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.7316e-02</span><span class="p">,</span>  <span class="mf">7.0567e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.8845e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.0867e-02</span><span class="p">]],</span>

        <span class="p">[[</span><span class="o">-</span><span class="mf">1.4069e-01</span><span class="p">,</span>  <span class="mf">4.9171e-02</span><span class="p">,</span>  <span class="mf">1.4314e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5284e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4395e-01</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">6.5296e-02</span><span class="p">,</span>  <span class="mf">9.3255e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.8411e-02</span><span class="p">,</span>  <span class="mf">1.5143e-01</span><span class="p">,</span>  <span class="mf">7.8252e-02</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">4.1765e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4635e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.9798e-02</span><span class="p">,</span>  <span class="mf">2.7597e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0256e-01</span><span class="p">],</span>
         <span class="o">...</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">3.9810e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.6746e-03</span><span class="p">,</span>  <span class="mf">1.2418e-01</span><span class="p">,</span>  <span class="mf">4.9897e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.4538e-02</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">3.4474e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0586e-02</span><span class="p">,</span>  <span class="mf">1.3861e-01</span><span class="p">,</span>  <span class="mf">4.0395e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.3676e-02</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">3.4092e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.3208e-02</span><span class="p">,</span>  <span class="mf">1.6097e-01</span><span class="p">,</span>  <span class="mf">2.3498e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.3332e-02</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">4.6900e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.0335e-02</span><span class="p">,</span>  <span class="mf">1.8982e-01</span><span class="p">,</span>  <span class="mf">3.6287e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.8078e-02</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">6.4105e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.2628e-02</span><span class="p">,</span>  <span class="mf">1.8999e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.9888e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1875e-01</span><span class="p">]]],</span>
       <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">AddBackward0</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出结果说明: 该输出结果为输入批次中句子的特征, 利用线性变换分别对应到每个tag的得分. 例如上述标量第一个值：<code>[ 4.0880e-02, -5.8926e-02, -9.3971e-02,  8.4794e-03, -2.9872e-01]</code>表示的意思为第一个句子第一个字分别被标记为["O", "B-dis", "I-dis", "B-sym", "I-sym"]的分数, 由此可以判断, 在这个例子中, 第一个字被标注为"O"的分数最高.</li>
</ul>
<hr>
<ul>
<li>小节总结:<ul>
<li>了解了BiLSTM网络结构<ul>
<li>设置隐藏层维度的时候, 需要将hidden_size // 2</li>
<li>总共有3层需要构建, 分别是词嵌入层, 双向LSTM层, 全连接线性层</li>
<li>在代码层面, 双向LSTM就是将nn.LSTM()中的参数bidirectional设置为True</li>
</ul>
</li>
<li>掌握了BiLSTM网络的代码实现<ul>
<li>构建类BiLSTM的初始化函数</li>
<li>添加文本向量化的辅助函数, 注意padding填充为相同长度的Tensor</li>
<li>要注意forward函数中不同张量的形状约定</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="63-crf">6.3 CRF介绍<a class="headerlink" href="#63-crf" title="Permanent link">¶</a></h2>
<ul>
<li>学习目标:<ul>
<li>了解CRF的概念和作用</li>
<li>了解转移概率矩阵</li>
<li>了解发射概率矩阵</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<p>CRF的概念和作用:</p>
<ul>
<li>
<p>CRF(全称Conditional Random Fields), 条件随机场. 是给定输入序列的条件下, 求解输出序列的条件概率分布模型.</p>
</li>
<li>
<p>下面举两个应用场景的例子:</p>
<ul>
<li>
<p>场景一: 假设有一堆日常生活的给小朋友排拍的视频片段, 可能的状态有睡觉、吃饭、喝水、洗澡、刷牙、玩耍等, 大部分情况, 我们是能够识别出视频片段的状态. 但如果你只是看到一小段拿杯子的视频, 在没有前后相连的视频作为前后文参照的情况下, 我们很难知道拿杯子是要刷牙还是喝水. 这时, 可以用到CRF模型.</p>
</li>
<li>
<p>场景二: 假设有分好词的句子, 我们要判断每个词的词性, 那么对于一些词来说, 如果我们不知道相邻词的词性的情况下, 是很难准确判断每个词的词性的. 这时, 我们也可以用到CRF.</p>
</li>
</ul>
</li>
<li>
<p>基本定义: 我们将随机变量的集合称为随机过程. 由一个空间变量索引的随机过程, 我们将其称为随机场. 上面的例子中, 做词性标注时, 可以将{名词、动词、形容词、副词}这些词性定义为随机变量, 然后从中选择相应的词性, 而这组随机变量在某种程度上遵循某种概率分布, 将这些词性按照对应的概率赋值给相应的词, 就完成了句子的词性标注.</p>
</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<p>关于条件随机场与马尔科夫假设:</p>
<ul>
<li>前面课程我们介绍过马尔科夫假设, 也就是当前位置的取值只和与它相邻的位置的值有关, 和它不相邻的位置的值无关.</li>
<li>应用到我们上面的词性标注例子中, 可以理解为当前词的词性是根据前一个词和后一个词的词性来决定的, 等效于从词性前后文的概率来给出当前词的词性判断结果.</li>
<li>现实中可以做如下假设: 假设一个动词或者副词后面不会连接同样的动词或者副词, 这样的概率很高. 那么, 可以假定这种给定隐藏状态(也就是词性序列)的情况下, 来计算观测状态的计算过程. 本质上CRF模型考虑到了观测状态这个先验条件, 这也是条件随机场中的条件一词的含义.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>转移概率矩阵:</li>
</ul>
<blockquote>
<ul>
<li>首先假设我们需要标注的实体类型有一下几类：</li>
</ul>
</blockquote>
<div class="highlight"><pre id="__code_12"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_12 pre, #__code_12 code"><span class="md-clipboard__message"></span></button><code><span class="p">{</span><span class="s2">"O"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>

<span class="c1"># 其中dis表示疾病(disease), sym表示症状(symptom), B表示命名实体开头, I表示命名实体中间到结尾, O表示其他类型.</span>
</code></pre></div>

<hr>
<blockquote>
<ul>
<li>因此我们很容易知道每个字的可能标注类型有以上五种可能性, 那么在一个句子中, 由上一个字到下一个字的概率乘积就有5 × 5种可能性, 具体见下图所示:</li>
</ul>
</blockquote>
<p></p><center><img alt="avatar" src="./index_files/transition.jpg"></center><p></p>
<blockquote>
<ul>
<li>最终训练出来结果大致会如上图所示, 其中下标索引为(i, j)的方格代表如果当前字符是第i行表示的标签, 那么下一个字符表示第j列表示的标签所对应的概率值. 以第二行为例, 假设当前第i个字的标签为B-dis, 那么第i+1个字最大可能出现的概率应该是I-dis.</li>
</ul>
</blockquote>
<hr>
<ul>
<li>发射概率矩阵:</li>
</ul>
<blockquote>
<ul>
<li>
<p>发射概率, 是指已知当前标签的情况下, 对应所出现字符的概率. 通俗理解就是当前标签比较可能出现的文字有哪些, 及其对应出现的概率.</p>
</li>
<li>
<p>下面是几段医疗文本数据的标注结果:</p>
</li>
</ul>
</blockquote>
<p></p><center><img alt="avatar" src="./index_files/ner_demo01.png"></center><p></p>
<p></p><center><img alt="" src="./index_files/ner_demo02.png"></center><p></p>
<p></p><center><img alt="" src="./index_files/ner_demo03.png"></center><p></p>
<p></p><center><img alt="" src="./index_files/ner_demo04.png"></center><p></p>
<hr>
<blockquote>
<ul>
<li>可以得到以上句子的转移矩阵概率如下：</li>
</ul>
</blockquote>
<p></p><center><img alt="avatar" src="./index_files/transition_matrix.png"></center><p></p>
<hr>
<blockquote>
<ul>
<li>对应的发射矩阵可以理解为如下图所示结果：</li>
</ul>
</blockquote>
<p></p><center><img alt="avatar" src="./index_files/emission_matrix.png"></center>   <p></p>
<hr>
<ul>
<li>小节总结:<ul>
<li>学习了CRF的概念和作用<ul>
<li>概念: 条件随机场, 一种条件概率分布模型</li>
<li>作用: 增加了先验条件, 可以更好的完成实体序列的识别</li>
</ul>
</li>
<li>学习了转移概率矩阵</li>
<li>学习了发射概率矩阵</li>
</ul>
</li>
</ul>
<hr>
<h2 id="64-bilstmcrf">6.4 BiLSTM+CRF模型<a class="headerlink" href="#64-bilstmcrf" title="Permanent link">¶</a></h2>
<ul>
<li>学习目标:<ul>
<li>掌握BiLSTM+CRF模型结构</li>
<li>掌握损失函数的定义</li>
<li>掌握BiLSTM_CRF模型的代码实现</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>BiLSTM+CRF模型结构:<ul>
<li>1, 模型的标签定义与整体架构</li>
<li>2, 模型内部的分层展开</li>
<li>3, CRF层的作用</li>
</ul>
</li>
</ul>
<hr>
<blockquote>
<ul>
<li>1, 模型的标签定义与整体架构: 假设我们的数据集中有两类实体-人名, 地名, 与之对应的在训练集中有5类标签如下所示:</li>
</ul>
</blockquote>
<div class="highlight"><pre id="__code_13"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_13 pre, #__code_13 code"><span class="md-clipboard__message"></span></button><code><span class="n">B</span><span class="o">-</span><span class="n">Person</span><span class="p">,</span> <span class="n">I</span><span class="o">-</span><span class="n">Person</span><span class="p">,</span> <span class="n">B</span><span class="o">-</span><span class="n">Organization</span><span class="p">,</span> <span class="n">I</span><span class="o">-</span><span class="n">Organization</span><span class="p">,</span> <span class="n">O</span>

<span class="c1"># B-Person: 人名的开始</span>
<span class="c1"># I-Person: 人名的中间部分</span>
<span class="c1"># B-Organization: 地名的开始</span>
<span class="c1"># I-Organization: 地名的中间部分</span>
<span class="c1"># O: 其他非人名, 非地名的标签</span>
</code></pre></div>

<blockquote>
<ul>
<li>
<p>假设一个句子有5个单词构成, (w0, w1, w2, w3, w4), 每一个单元都代表着由字嵌入构成的向量.
其中字嵌入是随机初始化的, 词嵌入是通过数据训练得到的, 所有的嵌入在训练过程中都会调整到最优解.</p>
</li>
<li>
<p>这些字嵌入或词嵌入作为BiLSTM+CRF模型的输入, 而输出的是句子中每个单元的标签.</p>
</li>
</ul>
</blockquote>
<p></p><center><img alt="avatar" src="./index_files/32.jpeg"></center><p></p>
<hr>
<blockquote>
<ul>
<li>2, 模型内部的分层展开: 整个模型明显有两层, 第一层是BiLSTM层, 第二层是CRF层, 将层的内部展开如下图所示:</li>
</ul>
</blockquote>
<p></p><center><img alt="avatar" src="./index_files/33.jpeg"></center><p></p>
<hr>
<blockquote>
<ul>
<li>BiLSTM层的输出为每一个标签的预测分值, 例如对于单词w0, BiLSTM层输出是</li>
</ul>
</blockquote>
<div class="highlight"><pre id="__code_14"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_14 pre, #__code_14 code"><span class="md-clipboard__message"></span></button><code><span class="mf">1.5</span> <span class="p">(</span><span class="n">B</span><span class="o">-</span><span class="n">Person</span><span class="p">),</span> <span class="mf">0.9</span> <span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="n">Person</span><span class="p">),</span> <span class="mf">0.1</span> <span class="p">(</span><span class="n">B</span><span class="o">-</span><span class="n">Organization</span><span class="p">),</span> <span class="mf">0.08</span> <span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="n">Organization</span><span class="p">),</span> <span class="mf">0.05</span> <span class="p">(</span><span class="n">O</span><span class="p">)</span>
</code></pre></div>

<blockquote>
<ul>
<li>这些分值将作为CRF层的输入.</li>
</ul>
</blockquote>
<hr>
<blockquote>
<ul>
<li>3, CRF层的作用: 如果没有CRF层, 也可以训练一个BiLSTM命名实体识别模型, 如下图所示:</li>
</ul>
</blockquote>
<p></p><center><img alt="avatar" src="./index_files/34.jpeg"></center><p></p>
<blockquote>
<ul>
<li>由于BiLSTM的输出为单元的每一个标签分值, 我们可以挑选分值最高的一个作为该单元的标签.例如, 对于单词w0, "B-Person"的分值-1.5是所有标签得分中最高的, 因此可以挑选"B-Person"作为单词w0的预测标签. 同理, 可以得到w1 - "I-Person", w2 - "O", w3 - "B-Organization", w4 - "O"</li>
</ul>
</blockquote>
<hr>
<blockquote>
<ul>
<li>虽然按照上述方法, 在没有CRF层的条件下我们也可以得到x中每个单元的预测标签, 但是不能保证标签的预测每次都是正确的. 如果出现下图的BiLSTM层输出结果, 则明显预测是错误的.</li>
</ul>
</blockquote>
<p></p><center><img alt="avatar" src="./index_files/35.jpeg"></center><p></p>
<hr>
<blockquote>
<ul>
<li>
<p>CRF层能从训练数据中获得约束性的规则.</p>
</li>
<li>
<p>CRF层可以为最后预测的标签添加一些约束来保证预测的标签是合法的. 在训练数据训练的过程中, 这些约束可以通过CRF层自动学习到.</p>
</li>
</ul>
</blockquote>
<div class="highlight"><pre id="__code_15"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_15 pre, #__code_15 code"><span class="md-clipboard__message"></span></button><code><span class="mi">1</span><span class="p">:</span> <span class="err">句子中的第一个词总是以标签</span><span class="s2">"B-"</span><span class="err">或者</span><span class="s2">"O"</span><span class="err">开始</span><span class="p">,</span> <span class="err">而不是</span><span class="s2">"I-"</span><span class="err">开始</span><span class="o">.</span>
<span class="mi">2</span><span class="p">:</span> <span class="err">标签</span><span class="s2">"B-label1 I-label2 I-label3 ......"</span><span class="p">,</span> <span class="err">其中的</span><span class="n">label1</span><span class="p">,</span> <span class="n">label2</span><span class="p">,</span> <span class="n">label3应该属于同一类实体</span><span class="o">.</span> 
<span class="err">比如</span><span class="p">,</span> <span class="s2">"B-Person I-Person"</span><span class="err">是合法的序列</span><span class="p">,</span> <span class="err">但是</span><span class="s2">"B-Person I-Organization"</span><span class="err">是非法的序列</span><span class="o">.</span>
<span class="mi">3</span><span class="p">:</span> <span class="err">标签序列</span><span class="s2">"O I-label"</span><span class="err">是非法序列</span><span class="p">,</span> <span class="err">任意实体标签的首个标签应该是</span><span class="s2">"B-"</span><span class="p">,</span> <span class="err">而不是</span><span class="s2">"I-"</span><span class="o">.</span>
<span class="err">比如</span><span class="p">,</span> <span class="s2">"O B-label"</span><span class="err">才是合法的序列</span>
</code></pre></div>

<blockquote>
<ul>
<li>有了上述这些约束, 标签序列的预测中非法序列出现的概率将会大大降低.</li>
</ul>
</blockquote>
<hr>
<ul>
<li>
<p>损失函数的定义:</p>
<ul>
<li>
<p>BiLSTM层的输出维度是tag_size, 也就是每个单词w_i映射到tag的发射概率值, 假设BiLSTM的输出矩阵是P, 其中P(i,j)代表单词w_i映射到tag_j的非归一化概率. 对于CRF层, 假设存在一个转移矩阵A, 其中A(i,j)代表tag_j转移到tag_i的概率.</p>
</li>
<li>
<p>对于输入序列X对应的输出tag序列y, 定义分数如下(本质上就是发射概率和转移概率的累加和):</p>
</li>
</ul>
</li>
</ul>
<p></p><center><img alt="avatar" src="./index_files/36.jpeg"></center><p></p>
<hr>
<blockquote>
<ul>
<li>利用softmax函数, 为每一个正确的tag序列y定义一个概率值, 在真实的训练中, 只需要最大化似然概率p(y|X)即可, 具体使用对数似然如下:</li>
</ul>
</blockquote>
<p></p><center><img alt="avatar" src="./index_files/37.jpeg"></center><p></p>
<hr>
<ul>
<li>BiLSTM+CRF模型的实现:<ul>
<li>第一步: 导入工具包并完成辅助函数</li>
<li>第二步: 文本信息张量化</li>
<li>第三步: 创建类的初始化函数</li>
<li>第四步: 创建获取发射矩阵张量的函数</li>
<li>第五步: 计算前向传播分值的函数</li>
<li>第六步: 计算句子真实分值的函数</li>
<li>第七步: 维特比算法的实现</li>
<li>第八步: 完善BiLSTM_CRF类的全部功能</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>第一步: 导入工具包并完成辅助函数</li>
</ul>
<hr>
<div class="highlight"><pre id="__code_16"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_16 pre, #__code_16 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入相关包与模块</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.autograd</span> <span class="kn">as</span> <span class="nn">autograd</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="kn">as</span> <span class="nn">nn</span>
<span class="n">imort</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span> <span class="k">as</span> <span class="n">optim</span>

<span class="c1"># 设置随机种子</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 编写3个辅助函数, 未来在类中会调用这些函数</span>
<span class="c1"># 第1个: 求最大值所在的下标</span>
<span class="k">def</span> <span class="nf">argmax</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
    <span class="c1"># 返回最大值对应的下标, 以Python整型返回</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">idx</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>


<span class="c1"># 第2个: 文本字符串转换成数字化张量, 以Tensor长整型返回</span>
<span class="k">def</span> <span class="nf">prepare_sequence</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">to_ix</span><span class="p">):</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">to_ix</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>


<span class="c1"># 第3个: 计算log-sum-exp的数值</span>
<span class="k">def</span> <span class="nf">log_sum_exp</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
    <span class="c1"># 先把最大值取出</span>
    <span class="n">max_score</span> <span class="o">=</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">argmax</span><span class="p">(</span><span class="n">vec</span><span class="p">)]</span>
    <span class="c1"># 使用广播变量将单一数值扩充成一行张量</span>
    <span class="n">max_score_broadcast</span> <span class="o">=</span> <span class="n">max_score</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">vec</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># 一个代码技巧: 这里先减去最大值, 外面再加上最大值, 并不影响数学计算的正确性.</span>
    <span class="c1"># 但却提升了代码的健壮性, 大大缓解了最大值溢出错误的问题, 因为计算机进行指数运算很容易溢出</span>
    <span class="k">return</span> <span class="n">max_score</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">vec</span> <span class="o">-</span> <span class="n">max_score_broadcast</span><span class="p">)))</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/bilstm_crf.py</li>
</ul>
<hr>
<ul>
<li>第二步: 文本信息张量化</li>
</ul>
<div class="highlight"><pre id="__code_17"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_17 pre, #__code_17 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 首先设置若干超参数</span>
<span class="n">START_TAG</span> <span class="o">=</span> <span class="s2">"&lt;START&gt;"</span>
<span class="n">STOP_TAG</span> <span class="o">=</span> <span class="s2">"&lt;STOP&gt;"</span>
<span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">HIDDEN_DIM</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># 初始化标签字典</span>
<span class="n">tag_to_ix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"O"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">START_TAG</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">STOP_TAG</span><span class="p">:</span><span class="mi">6</span><span class="p">}</span>

<span class="c1"># 函数sentence_map完成中文文本信息的数字编码, 变成张量</span>
<span class="k">def</span> <span class="nf">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">):</span>
    <span class="c1"># 初始化数字映射字典</span>
    <span class="n">word_to_ix</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word_to_ix</span><span class="p">:</span>
                <span class="n">word_to_ix</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_to_ix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">word_to_ix</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/bilstm_crf.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_18"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_18 pre, #__code_18 code"><span class="md-clipboard__message"></span></button><code><span class="n">sentence_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">([</span><span class="s2">"女"</span><span class="p">,</span> <span class="s2">"性"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"岁"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"农"</span><span class="p">,</span> <span class="s2">"民"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"双"</span><span class="p">,</span> <span class="s2">"滦"</span><span class="p">,</span> <span class="s2">"区"</span><span class="p">,</span> <span class="s2">"应"</span><span class="p">,</span> <span class="s2">"营"</span><span class="p">,</span> <span class="s2">"子"</span><span class="p">,</span> <span class="s2">"村"</span><span class="p">,</span> <span class="s2">"人"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"主"</span><span class="p">,</span> <span class="s2">"因"</span><span class="p">,</span> <span class="s2">"右"</span><span class="p">,</span> <span class="s2">"髋"</span><span class="p">,</span> <span class="s2">"部"</span><span class="p">,</span> <span class="s2">"摔"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"肿"</span><span class="p">,</span> <span class="s2">"胀"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"活"</span><span class="p">,</span> <span class="s2">"动"</span><span class="p">,</span> <span class="s2">"受"</span><span class="p">,</span> <span class="s2">"限"</span><span class="p">,</span> <span class="s2">"5"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"9"</span><span class="p">,</span> <span class="s2">"；"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"："</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]</span>
<span class="p">),</span>
    <span class="p">([</span><span class="s2">"处"</span><span class="p">,</span> <span class="s2">"外"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"伴"</span><span class="p">,</span> <span class="s2">"有"</span><span class="p">,</span> <span class="s2">"头"</span><span class="p">,</span> <span class="s2">"晕"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"收"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]</span>
<span class="p">)]</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_19"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_19 pre, #__code_19 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">word_to_ix</span> <span class="o">=</span> <span class="n">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">word_to_ix</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_20"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_20 pre, #__code_20 code"><span class="md-clipboard__message"></span></button><code><span class="p">{</span><span class="s1">'女'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'性'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'8'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'岁'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">'农'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'民'</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">'双'</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'滦'</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">'区'</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">'应'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'营'</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">'子'</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">'村'</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">'人'</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">'主'</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">'因'</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s1">'右'</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="s1">'髋'</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">'部'</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="s1">'摔'</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">'伤'</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span> <span class="s1">'后'</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="s1">'疼'</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span> <span class="s1">'痛'</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span> <span class="s1">'肿'</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">'胀'</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span> <span class="s1">'活'</span><span class="p">:</span> <span class="mi">27</span><span class="p">,</span> <span class="s1">'动'</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span> <span class="s1">'受'</span><span class="p">:</span> <span class="mi">29</span><span class="p">,</span> <span class="s1">'限'</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">'5'</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="s1">'小'</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s1">'时'</span><span class="p">:</span> <span class="mi">33</span><span class="p">,</span> <span class="s1">'于'</span><span class="p">:</span> <span class="mi">34</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span> <span class="s1">'6'</span><span class="p">:</span> <span class="mi">38</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">:</span> <span class="mi">39</span><span class="p">,</span> <span class="s1">'9'</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s1">'；'</span><span class="p">:</span> <span class="mi">41</span><span class="p">,</span> <span class="s1">'：'</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s1">'入'</span><span class="p">:</span> <span class="mi">43</span><span class="p">,</span> <span class="s1">'院'</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span> <span class="s1">'处'</span><span class="p">:</span> <span class="mi">46</span><span class="p">,</span> <span class="s1">'外'</span><span class="p">:</span> <span class="mi">47</span><span class="p">,</span> <span class="s1">'伴'</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span> <span class="s1">'有'</span><span class="p">:</span> <span class="mi">49</span><span class="p">,</span> <span class="s1">'头'</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">'晕'</span><span class="p">:</span> <span class="mi">51</span><span class="p">,</span> <span class="s1">':'</span><span class="p">:</span> <span class="mi">52</span><span class="p">,</span> <span class="s1">'收'</span><span class="p">:</span> <span class="mi">53</span><span class="p">}</span>
</code></pre></div>

<hr>
<ul>
<li>第三步: 创建类的初始化函数</li>
</ul>
<div class="highlight"><pre id="__code_21"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_21 pre, #__code_21 code"><span class="md-clipboard__message"></span></button><code><span class="k">class</span> <span class="nc">BiLSTM_CRF</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">tag_to_ix</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BiLSTM_CRF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># 将参数传入类中</span>
        <span class="c1"># 词嵌入的维度embedding_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="o">=</span> <span class="n">embddding_dim</span>
        <span class="c1"># LSTM网络中隐藏层的维度hidden_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="c1"># 词汇总数vocab_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>
        <span class="c1"># 标签映射字典tag_to_ix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_to_ix</span> <span class="o">=</span> <span class="n">tag_to_ix</span>
        <span class="c1"># 标签数量tagset_size, 决定了转移矩阵的维度</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tagset_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag_to_ix</span><span class="p">)</span>

        <span class="c1"># 定义词嵌入层, 输入的两个参数是vocab_size, embedding_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_embeds</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">)</span>
        <span class="c1"># 定义BiLSTM层, 设定内部只有一个隐藏层, 并通过参数指定成双向</span>
        <span class="c1"># 注意: 因为采用双向网络, 因此隐藏层维度要除以2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">embedding_dim</span><span class="p">,</span> <span class="n">hidden_dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="n">num_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># 定义一个全连接线性层, 用来将BiLSTM网络的输出维度hidden_dim映射到转移矩阵的维度tagset_size </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden2tag</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagset_size</span><span class="p">)</span>

        <span class="c1"># 定义转移矩阵, 并初始化参数, 采用正态分布的随机初始化赋值</span>
        <span class="c1"># 转移矩阵是一个方阵, 维度等于标签数量tagset_size</span>
        <span class="c1"># 转移矩阵的任意位置i, j代表从标签j转移到标签i的概率</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagset_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagset_size</span><span class="p">))</span>

        <span class="c1"># 设定两个限制条件, 任意合法的转移不会转移到起始标签, 也不会从结束标签转移出去</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">START_TAG</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">tag_to_ix</span><span class="p">[</span><span class="n">STOP_TAG</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10000</span>

        <span class="c1"># 初始化LSTM网络的两个输入张量h0, c0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_hidden</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">init_hidden</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 关于LSTM网络的初始输入张量, 三个参数分别代表(num_layers * num_directions, batch_size, hidden_size)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/bilstm_crf.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_22"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_22 pre, #__code_22 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 首先设置若干超参数</span>
<span class="n">START_TAG</span> <span class="o">=</span> <span class="s2">"&lt;START&gt;"</span>
<span class="n">STOP_TAG</span> <span class="o">=</span> <span class="s2">"&lt;STOP&gt;"</span>
<span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">HIDDEN_DIM</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">VOCAB_SIZE</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># 初始化标签字典</span>
<span class="n">tag_to_ix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"O"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">START_TAG</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">STOP_TAG</span><span class="p">:</span><span class="mi">6</span><span class="p">}</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_23"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_23 pre, #__code_23 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTM_CRF</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="n">VOCAB_SIZE</span><span class="p">,</span> <span class="n">tag_to_ix</span><span class="o">=</span><span class="n">tag_to_ix</span><span class="p">,</span>
                       <span class="n">embedding_dim</span><span class="o">=</span><span class="n">EMBEDDING_DIM</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">HIDDEN_DIM</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_24"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_24 pre, #__code_24 code"><span class="md-clipboard__message"></span></button><code><span class="n">BiLSTM_CRF</span><span class="p">(</span>
  <span class="p">(</span><span class="n">word_embeds</span><span class="p">):</span> <span class="n">Embedding</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
  <span class="p">(</span><span class="n">lstm</span><span class="p">):</span> <span class="n">LSTM</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="p">(</span><span class="n">hidden2tag</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>第四步: 创建获取发射矩阵张量的函数</li>
</ul>
<div class="highlight"><pre id="__code_25"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_25 pre, #__code_25 code"><span class="md-clipboard__message"></span></button><code><span class="k">def</span> <span class="nf">_get_lstm_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentence</span><span class="p">):</span>
    <span class="c1"># 为一个参数sentence, 代表文本向量化后的输入张量</span>
    <span class="c1"># 首先获取一个初始化的隐藏张量h0, c0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_hidden</span><span class="p">()</span>
    <span class="c1"># 进行词嵌入的处理, 并将一句样本变形为三维张量    </span>
    <span class="n">embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_embeds</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># 将输入张量和初始化张量送入LSTM网络中</span>
    <span class="n">lstm_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">embeds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">)</span>
    <span class="c1"># 再将输出的张量重新变形为二维张量, 以便后续送入全连接层</span>
    <span class="n">lstm_out</span> <span class="o">=</span> <span class="n">lstm_out</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">)</span>
    <span class="c1"># 进行映射处理, 将LSTM网络的输出维度hidden_dim映射到转移矩阵的维度tagset_size</span>
    <span class="n">lstm_feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden2tag</span><span class="p">(</span><span class="n">lstm_out</span><span class="p">)</span>
    <span class="c1"># 返回发射矩阵的张量</span>
    <span class="k">return</span> <span class="n">lstm_feats</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/bilstm_crf.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_26"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_26 pre, #__code_26 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 首先设置若干超参数</span>
<span class="n">START_TAG</span> <span class="o">=</span> <span class="s2">"&lt;START&gt;"</span>
<span class="n">STOP_TAG</span> <span class="o">=</span> <span class="s2">"&lt;STOP&gt;"</span>
<span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">HIDDEN_DIM</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># 初始化标签字典</span>
<span class="n">tag_to_ix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"O"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">START_TAG</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">STOP_TAG</span><span class="p">:</span><span class="mi">6</span><span class="p">}</span>

<span class="c1"># 输入样本数据</span>
<span class="n">sentence_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">([</span><span class="s2">"女"</span><span class="p">,</span> <span class="s2">"性"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"岁"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"农"</span><span class="p">,</span> <span class="s2">"民"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"双"</span><span class="p">,</span> <span class="s2">"滦"</span><span class="p">,</span> <span class="s2">"区"</span><span class="p">,</span> <span class="s2">"应"</span><span class="p">,</span> <span class="s2">"营"</span><span class="p">,</span> <span class="s2">"子"</span><span class="p">,</span> <span class="s2">"村"</span><span class="p">,</span> <span class="s2">"人"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"主"</span><span class="p">,</span> <span class="s2">"因"</span><span class="p">,</span> <span class="s2">"右"</span><span class="p">,</span> <span class="s2">"髋"</span><span class="p">,</span> <span class="s2">"部"</span><span class="p">,</span> <span class="s2">"摔"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"肿"</span><span class="p">,</span> <span class="s2">"胀"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"活"</span><span class="p">,</span> <span class="s2">"动"</span><span class="p">,</span> <span class="s2">"受"</span><span class="p">,</span> <span class="s2">"限"</span><span class="p">,</span> <span class="s2">"5"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"9"</span><span class="p">,</span> <span class="s2">"；"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"："</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]</span>
<span class="p">),</span>
    <span class="p">([</span><span class="s2">"处"</span><span class="p">,</span> <span class="s2">"外"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"伴"</span><span class="p">,</span> <span class="s2">"有"</span><span class="p">,</span> <span class="s2">"头"</span><span class="p">,</span> <span class="s2">"晕"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"收"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]</span>
<span class="p">)]</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_27"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_27 pre, #__code_27 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 函数sentence_map完成中文文本信息的数字编码, 变成张量</span>
<span class="k">def</span> <span class="nf">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">):</span>
    <span class="c1"># 初始化数字映射字典</span>
    <span class="n">word_to_ix</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word_to_ix</span><span class="p">:</span>
                <span class="n">word_to_ix</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_to_ix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">word_to_ix</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="c1"># 获取所有字符的映射字典</span>
    <span class="n">word_to_ix</span> <span class="o">=</span> <span class="n">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">)</span>
    <span class="c1"># 创建类对象</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTM_CRF</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">word_to_ix</span><span class="p">),</span> <span class="n">tag_to_ix</span><span class="o">=</span><span class="n">tag_to_ix</span><span class="p">,</span>
                       <span class="n">embedding_dim</span><span class="o">=</span><span class="n">EMBEDDING_DIM</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">HIDDEN_DIM</span><span class="p">)</span>

    <span class="c1"># 遍历样本数据</span>
    <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="c1"># 完成自然语言文本到数字化张量的映射</span>
        <span class="n">sentence_in</span> <span class="o">=</span> <span class="n">prepare_sequence</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">word_to_ix</span><span class="p">)</span>
        <span class="c1"># 调用类内函数完成发射矩阵张量的计算</span>
        <span class="n">feat_out</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_lstm_features</span><span class="p">(</span><span class="n">sentence_in</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">feat_out</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">feat_out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'******'</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_28"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_28 pre, #__code_28 code"><span class="md-clipboard__message"></span></button><code><span class="n">tensor</span><span class="p">([[</span> <span class="mf">2.5648e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.1561e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.2388e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.5633e-02</span><span class="p">,</span>  <span class="mf">9.1718e-02</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">3.0061e-01</span><span class="p">,</span>  <span class="mf">3.7920e-01</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">5.4860e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1659e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.1753e-02</span><span class="p">,</span>  <span class="mf">1.0082e-02</span><span class="p">,</span>  <span class="mf">3.3163e-02</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">4.4073e-01</span><span class="p">,</span>  <span class="mf">2.8370e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">5.1306e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.5514e-02</span><span class="p">,</span>  <span class="mf">4.6239e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2711e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4330e-01</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">2.1370e-01</span><span class="p">,</span>  <span class="mf">1.5965e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">6.4939e-05</span><span class="p">,</span>  <span class="mf">7.2022e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6883e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5513e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.4610e-01</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">4.5214e-02</span><span class="p">,</span>  <span class="mf">1.0375e-01</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">3.0024e-02</span><span class="p">,</span>  <span class="mf">9.2245e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.3889e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0817e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.2711e-01</span><span class="p">,</span>
          <span class="mf">2.5277e-02</span><span class="p">,</span>  <span class="mf">5.7591e-02</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">2.2383e-02</span><span class="p">,</span>  <span class="mf">1.2964e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8156e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2497e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.2534e-02</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">7.8362e-03</span><span class="p">,</span>  <span class="mf">1.0427e-01</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">1.0602e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.3365e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.7026e-02</span><span class="p">,</span>  <span class="mf">1.3497e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4938e-01</span><span class="p">,</span>
          <span class="mf">3.9804e-02</span><span class="p">,</span>  <span class="mf">1.0117e-01</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">1.0509e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.7863e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.9937e-01</span><span class="p">,</span>  <span class="mf">1.5289e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3783e-01</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">2.3168e-02</span><span class="p">,</span>  <span class="mf">2.6802e-02</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">1.7812e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.3242e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5064e-01</span><span class="p">,</span>  <span class="mf">9.9835e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4856e-01</span><span class="p">,</span>
          <span class="mf">4.0481e-02</span><span class="p">,</span>  <span class="mf">6.0709e-02</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">7.7586e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0244e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8352e-03</span><span class="p">,</span>  <span class="mf">1.6295e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3026e-01</span><span class="p">,</span>
          <span class="mf">5.1853e-02</span><span class="p">,</span>  <span class="mf">1.4791e-01</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">1.6325e-01</span><span class="p">,</span>  <span class="mf">2.4854e-02</span><span class="p">,</span>  <span class="mf">3.6954e-02</span><span class="p">,</span>  <span class="mf">2.1543e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.1775e-01</span><span class="p">,</span>
          <span class="mf">8.6133e-02</span><span class="p">,</span>  <span class="mf">9.4609e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.5338e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0924e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.7616e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3885e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.4871e-02</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">2.7718e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.9287e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.9098e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6652e-01</span><span class="p">,</span>  <span class="mf">2.1831e-02</span><span class="p">,</span>  <span class="mf">8.0889e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.4066e-01</span><span class="p">,</span>
          <span class="mf">1.8001e-01</span><span class="p">,</span>  <span class="mf">1.8485e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">2.3809e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1787e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5258e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.6684e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.8115e-02</span><span class="p">,</span>
          <span class="mf">1.1509e-01</span><span class="p">,</span>  <span class="mf">7.6804e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.5559e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.6017e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7135e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.2832e-01</span><span class="p">,</span>  <span class="mf">3.2622e-02</span><span class="p">,</span>
          <span class="mf">3.7467e-03</span><span class="p">,</span>  <span class="mf">5.6119e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">2.0804e-01</span><span class="p">,</span>  <span class="mf">1.0067e-01</span><span class="p">,</span>  <span class="mf">1.4587e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7181e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1958e-01</span><span class="p">,</span>
          <span class="mf">5.8949e-02</span><span class="p">,</span>  <span class="mf">1.4388e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.2343e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7671e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.6465e-02</span><span class="p">,</span>  <span class="mf">1.3866e-01</span><span class="p">,</span>  <span class="mf">6.7426e-02</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">3.2661e-02</span><span class="p">,</span>  <span class="mf">8.4317e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.4493e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1630e-01</span><span class="p">,</span>  <span class="mf">8.2518e-02</span><span class="p">,</span>  <span class="mf">4.6810e-03</span><span class="p">,</span>  <span class="mf">1.5111e-02</span><span class="p">,</span>
          <span class="mf">1.0425e-01</span><span class="p">,</span>  <span class="mf">1.0944e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.4941e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.4159e-02</span><span class="p">,</span>  <span class="mf">5.5885e-02</span><span class="p">,</span>  <span class="mf">7.2037e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.6110e-02</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">3.8676e-02</span><span class="p">,</span>  <span class="mf">1.7072e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.6386e-01</span><span class="p">,</span>  <span class="mf">1.4630e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0834e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2231e-01</span><span class="p">,</span>  <span class="mf">1.3832e-01</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">1.3537e-02</span><span class="p">,</span>  <span class="mf">9.5398e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">6.6860e-04</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1467e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0830e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.8238e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.9175e-02</span><span class="p">,</span>
          <span class="mf">1.1733e-01</span><span class="p">,</span>  <span class="mf">2.0297e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.1379e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.6003e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.6359e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.2608e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1837e-01</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">5.0142e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.5640e-02</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">2.5728e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2722e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1789e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3511e-01</span><span class="p">,</span>  <span class="mf">8.8251e-02</span><span class="p">,</span>
          <span class="mf">1.0855e-01</span><span class="p">,</span>  <span class="mf">7.9063e-02</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">6.4110e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.8353e-02</span><span class="p">,</span>  <span class="mf">4.0458e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1607e-02</span><span class="p">,</span>  <span class="mf">1.0290e-01</span><span class="p">,</span>
          <span class="mf">7.3695e-02</span><span class="p">,</span>  <span class="mf">1.9763e-01</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">5.9070e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.8002e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2392e-01</span><span class="p">,</span>  <span class="mf">1.0183e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.0449e-02</span><span class="p">,</span>
          <span class="mf">3.7332e-02</span><span class="p">,</span>  <span class="mf">1.3580e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.9642e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0014e-01</span><span class="p">,</span>  <span class="mf">1.4948e-02</span><span class="p">,</span>  <span class="mf">1.7080e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5619e-02</span><span class="p">,</span>
          <span class="mf">5.5880e-02</span><span class="p">,</span>  <span class="mf">1.2094e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.7654e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.8227e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.7823e-02</span><span class="p">,</span>  <span class="mf">3.1370e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1585e-01</span><span class="p">,</span>
          <span class="mf">1.1930e-01</span><span class="p">,</span>  <span class="mf">1.8831e-01</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">3.8926e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.1772e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.5110e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.9899e-02</span><span class="p">,</span>  <span class="mf">3.7298e-02</span><span class="p">,</span>
          <span class="mf">1.0584e-01</span><span class="p">,</span>  <span class="mf">1.5214e-01</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">1.6634e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4563e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3152e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6581e-01</span><span class="p">,</span>  <span class="mf">7.6784e-02</span><span class="p">,</span>
          <span class="mf">1.6939e-01</span><span class="p">,</span>  <span class="mf">2.7952e-03</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">8.4751e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.9533e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7325e-01</span><span class="p">,</span>  <span class="mf">6.6441e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7166e-01</span><span class="p">,</span>
          <span class="mf">3.1308e-03</span><span class="p">,</span>  <span class="mf">1.2822e-01</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">9.5597e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.9972e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.1223e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.9872e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3918e-01</span><span class="p">,</span>
          <span class="mf">9.6167e-03</span><span class="p">,</span>  <span class="mf">2.5080e-01</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">4.9030e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.4019e-02</span><span class="p">,</span>  <span class="mf">1.0980e-02</span><span class="p">,</span>  <span class="mf">8.0284e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6032e-01</span><span class="p">,</span>
          <span class="mf">3.0616e-02</span><span class="p">,</span>  <span class="mf">2.2779e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">2.2239e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.9603e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3757e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5273e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0932e-01</span><span class="p">,</span>
          <span class="mf">1.3724e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.1350e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.0584e-01</span><span class="p">,</span>  <span class="mf">6.1423e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.2631e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0891e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.1825e-01</span><span class="p">,</span>
          <span class="mf">6.6080e-02</span><span class="p">,</span>  <span class="mf">9.9337e-02</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">1.0939e-01</span><span class="p">,</span>  <span class="mf">1.0725e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2156e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0108e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1477e-01</span><span class="p">,</span>
          <span class="mf">8.4399e-02</span><span class="p">,</span>  <span class="mf">1.0016e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">5.9584e-02</span><span class="p">,</span>  <span class="mf">1.1755e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.8489e-02</span><span class="p">,</span>  <span class="mf">7.8746e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.9526e-02</span><span class="p">,</span>
          <span class="mf">5.2422e-02</span><span class="p">,</span>  <span class="mf">6.2766e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">2.6854e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.1575e-03</span><span class="p">,</span>  <span class="mf">2.4177e-02</span><span class="p">,</span>  <span class="mf">1.1323e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.2580e-01</span><span class="p">,</span>
          <span class="mf">2.7516e-01</span><span class="p">,</span>  <span class="mf">1.6391e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.4348e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5929e-01</span><span class="p">,</span>  <span class="mf">9.1898e-02</span><span class="p">,</span>  <span class="mf">1.2188e-02</span><span class="p">,</span>  <span class="mf">4.6504e-02</span><span class="p">,</span>
          <span class="mf">1.6280e-01</span><span class="p">,</span>  <span class="mf">5.6268e-03</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.4304e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.2476e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.8168e-02</span><span class="p">,</span>  <span class="mf">4.0186e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0070e-01</span><span class="p">,</span>
          <span class="mf">1.0418e-01</span><span class="p">,</span>  <span class="mf">2.0221e-03</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">9.5263e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4599e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.2916e-01</span><span class="p">,</span>  <span class="mf">1.5350e-01</span><span class="p">,</span>  <span class="mf">5.5031e-02</span><span class="p">,</span>
          <span class="mf">4.3325e-02</span><span class="p">,</span>  <span class="mf">1.9438e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.1325e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.0664e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7086e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0778e-01</span><span class="p">,</span>  <span class="mf">5.1010e-02</span><span class="p">,</span>
          <span class="mf">2.3094e-01</span><span class="p">,</span>  <span class="mf">1.8078e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.5837e-01</span><span class="p">,</span>  <span class="mf">4.5440e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.2990e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3247e-01</span><span class="p">,</span>  <span class="mf">7.0668e-02</span><span class="p">,</span>
          <span class="mf">1.3183e-01</span><span class="p">,</span>  <span class="mf">1.0439e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">5.3889e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1634e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8006e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0388e-01</span><span class="p">,</span>  <span class="mf">1.3787e-01</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">2.8443e-02</span><span class="p">,</span>  <span class="mf">1.5294e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">7.7196e-02</span><span class="p">,</span>  <span class="mf">2.0450e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.2790e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.5649e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6061e-01</span><span class="p">,</span>
          <span class="mf">1.6480e-01</span><span class="p">,</span>  <span class="mf">2.9966e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">2.1306e-02</span><span class="p">,</span>  <span class="mf">1.0840e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0215e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.1655e-03</span><span class="p">,</span>  <span class="mf">4.6625e-02</span><span class="p">,</span>
          <span class="mf">5.9342e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0751e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">7.1955e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.3778e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.8845e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.7507e-02</span><span class="p">,</span>  <span class="mf">1.1948e-01</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">1.0569e-01</span><span class="p">,</span>  <span class="mf">1.1710e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">2.4304e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.7232e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.6662e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.6694e-02</span><span class="p">,</span>  <span class="mf">5.0801e-02</span><span class="p">,</span>
          <span class="mf">5.9064e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.5642e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.0028e-01</span><span class="p">,</span>  <span class="mf">4.5246e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.9984e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.1227e-03</span><span class="p">,</span>  <span class="mf">3.1805e-02</span><span class="p">,</span>
          <span class="mf">5.9112e-02</span><span class="p">,</span>  <span class="mf">2.9075e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.9801e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0921e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0496e-01</span><span class="p">,</span>  <span class="mf">1.1706e-02</span><span class="p">,</span>  <span class="mf">8.4321e-02</span><span class="p">,</span>
          <span class="mf">7.8225e-02</span><span class="p">,</span>  <span class="mf">2.4727e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">3.0893e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.9573e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.1343e-02</span><span class="p">,</span>  <span class="mf">8.5030e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0323e-01</span><span class="p">,</span>
          <span class="mf">1.1476e-01</span><span class="p">,</span>  <span class="mf">1.6881e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">6.8506e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4309e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8610e-02</span><span class="p">,</span>  <span class="mf">7.6823e-02</span><span class="p">,</span>  <span class="mf">5.8049e-02</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">1.1352e-01</span><span class="p">,</span>  <span class="mf">1.0877e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">6.3511e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.6188e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.1462e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.1897e-02</span><span class="p">,</span>  <span class="mf">7.7706e-02</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">9.6639e-02</span><span class="p">,</span>  <span class="mf">1.9177e-01</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">5.8708e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.1466e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.2152e-01</span><span class="p">,</span>  <span class="mf">1.5471e-02</span><span class="p">,</span>  <span class="mf">5.0467e-02</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">1.6779e-01</span><span class="p">,</span>  <span class="mf">1.5930e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">2.3204e-02</span><span class="p">,</span>  <span class="mf">4.5757e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.7384e-02</span><span class="p">,</span>  <span class="mf">5.5347e-03</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2756e-01</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">2.6440e-01</span><span class="p">,</span>  <span class="mf">7.8458e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">6.5675e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.7523e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.4535e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.9116e-02</span><span class="p">,</span>  <span class="mf">6.8582e-02</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">1.8452e-01</span><span class="p">,</span>  <span class="mf">9.9607e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">2.1263e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.9625e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.2945e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.1818e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.9379e-04</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">1.9966e-02</span><span class="p">,</span>  <span class="mf">9.6999e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.8553e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.1016e-01</span><span class="p">,</span>  <span class="mf">5.4862e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8242e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0496e-01</span><span class="p">,</span>
          <span class="mf">5.9890e-02</span><span class="p">,</span>  <span class="mf">8.3824e-02</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">2.3465e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.7350e-01</span><span class="p">,</span>  <span class="mf">9.2973e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1989e-02</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.3038e-03</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">6.0264e-02</span><span class="p">,</span>  <span class="mf">1.3068e-01</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">1.8506e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5535e-02</span><span class="p">,</span>  <span class="mf">1.4393e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6613e-01</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.8865e-02</span><span class="p">,</span>
         <span class="o">-</span><span class="mf">1.5681e-01</span><span class="p">,</span>  <span class="mf">1.0718e-01</span><span class="p">]],</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">AddmmBackward</span><span class="o">&gt;</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">59</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="o">******</span>
<span class="n">tensor</span><span class="p">([[</span> <span class="mf">0.0179</span><span class="p">,</span>  <span class="mf">0.1205</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0091</span><span class="p">,</span>  <span class="mf">0.0300</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1250</span><span class="p">,</span>  <span class="mf">0.1379</span><span class="p">,</span>  <span class="mf">0.0560</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.1071</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1872</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1788</span><span class="p">,</span>  <span class="mf">0.0965</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0789</span><span class="p">,</span>  <span class="mf">0.2551</span><span class="p">,</span>  <span class="mf">0.3006</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0132</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2054</span><span class="p">,</span>  <span class="mf">0.0053</span><span class="p">,</span>  <span class="mf">0.2243</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0450</span><span class="p">,</span>  <span class="mf">0.1630</span><span class="p">,</span>  <span class="mf">0.0614</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.2276</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0825</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0554</span><span class="p">,</span>  <span class="mf">0.0942</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0953</span><span class="p">,</span>  <span class="mf">0.2312</span><span class="p">,</span>  <span class="mf">0.1374</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0089</span><span class="p">,</span>  <span class="mf">0.0020</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0536</span><span class="p">,</span>  <span class="mf">0.0455</span><span class="p">,</span>  <span class="mf">0.0978</span><span class="p">,</span>  <span class="mf">0.1404</span><span class="p">,</span>  <span class="mf">0.1034</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0690</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0728</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0548</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0588</span><span class="p">,</span>  <span class="mf">0.1107</span><span class="p">,</span>  <span class="mf">0.3034</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0665</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.1887</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1638</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0053</span><span class="p">,</span>  <span class="mf">0.0020</span><span class="p">,</span>  <span class="mf">0.0185</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0504</span><span class="p">,</span>  <span class="mf">0.0750</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0097</span><span class="p">,</span>  <span class="mf">0.0291</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0964</span><span class="p">,</span>  <span class="mf">0.1860</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1229</span><span class="p">,</span>  <span class="mf">0.0451</span><span class="p">,</span>  <span class="mf">0.0461</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0875</span><span class="p">,</span>  <span class="mf">0.0368</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1662</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0340</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1451</span><span class="p">,</span>  <span class="mf">0.0313</span><span class="p">,</span>  <span class="mf">0.0465</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0411</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2068</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2308</span><span class="p">,</span>  <span class="mf">0.0143</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1120</span><span class="p">,</span>  <span class="mf">0.0946</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1243</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.2291</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1112</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1099</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0274</span><span class="p">,</span>  <span class="mf">0.0865</span><span class="p">,</span>  <span class="mf">0.1574</span><span class="p">,</span>  <span class="mf">0.1050</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.1819</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3105</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0101</span><span class="p">,</span>  <span class="mf">0.0032</span><span class="p">,</span>  <span class="mf">0.0996</span><span class="p">,</span>  <span class="mf">0.0966</span><span class="p">,</span>  <span class="mf">0.0192</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.1709</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2729</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1083</span><span class="p">,</span>  <span class="mf">0.0380</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0819</span><span class="p">,</span>  <span class="mf">0.0805</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0093</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0910</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1606</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2611</span><span class="p">,</span>  <span class="mf">0.1295</span><span class="p">,</span>  <span class="mf">0.0643</span><span class="p">,</span>  <span class="mf">0.0187</span><span class="p">,</span>  <span class="mf">0.1950</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.1273</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1101</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1823</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1209</span><span class="p">,</span>  <span class="mf">0.0500</span><span class="p">,</span>  <span class="mf">0.2313</span><span class="p">,</span>  <span class="mf">0.1886</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.1600</span><span class="p">,</span>  <span class="mf">0.0286</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2412</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1419</span><span class="p">,</span>  <span class="mf">0.0728</span><span class="p">,</span>  <span class="mf">0.1378</span><span class="p">,</span>  <span class="mf">0.1065</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0484</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0171</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3976</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2148</span><span class="p">,</span>  <span class="mf">0.1356</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0324</span><span class="p">,</span>  <span class="mf">0.1486</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0614</span><span class="p">,</span>  <span class="mf">0.0218</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2509</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0683</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1848</span><span class="p">,</span>  <span class="mf">0.1841</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0053</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0057</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0713</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3331</span><span class="p">,</span>  <span class="mf">0.0018</span><span class="p">,</span>  <span class="mf">0.0233</span><span class="p">,</span>  <span class="mf">0.0557</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0746</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0015</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0170</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2862</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0416</span><span class="p">,</span>  <span class="mf">0.0596</span><span class="p">,</span>  <span class="mf">0.0455</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0565</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0577</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1040</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2926</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0566</span><span class="p">,</span>  <span class="mf">0.1434</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0981</span><span class="p">,</span>  <span class="mf">0.0994</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.2424</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0703</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2983</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1131</span><span class="p">,</span>  <span class="mf">0.0414</span><span class="p">,</span>  <span class="mf">0.0626</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1343</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0850</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0303</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3479</span><span class="p">,</span>  <span class="mf">0.0232</span><span class="p">,</span>  <span class="mf">0.0060</span><span class="p">,</span>  <span class="mf">0.1012</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0547</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0957</span><span class="p">,</span>  <span class="mf">0.0415</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2859</span><span class="p">,</span>  <span class="mf">0.0283</span><span class="p">,</span>  <span class="mf">0.0461</span><span class="p">,</span>  <span class="mf">0.1068</span><span class="p">,</span>  <span class="mf">0.0021</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.2566</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0221</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2082</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0598</span><span class="p">,</span>  <span class="mf">0.0825</span><span class="p">,</span>  <span class="mf">0.0285</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0457</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.1834</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0572</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0972</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1029</span><span class="p">,</span>  <span class="mf">0.0231</span><span class="p">,</span>  <span class="mf">0.1828</span><span class="p">,</span>  <span class="mf">0.1633</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0953</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0014</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3061</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0989</span><span class="p">,</span>  <span class="mf">0.1491</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0141</span><span class="p">,</span>  <span class="mf">0.1136</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.1600</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1590</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1616</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0491</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0867</span><span class="p">,</span>  <span class="mf">0.2221</span><span class="p">,</span>  <span class="mf">0.1389</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.1568</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1283</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1512</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0741</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1765</span><span class="p">,</span>  <span class="mf">0.1608</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0215</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.3159</span><span class="p">,</span>  <span class="mf">0.0051</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1963</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0410</span><span class="p">,</span>  <span class="mf">0.0183</span><span class="p">,</span>  <span class="mf">0.1283</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1136</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.2849</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0378</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0996</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0392</span><span class="p">,</span>  <span class="mf">0.0231</span><span class="p">,</span>  <span class="mf">0.2533</span><span class="p">,</span>  <span class="mf">0.0109</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.2216</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0392</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0893</span><span class="p">,</span>  <span class="mf">0.1504</span><span class="p">,</span>  <span class="mf">0.0441</span><span class="p">,</span>  <span class="mf">0.2549</span><span class="p">,</span>  <span class="mf">0.0670</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0345</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1584</span><span class="p">,</span>  <span class="mf">0.0173</span><span class="p">,</span>  <span class="mf">0.1099</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0570</span><span class="p">,</span>  <span class="mf">0.2982</span><span class="p">,</span>  <span class="mf">0.0662</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0833</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2845</span><span class="p">,</span>  <span class="mf">0.0057</span><span class="p">,</span>  <span class="mf">0.0437</span><span class="p">,</span>  <span class="mf">0.0045</span><span class="p">,</span>  <span class="mf">0.1029</span><span class="p">,</span>  <span class="mf">0.1027</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0424</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0029</span><span class="p">,</span>  <span class="mf">0.0322</span><span class="p">,</span>  <span class="mf">0.0061</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1806</span><span class="p">,</span>  <span class="mf">0.0729</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0696</span><span class="p">]],</span>
       <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">AddmmBackward</span><span class="o">&gt;</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">35</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="o">******</span>
</code></pre></div>

<hr>
<ul>
<li>第五步: 计算前向传播分值的函数</li>
</ul>
<div class="highlight"><pre id="__code_29"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_29 pre, #__code_29 code"><span class="md-clipboard__message"></span></button><code><span class="k">def</span> <span class="nf">_forward_alg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feats</span><span class="p">):</span>
    <span class="c1"># 唯一的输入参数feats, 代表经过BiLSTM网络处理后的发射矩阵张量</span>
    <span class="c1"># 初始化(1, tagset_size)的二维张量, 全部赋值为-10000</span>
    <span class="n">init_alphas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagset_size</span><span class="p">),</span> <span class="o">-</span><span class="mf">10000.</span><span class="p">)</span>
    <span class="c1"># 只把起始标签START_TAG位置赋值为0, 意思就是只能从起始标签开始进行合法的转移</span>
    <span class="n">init_alphas</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">START_TAG</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># 初始化前向传播张量, 并赋值为上面的初始张量, 也要求最初合法的转移从起始标签START_TAG开始</span>
    <span class="n">forward_var</span> <span class="o">=</span> <span class="n">init_alphas</span>

    <span class="c1"># 遍历样本句子中的每一个字符</span>
    <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feats</span><span class="p">:</span>
        <span class="c1"># 初始化空列表, 存储当前时间步的前向传播张量</span>
        <span class="n">alphas_t</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 遍历所有可能的标签类型, 本项目中是7种可能的标签</span>
        <span class="k">for</span> <span class="n">next_tag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagset_size</span><span class="p">):</span>
            <span class="c1"># 初始化发射分数的张量, 无论前一个标签是什么, 经过广播变量后的每一个分量值都相同</span>
            <span class="n">emit_score</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="n">next_tag</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagset_size</span><span class="p">)</span>
            <span class="c1"># 第i个输入的转移分数代表第i个字符转移到next_tag标签的转移分数</span>
            <span class="n">trans_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">next_tag</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># 前向传播张量 + 转移矩阵分数 + 发射矩阵分数, 表示第i个字符转移到next_tag标签的总分值</span>
            <span class="n">next_tag_var</span> <span class="o">=</span> <span class="n">forward_var</span> <span class="o">+</span> <span class="n">trans_score</span> <span class="o">+</span> <span class="n">emit_score</span>
            <span class="c1"># 经历log_sum_exp计算后的数值添加进每一个时间步的存储列表中</span>
            <span class="n">alphas_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_sum_exp</span><span class="p">(</span><span class="n">next_tag_var</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># 将前向传播张量变形成1行后, 赋值给forward_var, 等待下一个时间步的计算</span>
        <span class="n">forward_var</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">alphas_t</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># 所有时间步for循环结束后, 代表整个句子完成了遍历, 再加上结束标签的转移分数即可</span>
    <span class="n">terminal_var</span> <span class="o">=</span> <span class="n">forward_var</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">STOP_TAG</span><span class="p">]]</span>
    <span class="c1"># 同理, 对张量计算log_sum_exp的数值</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">log_sum_exp</span><span class="p">(</span><span class="n">terminal_var</span><span class="p">)</span>
    <span class="c1"># 最后返回整个样本句子的前向传播分数</span>
    <span class="k">return</span> <span class="n">alpha</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/bilstm_crf.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_30"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_30 pre, #__code_30 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 首先设置若干超参数</span>
<span class="n">START_TAG</span> <span class="o">=</span> <span class="s2">"&lt;START&gt;"</span>
<span class="n">STOP_TAG</span> <span class="o">=</span> <span class="s2">"&lt;STOP&gt;"</span>
<span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">HIDDEN_DIM</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># 初始化标签字典</span>
<span class="n">tag_to_ix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"O"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">START_TAG</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">STOP_TAG</span><span class="p">:</span><span class="mi">6</span><span class="p">}</span>

<span class="c1"># 输入样本数据</span>
<span class="n">sentence_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">([</span><span class="s2">"女"</span><span class="p">,</span> <span class="s2">"性"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"岁"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"农"</span><span class="p">,</span> <span class="s2">"民"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"双"</span><span class="p">,</span> <span class="s2">"滦"</span><span class="p">,</span> <span class="s2">"区"</span><span class="p">,</span> <span class="s2">"应"</span><span class="p">,</span> <span class="s2">"营"</span><span class="p">,</span> <span class="s2">"子"</span><span class="p">,</span> <span class="s2">"村"</span><span class="p">,</span> <span class="s2">"人"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"主"</span><span class="p">,</span> <span class="s2">"因"</span><span class="p">,</span> <span class="s2">"右"</span><span class="p">,</span> <span class="s2">"髋"</span><span class="p">,</span> <span class="s2">"部"</span><span class="p">,</span> <span class="s2">"摔"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"肿"</span><span class="p">,</span> <span class="s2">"胀"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"活"</span><span class="p">,</span> <span class="s2">"动"</span><span class="p">,</span> <span class="s2">"受"</span><span class="p">,</span> <span class="s2">"限"</span><span class="p">,</span> <span class="s2">"5"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"9"</span><span class="p">,</span> <span class="s2">"；"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"："</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]</span>
<span class="p">),</span>
    <span class="p">([</span><span class="s2">"处"</span><span class="p">,</span> <span class="s2">"外"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"伴"</span><span class="p">,</span> <span class="s2">"有"</span><span class="p">,</span> <span class="s2">"头"</span><span class="p">,</span> <span class="s2">"晕"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"收"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]</span>
<span class="p">)]</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_31"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_31 pre, #__code_31 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 函数sentence_map完成中文文本信息的数字编码, 变成张量</span>
<span class="k">def</span> <span class="nf">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">):</span>
    <span class="c1"># 初始化数字映射字典</span>
    <span class="n">word_to_ix</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word_to_ix</span><span class="p">:</span>
                <span class="n">word_to_ix</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_to_ix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">word_to_ix</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="c1"># 获取所有字符的映射字典</span>
    <span class="n">word_to_ix</span> <span class="o">=</span> <span class="n">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">)</span>
    <span class="c1"># 创建类对象</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTM_CRF</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">word_to_ix</span><span class="p">),</span> <span class="n">tag_to_ix</span><span class="o">=</span><span class="n">tag_to_ix</span><span class="p">,</span>
                       <span class="n">embedding_dim</span><span class="o">=</span><span class="n">EMBEDDING_DIM</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">HIDDEN_DIM</span><span class="p">)</span>

    <span class="c1"># 遍历样本数据</span>
    <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="c1"># 完成自然语言文本到数字化张量的映射</span>
        <span class="n">sentence_in</span> <span class="o">=</span> <span class="n">prepare_sequence</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">word_to_ix</span><span class="p">)</span>
        <span class="c1"># 调用类内函数完成发射矩阵张量的计算</span>
        <span class="n">feat_out</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_lstm_features</span><span class="p">(</span><span class="n">sentence_in</span><span class="p">)</span>
        <span class="n">forward_score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_forward_alg</span><span class="p">(</span><span class="n">feat_out</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">forward_score</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_32"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_32 pre, #__code_32 code"><span class="md-clipboard__message"></span></button><code>tensor(136.8093, grad_fn=&lt;AddBackward0&gt;)
tensor(81.3415, grad_fn=&lt;AddBackward0&gt;)
</code></pre></div>

<hr>
<ul>
<li>第六步: 计算句子真实分值的函数</li>
</ul>
<div class="highlight"><pre id="__code_33"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_33 pre, #__code_33 code"><span class="md-clipboard__message"></span></button><code><span class="k">def</span> <span class="nf">_score_sentence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feats</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
    <span class="c1"># feats: 代表经过BiLSTM网络处理后的发射矩阵张量</span>
    <span class="c1"># tags: 代表真实的标签序列</span>
    <span class="c1"># 初始化分数为0</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># 模拟NLP的处理流程, 将起始标签START_TAG添加到真实标签序列的最前面</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">START_TAG</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span> <span class="n">tags</span><span class="p">])</span>

    <span class="c1"># 遍历发射矩阵张量的每一个时间步, 累加分数    </span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feats</span><span class="p">):</span>
        <span class="c1"># 每个时间步进行分数的累加, 加的是从第i时间步的标签转移到第i+1时间步的标签分数, 再加上第i+1时间步的发射分数</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">score</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">tags</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+</span> <span class="n">feat</span><span class="p">[</span><span class="n">tags</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="c1"># for循环结束后, 代表整个样本句子所有的字符遍历完毕, 最后添加上转移到结束标签STOP_TAG的转移分数即可</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">STOP_TAG</span><span class="p">],</span> <span class="n">tags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="c1"># 最后返回带标签的真实句子分数</span>
    <span class="k">return</span> <span class="n">score</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置/data/doctor_offline/ner_model/bilstm_crf.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_34"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_34 pre, #__code_34 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 首先设置若干超参数</span>
<span class="n">START_TAG</span> <span class="o">=</span> <span class="s2">"&lt;START&gt;"</span>
<span class="n">STOP_TAG</span> <span class="o">=</span> <span class="s2">"&lt;STOP&gt;"</span>
<span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">HIDDEN_DIM</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># 初始化标签字典</span>
<span class="n">tag_to_ix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"O"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">START_TAG</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">STOP_TAG</span><span class="p">:</span><span class="mi">6</span><span class="p">}</span>

<span class="c1"># 输入样本数据</span>
<span class="n">sentence_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">([</span><span class="s2">"女"</span><span class="p">,</span> <span class="s2">"性"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"岁"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"农"</span><span class="p">,</span> <span class="s2">"民"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"双"</span><span class="p">,</span> <span class="s2">"滦"</span><span class="p">,</span> <span class="s2">"区"</span><span class="p">,</span> <span class="s2">"应"</span><span class="p">,</span> <span class="s2">"营"</span><span class="p">,</span> <span class="s2">"子"</span><span class="p">,</span> <span class="s2">"村"</span><span class="p">,</span> <span class="s2">"人"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"主"</span><span class="p">,</span> <span class="s2">"因"</span><span class="p">,</span> <span class="s2">"右"</span><span class="p">,</span> <span class="s2">"髋"</span><span class="p">,</span> <span class="s2">"部"</span><span class="p">,</span> <span class="s2">"摔"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"肿"</span><span class="p">,</span> <span class="s2">"胀"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"活"</span><span class="p">,</span> <span class="s2">"动"</span><span class="p">,</span> <span class="s2">"受"</span><span class="p">,</span> <span class="s2">"限"</span><span class="p">,</span> <span class="s2">"5"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"9"</span><span class="p">,</span> <span class="s2">"；"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"："</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]</span>
<span class="p">),</span>
    <span class="p">([</span><span class="s2">"处"</span><span class="p">,</span> <span class="s2">"外"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"伴"</span><span class="p">,</span> <span class="s2">"有"</span><span class="p">,</span> <span class="s2">"头"</span><span class="p">,</span> <span class="s2">"晕"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"收"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]</span>
<span class="p">)]</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_35"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_35 pre, #__code_35 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 函数sentence_map完成中文文本信息的数字编码, 变成张量</span>
<span class="k">def</span> <span class="nf">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">):</span>
    <span class="c1"># 初始化数字映射字典</span>
    <span class="n">word_to_ix</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word_to_ix</span><span class="p">:</span>
                <span class="n">word_to_ix</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_to_ix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">word_to_ix</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="c1"># 获取所有字符的映射字典</span>
    <span class="n">word_to_ix</span> <span class="o">=</span> <span class="n">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">)</span>
    <span class="c1"># 创建类对象</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTM_CRF</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">word_to_ix</span><span class="p">),</span> <span class="n">tag_to_ix</span><span class="o">=</span><span class="n">tag_to_ix</span><span class="p">,</span>
                       <span class="n">embedding_dim</span><span class="o">=</span><span class="n">EMBEDDING_DIM</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">HIDDEN_DIM</span><span class="p">)</span>

    <span class="c1"># 遍历样本数据</span>
    <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="c1"># 完成自然语言文本到数字化张量的映射</span>
        <span class="n">sentence_in</span> <span class="o">=</span> <span class="n">prepare_sequence</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">word_to_ix</span><span class="p">)</span>
        <span class="c1"># 调用类内函数完成发射矩阵张量的计算</span>
        <span class="n">feat_out</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_lstm_features</span><span class="p">(</span><span class="n">sentence_in</span><span class="p">)</span>
        <span class="n">forward_score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_forward_alg</span><span class="p">(</span><span class="n">feat_out</span><span class="p">)</span>
        <span class="c1"># 将tags标签进行数字化映射, 然后封装成torch.long型的Tensor张量</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="c1"># 计算真实句子分数</span>
        <span class="n">gold_score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_score_sentence</span><span class="p">(</span><span class="n">feat_out</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">gold_score</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_36"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_36 pre, #__code_36 code"><span class="md-clipboard__message"></span></button><code>tensor([-11.6082], grad_fn=&lt;AddBackward0&gt;)
tensor([-10.6687], grad_fn=&lt;AddBackward0&gt;)
</code></pre></div>

<hr>
<ul>
<li>第七步: 维特比算法的实现</li>
</ul>
<div class="highlight"><pre id="__code_37"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_37 pre, #__code_37 code"><span class="md-clipboard__message"></span></button><code><span class="k">def</span> <span class="nf">_viterbi_decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feats</span><span class="p">):</span>
    <span class="c1"># feats: 传入的唯一参数是经过BiLSTM网络后得到的发射矩阵张量</span>
    <span class="c1"># 初始化回溯指针列表, 里面存放着每一个时间步的解析标签结果</span>
    <span class="n">backpointers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 初始化变量为1行7列的张量, 并赋值全部为-10000</span>
    <span class="n">init_vvars</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagset_size</span><span class="p">),</span> <span class="o">-</span><span class="mf">10000.</span><span class="p">)</span>
    <span class="c1"># 只将起始标签位置设置为0, 意思是所有合法的序列都从START_TAG开始</span>
    <span class="n">init_vvars</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">START_TAG</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># 初始化前向传播张量, 第i个时间步的forward_var中存放的是第i-1个时间步的维特比变量</span>
    <span class="n">forward_var</span> <span class="o">=</span> <span class="n">init_vvars</span>
    <span class="c1"># 遍历样本语句中的每一个时间步, 也就是遍历序列中的每一个字符</span>
    <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feats</span><span class="p">:</span>
        <span class="c1"># 初始化当前时间步的回溯指针</span>
        <span class="n">bptrs_t</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 初始化当前时间步的维特比变量</span>
        <span class="n">viterbivars_t</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 遍历当前时间步下, 所有的可能标签, 本项目中有7种可能的标签</span>
        <span class="k">for</span> <span class="n">next_tag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagset_size</span><span class="p">):</span>
            <span class="c1"># 将上一个时间步标签i对应的维特比变量, 加上从标签i转移到标签next_tag的转移分数, 作为next_tag_var</span>
            <span class="c1"># 这里没有加发射矩阵的分数, 是因为发射分数经过广播变量后值都相同, 不影响后面求最大值的操作, 因此不加了</span>
            <span class="n">next_tag_var</span> <span class="o">=</span> <span class="n">forward_var</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">next_tag</span><span class="p">]</span>
            <span class="c1"># 采用贪心算法, 将最大值作为解析结果</span>
            <span class="n">best_tag_id</span> <span class="o">=</span> <span class="n">argmax</span><span class="p">(</span><span class="n">next_tag_var</span><span class="p">)</span>
            <span class="c1"># 将最优解析结果追加存入当前时间步的回溯指针列表中</span>
            <span class="n">bptrs_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_tag_id</span><span class="p">)</span>
            <span class="c1"># 将维特比变量值存入当前时间步的列表中</span>
            <span class="n">viterbivars_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_tag_var</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">best_tag_id</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># 内层for循环结束后, 再加上发射矩阵张量, 作为更新后的前向传播张量, 准备下一个时间步的解析</span>
        <span class="n">forward_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">viterbivars_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">feat</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 将当前时间步的解析指针追加存入总的回溯指针列表中</span>
        <span class="n">backpointers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bptrs_t</span><span class="p">)</span>

    <span class="c1"># 外层for循环结束后, 说明已经遍历了整个序列, 在最后追加上转移到结束标签的转移分数即可</span>
    <span class="n">terminal_var</span> <span class="o">=</span> <span class="n">forward_var</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">STOP_TAG</span><span class="p">]]</span>
    <span class="c1"># 求最大值作为最后一步的tag</span>
    <span class="n">best_tag_id</span> <span class="o">=</span> <span class="n">argmax</span><span class="p">(</span><span class="n">terminal_var</span><span class="p">)</span>
    <span class="c1"># 采用最佳tag对应的分数值作为整个路径解析的分数值</span>
    <span class="n">path_score</span> <span class="o">=</span> <span class="n">terminal_var</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">best_tag_id</span><span class="p">]</span>

    <span class="c1"># 遍历回溯指针列表, 依次解析出最佳路径标签</span>
    <span class="c1"># 最后一步的标签首先进入结果列表中</span>
    <span class="n">best_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">best_tag_id</span><span class="p">]</span>
    <span class="c1"># 逆向遍历回溯指针列表</span>
    <span class="k">for</span> <span class="n">bptrs_t</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">backpointers</span><span class="p">):</span>
        <span class="c1"># 每次拿出一个最佳标签, 并用这个最佳标签作为下一步解析的索引</span>
        <span class="n">best_tag_id</span> <span class="o">=</span> <span class="n">bptrs_t</span><span class="p">[</span><span class="n">best_tag_id</span><span class="p">]</span>
        <span class="c1"># 依次将每一步解析出来的最佳标签追加进结果列表中</span>
        <span class="n">best_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_tag_id</span><span class="p">)</span>
    <span class="c1"># 解析的最后一步对应的一定是开始标签START_TAG, 这里删除掉, 因为START_TAG并不是真实的标签序列, 只是人为添加的为程序代码服务的标签</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">best_path</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="c1"># 确认一下这个标签是开始标签, 属于一个正确性检测代码</span>
    <span class="k">assert</span> <span class="n">start</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">START_TAG</span><span class="p">]</span>
    <span class="c1"># 因为是从后向前追加进的结果列表, 所以逆序排列后的结果就是从前向后的真实语序解析结果</span>
    <span class="n">best_path</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="c1"># 返回解析的语句得分, 还有解析得到的最佳路径</span>
    <span class="k">return</span> <span class="n">path_score</span><span class="p">,</span> <span class="n">best_path</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/bilstm_crf.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_38"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_38 pre, #__code_38 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 首先设置若干超参数</span>
<span class="n">START_TAG</span> <span class="o">=</span> <span class="s2">"&lt;START&gt;"</span>
<span class="n">STOP_TAG</span> <span class="o">=</span> <span class="s2">"&lt;STOP&gt;"</span>
<span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">HIDDEN_DIM</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># 初始化标签字典</span>
<span class="n">tag_to_ix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"O"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">START_TAG</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">STOP_TAG</span><span class="p">:</span><span class="mi">6</span><span class="p">}</span>

<span class="c1"># 输入样本数据</span>
<span class="n">sentence_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">([</span><span class="s2">"女"</span><span class="p">,</span> <span class="s2">"性"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"岁"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"农"</span><span class="p">,</span> <span class="s2">"民"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"双"</span><span class="p">,</span> <span class="s2">"滦"</span><span class="p">,</span> <span class="s2">"区"</span><span class="p">,</span> <span class="s2">"应"</span><span class="p">,</span> <span class="s2">"营"</span><span class="p">,</span> <span class="s2">"子"</span><span class="p">,</span> <span class="s2">"村"</span><span class="p">,</span> <span class="s2">"人"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"主"</span><span class="p">,</span> <span class="s2">"因"</span><span class="p">,</span> <span class="s2">"右"</span><span class="p">,</span> <span class="s2">"髋"</span><span class="p">,</span> <span class="s2">"部"</span><span class="p">,</span> <span class="s2">"摔"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"肿"</span><span class="p">,</span> <span class="s2">"胀"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"活"</span><span class="p">,</span> <span class="s2">"动"</span><span class="p">,</span> <span class="s2">"受"</span><span class="p">,</span> <span class="s2">"限"</span><span class="p">,</span> <span class="s2">"5"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"9"</span><span class="p">,</span> <span class="s2">"；"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"："</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]</span>
<span class="p">),</span>
    <span class="p">([</span><span class="s2">"处"</span><span class="p">,</span> <span class="s2">"外"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"伴"</span><span class="p">,</span> <span class="s2">"有"</span><span class="p">,</span> <span class="s2">"头"</span><span class="p">,</span> <span class="s2">"晕"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"收"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]</span>
<span class="p">)]</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_39"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_39 pre, #__code_39 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 函数sentence_map完成中文文本信息的数字编码, 变成张量</span>
<span class="k">def</span> <span class="nf">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">):</span>
    <span class="c1"># 初始化数字映射字典</span>
    <span class="n">word_to_ix</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word_to_ix</span><span class="p">:</span>
                <span class="n">word_to_ix</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_to_ix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">word_to_ix</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="c1"># 获取所有字符的映射字典</span>
    <span class="n">word_to_ix</span> <span class="o">=</span> <span class="n">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">)</span>
    <span class="c1"># 创建类对象</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTM_CRF</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">word_to_ix</span><span class="p">),</span> <span class="n">tag_to_ix</span><span class="o">=</span><span class="n">tag_to_ix</span><span class="p">,</span>
                       <span class="n">embedding_dim</span><span class="o">=</span><span class="n">EMBEDDING_DIM</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">HIDDEN_DIM</span><span class="p">)</span>

    <span class="c1"># 遍历样本数据</span>
    <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="c1"># 完成自然语言文本到数字化张量的映射</span>
        <span class="n">sentence_in</span> <span class="o">=</span> <span class="n">prepare_sequence</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">word_to_ix</span><span class="p">)</span>
        <span class="c1"># 调用类内函数完成发射矩阵张量的计算</span>
        <span class="n">feat_out</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_lstm_features</span><span class="p">(</span><span class="n">sentence_in</span><span class="p">)</span>
        <span class="n">forward_score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_forward_alg</span><span class="p">(</span><span class="n">feat_out</span><span class="p">)</span>
        <span class="c1"># 将tags标签进行数字化映射, 然后封装成torch.long型的Tensor张量</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
        <span class="c1"># 计算真实句子分数</span>
        <span class="n">gold_score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_score_sentence</span><span class="p">(</span><span class="n">feat_out</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="c1"># 利用维特比算法解析最佳路径</span>
        <span class="n">score</span><span class="p">,</span> <span class="n">tag_seq</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_viterbi_decode</span><span class="p">(</span><span class="n">feat_out</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">tag_seq</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'******'</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_40"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_40 pre, #__code_40 code"><span class="md-clipboard__message"></span></button><code><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">tensor</span><span class="p">(</span><span class="mf">100.9586</span><span class="p">,</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">SelectBackward</span><span class="o">&gt;</span><span class="p">)</span>
<span class="o">******</span>
<span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">tensor</span><span class="p">(</span><span class="mf">61.5116</span><span class="p">,</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">SelectBackward</span><span class="o">&gt;</span><span class="p">)</span>
<span class="o">******</span>
</code></pre></div>

<hr>
<ul>
<li>第八步: 完善BiLSTM_CRF类的全部功能</li>
</ul>
<div class="highlight"><pre id="__code_41"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_41 pre, #__code_41 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 添加一个计算损失loss的函数</span>
<span class="k">def</span> <span class="nf">neg_log_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
    <span class="c1"># 从BiLSTM网络中得到发射矩阵张量</span>
    <span class="n">feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lstm_features</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
    <span class="c1"># 调用手写的训练阶段前向传播函数, 得到前向传播的预测分数值</span>
    <span class="n">forward_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_alg</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
    <span class="c1"># 调用手写的训练阶段句子分值计算函数, 计算真实的句子分数值, 里面有真实的标签序列</span>
    <span class="n">gold_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_sentence</span><span class="p">(</span><span class="n">feats</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
    <span class="c1"># 预测分数 - 真实分数, 这个差值就是损失值loss    </span>
    <span class="k">return</span> <span class="n">forward_score</span> <span class="o">-</span> <span class="n">gold_score</span>


<span class="c1"># 添加前向传播函数, 这里面的forward函数不在训练阶段使用, 反倒是在预测阶段才使用</span>
<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sentence</span><span class="p">):</span>
    <span class="c1"># 从BiLSTM网络中得到发射矩阵张量</span>
    <span class="n">lstm_feats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lstm_features</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>

    <span class="c1"># 利用发射矩阵张量, 通过维特比算法直接解码得到最佳路径</span>
    <span class="n">score</span><span class="p">,</span> <span class="n">tag_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viterbi_decode</span><span class="p">(</span><span class="n">lstm_feats</span><span class="p">)</span>
    <span class="c1"># 返回句子分数值, 和最佳解析标签路径</span>
    <span class="k">return</span> <span class="n">score</span><span class="p">,</span> <span class="n">tag_seq</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/bilstm_crf.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_42"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_42 pre, #__code_42 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 首先设置若干超参数</span>
<span class="n">START_TAG</span> <span class="o">=</span> <span class="s2">"&lt;START&gt;"</span>
<span class="n">STOP_TAG</span> <span class="o">=</span> <span class="s2">"&lt;STOP&gt;"</span>
<span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">HIDDEN_DIM</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># 初始化标签字典</span>
<span class="n">tag_to_ix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"O"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">START_TAG</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">STOP_TAG</span><span class="p">:</span><span class="mi">6</span><span class="p">}</span>

<span class="c1"># 输入样本数据</span>
<span class="n">sentence_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">([</span><span class="s2">"女"</span><span class="p">,</span> <span class="s2">"性"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"岁"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"农"</span><span class="p">,</span> <span class="s2">"民"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"双"</span><span class="p">,</span> <span class="s2">"滦"</span><span class="p">,</span> <span class="s2">"区"</span><span class="p">,</span> <span class="s2">"应"</span><span class="p">,</span> <span class="s2">"营"</span><span class="p">,</span> <span class="s2">"子"</span><span class="p">,</span> <span class="s2">"村"</span><span class="p">,</span> <span class="s2">"人"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"主"</span><span class="p">,</span> <span class="s2">"因"</span><span class="p">,</span> <span class="s2">"右"</span><span class="p">,</span> <span class="s2">"髋"</span><span class="p">,</span> <span class="s2">"部"</span><span class="p">,</span> <span class="s2">"摔"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"肿"</span><span class="p">,</span> <span class="s2">"胀"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"活"</span><span class="p">,</span> <span class="s2">"动"</span><span class="p">,</span> <span class="s2">"受"</span><span class="p">,</span> <span class="s2">"限"</span><span class="p">,</span> <span class="s2">"5"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"9"</span><span class="p">,</span> <span class="s2">"；"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"："</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]</span>
<span class="p">),</span>
    <span class="p">([</span><span class="s2">"处"</span><span class="p">,</span> <span class="s2">"外"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"伴"</span><span class="p">,</span> <span class="s2">"有"</span><span class="p">,</span> <span class="s2">"头"</span><span class="p">,</span> <span class="s2">"晕"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"收"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]</span>
<span class="p">)]</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_43"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_43 pre, #__code_43 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 函数sentence_map完成中文文本信息的数字编码, 变成张量</span>
<span class="k">def</span> <span class="nf">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">):</span>
    <span class="c1"># 初始化数字映射字典</span>
    <span class="n">word_to_ix</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word_to_ix</span><span class="p">:</span>
                <span class="n">word_to_ix</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_to_ix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">word_to_ix</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="c1"># 获取所有字符的映射字典</span>
    <span class="n">word_to_ix</span> <span class="o">=</span> <span class="n">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">)</span>
    <span class="c1"># 创建类对象</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTM_CRF</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">word_to_ix</span><span class="p">),</span> <span class="n">tag_to_ix</span><span class="o">=</span><span class="n">tag_to_ix</span><span class="p">,</span>
                       <span class="n">embedding_dim</span><span class="o">=</span><span class="n">EMBEDDING_DIM</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">HIDDEN_DIM</span><span class="p">)</span>

    <span class="c1"># 遍历样本数据</span>
    <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="c1"># 完成自然语言文本到数字化张量的映射</span>
        <span class="n">sentence_in</span> <span class="o">=</span> <span class="n">prepare_sequence</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">word_to_ix</span><span class="p">)</span>
        <span class="c1"># 调用类内函数完成发射矩阵张量的计算</span>
        <span class="n">feat_out</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_lstm_features</span><span class="p">(</span><span class="n">sentence_in</span><span class="p">)</span>
        <span class="c1"># 将tags标签进行数字化映射, 然后封装成torch.long型的Tensor张量</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>

        <span class="c1"># 直接调用损失值计算函数, 计算loss值</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">neg_log_likelihood</span><span class="p">(</span><span class="n">sentence_in</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'loss='</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>

        <span class="c1"># 进入预测阶段, 调用模型默认的forward()函数</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="c1"># 模型默认的函数就是预测阶段的维特比解码函数</span>
            <span class="n">score</span><span class="p">,</span> <span class="n">tag_seq</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">sentence_in</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">tag_seq</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'******'</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_44"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_44 pre, #__code_44 code"><span class="md-clipboard__message"></span></button><code><span class="n">loss</span><span class="o">=</span> <span class="n">tensor</span><span class="p">([</span><span class="mf">148.3674</span><span class="p">],</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">SubBackward0</span><span class="o">&gt;</span><span class="p">)</span>
<span class="n">tensor</span><span class="p">(</span><span class="mf">101.2418</span><span class="p">)</span>
<span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="o">******</span>
<span class="n">loss</span><span class="o">=</span> <span class="n">tensor</span><span class="p">([</span><span class="mf">92.3998</span><span class="p">],</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">SubBackward0</span><span class="o">&gt;</span><span class="p">)</span>
<span class="n">tensor</span><span class="p">(</span><span class="mf">61.5078</span><span class="p">)</span>
<span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="o">******</span>
</code></pre></div>

<hr>
<hr>
<h2 id="65">6.5 模型训练<a class="headerlink" href="#65" title="Permanent link">¶</a></h2>
<ul>
<li>学习目标:<ul>
<li>掌握数据的预处理流程</li>
<li>掌握NER任务准确率和召回率计算的方法</li>
<li>掌握模型训练代码</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>模型训练的流程<ul>
<li>第一步: 熟悉字符到数字编码的码表</li>
<li>第二步: 熟悉训练数据集的样式和含义解释</li>
<li>第三步: 完成字符到id的映射函数</li>
<li>第四步: 获取训练数据和验证数据的函数</li>
<li>第五步: 完成准确率和召回率的评估代码</li>
<li>第六步: 绘制损失曲线和评估曲线图</li>
<li>第七步: 完成训练模型的完整代码</li>
<li>第八步: 训练集和验证集损失曲线和指标数据曲线的分析</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>第一步: 熟悉字符到数字编码的码表.</li>
</ul>
<div class="highlight"><pre id="__code_45"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_45 pre, #__code_45 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 代表了数据集中所有字符到数字编码的字典映射</span>
<span class="c1"># 码表可以包含中文简体、繁体、英文大小写字母、数字、中英文标点符号等等</span>
<span class="c1"># &lt;PAD&gt;为填充标识, 训练时需要将句子转化成矩阵, 而句子长短不一, 需要做padding处理</span>

<span class="p">{</span>
    <span class="s2">"&lt;PAD&gt;"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">"厑"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"吖"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">"呵"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">"啊"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">"嗄"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">"嬶"</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<ul>
<li>码表所在位置: /data/doctor_offline/ner_model/data/char_to_id.json</li>
</ul>
<hr>
<ul>
<li>第二步: 熟悉训练数据集的样式和含义解释.</li>
</ul>
<div class="highlight"><pre id="__code_46"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_46 pre, #__code_46 code"><span class="md-clipboard__message"></span></button><code><span class="p">{</span><span class="s2">"text"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"女"</span><span class="p">,</span> <span class="s2">"性"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"岁"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"农"</span><span class="p">,</span> <span class="s2">"民"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"双"</span><span class="p">,</span> <span class="s2">"滦"</span><span class="p">,</span> <span class="s2">"区"</span><span class="p">,</span> <span class="s2">"应"</span><span class="p">,</span> <span class="s2">"营"</span><span class="p">,</span> <span class="s2">"子"</span><span class="p">,</span> <span class="s2">"村"</span><span class="p">,</span> <span class="s2">"人"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"主"</span><span class="p">,</span> <span class="s2">"因"</span><span class="p">,</span> <span class="s2">"右"</span><span class="p">,</span> <span class="s2">"髋"</span><span class="p">,</span> <span class="s2">"部"</span><span class="p">,</span> <span class="s2">"摔"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"肿"</span><span class="p">,</span> <span class="s2">"胀"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"活"</span><span class="p">,</span> <span class="s2">"动"</span><span class="p">,</span> <span class="s2">"受"</span><span class="p">,</span> <span class="s2">"&gt;限"</span><span class="p">,</span> <span class="s2">"5"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"9"</span><span class="p">,</span> <span class="s2">"；"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"："</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="s2">"label"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]}</span>
<span class="p">{</span><span class="s2">"text"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"腰"</span><span class="p">,</span> <span class="s2">"部"</span><span class="p">,</span> <span class="s2">"外"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"9"</span><span class="p">,</span> <span class="s2">"收"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="s2">"label"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]}</span>
<span class="p">{</span><span class="s2">"text"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"处"</span><span class="p">,</span> <span class="s2">"外"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"伴"</span><span class="p">,</span> <span class="s2">"有"</span><span class="p">,</span> <span class="s2">"头"</span><span class="p">,</span> <span class="s2">"晕"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"收"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="s2">"label"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]}</span>
<span class="p">{</span><span class="s2">"text"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"、"</span><span class="p">,</span> <span class="s2">"头"</span><span class="p">,</span> <span class="s2">"晕"</span><span class="p">,</span> <span class="s2">"3"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"分"</span><span class="p">,</span> <span class="s2">"钟"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="s2">"label"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]}</span>
<span class="p">{</span><span class="s2">"text"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"侧"</span><span class="p">,</span> <span class="s2">"腹"</span><span class="p">,</span> <span class="s2">"部"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"天"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"7"</span><span class="p">,</span> <span class="s2">"收"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="s2">"label"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]}</span>
</code></pre></div>

<hr>
<ul>
<li>训练数据集的含义解释:<ul>
<li>每一行都是一个json数据, 包含两部分text和label, 具体的值以列表形式展现.</li>
<li>每一行一个样本, 以\n分隔不同的行样本.</li>
<li>标签说明:<ul>
<li>B-dis: 疾病实体名词起始标识</li>
<li>I-dis: 疾病实体名词中间到结尾标识</li>
<li>B-sym: 症状实体名词起始标识</li>
<li>I-sym: 症状实体名词中间到结尾标识</li>
<li>O:     其他非实体部分标识</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>数据集所在位置: /data/doctor_offline/ner_model/data/train_data.txt</li>
</ul>
<hr>
<ul>
<li>第三步: 完成字符到id的映射函数</li>
</ul>
<div class="highlight"><pre id="__code_47"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_47 pre, #__code_47 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 构建文本到id的映射函数</span>
<span class="k">def</span> <span class="nf">prepare_sequence</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">char_to_id</span><span class="p">):</span>
    <span class="c1"># 初始化空列表</span>
    <span class="n">char_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
        <span class="c1"># 判断若字符不在码表对应字典中，则取 NUK 的编码（即 unknown），否则取对应的字符编&gt;码</span>
        <span class="k">if</span> <span class="n">char_to_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">char</span><span class="p">):</span>
            <span class="n">char_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_to_id</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">char_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_to_id</span><span class="p">[</span><span class="s2">"UNK"</span><span class="p">])</span>
    <span class="c1"># 将列表封装成Tensor类型返回</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">char_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/train.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_48"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_48 pre, #__code_48 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 字符码表文件路径</span>
<span class="n">json_file</span> <span class="o">=</span> <span class="s1">'./data/char_to_id.json'</span>

<span class="c1"># 示例样本数据</span>
<span class="n">train_data_list</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">"text"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"女"</span><span class="p">,</span> <span class="s2">"性"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"8"</span><span class="p">,</span> <span class="s2">"岁"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"农"</span><span class="p">,</span> <span class="s2">"民"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"双"</span><span class="p">,</span> <span class="s2">"滦"</span><span class="p">,</span> <span class="s2">"区"</span><span class="p">,</span> <span class="s2">"应"</span><span class="p">,</span> <span class="s2">"营"</span><span class="p">,</span> <span class="s2">"子"</span><span class="p">,</span> <span class="s2">"村"</span><span class="p">,</span> <span class="s2">"人"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"主"</span><span class="p">,</span> <span class="s2">"因"</span><span class="p">,</span> <span class="s2">"右"</span><span class="p">,</span> <span class="s2">"髋"</span><span class="p">,</span> <span class="s2">"部"</span><span class="p">,</span> <span class="s2">"摔"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"肿"</span><span class="p">,</span> <span class="s2">"胀"</span><span class="p">,</span> <span class="s2">"，"</span><span class="p">,</span> <span class="s2">"活"</span><span class="p">,</span> <span class="s2">"动"</span><span class="p">,</span> <span class="s2">"受"</span><span class="p">,</span> <span class="s2">"&gt;限"</span><span class="p">,</span> <span class="s2">"5"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"9"</span><span class="p">,</span> <span class="s2">"；"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"："</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="s2">"label"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]},</span>
<span class="p">{</span><span class="s2">"text"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"腰"</span><span class="p">,</span> <span class="s2">"部"</span><span class="p">,</span> <span class="s2">"外"</span><span class="p">,</span> <span class="s2">"伤"</span><span class="p">,</span> <span class="s2">"后"</span><span class="p">,</span> <span class="s2">"疼"</span><span class="p">,</span> <span class="s2">"痛"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"小"</span><span class="p">,</span> <span class="s2">"时"</span><span class="p">,</span> <span class="s2">"于"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"6"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"9"</span><span class="p">,</span> <span class="s2">"收"</span><span class="p">,</span> <span class="s2">"入"</span><span class="p">,</span> <span class="s2">"院"</span><span class="p">,</span> <span class="s2">"。"</span><span class="p">],</span> <span class="s2">"label"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">,</span> <span class="s2">"O"</span><span class="p">]}]</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_49"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_49 pre, #__code_49 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="kn">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="kn">as</span> <span class="nn">optim</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">char_to_id</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">'char_to_id.json'</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf8'</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">train_data_list</span><span class="p">:</span>
        <span class="n">text</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">),</span> <span class="n">line</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'label'</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">prepare_sequence</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">char_to_id</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'******'</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_50"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_50 pre, #__code_50 code"><span class="md-clipboard__message"></span></button><code><span class="n">tensor</span><span class="p">([</span><span class="mi">12192</span><span class="p">,</span> <span class="mi">17433</span><span class="p">,</span> <span class="mi">21253</span><span class="p">,</span> <span class="mi">22300</span><span class="p">,</span> <span class="mi">22300</span><span class="p">,</span> <span class="mi">15160</span><span class="p">,</span> <span class="mi">21253</span><span class="p">,</span> <span class="mi">12144</span><span class="p">,</span> <span class="mi">11529</span><span class="p">,</span> <span class="mi">21253</span><span class="p">,</span>
        <span class="mi">14850</span><span class="p">,</span> <span class="mi">10814</span><span class="p">,</span> <span class="mi">12244</span><span class="p">,</span> <span class="mi">18795</span><span class="p">,</span> <span class="mi">18860</span><span class="p">,</span> <span class="mi">20637</span><span class="p">,</span>  <span class="mi">2902</span><span class="p">,</span> <span class="mi">13734</span><span class="p">,</span> <span class="mi">21253</span><span class="p">,</span> <span class="mi">20378</span><span class="p">,</span>
        <span class="mi">18668</span><span class="p">,</span> <span class="mi">18979</span><span class="p">,</span>  <span class="mi">9195</span><span class="p">,</span>  <span class="mi">1287</span><span class="p">,</span> <span class="mi">14842</span><span class="p">,</span> <span class="mi">14271</span><span class="p">,</span>  <span class="mi">6371</span><span class="p">,</span> <span class="mi">15538</span><span class="p">,</span> <span class="mi">15807</span><span class="p">,</span> <span class="mi">20290</span><span class="p">,</span>
        <span class="mi">19837</span><span class="p">,</span> <span class="mi">21253</span><span class="p">,</span>  <span class="mi">5887</span><span class="p">,</span>  <span class="mi">3729</span><span class="p">,</span> <span class="mi">14693</span><span class="p">,</span> <span class="mi">22302</span><span class="p">,</span> <span class="mi">22297</span><span class="p">,</span> <span class="mi">17205</span><span class="p">,</span> <span class="mi">14573</span><span class="p">,</span> <span class="mi">17540</span><span class="p">,</span>
        <span class="mi">22294</span><span class="p">,</span> <span class="mi">22292</span><span class="p">,</span> <span class="mi">22293</span><span class="p">,</span> <span class="mi">22298</span><span class="p">,</span> <span class="mi">21312</span><span class="p">,</span> <span class="mi">22293</span><span class="p">,</span> <span class="mi">22292</span><span class="p">,</span> <span class="mi">21312</span><span class="p">,</span> <span class="mi">22294</span><span class="p">,</span> <span class="mi">22301</span><span class="p">,</span>
        <span class="mi">21257</span><span class="p">,</span> <span class="mi">22293</span><span class="p">,</span> <span class="mi">22293</span><span class="p">,</span> <span class="mi">21256</span><span class="p">,</span> <span class="mi">22293</span><span class="p">,</span> <span class="mi">22294</span><span class="p">,</span> <span class="mi">13893</span><span class="p">,</span> <span class="mi">19362</span><span class="p">,</span> <span class="mi">21252</span><span class="p">])</span>
<span class="o">******</span>
<span class="n">tensor</span><span class="p">([</span><span class="mi">18244</span><span class="p">,</span>  <span class="mi">1287</span><span class="p">,</span> <span class="mi">16103</span><span class="p">,</span> <span class="mi">14271</span><span class="p">,</span>  <span class="mi">6371</span><span class="p">,</span> <span class="mi">15538</span><span class="p">,</span> <span class="mi">15807</span><span class="p">,</span> <span class="mi">22294</span><span class="p">,</span> <span class="mi">17205</span><span class="p">,</span> <span class="mi">14573</span><span class="p">,</span>
        <span class="mi">17540</span><span class="p">,</span> <span class="mi">22294</span><span class="p">,</span> <span class="mi">22292</span><span class="p">,</span> <span class="mi">22293</span><span class="p">,</span> <span class="mi">22298</span><span class="p">,</span> <span class="mi">21312</span><span class="p">,</span> <span class="mi">21312</span><span class="p">,</span> <span class="mi">22293</span><span class="p">,</span> <span class="mi">22292</span><span class="p">,</span> <span class="mi">21312</span><span class="p">,</span>
        <span class="mi">21312</span><span class="p">,</span> <span class="mi">22294</span><span class="p">,</span> <span class="mi">22301</span><span class="p">,</span> <span class="mi">14703</span><span class="p">,</span> <span class="mi">13893</span><span class="p">,</span> <span class="mi">19362</span><span class="p">,</span> <span class="mi">21252</span><span class="p">])</span>
<span class="o">******</span>
</code></pre></div>

<hr>
<ul>
<li>第四步: 获取训练数据和验证数据的函数</li>
</ul>
<div class="highlight"><pre id="__code_51"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_51 pre, #__code_51 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 获取训练数据集和验证数据集</span>
<span class="k">def</span> <span class="nf">get_data</span><span class="p">():</span>
    <span class="c1"># 训练数据集和验证数据集的路径, 后面直接以读取文件的形式获取数据即可</span>
    <span class="n">train_data_file_path</span> <span class="o">=</span> <span class="s2">"data/train_data.txt"</span>
    <span class="n">validate_file_path</span> <span class="o">=</span> <span class="s2">"data/validate_data.txt"</span>
    <span class="n">train_data_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">validate_data_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># 因为每一行都是一个样本, 所以按行遍历即可</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">train_data_file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf8"</span><span class="p">):</span>
        <span class="c1"># 每行样本数据都是json字符串, 直接loads进来, 再追加进结果列表中</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">train_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">validate_file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf8"</span><span class="p">):</span>
        <span class="c1"># 采用和上面训练数据同样的处理方法即可</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">validate_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># 以列表形式返回训练数据集和验证数据集</span>
    <span class="k">return</span> <span class="n">train_data_list</span><span class="p">,</span> <span class="n">validate_data_list</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/train.py</li>
</ul>
<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_52"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_52 pre, #__code_52 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">train_data_list</span><span class="p">,</span> <span class="n">valid_data_list</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">train_data_list</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data_list</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'******'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">valid_data_list</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_data_list</span><span class="p">))</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_53"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_53 pre, #__code_53 code"><span class="md-clipboard__message"></span></button><code><span class="p">[{</span><span class="s1">'text'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'女'</span><span class="p">,</span> <span class="s1">'性'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'8'</span><span class="p">,</span> <span class="s1">'8'</span><span class="p">,</span> <span class="s1">'岁'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'农'</span><span class="p">,</span> <span class="s1">'民'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'双'</span><span class="p">,</span> <span class="s1">'滦'</span><span class="p">,</span> <span class="s1">'区'</span><span class="p">,</span> <span class="s1">'应'</span><span class="p">,</span> <span class="s1">'营'</span><span class="p">,</span> <span class="s1">'子'</span><span class="p">,</span> <span class="s1">'村'</span><span class="p">,</span> <span class="s1">'人'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'主'</span><span class="p">,</span> <span class="s1">'因'</span><span class="p">,</span> <span class="s1">'右'</span><span class="p">,</span> <span class="s1">'髋'</span><span class="p">,</span> <span class="s1">'部'</span><span class="p">,</span> <span class="s1">'摔'</span><span class="p">,</span> <span class="s1">'伤'</span><span class="p">,</span> <span class="s1">'后'</span><span class="p">,</span> <span class="s1">'疼'</span><span class="p">,</span> <span class="s1">'痛'</span><span class="p">,</span> <span class="s1">'肿'</span><span class="p">,</span> <span class="s1">'胀'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'活'</span><span class="p">,</span> <span class="s1">'动'</span><span class="p">,</span> <span class="s1">'受'</span><span class="p">,</span> <span class="s1">'限'</span><span class="p">,</span> <span class="s1">'5'</span><span class="p">,</span> <span class="s1">'小'</span><span class="p">,</span> <span class="s1">'时'</span><span class="p">,</span> <span class="s1">'于'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'6'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'9'</span><span class="p">,</span> <span class="s1">'；'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'：'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'入'</span><span class="p">,</span> <span class="s1">'院'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">],</span> <span class="s1">'label'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'B-sym'</span><span class="p">,</span> <span class="s1">'I-sym'</span><span class="p">,</span> <span class="s1">'B-sym'</span><span class="p">,</span> <span class="s1">'I-sym'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">]},</span> <span class="p">{</span><span class="s1">'text'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'腰'</span><span class="p">,</span> <span class="s1">'部'</span><span class="p">,</span> <span class="s1">'外'</span><span class="p">,</span> <span class="s1">'伤'</span><span class="p">,</span> <span class="s1">'后'</span><span class="p">,</span> <span class="s1">'疼'</span><span class="p">,</span> <span class="s1">'痛'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'小'</span><span class="p">,</span> <span class="s1">'时'</span><span class="p">,</span> <span class="s1">'于'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'6'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'9'</span><span class="p">,</span> <span class="s1">'收'</span><span class="p">,</span> <span class="s1">'入'</span><span class="p">,</span> <span class="s1">'院'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">],</span> <span class="s1">'label'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'B-sym'</span><span class="p">,</span> <span class="s1">'I-sym'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">]},</span> <span class="p">{</span><span class="s1">'text'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'处'</span><span class="p">,</span> <span class="s1">'外'</span><span class="p">,</span> <span class="s1">'伤'</span><span class="p">,</span> <span class="s1">'后'</span><span class="p">,</span> <span class="s1">'疼'</span><span class="p">,</span> <span class="s1">'痛'</span><span class="p">,</span> <span class="s1">'伴'</span><span class="p">,</span> <span class="s1">'有'</span><span class="p">,</span> <span class="s1">'头'</span><span class="p">,</span> <span class="s1">'晕'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'小'</span><span class="p">,</span> <span class="s1">'时'</span><span class="p">,</span> <span class="s1">'于'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'6'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">':'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'收'</span><span class="p">,</span> <span class="s1">'入'</span><span class="p">,</span> <span class="s1">'院'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">],</span> <span class="s1">'label'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'B-sym'</span><span class="p">,</span> <span class="s1">'I-sym'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'B-sym'</span><span class="p">,</span> <span class="s1">'I-sym'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">]},</span> <span class="p">{</span><span class="s1">'text'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'伤'</span><span class="p">,</span> <span class="s1">'后'</span><span class="p">,</span> <span class="s1">'疼'</span><span class="p">,</span> <span class="s1">'痛'</span><span class="p">,</span> <span class="s1">'、'</span><span class="p">,</span> <span class="s1">'头'</span><span class="p">,</span> <span class="s1">'晕'</span><span class="p">,</span> <span class="s1">'3'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'分'</span><span class="p">,</span> <span class="s1">'钟'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">],</span> <span class="s1">'label'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'B-sym'</span><span class="p">,</span> <span class="s1">'I-sym'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'B-sym'</span><span class="p">,</span> <span class="s1">'I-sym'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">]},</span> <span class="p">{</span><span class="s1">'text'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'侧'</span><span class="p">,</span> <span class="s1">'腹'</span><span class="p">,</span> <span class="s1">'部'</span><span class="p">,</span> <span class="s1">'疼'</span><span class="p">,</span> <span class="s1">'痛'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'天'</span><span class="p">,</span> <span class="s1">'于'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'6'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'7'</span><span class="p">,</span> <span class="s1">'收'</span><span class="p">,</span> <span class="s1">'入'</span><span class="p">,</span> <span class="s1">'院'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">],</span> <span class="s1">'label'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'B-sym'</span><span class="p">,</span> <span class="s1">'I-sym'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">]}]</span>
<span class="mi">1500</span>
<span class="o">******</span>
<span class="p">[{</span><span class="s1">'text'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'1'</span><span class="p">,</span> <span class="s1">'患'</span><span class="p">,</span> <span class="s1">'者'</span><span class="p">,</span> <span class="s1">'男'</span><span class="p">,</span> <span class="s1">'性'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'8'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'岁'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">'既'</span><span class="p">,</span> <span class="s1">'往'</span><span class="p">,</span> <span class="s1">'有'</span><span class="p">,</span> <span class="s1">'尿'</span><span class="p">,</span> <span class="s1">'潴'</span><span class="p">,</span> <span class="s1">'留'</span><span class="p">,</span> <span class="s1">'病'</span><span class="p">,</span> <span class="s1">'史'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'次'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">],</span> <span class="s1">'label'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'B-dis'</span><span class="p">,</span> <span class="s1">'I-dis'</span><span class="p">,</span> <span class="s1">'I-dis'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">]},</span> <span class="p">{</span><span class="s1">'text'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'3'</span><span class="p">,</span> <span class="s1">'患'</span><span class="p">,</span> <span class="s1">'者'</span><span class="p">,</span> <span class="s1">'缘'</span><span class="p">,</span> <span class="s1">'于'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'年'</span><span class="p">,</span> <span class="s1">'前'</span><span class="p">,</span> <span class="s1">'无'</span><span class="p">,</span> <span class="s1">'明'</span><span class="p">,</span> <span class="s1">'显'</span><span class="p">,</span> <span class="s1">'诱'</span><span class="p">,</span> <span class="s1">'因'</span><span class="p">,</span> <span class="s1">'出'</span><span class="p">,</span> <span class="s1">'现'</span><span class="p">,</span> <span class="s1">'尿'</span><span class="p">,</span> <span class="s1">'频'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'尿'</span><span class="p">,</span> <span class="s1">'急'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'尿'</span><span class="p">,</span> <span class="s1">'不'</span><span class="p">,</span> <span class="s1">'尽'</span><span class="p">,</span> <span class="s1">'感'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'排'</span><span class="p">,</span> <span class="s1">'尿'</span><span class="p">,</span> <span class="s1">'踌'</span><span class="p">,</span> <span class="s1">'躇'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'夜'</span><span class="p">,</span> <span class="s1">'尿'</span><span class="p">,</span> <span class="s1">'次'</span><span class="p">,</span> <span class="s1">'数'</span><span class="p">,</span> <span class="s1">'增'</span><span class="p">,</span> <span class="s1">'多'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">,</span> <span class="s1">'有'</span><span class="p">,</span> <span class="s1">'时'</span><span class="p">,</span> <span class="s1">'达'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'余'</span><span class="p">,</span> <span class="s1">'次'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'尿'</span><span class="p">,</span> <span class="s1">'线'</span><span class="p">,</span> <span class="s1">'逐'</span><span class="p">,</span> <span class="s1">'渐'</span><span class="p">,</span> <span class="s1">'变'</span><span class="p">,</span> <span class="s1">'细'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">,</span> <span class="s1">'无'</span><span class="p">,</span> <span class="s1">'肉'</span><span class="p">,</span> <span class="s1">'眼'</span><span class="p">,</span> <span class="s1">'血'</span><span class="p">,</span> <span class="s1">'尿'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'近'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'天'</span><span class="p">,</span> <span class="s1">'上'</span><span class="p">,</span> <span class="s1">'述'</span><span class="p">,</span> <span class="s1">'症'</span><span class="p">,</span> <span class="s1">'状'</span><span class="p">,</span> <span class="s1">'逐'</span><span class="p">,</span> <span class="s1">'渐'</span><span class="p">,</span> <span class="s1">'加'</span><span class="p">,</span> <span class="s1">'重'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'伴'</span><span class="p">,</span> <span class="s1">'有'</span><span class="p">,</span> <span class="s1">'排'</span><span class="p">,</span> <span class="s1">'尿'</span><span class="p">,</span> <span class="s1">'后'</span><span class="p">,</span> <span class="s1">'疼'</span><span class="p">,</span> <span class="s1">'痛'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">],</span> <span class="s1">'label'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'B-sym'</span><span class="p">,</span> <span class="s1">'I-sym'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">]},</span> <span class="p">{</span><span class="s1">'text'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'于'</span><span class="p">,</span> <span class="s1">'滦'</span><span class="p">,</span> <span class="s1">'平'</span><span class="p">,</span> <span class="s1">'县'</span><span class="p">,</span> <span class="s1">'医'</span><span class="p">,</span> <span class="s1">'院'</span><span class="p">,</span> <span class="s1">'诊'</span><span class="p">,</span> <span class="s1">'断'</span><span class="p">,</span> <span class="s1">'为'</span><span class="p">,</span> <span class="s1">'前'</span><span class="p">,</span> <span class="s1">'列'</span><span class="p">,</span> <span class="s1">'腺'</span><span class="p">,</span> <span class="s1">'增'</span><span class="p">,</span> <span class="s1">'生'</span><span class="p">,</span> <span class="s1">'住'</span><span class="p">,</span> <span class="s1">'院'</span><span class="p">,</span> <span class="s1">'治'</span><span class="p">,</span> <span class="s1">'疗'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'给'</span><span class="p">,</span> <span class="s1">'予'</span><span class="p">,</span> <span class="s1">'留'</span><span class="p">,</span> <span class="s1">'置'</span><span class="p">,</span> <span class="s1">'尿'</span><span class="p">,</span> <span class="s1">'管'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">],</span> <span class="s1">'label'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'B-dis'</span><span class="p">,</span> <span class="s1">'I-dis'</span><span class="p">,</span> <span class="s1">'I-dis'</span><span class="p">,</span> <span class="s1">'I-dis'</span><span class="p">,</span> <span class="s1">'I-dis'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">]},</span> <span class="p">{</span><span class="s1">'text'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'静'</span><span class="p">,</span> <span class="s1">'点'</span><span class="p">,</span> <span class="s1">'抗'</span><span class="p">,</span> <span class="s1">'生'</span><span class="p">,</span> <span class="s1">'素'</span><span class="p">,</span> <span class="s1">'('</span><span class="p">,</span> <span class="s1">'名'</span><span class="p">,</span> <span class="s1">'量'</span><span class="p">,</span> <span class="s1">'具'</span><span class="p">,</span> <span class="s1">'体'</span><span class="p">,</span> <span class="s1">'不'</span><span class="p">,</span> <span class="s1">'详'</span><span class="p">,</span> <span class="s1">')'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">,</span> <span class="s1">'症'</span><span class="p">,</span> <span class="s1">'状'</span><span class="p">,</span> <span class="s1">'无'</span><span class="p">,</span> <span class="s1">'缓'</span><span class="p">,</span> <span class="s1">'解'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">,</span> <span class="s1">'出'</span><span class="p">,</span> <span class="s1">'院'</span><span class="p">,</span> <span class="s1">'后'</span><span class="p">,</span> <span class="s1">'于'</span><span class="p">,</span> <span class="s1">'滦'</span><span class="p">,</span> <span class="s1">'平'</span><span class="p">,</span> <span class="s1">'县'</span><span class="p">,</span> <span class="s1">'中'</span><span class="p">,</span> <span class="s1">'医'</span><span class="p">,</span> <span class="s1">'院'</span><span class="p">,</span> <span class="s1">'检'</span><span class="p">,</span> <span class="s1">'查'</span><span class="p">,</span> <span class="s1">'行'</span><span class="p">,</span> <span class="s1">'泌'</span><span class="p">,</span> <span class="s1">'尿'</span><span class="p">,</span> <span class="s1">'系'</span><span class="p">,</span> <span class="s1">'彩'</span><span class="p">,</span> <span class="s1">'超'</span><span class="p">,</span> <span class="s1">'检'</span><span class="p">,</span> <span class="s1">'查'</span><span class="p">,</span> <span class="s1">'回'</span><span class="p">,</span> <span class="s1">'报'</span><span class="p">,</span> <span class="s1">'：'</span><span class="p">,</span> <span class="s1">'⑴'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">'前'</span><span class="p">,</span> <span class="s1">'列'</span><span class="p">,</span> <span class="s1">'腺'</span><span class="p">,</span> <span class="s1">'增'</span><span class="p">,</span> <span class="s1">'生'</span><span class="p">,</span> <span class="s1">'回'</span><span class="p">,</span> <span class="s1">'声'</span><span class="p">,</span> <span class="s1">'不'</span><span class="p">,</span> <span class="s1">'均'</span><span class="p">,</span> <span class="s1">'匀'</span><span class="p">,</span> <span class="s1">'⑵'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">'膀'</span><span class="p">,</span> <span class="s1">'胱'</span><span class="p">,</span> <span class="s1">'壁'</span><span class="p">,</span> <span class="s1">'增'</span><span class="p">,</span> <span class="s1">'厚'</span><span class="p">,</span> <span class="s1">'⑶'</span><span class="p">,</span> <span class="s1">'双'</span><span class="p">,</span> <span class="s1">'肾'</span><span class="p">,</span> <span class="s1">'未'</span><span class="p">,</span> <span class="s1">'见'</span><span class="p">,</span> <span class="s1">'异'</span><span class="p">,</span> <span class="s1">'常'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">,</span> <span class="s1">'心'</span><span class="p">,</span> <span class="s1">'脏'</span><span class="p">,</span> <span class="s1">'彩'</span><span class="p">,</span> <span class="s1">'超'</span><span class="p">,</span> <span class="s1">'回'</span><span class="p">,</span> <span class="s1">'报'</span><span class="p">,</span> <span class="s1">'：'</span><span class="p">,</span> <span class="s1">'左'</span><span class="p">,</span> <span class="s1">'室'</span><span class="p">,</span> <span class="s1">'舒'</span><span class="p">,</span> <span class="s1">'张'</span><span class="p">,</span> <span class="s1">'功'</span><span class="p">,</span> <span class="s1">'能'</span><span class="p">,</span> <span class="s1">'减'</span><span class="p">,</span> <span class="s1">'退'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">'肺'</span><span class="p">,</span> <span class="s1">'动'</span><span class="p">,</span> <span class="s1">'脉'</span><span class="p">,</span> <span class="s1">'高'</span><span class="p">,</span> <span class="s1">'压'</span><span class="p">,</span> <span class="s1">'（'</span><span class="p">,</span> <span class="s1">'轻'</span><span class="p">,</span> <span class="s1">'）'</span><span class="p">,</span> <span class="s1">'3'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">'主'</span><span class="p">,</span> <span class="s1">'动'</span><span class="p">,</span> <span class="s1">'脉'</span><span class="p">,</span> <span class="s1">'瓣'</span><span class="p">,</span> <span class="s1">'返'</span><span class="p">,</span> <span class="s1">'流'</span><span class="p">,</span> <span class="s1">'（'</span><span class="p">,</span> <span class="s1">'轻'</span><span class="p">,</span> <span class="s1">'）'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'4'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">'三'</span><span class="p">,</span> <span class="s1">'尖'</span><span class="p">,</span> <span class="s1">'瓣'</span><span class="p">,</span> <span class="s1">'返'</span><span class="p">,</span> <span class="s1">'流'</span><span class="p">,</span> <span class="s1">'（'</span><span class="p">,</span> <span class="s1">'轻'</span><span class="p">,</span> <span class="s1">'）'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'胸'</span><span class="p">,</span> <span class="s1">'部'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'T'</span><span class="p">,</span> <span class="s1">'回'</span><span class="p">,</span> <span class="s1">'报'</span><span class="p">,</span> <span class="s1">'：'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">'肺'</span><span class="p">,</span> <span class="s1">'气'</span><span class="p">,</span> <span class="s1">'肿'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">'两'</span><span class="p">,</span> <span class="s1">'上'</span><span class="p">,</span> <span class="s1">'肺'</span><span class="p">,</span> <span class="s1">'肺'</span><span class="p">,</span> <span class="s1">'气'</span><span class="p">,</span> <span class="s1">'肿'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'3'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">'两'</span><span class="p">,</span> <span class="s1">'肺'</span><span class="p">,</span> <span class="s1">'多'</span><span class="p">,</span> <span class="s1">'索'</span><span class="p">,</span> <span class="s1">'条'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'胸'</span><span class="p">,</span> <span class="s1">'膜'</span><span class="p">,</span> <span class="s1">'幕'</span><span class="p">,</span> <span class="s1">'状'</span><span class="p">,</span> <span class="s1">'粘'</span><span class="p">,</span> <span class="s1">'连'</span><span class="p">,</span> <span class="s1">'4'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">'主'</span><span class="p">,</span> <span class="s1">'动'</span><span class="p">,</span> <span class="s1">'脉'</span><span class="p">,</span> <span class="s1">'伸'</span><span class="p">,</span> <span class="s1">'长'</span><span class="p">,</span> <span class="s1">'迂'</span><span class="p">,</span> <span class="s1">'回'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'主'</span><span class="p">,</span> <span class="s1">'动'</span><span class="p">,</span> <span class="s1">'脉'</span><span class="p">,</span> <span class="s1">'及'</span><span class="p">,</span> <span class="s1">'冠'</span><span class="p">,</span> <span class="s1">'状'</span><span class="p">,</span> <span class="s1">'动'</span><span class="p">,</span> <span class="s1">'脉'</span><span class="p">,</span> <span class="s1">'钙'</span><span class="p">,</span> <span class="s1">'化'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'5'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">'甲'</span><span class="p">,</span> <span class="s1">'状'</span><span class="p">,</span> <span class="s1">'腺'</span><span class="p">,</span> <span class="s1">'多'</span><span class="p">,</span> <span class="s1">'发'</span><span class="p">,</span> <span class="s1">'混'</span><span class="p">,</span> <span class="s1">'杂'</span><span class="p">,</span> <span class="s1">'密'</span><span class="p">,</span> <span class="s1">'度'</span><span class="p">,</span> <span class="s1">'结'</span><span class="p">,</span> <span class="s1">'节'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'伴'</span><span class="p">,</span> <span class="s1">'有'</span><span class="p">,</span> <span class="s1">'钙'</span><span class="p">,</span> <span class="s1">'化'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">],</span> <span class="s1">'label'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'B-sym'</span><span class="p">,</span> <span class="s1">'I-sym'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">]},</span> <span class="p">{</span><span class="s1">'text'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'建'</span><span class="p">,</span> <span class="s1">'议'</span><span class="p">,</span> <span class="s1">'上'</span><span class="p">,</span> <span class="s1">'级'</span><span class="p">,</span> <span class="s1">'医'</span><span class="p">,</span> <span class="s1">'院'</span><span class="p">,</span> <span class="s1">'治'</span><span class="p">,</span> <span class="s1">'疗'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'为'</span><span class="p">,</span> <span class="s1">'进'</span><span class="p">,</span> <span class="s1">'一'</span><span class="p">,</span> <span class="s1">'步'</span><span class="p">,</span> <span class="s1">'治'</span><span class="p">,</span> <span class="s1">'疗'</span><span class="p">,</span> <span class="s1">'于'</span><span class="p">,</span> <span class="s1">'今'</span><span class="p">,</span> <span class="s1">'日'</span><span class="p">,</span> <span class="s1">'到'</span><span class="p">,</span> <span class="s1">'我'</span><span class="p">,</span> <span class="s1">'院'</span><span class="p">,</span> <span class="s1">'，'</span><span class="p">,</span> <span class="s1">'门'</span><span class="p">,</span> <span class="s1">'诊'</span><span class="p">,</span> <span class="s1">'以'</span><span class="p">,</span> <span class="s1">'前'</span><span class="p">,</span> <span class="s1">'列'</span><span class="p">,</span> <span class="s1">'腺'</span><span class="p">,</span> <span class="s1">'增'</span><span class="p">,</span> <span class="s1">'生'</span><span class="p">,</span> <span class="s1">'介'</span><span class="p">,</span> <span class="s1">'绍'</span><span class="p">,</span> <span class="s1">'入'</span><span class="p">,</span> <span class="s1">'院'</span><span class="p">,</span> <span class="s1">'。'</span><span class="p">],</span> <span class="s1">'label'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'B-dis'</span><span class="p">,</span> <span class="s1">'I-dis'</span><span class="p">,</span> <span class="s1">'I-dis'</span><span class="p">,</span> <span class="s1">'I-dis'</span><span class="p">,</span> <span class="s1">'I-dis'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">,</span> <span class="s1">'O'</span><span class="p">]}]</span>
<span class="mi">1032</span>
</code></pre></div>

<hr>
<ul>
<li>第五步: 完成准确率和召回率的评估代码.</li>
</ul>
<div class="highlight"><pre id="__code_54"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_54 pre, #__code_54 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 构建函数评估模型的准确率和召回率</span>
<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">,</span> <span class="n">gold_tags</span><span class="p">,</span> <span class="n">predict_tags</span><span class="p">,</span> <span class="n">id2char</span><span class="p">,</span> <span class="n">id2tag</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    description: 评价模型指标方法</span>
<span class="sd">    :param sentence_list:    句子列表</span>
<span class="sd">    :param gold_tags:        标签序列</span>
<span class="sd">    :param predict_tags:     预测标签序列</span>
<span class="sd">    :param id2char:          文字码表</span>
<span class="sd">    :param id2tag:           标签码表</span>
<span class="sd">    :return: step_acc,                   当前批次准确率</span>
<span class="sd">             step_recall,                当前批次召回率</span>
<span class="sd">             f1_score,                   当前批次 f1 值</span>
<span class="sd">             acc_entities_length,        当前批次正确识别实体总数</span>
<span class="sd">             predict_entities_length,    当前批次识别出的实体总数</span>
<span class="sd">             gold_entities_length        当前批次真实的实体总数</span>
<span class="sd">    """</span>
    <span class="c1"># 真实实体集合以及每个实体的字与标签列表</span>
    <span class="n">gold_entities</span><span class="p">,</span> <span class="n">gold_entity</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="c1"># 预测实体集合以及每个实体的字与标签列表</span>
    <span class="n">predict_entities</span><span class="p">,</span> <span class="n">predict_entity</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="c1"># 遍历当前待评估的句子列表</span>
    <span class="k">for</span> <span class="n">line_no</span><span class="p">,</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">):</span>
        <span class="c1"># 迭代句子每个字符</span>
        <span class="k">for</span> <span class="n">char_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">)):</span>
            <span class="c1"># 判断:若句子的id值对应的是0(即:&lt;PAD&gt;)则跳过循环</span>
            <span class="k">if</span> <span class="n">sentence</span><span class="p">[</span><span class="n">char_no</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># 获取当前句子中的每一个文字</span>
            <span class="n">char_text</span> <span class="o">=</span> <span class="n">id2char</span><span class="p">[</span><span class="n">sentence</span><span class="p">[</span><span class="n">char_no</span><span class="p">]]</span>
            <span class="c1"># 获取当前字真实实体标注类型</span>
            <span class="n">gold_tag_type</span> <span class="o">=</span> <span class="n">id2tag</span><span class="p">[</span><span class="n">gold_tags</span><span class="p">[</span><span class="n">line_no</span><span class="p">][</span><span class="n">char_no</span><span class="p">]]</span>
            <span class="c1"># 获取当前预测实体标注类型</span>
            <span class="n">predict_tag_type</span> <span class="o">=</span> <span class="n">id2tag</span><span class="p">[</span><span class="n">predict_tags</span><span class="p">[</span><span class="n">line_no</span><span class="p">][</span><span class="n">char_no</span><span class="p">]]</span>
            <span class="c1"># 判断 id2tag 第一个字符是否为 B ,表示实体开始</span>
            <span class="k">if</span> <span class="n">gold_tag_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"B"</span><span class="p">:</span>
                <span class="c1"># 将实体文字与类别加入实体列表中</span>
                <span class="n">gold_entity</span> <span class="o">=</span> <span class="p">[</span><span class="n">char_text</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="n">gold_tag_type</span><span class="p">]</span>
            <span class="c1"># 判断 id2tag 第一个字符是否为 I ,表示实体中部到结尾</span>
            <span class="c1"># 判断依据: I 开头; entiry 不为空; 实体类别相同.</span>
            <span class="k">elif</span> <span class="n">gold_tag_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"I"</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gold_entity</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> \
                    <span class="ow">and</span> <span class="n">gold_entity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">gold_tag_type</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="c1"># 满足条件则加入实体列表中</span>
                <span class="n">gold_entity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_text</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="n">gold_tag_type</span><span class="p">)</span>
            <span class="c1"># 判断依据: O 开头, 并且entiry 不为空.</span>
            <span class="k">elif</span> <span class="n">gold_tag_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"O"</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gold_entity</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="c1"># 增加唯一标识(人为增加的标志位)</span>
                <span class="n">gold_entity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">line_no</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"_"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">char_no</span><span class="p">))</span>
                <span class="c1"># 将实体文字与类别加入实体列表中</span>
                <span class="n">gold_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gold_entity</span><span class="p">)</span>
                <span class="c1"># 重置实体列表</span>
                <span class="n">gold_entity</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 重置实体列表</span>
                <span class="n">gold_entity</span><span class="o">=</span><span class="p">[]</span>

            <span class="c1"># 判断 id2tag 第一个字符是否为 B ,表示实体开始</span>
            <span class="k">if</span> <span class="n">predict_tag_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"B"</span><span class="p">:</span>
                <span class="c1"># 将实体文字与类别加入实体列表中</span>
                <span class="n">predict_entity</span> <span class="o">=</span> <span class="p">[</span><span class="n">char_text</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="n">predict_tag_type</span><span class="p">]</span>
            <span class="c1"># 判断 id2tag 第一个字符是否为 I ,表示实体中部到结尾</span>
            <span class="c1"># 判断依据: I 开头; entiry 不为空; 实体类别相同.</span>
            <span class="k">elif</span> <span class="n">predict_tag_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"I"</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">predict_entity</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> \
                    <span class="ow">and</span> <span class="n">predict_entity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">predict_tag_type</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="c1"># 将实体文字与类别加入实体列表中</span>
                <span class="n">predict_entity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_text</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="n">predict_tag_type</span><span class="p">)</span>
            <span class="c1"># 判断依据: O 开头, 并且entiry 不为空.</span>
            <span class="k">elif</span> <span class="n">predict_tag_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"O"</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">predict_entity</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># 增加唯一标识(人为添加的标志位)</span>
                <span class="n">predict_entity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">line_no</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"_"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">char_no</span><span class="p">))</span>
                <span class="c1"># 将实体加入列表中</span>
                <span class="n">predict_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predict_entity</span><span class="p">)</span>
                <span class="c1"># 重置实体列表</span>
                <span class="n">predict_entity</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 重置实体列表</span>
                <span class="n">predict_entity</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 获取预测正确的实体集合</span>
    <span class="n">acc_entities</span> <span class="o">=</span> <span class="p">[</span><span class="n">entity</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">predict_entities</span> <span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">gold_entities</span><span class="p">]</span>
    <span class="c1"># 预测正确实体长度(用于计算准确率, 召回, F1值)</span>
    <span class="n">acc_entities_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">acc_entities</span><span class="p">)</span>
    <span class="c1"># 预测出实体个数</span>
    <span class="n">predict_entities_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predict_entities</span><span class="p">)</span>
    <span class="c1"># 真实实体列表个数</span>
    <span class="n">gold_entities_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gold_entities</span><span class="p">)</span>

    <span class="c1"># 如果准确实体个数大于0, 则计算准确度, 召回率, f1值</span>
    <span class="k">if</span> <span class="n">acc_entities_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 准确率</span>
        <span class="n">step_acc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">acc_entities_length</span> <span class="o">/</span> <span class="n">predict_entities_length</span><span class="p">)</span>
        <span class="c1"># 召回率</span>
        <span class="n">step_recall</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">acc_entities_length</span> <span class="o">/</span> <span class="n">gold_entities_length</span><span class="p">)</span>
        <span class="c1"># f1值</span>
        <span class="n">f1_score</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">step_acc</span> <span class="o">*</span> <span class="n">step_recall</span> <span class="o">/</span> <span class="p">(</span><span class="n">step_acc</span> <span class="o">+</span> <span class="n">step_recall</span><span class="p">)</span>
        <span class="c1"># 返回评估值与各个实体长度(用于整体计算)</span>
        <span class="k">return</span> <span class="n">step_acc</span><span class="p">,</span> <span class="n">step_recall</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">acc_entities_length</span><span class="p">,</span> <span class="n">predict_entities_length</span><span class="p">,</span> <span class="n">gold_entities_length</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 准确率, 召回率, f1值均为0</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">acc_entities_length</span><span class="p">,</span> <span class="n">predict_entities_length</span><span class="p">,</span> <span class="n">gold_entities_length</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/evaluate.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_55"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_55 pre, #__code_55 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 真实标签数据</span>
<span class="n">tag_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="p">]</span>

<span class="c1"># 预测标签数据</span>
<span class="n">predict_tag_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="p">]</span>

<span class="c1"># 编码与字符对照字典</span>
<span class="n">id2char</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">'&lt;PAD&gt;'</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">'确'</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">'诊'</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">'弥'</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s1">'漫'</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="s1">'大'</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s1">'b'</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="s1">'细'</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="s1">'胞'</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="s1">'淋'</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="s1">'巴'</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="s1">'瘤'</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span> <span class="s1">'年'</span><span class="p">,</span> <span class="mi">14</span><span class="p">:</span> <span class="s1">'反'</span><span class="p">,</span> <span class="mi">15</span><span class="p">:</span> <span class="s1">'复'</span><span class="p">,</span> <span class="mi">16</span><span class="p">:</span> <span class="s1">'咳'</span><span class="p">,</span> <span class="mi">17</span><span class="p">:</span> <span class="s1">'嗽'</span><span class="p">,</span> <span class="mi">18</span><span class="p">:</span> <span class="s1">'、'</span><span class="p">,</span> <span class="mi">19</span><span class="p">:</span> <span class="s1">'痰'</span><span class="p">,</span> <span class="mi">20</span><span class="p">:</span> <span class="s1">'4'</span><span class="p">,</span> <span class="mi">21</span><span class="p">:</span> <span class="s1">'0'</span><span class="p">,</span> <span class="mi">22</span><span class="p">:</span> <span class="s1">','</span><span class="p">,</span> <span class="mi">23</span><span class="p">:</span> <span class="s1">'再'</span><span class="p">,</span> <span class="mi">24</span><span class="p">:</span> <span class="s1">'发'</span><span class="p">,</span> <span class="mi">25</span><span class="p">:</span> <span class="s1">'伴'</span><span class="p">,</span> <span class="mi">26</span><span class="p">:</span> <span class="s1">'气'</span><span class="p">,</span> <span class="mi">27</span><span class="p">:</span> <span class="s1">'促'</span><span class="p">,</span> <span class="mi">28</span><span class="p">:</span> <span class="s1">'5'</span><span class="p">,</span> <span class="mi">29</span><span class="p">:</span> <span class="s1">'天'</span><span class="p">,</span> <span class="mi">30</span><span class="p">:</span> <span class="s1">'。'</span><span class="p">,</span> <span class="mi">31</span><span class="p">:</span> <span class="s1">'生'</span><span class="p">,</span> <span class="mi">32</span><span class="p">:</span> <span class="s1">'长'</span><span class="p">,</span> <span class="mi">33</span><span class="p">:</span> <span class="s1">'育'</span><span class="p">,</span> <span class="mi">34</span><span class="p">:</span> <span class="s1">'迟'</span><span class="p">,</span> <span class="mi">35</span><span class="p">:</span> <span class="s1">'缓'</span><span class="p">,</span> <span class="mi">36</span><span class="p">:</span> <span class="s1">'9'</span><span class="p">,</span> <span class="mi">37</span><span class="p">:</span> <span class="s1">'右'</span><span class="p">,</span> <span class="mi">38</span><span class="p">:</span> <span class="s1">'侧'</span><span class="p">,</span> <span class="mi">39</span><span class="p">:</span> <span class="s1">'小'</span><span class="p">,</span> <span class="mi">40</span><span class="p">:</span> <span class="s1">'肺'</span><span class="p">,</span> <span class="mi">41</span><span class="p">:</span> <span class="s1">'癌'</span><span class="p">,</span> <span class="mi">42</span><span class="p">:</span> <span class="s1">'第'</span><span class="p">,</span> <span class="mi">43</span><span class="p">:</span> <span class="s1">'三'</span><span class="p">,</span> <span class="mi">44</span><span class="p">:</span> <span class="s1">'次'</span><span class="p">,</span> <span class="mi">45</span><span class="p">:</span> <span class="s1">'化'</span><span class="p">,</span> <span class="mi">46</span><span class="p">:</span> <span class="s1">'疗'</span><span class="p">,</span> <span class="mi">47</span><span class="p">:</span> <span class="s1">'入'</span><span class="p">,</span> <span class="mi">48</span><span class="p">:</span> <span class="s1">'院'</span><span class="p">,</span> <span class="mi">49</span><span class="p">:</span> <span class="s1">'心'</span><span class="p">,</span> <span class="mi">50</span><span class="p">:</span> <span class="s1">'悸'</span><span class="p">,</span> <span class="mi">51</span><span class="p">:</span> <span class="s1">'加'</span><span class="p">,</span> <span class="mi">52</span><span class="p">:</span> <span class="s1">'重'</span><span class="p">,</span> <span class="mi">53</span><span class="p">:</span> <span class="s1">'胸'</span><span class="p">,</span> <span class="mi">54</span><span class="p">:</span> <span class="s1">'痛'</span><span class="p">,</span> <span class="mi">55</span><span class="p">:</span> <span class="s1">'3'</span><span class="p">,</span> <span class="mi">56</span><span class="p">:</span> <span class="s1">'闷'</span><span class="p">,</span> <span class="mi">57</span><span class="p">:</span> <span class="s1">'2'</span><span class="p">,</span> <span class="mi">58</span><span class="p">:</span> <span class="s1">'多'</span><span class="p">,</span> <span class="mi">59</span><span class="p">:</span> <span class="s1">'月'</span><span class="p">,</span> <span class="mi">60</span><span class="p">:</span> <span class="s1">'余'</span><span class="p">,</span> <span class="mi">61</span><span class="p">:</span> <span class="s1">' '</span><span class="p">,</span> <span class="mi">62</span><span class="p">:</span> <span class="s1">'周'</span><span class="p">,</span> <span class="mi">63</span><span class="p">:</span> <span class="s1">'上'</span><span class="p">,</span> <span class="mi">64</span><span class="p">:</span> <span class="s1">'肢'</span><span class="p">,</span> <span class="mi">65</span><span class="p">:</span> <span class="s1">'无'</span><span class="p">,</span> <span class="mi">66</span><span class="p">:</span> <span class="s1">'力'</span><span class="p">,</span> <span class="mi">67</span><span class="p">:</span> <span class="s1">'肌'</span><span class="p">,</span> <span class="mi">68</span><span class="p">:</span> <span class="s1">'肉'</span><span class="p">,</span> <span class="mi">69</span><span class="p">:</span> <span class="s1">'萎'</span><span class="p">,</span> <span class="mi">70</span><span class="p">:</span> <span class="s1">'缩'</span><span class="p">,</span> <span class="mi">71</span><span class="p">:</span> <span class="s1">'半'</span><span class="p">}</span>

<span class="c1"># 编码与标签对照字典</span>
<span class="n">id2tag</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">'O'</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">'B-dis'</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">'I-dis'</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">'B-sym'</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s1">'I-sym'</span><span class="p">}</span>

<span class="c1"># 输入的数字化sentences_sequence, 由下面的sentence_list经过映射函数sentence_map()转化后得到</span>
<span class="n">sentence_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"确诊弥漫大b细胞淋巴瘤1年"</span><span class="p">,</span>
    <span class="s2">"反复咳嗽、咳痰40年,再发伴气促5天。"</span><span class="p">,</span>
    <span class="s2">"生长发育迟缓9年。"</span><span class="p">,</span>
    <span class="s2">"右侧小细胞肺癌第三次化疗入院"</span><span class="p">,</span>
    <span class="s2">"反复气促、心悸10年,加重伴胸痛3天。"</span><span class="p">,</span>
    <span class="s2">"反复胸闷、心悸、气促2多月,加重3天"</span><span class="p">,</span>
    <span class="s2">"咳嗽、胸闷1月余, 加重1周"</span><span class="p">,</span>
    <span class="s2">"右上肢无力3年, 加重伴肌肉萎缩半年"</span>
<span class="p">]</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_56"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_56 pre, #__code_56 code"><span class="md-clipboard__message"></span></button><code><span class="k">def</span> <span class="nf">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">,</span> <span class="n">char_to_id</span><span class="p">,</span> <span class="n">max_length</span><span class="p">):</span>
    <span class="n">sentence_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">sentence_map_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
        <span class="n">sentence_id_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">char_to_id</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">]</span>
        <span class="n">padding_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">))</span>
        <span class="n">sentence_id_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">padding_list</span><span class="p">)</span>
        <span class="n">sentence_map_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence_id_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">sentence_map_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>

<span class="n">char_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"&lt;PAD&gt;"</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>

<span class="n">SENTENCE_LENGTH</span> <span class="o">=</span> <span class="mi">20</span>

<span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentence_list</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">_char</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">char_to_id</span><span class="p">:</span>
            <span class="n">char_to_id</span><span class="p">[</span><span class="n">_char</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">char_to_id</span><span class="p">)</span>

<span class="n">sentences_sequence</span> <span class="o">=</span> <span class="n">sentence_map</span><span class="p">(</span><span class="n">sentence_list</span><span class="p">,</span> <span class="n">char_to_id</span><span class="p">,</span> <span class="n">SENTENCE_LENGTH</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">accuracy</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">acc_entities_length</span><span class="p">,</span> <span class="n">predict_entities_length</span><span class="p">,</span> <span class="n">true_entities_length</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">sentences_sequence</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">tag_list</span><span class="p">,</span> <span class="n">predict_tag_list</span><span class="p">,</span> <span class="n">id2char</span><span class="p">,</span> <span class="n">id2tag</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">"accuracy:"</span><span class="p">,</span>                  <span class="n">accuracy</span><span class="p">,</span>
          <span class="s2">"</span><span class="se">\n</span><span class="s2">recall:"</span><span class="p">,</span>                  <span class="n">recall</span><span class="p">,</span>
          <span class="s2">"</span><span class="se">\n</span><span class="s2">f1_score:"</span><span class="p">,</span>                <span class="n">f1_score</span><span class="p">,</span>
          <span class="s2">"</span><span class="se">\n</span><span class="s2">acc_entities_length:"</span><span class="p">,</span>     <span class="n">acc_entities_length</span><span class="p">,</span>
          <span class="s2">"</span><span class="se">\n</span><span class="s2">predict_entities_length:"</span><span class="p">,</span> <span class="n">predict_entities_length</span><span class="p">,</span>
          <span class="s2">"</span><span class="se">\n</span><span class="s2">true_entities_length:"</span><span class="p">,</span>    <span class="n">true_entities_length</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_57"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_57 pre, #__code_57 code"><span class="md-clipboard__message"></span></button><code><span class="n">accuracy</span><span class="p">:</span> <span class="mf">0.8823529411764706</span> 
<span class="n">recall</span><span class="p">:</span> <span class="mf">0.9375</span> 
<span class="n">f1_score</span><span class="p">:</span> <span class="mf">0.9090909090909091</span> 
<span class="n">acc_entities_length</span><span class="p">:</span> <span class="mi">15</span> 
<span class="n">predict_entities_length</span><span class="p">:</span> <span class="mi">17</span> 
<span class="n">true_entities_length</span><span class="p">:</span> <span class="mi">16</span>
</code></pre></div>

<hr>
<ul>
<li>第六步: 绘制损失曲线和评估曲线图</li>
</ul>
<div class="highlight"><pre id="__code_58"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_58 pre, #__code_58 code"><span class="md-clipboard__message"></span></button><code><span class="k">def</span> <span class="nf">save_train_history_image</span><span class="p">(</span><span class="n">train_history_list</span><span class="p">,</span>
                             <span class="n">validate_history_list</span><span class="p">,</span>
                             <span class="n">history_image_path</span><span class="p">,</span>
                             <span class="n">data_type</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    description: 存储训练历史图片</span>
<span class="sd">    :param train_history_list:          训练历史结果</span>
<span class="sd">    :param validate_history_list:       验证历史结果</span>
<span class="sd">    :param history_image_path:          历史数据生成图像保存路径</span>
<span class="sd">    :param data_type:                   数据类型[用于替换label,y轴以及保存文件名中数据类型</span>
<span class="sd">]</span>
<span class="sd">    :return:                            无,直接将数据转为图片进行存储</span>
<span class="sd">    """</span>
    <span class="c1"># 存储训练历史图片</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_history_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Train </span><span class="si">%s</span><span class="s2"> History"</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_type</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">validate_history_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Validate </span><span class="si">%s</span><span class="s2"> History"</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_type</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"best"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Epochs"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">history_image_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"plot"</span><span class="p">,</span> <span class="n">data_type</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<hr>
<ul>
<li>代码所在位置: /data/doctor_offline/ner_model/train.py</li>
</ul>
<hr>
<ul>
<li>第七步: 完成训练模型的完整代码</li>
</ul>
<div class="highlight"><pre id="__code_59"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_59 pre, #__code_59 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入代码所需的全部包</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.autograd</span> <span class="kn">as</span> <span class="nn">autograd</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="kn">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="kn">as</span> <span class="nn">optim</span>
<span class="c1"># 导入自定义的模型和评估函数</span>
<span class="kn">from</span> <span class="nn">bilstm_crf</span> <span class="kn">import</span> <span class="n">BiLSTM_CRF</span>
<span class="kn">from</span> <span class="nn">evaluate</span> <span class="kn">import</span> <span class="n">evaluate</span>
<span class="c1"># 导入若干工具包</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>


<span class="c1"># 训练主函数代码</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="c1"># 先将超参数和训练数据导入, 所有的预备工作准备好</span>
    <span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">HIDDEN_DIM</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">train_data_list</span><span class="p">,</span> <span class="n">validate_data_list</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">()</span>
    <span class="c1"># 字符到id的映射提前通过全样本统计完了, 也可以放在单独的函数中构建char_to_id</span>
    <span class="n">char_to_id</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">'./data/char_to_id.json'</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">))</span>
    <span class="c1"># 标签到id的映射是由特定任务决定的, 任务一旦确定那么这个字典也就确定了, 因此也以超参数的形式提前准备好</span>
    <span class="n">tag_to_ix</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"O"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">"&lt;START&gt;"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">"&lt;STOP&gt;"</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>

    <span class="c1"># 直接构建模型对象</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTM_CRF</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">char_to_id</span><span class="p">),</span> <span class="n">tag_to_ix</span><span class="p">,</span> <span class="n">EMBEDDING_DIM</span><span class="p">,</span> <span class="n">HIDDEN_DIM</span><span class="p">)</span>
    <span class="c1"># 直接选定优化器</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

    <span class="c1"># 调转字符标签与id值</span>
    <span class="n">id_to_tag</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tag_to_ix</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="c1"># 调转字符编码与id值</span>
    <span class="n">id_to_char</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">char_to_id</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># 获取时间戳标签, 用于模型文件和图片, 日志文件的命名</span>
    <span class="n">time_str</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">"%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S"</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="n">model_saved_path</span> <span class="o">=</span> <span class="s2">"model/bilstm_crf_state_dict_</span><span class="si">%s</span><span class="s2">.pt"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_str</span><span class="p">)</span>
    <span class="n">train_history_image_path</span> <span class="o">=</span> <span class="s2">"log/bilstm_crf_train_plot_</span><span class="si">%s</span><span class="s2">.png"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_str</span><span class="p">)</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"log/train_</span><span class="si">%s</span><span class="s2">.log"</span><span class="o">%</span><span class="p">(</span><span class="n">time_str</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"w"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf8"</span><span class="p">)</span>
    <span class="c1"># 设定整个训练数据的批次数</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="c1"># 将几个重要的统计量做初始化</span>
    <span class="n">train_loss_history</span><span class="p">,</span> <span class="n">train_acc_history</span><span class="p">,</span> <span class="n">train_recall_history</span><span class="p">,</span> <span class="n">train_f1_history</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">validate_loss_history</span><span class="p">,</span> <span class="n">validate_acc_history</span><span class="p">,</span> <span class="n">validate_recall_history</span><span class="p">,</span> <span class="n">validate_f1_history</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="c1"># 按epoch进行迭代训练</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
        <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Epoch {}/{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="p">))</span>
        <span class="n">total_acc_length</span><span class="p">,</span> <span class="n">total_prediction_length</span><span class="p">,</span> <span class="n">total_gold_length</span><span class="p">,</span> <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="c1"># 每一个epoch先遍历训练集, 通过训练样本更新模型</span>
        <span class="k">for</span> <span class="n">train_data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_data_list</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># 取出原始样本数据</span>
            <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"text"</span><span class="p">),</span> <span class="n">train_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"label"</span><span class="p">)</span>
            <span class="c1"># 完成数字化编码的映射</span>
            <span class="n">sentence_in</span> <span class="o">=</span> <span class="n">prepare_sequence</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">char_to_id</span><span class="p">)</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
            <span class="c1"># 直接将特征和标签送入模型中计算loss</span>
            <span class="c1"># 注意: model中真实计算损失值的函数不是forward(), 而是neg_log_likelihood()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">neg_log_likelihood</span><span class="p">(</span><span class="n">sentence_in</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="c1"># 这一步才真正的调用forward()函数, 目的是通过维特比算法解码出最佳路径, 本质上是一个预测的过程</span>
            <span class="n">score</span><span class="p">,</span> <span class="n">best_path_list</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">sentence_in</span><span class="p">)</span>
            <span class="c1"># 累加每一个样本的损失值</span>
            <span class="n">step_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">step_loss</span>
            <span class="n">sentence_in_unq</span> <span class="o">=</span> <span class="n">sentence_in</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">targets_unq</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">best_path_list_up</span> <span class="o">=</span> <span class="p">[</span><span class="n">best_path_list</span><span class="p">]</span>
            <span class="n">step_acc</span><span class="p">,</span> <span class="n">step_recall</span><span class="p">,</span>  <span class="n">f1_score</span><span class="p">,</span>  <span class="n">acc_entities_length</span><span class="p">,</span>  <span class="n">predict_entities_length</span><span class="p">,</span> <span class="n">gold_entities_length</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">sentence_in_unq</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">targets_unq</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">best_path_list_up</span><span class="p">,</span> <span class="n">id_to_char</span><span class="p">,</span> <span class="n">id_to_tag</span><span class="p">)</span>
            <span class="c1"># 累加三个重要的统计量, 预测正确的实体数, 预测的总实体数, 真实标签的实体数</span>
            <span class="n">total_acc_length</span> <span class="o">+=</span> <span class="n">acc_entities_length</span>
            <span class="n">total_prediction_length</span> <span class="o">+=</span> <span class="n">predict_entities_length</span>
            <span class="n">total_gold_length</span> <span class="o">+=</span> <span class="n">gold_entities_length</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">"train:"</span><span class="p">,</span> <span class="n">total_acc_length</span><span class="p">,</span> <span class="n">total_prediction_length</span><span class="p">,</span> <span class="n">total_gold_length</span><span class="p">)</span>
        <span class="c1"># 如果for循环结束, 真实预测的实体数大于0, 则计算准确率, 召回率, F1等统计量值</span>
        <span class="k">if</span> <span class="n">total_prediction_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">train_mean_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data_list</span><span class="p">)</span>
            <span class="n">train_epoch_acc</span> <span class="o">=</span> <span class="n">total_acc_length</span> <span class="o">/</span> <span class="n">total_prediction_length</span>
            <span class="n">train_epoch_recall</span> <span class="o">=</span> <span class="n">total_acc_length</span> <span class="o">/</span> <span class="n">total_gold_length</span>
            <span class="n">train_epoch_f1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">train_epoch_acc</span> <span class="o">*</span> <span class="n">train_epoch_recall</span> <span class="o">/</span> <span class="p">(</span><span class="n">train_epoch_acc</span> <span class="o">+</span> <span class="n">train_epoch_recall</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"train_total_prediction_length is zero"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># 每一个epoch, 训练结束后直接在验证集上进行验证</span>
        <span class="n">total_acc_length</span><span class="p">,</span> <span class="n">total_prediction_length</span><span class="p">,</span> <span class="n">total_gold_length</span><span class="p">,</span> <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="c1"># 进入验证阶段最重要的一步就是保持模型参数不变, 不参与反向传播和参数更新</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">validate_data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">validate_data_list</span><span class="p">):</span>
                <span class="c1"># 直接提取验证集的特征和标签, 并进行数字化映射</span>
                <span class="n">sentence</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">validate_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"text"</span><span class="p">),</span> <span class="n">validate_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"label"</span><span class="p">)</span>
                <span class="n">sentence_in</span> <span class="o">=</span> <span class="n">prepare_sequence</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">char_to_id</span><span class="p">)</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">tag_to_ix</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
                <span class="c1"># 验证阶段的损失值依然是通过neg_log_likelihood函数进行计算</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">neg_log_likelihood</span><span class="p">(</span><span class="n">sentence_in</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
                <span class="c1"># 验证阶段的解码依然是通过直接调用model中的forward函数进行</span>
                <span class="n">score</span><span class="p">,</span> <span class="n">best_path_list</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">sentence_in</span><span class="p">)</span>
                <span class="c1"># 累加每一个样本的损失值</span>
                <span class="n">step_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">step_loss</span>
                <span class="n">sentence_in_unq</span> <span class="o">=</span> <span class="n">sentence_in</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">targets_unq</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">best_path_list_up</span> <span class="o">=</span> <span class="p">[</span><span class="n">best_path_list</span><span class="p">]</span>
                <span class="n">step_acc</span><span class="p">,</span> <span class="n">step_recall</span><span class="p">,</span>  <span class="n">f1_score</span><span class="p">,</span>  <span class="n">acc_entities_length</span><span class="p">,</span>  <span class="n">predict_entities_length</span><span class="p">,</span> <span class="n">gold_entities_length</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">sentence_in_unq</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">targets_unq</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">best_path_list_up</span><span class="p">,</span> <span class="n">id_to_char</span><span class="p">,</span> <span class="n">id_to_tag</span><span class="p">)</span>
                <span class="c1"># 累加三个重要的统计量, 预测正确的实体数, 预测的总实体数, 真实标签的实体数 </span>
                <span class="n">total_acc_length</span> <span class="o">+=</span> <span class="n">acc_entities_length</span>
                <span class="n">total_prediction_length</span> <span class="o">+=</span> <span class="n">predict_entities_length</span>
                <span class="n">total_gold_length</span> <span class="o">+=</span> <span class="n">gold_entities_length</span>

        <span class="k">print</span><span class="p">(</span><span class="s2">"validate:"</span><span class="p">,</span> <span class="n">total_acc_length</span><span class="p">,</span> <span class="n">total_prediction_length</span><span class="p">,</span> <span class="n">total_gold_length</span><span class="p">)</span>
        <span class="c1"># 当准确预测的数量大于0, 并且总的预测标签量大于0, 计算验证集上的准确率, 召回率, F1值</span>
        <span class="k">if</span> <span class="n">total_acc_length</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">total_prediction_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">validate_mean_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">validate_data_list</span><span class="p">)</span>
            <span class="n">validate_epoch_acc</span> <span class="o">=</span> <span class="n">total_acc_length</span> <span class="o">/</span> <span class="n">total_prediction_length</span>
            <span class="n">validate_epoch_recall</span> <span class="o">=</span> <span class="n">total_acc_length</span> <span class="o">/</span> <span class="n">total_gold_length</span>
            <span class="n">validate_epoch_f1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">validate_epoch_acc</span> <span class="o">*</span> <span class="n">validate_epoch_recall</span> <span class="o">/</span> <span class="p">(</span><span class="n">validate_epoch_acc</span> <span class="o">+</span> <span class="n">validate_epoch_recall</span><span class="p">)</span>
            <span class="n">log_text</span> <span class="o">=</span> <span class="s2">"Epoch: </span><span class="si">%s</span><span class="s2"> | train loss: </span><span class="si">%.5f</span><span class="s2"> |train acc: </span><span class="si">%.3f</span><span class="s2"> |train recall: </span><span class="si">%.3f</span><span class="s2"> |train f1 score: </span><span class="si">%.3f</span><span class="s2">"</span> \
                       <span class="s2">" | validate loss: </span><span class="si">%.5f</span><span class="s2"> |validate acc: </span><span class="si">%.3f</span><span class="s2"> |validate recall: </span><span class="si">%.3f</span><span class="s2"> |validate f1 score: </span><span class="si">%.3f</span><span class="s2">"</span> <span class="o">%</span> \
                       <span class="p">(</span><span class="n">epoch</span><span class="p">,</span>
                        <span class="n">train_mean_loss</span><span class="p">,</span> <span class="n">train_epoch_acc</span><span class="p">,</span> <span class="n">train_epoch_recall</span><span class="p">,</span> <span class="n">train_epoch_f1</span><span class="p">,</span>
                        <span class="n">validate_mean_loss</span><span class="p">,</span> <span class="n">validate_epoch_acc</span><span class="p">,</span> <span class="n">validate_epoch_recall</span><span class="p">,</span> <span class="n">validate_epoch_f1</span><span class="p">)</span>
            <span class="n">log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_text</span><span class="o">+</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># 将当前轮次的重要统计量添加进列表中, 为后续的画图做准备</span>
            <span class="n">train_loss_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_mean_loss</span><span class="p">)</span>
            <span class="n">train_acc_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_epoch_acc</span><span class="p">)</span>
            <span class="n">train_recall_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_epoch_recall</span><span class="p">)</span>
            <span class="n">train_f1_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_epoch_f1</span><span class="p">)</span>
            <span class="n">validate_loss_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">validate_mean_loss</span><span class="p">)</span>
            <span class="n">validate_acc_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">validate_epoch_acc</span><span class="p">)</span>
            <span class="n">validate_recall_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">validate_epoch_recall</span><span class="p">)</span>
            <span class="n">validate_f1_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">validate_epoch_f1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"validate_total_prediction_length is zero"</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># 保存模型</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">model_saved_path</span><span class="p">)</span>

    <span class="c1"># 将 loss 下降历史数据转为图片存储</span>
    <span class="n">save_train_history_image</span><span class="p">(</span><span class="n">train_loss_history</span><span class="p">,</span>
                             <span class="n">validate_loss_history</span><span class="p">,</span>
                             <span class="n">train_history_image_path</span><span class="p">,</span>
                             <span class="s2">"Loss"</span><span class="p">)</span>
    <span class="c1"># 将准确率提升历史数据转为图片存储</span>
    <span class="n">save_train_history_image</span><span class="p">(</span><span class="n">train_acc_history</span><span class="p">,</span>
                             <span class="n">validate_acc_history</span><span class="p">,</span>
                             <span class="n">train_history_image_path</span><span class="p">,</span>
                             <span class="s2">"Acc"</span><span class="p">)</span>
    <span class="c1"># 将召回提升历史数据转为图片存储</span>
    <span class="n">save_train_history_image</span><span class="p">(</span><span class="n">train_recall_history</span><span class="p">,</span>
                             <span class="n">validate_recall_history</span><span class="p">,</span>
                             <span class="n">train_history_image_path</span><span class="p">,</span>
                             <span class="s2">"Recall"</span><span class="p">)</span>
    <span class="c1"># 将F1上升历史数据转为图片存储</span>
    <span class="n">save_train_history_image</span><span class="p">(</span><span class="n">train_f1_history</span><span class="p">,</span>
                             <span class="n">validate_f1_history</span><span class="p">,</span>
                             <span class="n">train_history_image_path</span><span class="p">,</span>
                             <span class="s2">"F1"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"train Finished"</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">))</span>

    <span class="c1"># 训练代码到此结束了, 最后打印一下训练好的模型中各个组成模块的参数详情, 以便开发人员核对</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">':'</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/train.py</li>
</ul>
<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_60"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_60 pre, #__code_60 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 直接在linux命令行上执行训练命令</span>
python train.py
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_61"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_61 pre, #__code_61 code"><span class="md-clipboard__message"></span></button><code><span class="n">Epoch</span> <span class="mi">1</span><span class="o">/</span><span class="mi">10</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1500</span><span class="o">/</span><span class="mi">1500</span> <span class="p">[</span><span class="mo">02</span><span class="p">:</span><span class="mi">49</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>  <span class="mf">8.83</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">train</span><span class="p">:</span> <span class="mi">1767</span> <span class="mi">2480</span> <span class="mi">2757</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1032</span><span class="o">/</span><span class="mi">1032</span> <span class="p">[</span><span class="mo">00</span><span class="p">:</span><span class="mi">44</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span> <span class="mf">23.26</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">validate</span><span class="p">:</span> <span class="mi">878</span> <span class="mi">2168</span> <span class="mi">1935</span>
<span class="n">Epoch</span> <span class="mi">2</span><span class="o">/</span><span class="mi">10</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1500</span><span class="o">/</span><span class="mi">1500</span> <span class="p">[</span><span class="mo">02</span><span class="p">:</span><span class="mi">46</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>  <span class="mf">9.03</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">train</span><span class="p">:</span> <span class="mi">1926</span> <span class="mi">2572</span> <span class="mi">2757</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1032</span><span class="o">/</span><span class="mi">1032</span> <span class="p">[</span><span class="mo">00</span><span class="p">:</span><span class="mi">44</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span> <span class="mf">22.99</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">validate</span><span class="p">:</span> <span class="mi">789</span> <span class="mi">1703</span> <span class="mi">1935</span>
<span class="n">Epoch</span> <span class="mi">3</span><span class="o">/</span><span class="mi">10</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1500</span><span class="o">/</span><span class="mi">1500</span> <span class="p">[</span><span class="mo">02</span><span class="p">:</span><span class="mi">46</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>  <span class="mf">9.02</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">train</span><span class="p">:</span> <span class="mi">1950</span> <span class="mi">2554</span> <span class="mi">2757</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1032</span><span class="o">/</span><span class="mi">1032</span> <span class="p">[</span><span class="mo">00</span><span class="p">:</span><span class="mi">45</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span> <span class="mf">22.75</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">validate</span><span class="p">:</span> <span class="mi">884</span> <span class="mi">2225</span> <span class="mi">1935</span>
<span class="n">Epoch</span> <span class="mi">4</span><span class="o">/</span><span class="mi">10</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1500</span><span class="o">/</span><span class="mi">1500</span> <span class="p">[</span><span class="mo">02</span><span class="p">:</span><span class="mi">48</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>  <span class="mf">8.90</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">train</span><span class="p">:</span> <span class="mi">1951</span> <span class="mi">2557</span> <span class="mi">2757</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1032</span><span class="o">/</span><span class="mi">1032</span> <span class="p">[</span><span class="mo">00</span><span class="p">:</span><span class="mi">44</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span> <span class="mf">23.02</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">validate</span><span class="p">:</span> <span class="mi">999</span> <span class="mi">4381</span> <span class="mi">1935</span>
<span class="n">Epoch</span> <span class="mi">5</span><span class="o">/</span><span class="mi">10</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1500</span><span class="o">/</span><span class="mi">1500</span> <span class="p">[</span><span class="mo">02</span><span class="p">:</span><span class="mi">48</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>  <span class="mf">8.90</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">train</span><span class="p">:</span> <span class="mi">2016</span> <span class="mi">2589</span> <span class="mi">2757</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1032</span><span class="o">/</span><span class="mi">1032</span> <span class="p">[</span><span class="mo">00</span><span class="p">:</span><span class="mi">43</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span> <span class="mf">23.51</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">validate</span><span class="p">:</span> <span class="mi">667</span> <span class="mi">1609</span> <span class="mi">1935</span>
<span class="n">Epoch</span> <span class="mi">6</span><span class="o">/</span><span class="mi">10</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1500</span><span class="o">/</span><span class="mi">1500</span> <span class="p">[</span><span class="mo">02</span><span class="p">:</span><span class="mi">47</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>  <span class="mf">8.97</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">train</span><span class="p">:</span> <span class="mi">1939</span> <span class="mi">2580</span> <span class="mi">2757</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1032</span><span class="o">/</span><span class="mi">1032</span> <span class="p">[</span><span class="mo">00</span><span class="p">:</span><span class="mi">44</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span> <span class="mf">23.45</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">validate</span><span class="p">:</span> <span class="mi">660</span> <span class="mi">1503</span> <span class="mi">1935</span>
<span class="n">Epoch</span> <span class="mi">7</span><span class="o">/</span><span class="mi">10</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1500</span><span class="o">/</span><span class="mi">1500</span> <span class="p">[</span><span class="mo">02</span><span class="p">:</span><span class="mi">44</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>  <span class="mf">9.13</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">train</span><span class="p">:</span> <span class="mi">1850</span> <span class="mi">2585</span> <span class="mi">2757</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1032</span><span class="o">/</span><span class="mi">1032</span> <span class="p">[</span><span class="mo">00</span><span class="p">:</span><span class="mi">44</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span> <span class="mf">23.08</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">validate</span><span class="p">:</span> <span class="mi">866</span> <span class="mi">2085</span> <span class="mi">1935</span>
<span class="n">Epoch</span> <span class="mi">8</span><span class="o">/</span><span class="mi">10</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1500</span><span class="o">/</span><span class="mi">1500</span> <span class="p">[</span><span class="mo">02</span><span class="p">:</span><span class="mi">48</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>  <span class="mf">8.92</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">train</span><span class="p">:</span> <span class="mi">1943</span> <span class="mi">2573</span> <span class="mi">2757</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1032</span><span class="o">/</span><span class="mi">1032</span> <span class="p">[</span><span class="mo">00</span><span class="p">:</span><span class="mi">44</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span> <span class="mf">23.01</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">validate</span><span class="p">:</span> <span class="mi">770</span> <span class="mi">2529</span> <span class="mi">1935</span>
<span class="n">Epoch</span> <span class="mi">9</span><span class="o">/</span><span class="mi">10</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1500</span><span class="o">/</span><span class="mi">1500</span> <span class="p">[</span><span class="mo">02</span><span class="p">:</span><span class="mi">48</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>  <span class="mf">8.92</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">train</span><span class="p">:</span> <span class="mi">1986</span> <span class="mi">2576</span> <span class="mi">2757</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1032</span><span class="o">/</span><span class="mi">1032</span> <span class="p">[</span><span class="mo">00</span><span class="p">:</span><span class="mi">44</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span> <span class="mf">23.07</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">validate</span><span class="p">:</span> <span class="mi">876</span> <span class="mi">2662</span> <span class="mi">1935</span>
<span class="n">Epoch</span> <span class="mi">10</span><span class="o">/</span><span class="mi">10</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1500</span><span class="o">/</span><span class="mi">1500</span> <span class="p">[</span><span class="mo">02</span><span class="p">:</span><span class="mi">46</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span>  <span class="mf">8.98</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">train</span><span class="p">:</span> <span class="mi">1993</span> <span class="mi">2599</span> <span class="mi">2757</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">█████████████████████████████████████████████████████████████████████</span><span class="o">|</span> <span class="mi">1032</span><span class="o">/</span><span class="mi">1032</span> <span class="p">[</span><span class="mo">00</span><span class="p">:</span><span class="mi">44</span><span class="o">&lt;</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">,</span> <span class="mf">23.32</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">validate</span><span class="p">:</span> <span class="mi">1032</span> <span class="mi">3740</span> <span class="mi">1935</span>
<span class="o">-------------------------------------------</span><span class="n">train</span> <span class="n">Finished</span><span class="o">-------------------------------------------</span>
<span class="n">transitions</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="n">word_embeds</span><span class="o">.</span><span class="n">weight</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">22303</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
<span class="n">lstm</span><span class="o">.</span><span class="n">weight_ih_l0</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
<span class="n">lstm</span><span class="o">.</span><span class="n">weight_hh_l0</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>
<span class="n">lstm</span><span class="o">.</span><span class="n">bias_ih_l0</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">200</span><span class="p">])</span>
<span class="n">lstm</span><span class="o">.</span><span class="n">bias_hh_l0</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">200</span><span class="p">])</span>
<span class="n">lstm</span><span class="o">.</span><span class="n">weight_ih_l0_reverse</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
<span class="n">lstm</span><span class="o">.</span><span class="n">weight_hh_l0_reverse</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>
<span class="n">lstm</span><span class="o">.</span><span class="n">bias_ih_l0_reverse</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">200</span><span class="p">])</span>
<span class="n">lstm</span><span class="o">.</span><span class="n">bias_hh_l0_reverse</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">200</span><span class="p">])</span>
<span class="n">hidden2tag</span><span class="o">.</span><span class="n">weight</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">hidden2tag</span><span class="o">.</span><span class="n">bias</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">7</span><span class="p">])</span>
</code></pre></div>

<hr>
<ul>
<li>
<p>第八步: 训练集和验证集损失曲线和指标数据曲线的分析</p>
<ul>
<li>训练和验证损失对照曲线:</li>
</ul>
</li>
</ul>
<p></p><center><img alt="loss" src="./index_files/bilstm_crf_train_Loss.png"></center><p></p>
<hr>
<blockquote>
<ul>
<li>分析: 损失对照曲线一直下降, 从第5个epoch开始, 迅速降到比较理想的位置, 说明模型能够从数据中获取规律了, 到第40个批次之后, 模型趋于稳定, 说明参数基本能够已经得到最优化效果, 此时, 根据对scheduler的设置, 通过该方法已经对优化器进行了近8次的迭代, 应该在我们原本设置的初始学习率基础上缩小了0.2的8次方倍, 此时应该找到了当前最优解, 因此也就趋于稳定了.</li>
</ul>
</blockquote>
<hr>
<ul>
<li>训练和验证准确率对照曲线:
<center><img alt="acc" src="./index_files/bilstm_crf_train_Acc.png"></center></li>
</ul>
<hr>
<blockquote>
<ul>
<li>分析:</li>
<li>首先，准确率是指识别**正确的实体**占**识别出的实体**中的比例.</li>
<li>根据对照曲线来看，整体学习结果都在趋于准确率上升方向增加，而且随着批次的增加曲线震动相对平稳，不过可能由于训练与验证样本分布不均衡或者噪声等原因，导致最终验证集的准确度没有达到与训练集相同的情况.</li>
<li>最终的训练集和验证集的召回率分别在：0.85和0.78左右.</li>
</ul>
</blockquote>
<hr>
<ul>
<li>训练和验证召回率对照曲线:
<center><img alt="recall" src="./index_files/bilstm_crf_train_Recall.png"></center></li>
</ul>
<hr>
<blockquote>
<ul>
<li>分析:</li>
<li>在此召回率是指**识别正确的实体**占当前批次所包含的**所有实体总数**的比例.</li>
<li>关于训练和验证召回率对照曲线，可以看出召回率的变化相对比较平滑，基本上也在40步左右趋于稳定.</li>
<li>最终的训练集和验证集的召回率分别在：0.83和0.75左右.</li>
</ul>
</blockquote>
<hr>
<ul>
<li>训练和验证F1值对照曲线:</li>
</ul>
<p></p><center><img alt="F1" src="./index_files/bilstm_crf_train_F1.png"></center><p></p>
<hr>
<blockquote>
<ul>
<li>分析:</li>
<li>F1值主要是指训练效果而言，在不多识别实体的情况下同时提高准确度的衡量指标.</li>
<li>其公式为：2×准确率×召回率 / (准确率**+**召回率)</li>
<li>从曲线可见整体F1值上升与损失、召回率的曲线比较接近，说明在识别出的实体中，正确率比较问题，不过根据前面的准确度来分析，可能在识别过程中，增加了识别出的实体个数而导致不稳定。从这方面来说，可以验证样本不均衡问题以及噪声对模型的影响还是比较大的。</li>
<li>从整体而言，F1值基本也在第40步之后趋于稳定，最终的训练集和验证集的结果在：0.85和0.75左右。</li>
</ul>
</blockquote>
<hr>
<ul>
<li>小节总结:<ul>
<li>学习了数据预处理的相关方法<ul>
<li>原始数据集的字符经过数字化编码变成向量</li>
<li>标注数据集的字符经过数字化编码变成向量</li>
</ul>
</li>
<li>学习生成批量训练数据的方法</li>
<li>学习了模型训练相关代码的实现<ul>
<li>准确率和召回率评估的代码</li>
<li>模型构建类的全部内部函数代码</li>
<li>启动训练流程的代码</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="66">6.6 模型使用<a class="headerlink" href="#66" title="Permanent link">¶</a></h2>
<ul>
<li>学习目标:<ul>
<li>掌握模型单条文本预测代码实现</li>
<li>掌握批量文件夹文件预测代码实现</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>模型单条文本预测代码实现:</li>
</ul>
<div class="highlight"><pre id="__code_62"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_62 pre, #__code_62 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入工具包</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">bilstm_crf</span> <span class="kn">import</span> <span class="n">BiLSTM_CRF</span>

<span class="c1"># 完成中文文本数字化映射的函数</span>
<span class="k">def</span> <span class="nf">prepare_sequence</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">char_to_id</span><span class="p">):</span>
    <span class="n">char_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
        <span class="c1"># 判断若字符不在码表对应字典中, 则取NUK的编码(即unknown), 否则取对应的字符编码</span>
        <span class="k">if</span> <span class="n">char_to_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">char</span><span class="p">):</span>
            <span class="n">char_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_to_id</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">char_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_to_id</span><span class="p">[</span><span class="s2">"&lt;UNK&gt;"</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">char_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>

<span class="c1"># 单样本预测的函数</span>
<span class="k">def</span> <span class="nf">singel_predict</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span>
                   <span class="n">content</span><span class="p">,</span>
                   <span class="n">char_to_id_json_path</span><span class="p">,</span>
                   <span class="n">embedding_dim</span><span class="p">,</span>
                   <span class="n">hidden_dim</span><span class="p">,</span>
                   <span class="n">target_type_list</span><span class="p">,</span>
                   <span class="n">tag_to_id</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    函数功能:                单句命名实体识别预测，返回实体列表</span>
<span class="sd">    model_path:             模型文件路径</span>
<span class="sd">    content:                待预测文本</span>
<span class="sd">    char_to_id_json_path:   字符码表文件路径</span>
<span class="sd">    embedding_dim:          字向量维度</span>
<span class="sd">    hidden_dim:             BiLSTM 隐藏层向量维度</span>
<span class="sd">    target_type_list:       待匹配类型，符合条件的实体将会被提取出来</span>
<span class="sd">    tag_to_id:              标签码表对照字典，标签对应 id</span>
<span class="sd">    """</span>
    <span class="c1"># 加载数字化映射字典</span>
    <span class="n">char_to_id</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">char_to_id_json_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf8"</span><span class="p">))</span>
    <span class="c1"># 实例化类对象</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BiLSTM_CRF</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">char_to_id</span><span class="p">),</span> <span class="n">tag_to_id</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
    <span class="c1"># 加载已经训练好的模型</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>
    <span class="c1"># 获取需要提取的 tag 对应的 id 列表</span>
    <span class="n">tag_id_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tag_to_id</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">target_type_list</span><span class="p">}</span>
    <span class="c1"># 定义返回实体列表</span>
    <span class="n">entities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># 预测阶段不求解梯度, 不更新参数</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="c1"># 将待预测的文本进行数字化映射</span>
        <span class="n">sentence_in</span> <span class="o">=</span> <span class="n">prepare_sequence</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">char_to_id</span><span class="p">)</span>
        <span class="c1"># 直接调用模型进行维特比解码</span>
        <span class="n">score</span><span class="p">,</span> <span class="n">best_path_list</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">sentence_in</span><span class="p">)</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">char_idx</span><span class="p">,</span> <span class="n">tag_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">best_path_list</span><span class="p">):</span>
            <span class="c1"># 若预测结果 tag_id 属于目标字典数据 key 中</span>
            <span class="k">if</span> <span class="n">tag_id</span> <span class="ow">in</span> <span class="n">tag_id_dict</span><span class="p">:</span>
                <span class="c1"># 取符合匹配字典id的第一个字符，即[B, I]</span>
                <span class="n">tag_index</span> <span class="o">=</span> <span class="n">tag_id_dict</span><span class="p">[</span><span class="n">tag_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># 计算当前字符确切的下标位置</span>
                <span class="n">current_char</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">char_idx</span><span class="p">]</span>
                <span class="c1"># 若当前字标签起始为B, 则设置为实体开始</span>
                <span class="k">if</span> <span class="n">tag_index</span> <span class="o">==</span> <span class="s2">"B"</span><span class="p">:</span>
                    <span class="n">entity</span> <span class="o">=</span> <span class="n">current_char</span>
                <span class="c1"># 若当前字标签起始为I, 则进行字符串追加</span>
                <span class="k">elif</span> <span class="n">tag_index</span> <span class="o">==</span> <span class="s2">"I"</span> <span class="ow">and</span> <span class="n">entity</span><span class="p">:</span>
                    <span class="n">entity</span> <span class="o">+=</span> <span class="n">current_char</span>
            <span class="c1"># 当实体不为空且当前标签类型为O时, 加入实体列表</span>
            <span class="k">if</span> <span class="n">tag_id</span> <span class="o">==</span> <span class="n">tag_to_id</span><span class="p">[</span><span class="s2">"O"</span><span class="p">]</span> <span class="ow">and</span> <span class="n">entity</span><span class="p">:</span>
                <span class="c1"># 满足当前字符为O, 上一个字符为目标提取实体结尾时, 将其加入实体列表</span>
                <span class="k">if</span> <span class="s2">"、"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> <span class="ow">and</span> <span class="s2">"～"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> <span class="ow">and</span> <span class="s2">"。"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> \
                    <span class="ow">and</span> <span class="s2">"”"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> <span class="ow">and</span> <span class="s2">"："</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> <span class="ow">and</span> <span class="s2">":"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> \
                    <span class="ow">and</span> <span class="s2">"，"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> <span class="ow">and</span> <span class="s2">","</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> <span class="ow">and</span> <span class="s2">"."</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> \
                    <span class="ow">and</span> <span class="s2">";"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> <span class="ow">and</span> <span class="s2">"；"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> <span class="ow">and</span> <span class="s2">"【"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> \
                    <span class="ow">and</span> <span class="s2">"】"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> <span class="ow">and</span> <span class="s2">"["</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span> <span class="ow">and</span> <span class="s2">"]"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span><span class="p">:</span>
                    <span class="n">entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
                <span class="c1"># 重置为空, 准备下一个实体的识别</span>
                <span class="n">entity</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># 返回单条文本中所有识别出来的命名实体, 以集合的形式返回</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/predict.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_63"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_63 pre, #__code_63 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 待识别文本</span>
<span class="n">content</span> <span class="o">=</span> <span class="s2">"本病是由DNA病毒的单纯疱疹病毒所致。人类单纯疱疹病毒分为两型，"</span> \
<span class="s2">"即单纯疱疹病毒Ⅰ型（HSV-Ⅰ）和单纯疱疹病毒Ⅱ型（HSV-Ⅱ）。"</span> \
<span class="s2">"Ⅰ型主要引起生殖器以外的皮肤黏膜（口腔黏膜）和器官（脑）的感染。"</span> \
<span class="s2">"Ⅱ型主要引起生殖器部位皮肤黏膜感染。"</span> \
<span class="s2">"病毒经呼吸道、口腔、生殖器黏膜以及破损皮肤进入体内，"</span> \
<span class="s2">"潜居于人体正常黏膜、血液、唾液及感觉神经节细胞内。"</span> \
<span class="s2">"当机体抵抗力下降时，如发热胃肠功能紊乱、月经、疲劳等时，"</span> \
<span class="s2">"体内潜伏的HSV被激活而发病。"</span>

<span class="c1"># 模型保存路径</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="s2">"model/bilstm_crf_state_dict_20200116_172138.pt"</span>

<span class="c1"># 词嵌入维度</span>
<span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>

<span class="c1"># 隐藏层维度</span>
<span class="n">HIDDEN_DIM</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># 标签数字化映射字典</span>
<span class="n">tag_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"O"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">"&lt;START&gt;"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">"&lt;STOP&gt;"</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>

<span class="c1"># 字符数字化映射字典的存储文件</span>
<span class="n">char_to_id_json_path</span> <span class="o">=</span> <span class="s2">"./data/char_to_id.json"</span>

<span class="c1"># 预测结果存储路径</span>
<span class="n">prediction_result_path</span> <span class="o">=</span> <span class="s2">"prediction_result"</span>

<span class="c1"># 待匹配标签类型</span>
<span class="n">target_type_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"sym"</span><span class="p">]</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_64"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_64 pre, #__code_64 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 单独文本预测, 获得实体结果</span>
<span class="n">entities</span> <span class="o">=</span> <span class="n">singel_predict</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span>
                          <span class="n">content</span><span class="p">,</span>
                          <span class="n">char_to_id_json_path</span><span class="p">,</span>
                          <span class="n">EMBEDDING_DIM</span><span class="p">,</span>
                          <span class="n">HIDDEN_DIM</span><span class="p">,</span>
                          <span class="n">target_type_list</span><span class="p">,</span>
                          <span class="n">tag_to_id</span><span class="p">)</span>

<span class="c1"># 打印实体结果</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"entities:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">entities</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_65"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_65 pre, #__code_65 code"><span class="md-clipboard__message"></span></button><code>entities:
['感染', '发热', '##']
</code></pre></div>

<hr>
<ul>
<li>批量文件夹文件预测代码实现:</li>
</ul>
<div class="highlight"><pre id="__code_66"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_66 pre, #__code_66 code"><span class="md-clipboard__message"></span></button><code><span class="k">def</span> <span class="nf">batch_predict</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span>
                  <span class="n">model_path</span><span class="p">,</span>
                  <span class="n">char_to_id_json_path</span><span class="p">,</span>
                  <span class="n">embedding_dim</span><span class="p">,</span>
                  <span class="n">hidden_dim</span><span class="p">,</span>
                  <span class="n">target_type_list</span><span class="p">,</span>
                  <span class="n">prediction_result_path</span><span class="p">,</span>
                  <span class="n">tag_to_id</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    函数功能: 批量预测, 查询文件目录下数据,</span>
<span class="sd">              从中提取符合条件的实体并存储至新的目录[prediction_result_path]</span>
<span class="sd">    data_path:               数据文件路径</span>
<span class="sd">    model_path:              模型文件路径</span>
<span class="sd">    char_to_id_json_path:    字符码表文件路径</span>
<span class="sd">    embedding_dim:           字向量维度</span>
<span class="sd">    hidden_dim:              隐藏层维度</span>
<span class="sd">    target_type_list:        待匹配标签类型</span>
<span class="sd">    prediction_result_path:  预测结果保存路径</span>
<span class="sd">    tag_to_id:               标签映射字典</span>
<span class="sd">    """</span>
    <span class="c1"># 迭代路径, 读取文件名</span>
    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)):</span>
        <span class="c1"># 拼装全路径</span>
        <span class="n">fullpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        <span class="c1"># 定义输出结果文件</span>
        <span class="n">entities_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prediction_result_path</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"txt"</span><span class="p">,</span> <span class="s2">"csv"</span><span class="p">)),</span>
                             <span class="n">mode</span><span class="o">=</span><span class="s2">"w"</span><span class="p">,</span>
                             <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fullpath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># 读取文件内容</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="c1"># 调用单个预测模型，输出为目标类型实体文本列表</span>
            <span class="n">entities</span> <span class="o">=</span> <span class="n">singel_predict</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span>
                                      <span class="n">content</span><span class="p">,</span>
                                      <span class="n">char_to_id_json_path</span><span class="p">,</span>
                                      <span class="n">embedding_dim</span><span class="p">,</span>
                                      <span class="n">hidden_dim</span><span class="p">,</span>
                                      <span class="n">target_type_list</span><span class="p">,</span>
                                      <span class="n">tag_to_id</span><span class="p">)</span>
            <span class="c1"># 写入识别结果文件</span>
            <span class="n">entities_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">entities</span><span class="p">))</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">"batch_predict Finished"</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">))</span>
</code></pre></div>

<hr>
<ul>
<li>代码实现位置: /data/doctor_offline/ner_model/predict.py</li>
</ul>
<hr>
<ul>
<li>输入参数:</li>
</ul>
<div class="highlight"><pre id="__code_67"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_67 pre, #__code_67 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 模型保存路径</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="s2">"model/bilstm_crf_state_dict_20200116_172138.pt"</span>

<span class="c1"># 字向量维度</span>
<span class="n">EMBEDDING_DIM</span> <span class="o">=</span> <span class="mi">200</span>

<span class="c1"># 隐层维度</span>
<span class="n">HIDDEN_DIM</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># 标签码表对照字典</span>
<span class="n">tag_to_id</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"O"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"B-dis"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"I-dis"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"B-sym"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">"I-sym"</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">"&lt;START&gt;"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">"&lt;STOP&gt;"</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>

<span class="c1"># 字符码表文件路径</span>
<span class="n">char_to_id_json_path</span> <span class="o">=</span> <span class="s2">"char_to_id.json"</span>

<span class="c1"># 预测结果存储路径</span>
<span class="n">prediction_result_path</span> <span class="o">=</span> <span class="s2">"prediction_result"</span>

<span class="c1"># 待匹配标签类型</span>
<span class="n">target_type_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"sym"</span><span class="p">]</span>

<span class="c1"># 待预测文本文件所在目录</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="s2">"/data/doctor_offline/unstructured/norecognized/"</span>
</code></pre></div>

<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_68"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_68 pre, #__code_68 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 批量文本预测, 并将结果写入文件中</span>
<span class="n">batch_predict</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span>
              <span class="n">model_path</span><span class="p">,</span>
              <span class="n">char_to_id_json_path</span><span class="p">,</span>
              <span class="n">EMBEDDING_DIM</span><span class="p">,</span>
              <span class="n">HIDDEN_DIM</span><span class="p">,</span>
              <span class="n">target_type_list</span><span class="p">,</span>
              <span class="n">prediction_result_path</span><span class="p">,</span>
              <span class="n">tag_to_id</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>输出效果: 将识别结果保存至prediction_result_path指定的目录下, 名称与源文件一致, 内容为每行存储识别实体名称</li>
</ul>
<hr>
<ul>
<li>小节总结:<ul>
<li>学习了模型单条文本预测代码实现</li>
<li>学习了批量文件夹文件预测代码实现</li>
</ul>
</li>
</ul>
<hr>
<hr>
<hr>
<hr>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="./index5.html" title="第五章:命名实体审核任务" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                第五章:命名实体审核任务
              </span>
            </div>
          </a>
        
        
          <a href="./index7.html" title="第七章:在线部分" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                第七章:在线部分
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            ©Copyright 2019, itcast.cn.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org/">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="./index_files/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:".."}})</script>
      
    
  
</body></html>