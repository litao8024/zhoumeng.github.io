<!DOCTYPE html>
<!-- saved from url=(0029)http://121.199.45.168:8888/8/ -->
<html lang="en" class="js json svg checked target dataset details fetch supports csstransforms3d no-ios" style=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
      
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://0.0.0.0:8888/8/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="./index_files/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-4.4.0">
    
    
      
        <title>第八章:句子主题相关任务 - DOCTOR</title>
      
    
    
      <link rel="stylesheet" href="./index_files/application.0284f74d.css">
      
      
    
    
      <script src="./index_files/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin="">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&amp;display=fallback">
        <link rel="stylesheet" href="./index_files/css">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="./index_files/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-36723568-3", "mkdocs.org")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async="" src="./index_files/analytics.js"></script>
      
    
    
  <script type="text/javascript">(function(){var s=document.createElement("script");var port=window.location.port;s.src="//"+window.location.hostname+":"+port+ "/livereload.js?port=" + port;document.head.appendChild(s);})();</script><script src="./index_files/livereload.js"></script></head>
  
    <body dir="ltr" data-md-state="">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#81" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header" data-md-state="shadow">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="#" title="DOCTOR" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic" style="width: 882px;">
              DOCTOR
            </span>
            <span class="md-header-nav__topic" style="width: 882px;">
              
                第八章:句子主题相关任务
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix="">
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" style="height: 851px;">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="#" title="DOCTOR" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    DOCTOR
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix="">
    
      
      
      


  <li class="md-nav__item">
    <a href="./index.html" title="第一章:背景介绍与Unit的使用" class="md-nav__link">
      第一章:背景介绍与Unit的使用
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index2.html" title="第二章:在线医生的总体架构与工具介绍" class="md-nav__link">
      第二章:在线医生的总体架构与工具介绍
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index3.html" title="第三章:neo4j图数据库" class="md-nav__link">
      第三章:neo4j图数据库
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index4.html" title="第四章:离线部分" class="md-nav__link">
      第四章:离线部分
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index5.html" title="第五章:命名实体审核任务" class="md-nav__link">
      第五章:命名实体审核任务
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index6.html" title="第六章:命名实体识别任务" class="md-nav__link">
      第六章:命名实体识别任务
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index7.html" title="第七章:在线部分" class="md-nav__link">
      第七章:在线部分
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        第八章:句子主题相关任务
      </label>
    
    <a href="" title="第八章:句子主题相关任务" class="md-nav__link md-nav__link--active">
      第八章:句子主题相关任务
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix="">
      
        <li class="md-nav__item">
  <a href="#81" title="8.1 任务介绍与模型选用" class="md-nav__link">
    8.1 任务介绍与模型选用
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#82" title="8.2 训练数据集" class="md-nav__link">
    8.2 训练数据集
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#83-bert" title="8.3 BERT中文预训练模型" class="md-nav__link">
    8.3 BERT中文预训练模型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#84" title="8.4 微调模型" class="md-nav__link">
    8.4 微调模型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#85" title="8.5 进行模型训练" class="md-nav__link">
    8.5 进行模型训练
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#86" title="8.6 模型部署" class="md-nav__link">
    8.6 模型部署
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index9.html" title="第九章:系统联调与测试" class="md-nav__link">
      第九章:系统联调与测试
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="./index10.html" title="附录:环境安装部署手册" class="md-nav__link">
      附录:环境安装部署手册
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" style="height: 851px;">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix="">
      
        <li class="md-nav__item">
  <a href="#81" title="8.1 任务介绍与模型选用" class="md-nav__link">
    8.1 任务介绍与模型选用
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#82" title="8.2 训练数据集" class="md-nav__link">
    8.2 训练数据集
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#83-bert" title="8.3 BERT中文预训练模型" class="md-nav__link">
    8.3 BERT中文预训练模型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#84" title="8.4 微调模型" class="md-nav__link">
    8.4 微调模型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#85" title="8.5 进行模型训练" class="md-nav__link">
    8.5 进行模型训练
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#86" title="8.6 模型部署" class="md-nav__link">
    8.6 模型部署
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>第八章:句子主题相关任务</h1>
                
                <h2 id="81">8.1 任务介绍与模型选用<a class="headerlink" href="#81" title="Permanent link">¶</a></h2>
<ul>
<li>学习目标:<ul>
<li>了解句子主题相关任务的相关知识.</li>
<li>了解选用的模型及其原因.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>句子主题相关任务: <ul>
<li>在多轮对话系统中, 往往需要判断用户的最近两次回复是否围绕同一主题, 来决定问答机器人是否也根据自己上一次的回复来讨论相关内容. 在线医生问答过程中, 同样需要这样的处理, 确保用户一直讨论疾病有关的内容, 来根据症状推断病情. 这种任务的形式与判断两个句子是否连贯的形式相同, 他们都需要输入两段文本内容, 返回'是'或'否'的二分类标签.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>选用的模型及其原因:<ul>
<li>对话系统是开放的语言处理系统, 可能出现各种文字, 当我们的训练集有限无法覆盖大多数情况时, 可以直接使用预训练模型进行文字表示. 我们这里使用了bert-chinese预训练模型, 同时为了适应我们研究的垂直领域, 我们在后面自定义浅层的微调模型, 它将由两层全连接网络组成, 之后我们会详细介绍. </li>
</ul>
</li>
</ul>
<hr>
<h2 id="82">8.2 训练数据集<a class="headerlink" href="#82" title="Permanent link">¶</a></h2>
<ul>
<li>学习目标:<ul>
<li>了解训练数据集的样式及其相关解释.</li>
<li>了解训练数据集的来源和扩充方式.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>训练数据集的样式:</li>
</ul>
<div class="highlight"><pre id="__code_0"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_0 pre, #__code_0 code"><span class="md-clipboard__message"></span></button><code><span class="mi">1</span>       <span class="err">腹股沟淋巴结肿大腹股沟皮下包块</span>  <span class="err">想请您帮忙解读一下上面的</span><span class="n">b超结果</span><span class="err">，是否要治疗，或做进一步的检查？</span><span class="o">&gt;</span><span class="err">因为做完</span><span class="n">b超医生下班了</span>
<span class="mi">1</span>       <span class="err">想请您帮忙解读一下上面的</span><span class="n">b超结果</span><span class="err">，是否要治疗，或做进一步的检查？因为做完</span><span class="n">b超医生下班了</span>    <span class="err">左侧的包</span>
<span class="err">块是否是普通的淋巴结肿大？</span>
<span class="mi">1</span>       <span class="err">左侧的包块是否是普通的淋巴结肿大？</span>      <span class="err">按压不疼，但用手敲会有点刺痛</span>
<span class="mi">1</span>       <span class="err">按压不疼，但用手敲会有点刺痛</span>    <span class="err">？</span>
<span class="mi">1</span>       <span class="err">抗谬肋氏管激素偏低抗缪肋氏管激素偏低</span>    <span class="err">昨天同房后出血了，以前都不会，先是鲜红色，今天变褐色，少</span>
<span class="err">量，不想去医院检查，过几天它会自己停吧？还是要吃什么药？</span>
<span class="mi">0</span>       <span class="err">水痘水痘后第七天脸上色素严重</span>    <span class="err">五险一金会下调吗</span>
<span class="mi">0</span>       <span class="err">腺样体重度肥大，分泌性中耳炎宝宝腺样体肥大怎么办</span>        <span class="err">我爸因车祸死亡意外险能赔偿吗</span>
<span class="mi">0</span>       <span class="err">尿血尿血这种情况要求高不高治疗</span>  <span class="err">车辆保险理赔回执弄丢了可以补吗</span>
<span class="mi">0</span>       <span class="err">尿路感染尿路感染备孕中</span>  <span class="err">在单位辞职了，当时没办医保，是否能申办居民医保？</span>
<span class="mi">0</span>       <span class="err">眼角有血块左眼角有血块状</span>        <span class="err">有谁知道，安</span><span class="o">*</span><span class="err">长</span><span class="o">*</span><span class="err">树出险了需要提供哪些医院证明？</span>
</code></pre></div>

<hr>
<ul>
<li>数据集的相关解释:<ul>
<li>数据集中的第一列代表标签, 1为正标签, 代表后面的两句话是在讨论同一主题. 0为负标签, 代表后面的两句话不相关.  </li>
<li>数据集中的第二列是用户回复的文本信息, 第三列是与上一句相关或不相关的文本.</li>
<li>正负样本的比例是1:1左右 </li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>数据集所在位置: /data/doctor_online/bert_serve/train_data.csv</li>
</ul>
<hr>
<ul>
<li>数据集来源及其扩充方式:<ul>
<li>来源: 正样本数据来自网络医患在线问答的真实语料. 负样本来自其他使用其他问答语料的回复信息, 保证两段文本不相关.</li>
<li>扩充方式: 根据来源, 可通过数据抓取技术对语料集进行扩充.</li>
</ul>
</li>
</ul>
<hr>
<h2 id="83-bert">8.3 BERT中文预训练模型<a class="headerlink" href="#83-bert" title="Permanent link">¶</a></h2>
<ul>
<li>学习目标:<ul>
<li>了解BERT中文预训练模型的有关知识和作用.</li>
<li>掌握使用BERT中文预训练模型对句子编码的过程.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>BERT中文预训练模型:<ul>
<li>BERT模型整体架构基于Transformer模型架构(只使用Transformer中的编码器), BERT中文预训练模型的Transformer编码器具有12层, 输出层中的线性层具有768个节点, 即输出张量最后一维的维度是768. 它使用的多头注意力机制结构中, 头的数量为12, 模型总参数量为110M. 同时, 它在中文简体和繁体上进行训练, 因此适合中文简体和繁体任务.  </li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>BERT中文预训练模型作用:<ul>
<li>在实际的文本任务处理中, 有些训练语料很难获得, 他们的总体数量和包含的词汇总数都非常少, 不适合用于训练带有Embedding层的模型, 但这些数据中却又蕴含这一些有价值的规律可以被模型挖掘, 在这种情况下,使用预训练模型对原始文本进行编码是非常不错的选择, 因为预训练模型来自大型语料, 能够使得当前文本具有意义, 虽然这些意义可能并不针对某个特定领域, 但是这种缺陷可以使用微调模型来进行弥补.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>使用BERT中文预训练模型对两个句子进行编码:</li>
</ul>
<div class="highlight"><pre id="__code_1"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_1 pre, #__code_1 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="kn">as</span> <span class="nn">nn</span>


<span class="c1"># 使用torch.hub加载bert中文模型的字映射器</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'huggingface/pytorch-transformers'</span><span class="p">,</span> <span class="s1">'tokenizer'</span><span class="p">,</span> <span class="s1">'bert-base-chinese'</span><span class="p">)</span>
<span class="c1"># 使用torch.hub加载bert中文模型</span>
<span class="n">model</span> <span class="o">=</span>  <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'huggingface/pytorch-transformers'</span><span class="p">,</span> <span class="s1">'model'</span><span class="p">,</span> <span class="s1">'bert-base-chinese'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_bert_encode</span><span class="p">(</span><span class="n">text_1</span><span class="p">,</span> <span class="n">text_2</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="mi">102</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    description: 使用bert中文模型对输入的文本对进行编码</span>
<span class="sd">    :param text_1: 代表输入的第一句话</span>
<span class="sd">    :param text_2: 代表输入的第二句话</span>
<span class="sd">    :param mark: 分隔标记, 是预训练模型tokenizer本身的标记符号, 当输入是两个文本时,</span>
<span class="sd">                 得到的index_tokens会以102进行分隔</span>
<span class="sd">    :param max_len: 文本的允许最大长度, 也是文本的规范长度即大于该长度要被截断, 小于该长度要进行0补齐</span>
<span class="sd">    :return 输入文本的bert编码</span>
<span class="sd">    """</span>
    <span class="c1"># 使用tokenizer的encode方法对输入的两句文本进行字映射.</span>
    <span class="n">indexed_tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text_1</span><span class="p">,</span> <span class="n">text_2</span><span class="p">)</span>
    <span class="c1"># 准备对映射后的文本进行规范长度处理即大于该长度要被截断, 小于该长度要进行0补齐</span>
    <span class="c1"># 所以需要先找到分隔标记的索引位置</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">indexed_tokens</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mark</span><span class="p">)</span>
    <span class="c1"># 首先对第一句话进行长度规范因此将indexed_tokens截取到[:k]判断</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indexed_tokens</span><span class="p">[:</span><span class="n">k</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">max_len</span><span class="p">:</span>
        <span class="c1"># 如果大于max_len, 则进行截断</span>
        <span class="n">indexed_tokens_1</span> <span class="o">=</span> <span class="n">indexed_tokens</span><span class="p">[:</span><span class="n">max_len</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 否则使用[0]进行补齐, 补齐的0的个数就是max_len-len(indexed_tokens[:k])</span>
        <span class="n">indexed_tokens_1</span> <span class="o">=</span> <span class="n">indexed_tokens</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_len</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">indexed_tokens</span><span class="p">[:</span><span class="n">k</span><span class="p">]))</span><span class="o">*</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># 同理下面是对第二句话进行规范长度处理, 因此截取[k:]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indexed_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">:])</span> <span class="o">&gt;=</span> <span class="n">max_len</span><span class="p">:</span>
        <span class="c1"># 如果大于max_len, 则进行截断</span>
        <span class="n">indexed_tokens_2</span> <span class="o">=</span> <span class="n">indexed_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">max_len</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
         <span class="c1"># 否则使用[0]进行补齐, 补齐的0的个数就是max_len-len(indexed_tokens[:k])</span>
        <span class="n">indexed_tokens_2</span> <span class="o">=</span> <span class="n">indexed_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_len</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">indexed_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">:]))</span><span class="o">*</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># 最后将处理后的indexed_tokens_1和indexed_tokens_2再进行相加</span>
    <span class="n">indexed_tokens</span> <span class="o">=</span> <span class="n">indexed_tokens_1</span> <span class="o">+</span> <span class="n">indexed_tokens_2</span>
    <span class="c1"># 为了让模型在编码时能够更好的区分这两句话, 我们可以使用分隔ids,</span>
    <span class="c1"># 它是一个与indexed_tokens等长的向量, 0元素的位置代表是第一句话</span>
    <span class="c1"># 1元素的位置代表是第二句话, 长度都是max_len</span>
    <span class="n">segments_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">max_len</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">max_len</span>
    <span class="c1"># 将segments_ids和indexed_tokens转换成模型需要的张量形式</span>
    <span class="n">segments_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">segments_ids</span><span class="p">])</span>
    <span class="n">tokens_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">indexed_tokens</span><span class="p">])</span>
    <span class="c1"># 模型不自动求解梯度</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="c1"># 使用bert model进行编码, 传入参数tokens_tensor和segments_tensor得到encoded_layers</span>
        <span class="n">encoded_layers</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">tokens_tensor</span><span class="p">,</span> <span class="n">token_type_ids</span><span class="o">=</span><span class="n">segments_tensor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">encoded_layers</span>
</code></pre></div>

<hr>
<ul>
<li>代码位置: /data/doctor_online/bert_serve/bert_chinese_encode.py</li>
</ul>
<hr>
<ul>
<li>输入参数:
<div class="highlight"><pre id="__code_2"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_2 pre, #__code_2 code"><span class="md-clipboard__message"></span></button><code><span class="n">text_1</span> <span class="o">=</span> <span class="s2">"人生该如何起头"</span>
<span class="n">text_2</span> <span class="o">=</span> <span class="s2">"改变要如何起手"</span>
</code></pre></div></li>
</ul>
<hr>
<ul>
<li>调用:
<div class="highlight"><pre id="__code_3"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_3 pre, #__code_3 code"><span class="md-clipboard__message"></span></button><code><span class="n">encoded_layers</span> <span class="o">=</span> <span class="n">get_bert_encode</span><span class="p">(</span><span class="n">text_1</span><span class="p">,</span> <span class="n">text_2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">encoded_layers</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">encoded_layers</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div></li>
</ul>
<hr>
<ul>
<li>输出效果:
<div class="highlight"><pre id="__code_4"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_4 pre, #__code_4 code"><span class="md-clipboard__message"></span></button><code><span class="n">tensor</span><span class="p">([[[</span> <span class="mf">1.0210</span><span class="p">,</span>  <span class="mf">0.0659</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3472</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span>  <span class="mf">0.5131</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7699</span><span class="p">,</span>  <span class="mf">0.0202</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">0.1966</span><span class="p">,</span>  <span class="mf">0.2660</span><span class="p">,</span>  <span class="mf">0.3689</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0650</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2853</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1777</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">0.9295</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3890</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1026</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span>  <span class="mf">1.3917</span><span class="p">,</span>  <span class="mf">0.4692</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0851</span><span class="p">],</span>
         <span class="o">...</span><span class="p">,</span>
         <span class="p">[</span> <span class="mf">1.4777</span><span class="p">,</span>  <span class="mf">0.7781</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4310</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span>  <span class="mf">0.7403</span><span class="p">,</span>  <span class="mf">0.2006</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1198</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">0.3867</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2031</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0721</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span>  <span class="mf">1.0050</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2479</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3525</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">0.0599</span><span class="p">,</span>  <span class="mf">0.2883</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4011</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1875</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2546</span><span class="p">,</span>  <span class="mf">0.0453</span><span class="p">]]])</span>

<span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">768</span><span class="p">])</span>
</code></pre></div></li>
</ul>
<hr>
<ul>
<li>注意: 有时候会产生在调用上述代码时打印字符串的问题.</li>
</ul>
<div class="highlight"><pre id="__code_5"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_5 pre, #__code_5 code"><span class="md-clipboard__message"></span></button><code><span class="err">比如调用代码打印时</span><span class="p">:</span> 
<span class="n">encoded_layers</span> <span class="o">=</span> <span class="n">get_bert_encode</span><span class="p">(</span><span class="n">text_1</span><span class="p">,</span> <span class="n">text_2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'encoder_layers: '</span><span class="p">,</span> <span class="n">encoded_layers</span><span class="p">)</span>

<span class="c1">######################</span>

<span class="err">输出的是一个字符串</span><span class="p">,</span> <span class="err">而不是希望的数字化张量</span>
<span class="n">encoder_layers</span><span class="p">:</span> <span class="n">last_hidden_state</span>
</code></pre></div>

<hr>
<ul>
<li>解决方案1 (不使用pytorch_transformers, 直接用pip install transformers):</li>
</ul>
<div class="highlight"><pre id="__code_6"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_6 pre, #__code_6 code"><span class="md-clipboard__message"></span></button><code><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">BertTokenizer</span><span class="p">,</span> <span class="n">BertModel</span>

<span class="c1"># 加载字符映射器</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">BertTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">'bert-base-chinese'</span><span class="p">)</span>

<span class="c1"># 加载预训练中文模型</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">BertModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">'bert-base-chinese'</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>解决方案2 (继续使用torch.hub.load()传统方案):</li>
</ul>
<div class="highlight"><pre id="__code_7"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_7 pre, #__code_7 code"><span class="md-clipboard__message"></span></button><code><span class="err">按照之前的经验</span><span class="p">,</span> <span class="err">很多同学在服务器上出现打印字符串的问题后</span><span class="p">,</span> <span class="err">第二天再次登录就回复正常了</span><span class="o">.</span>

<span class="err">虽然不是一个通用的解决方案</span><span class="p">,</span> <span class="err">但是也很多次验证有效</span><span class="p">,</span> <span class="err">不着急的话可以等等再用</span><span class="o">.</span>
</code></pre></div>

<hr>
<ul>
<li>小节总结:<ul>
<li>学习了BERT中文预训练模型的有关知识和作用.</li>
<li>使用BERT中文预训练模型对句子编码的函数: get_bert_encode</li>
</ul>
</li>
</ul>
<hr>
<h2 id="84">8.4 微调模型<a class="headerlink" href="#84" title="Permanent link">¶</a></h2>
<ul>
<li>学习目标:<ul>
<li>了解微调模型的作用.</li>
<li>掌握构建全连接微调模型的过程.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>微调模型的作用:<ul>
<li>微调模型一般用在迁移学习中的预训练模型之后, 因为单纯的预训练模型往往不能针对特定领域或任务获得预期结果, 需要通过微调模型在特定领域或任务上调节整体模型功能, 使其适应当下问题.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>构建全连接微调模型的代码分析:</li>
</ul>
<div class="highlight"><pre id="__code_8"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_8 pre, #__code_8 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="kn">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="kn">as</span> <span class="nn">F</span>


<span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">"""定义微调网络的类"""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">embedding_size</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        :param char_size: 输入句子中的字符数量, 因为规范后每条句子长度是max_len, 因此char_size为2*max_len</span>
<span class="sd">        :param embedding_size: 字嵌入的维度, 因为使用的bert中文模型嵌入维度是768, 因此embedding_size为768</span>
<span class="sd">        :param dropout: 为了防止过拟合, 网络中将引入Dropout层, dropout为置0比率, 默认是0.2</span>
<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># 将char_size和embedding_size传入其中</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char_size</span> <span class="o">=</span> <span class="n">char_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_size</span> <span class="o">=</span> <span class="n">embedding_size</span>
        <span class="c1"># 实例化化必要的层和层参数:</span>
        <span class="c1"># 实例化Dropout层</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>
        <span class="c1"># 实例化第一个全连接层</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">char_size</span><span class="o">*</span><span class="n">embedding_size</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="c1"># 实例化第二个全连接层</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># 对输入的张量形状进行变换, 以满足接下来层的输入要求</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">char_size</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_size</span><span class="p">)</span>
        <span class="c1"># 使用dropout层</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># 使用第一个全连接层并使用relu函数</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="c1"># 使用dropout层</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># 使用第二个全连接层并使用relu函数</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span>
</code></pre></div>

<hr>
<ul>
<li>代码位置: /data/doctor_online/bert_serve/finetuning_net.py</li>
</ul>
<hr>
<ul>
<li>实例化参数:
<div class="highlight"><pre id="__code_9"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_9 pre, #__code_9 code"><span class="md-clipboard__message"></span></button><code><span class="n">embedding_size</span> <span class="o">=</span> <span class="mi">768</span>
<span class="n">char_size</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.2</span>
</code></pre></div></li>
</ul>
<hr>
<ul>
<li>输入参数:
<div class="highlight"><pre id="__code_10"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_10 pre, #__code_10 code"><span class="md-clipboard__message"></span></button><code><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">768</span><span class="p">)</span>
</code></pre></div></li>
</ul>
<hr>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre id="__code_11"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_11 pre, #__code_11 code"><span class="md-clipboard__message"></span></button><code><span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="n">char_size</span><span class="p">,</span> <span class="n">embedding_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
<span class="n">nr</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
</code></pre></div>

<ul>
<li>输出效果:</li>
</ul>
<div class="highlight"><pre id="__code_12"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_12 pre, #__code_12 code"><span class="md-clipboard__message"></span></button><code><span class="n">tensor</span><span class="p">([[</span><span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.4061</span><span class="p">]],</span> <span class="n">grad_fn</span><span class="o">=&lt;</span><span class="n">ReluBackward0</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div>

<hr>
<ul>
<li>
<p>小节总结:</p>
<ul>
<li>学习了微调模型的作用:<ul>
<li>微调模型一般用在迁移学习中的预训练模型之后, 因为单纯的预训练模型往往不能针对特定领域或任务获得预期结果, 需要通过微调模型在特定领域或任务上调节整体模型功能, 使其适应当下问题.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>学习并实现了构建全连接微调模型的类: class Net(nn.Module)</li>
</ul>
</li>
</ul>
<hr>
<h2 id="85">8.5 进行模型训练<a class="headerlink" href="#85" title="Permanent link">¶</a></h2>
<ul>
<li>学习目标:<ul>
<li>了解进行模型训练的步骤.</li>
<li>掌握模型训练中每个步骤的实现过程.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>进行模型训练的步骤:<ul>
<li>第一步: 构建数据加载器函数.</li>
<li>第二步: 构建模型训练函数.</li>
<li>第三步: 构建模型验证函数.</li>
<li>第四步: 调用训练和验证函数并打印日志.</li>
<li>第五步: 绘制训练和验证的损失和准确率对照曲线.</li>
<li>第六步: 模型保存. </li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>第一步: 构建数据加载器函数 </li>
</ul>
<div class="highlight"><pre id="__code_13"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_13 pre, #__code_13 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">bert_chinese_encode</span> <span class="kn">import</span> <span class="n">get_bert_encode</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="kn">as</span> <span class="nn">nn</span>


<span class="k">def</span> <span class="nf">data_loader</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    description: 从持久化文件中加载数据, 并划分训练集和验证集及其批次大小</span>
<span class="sd">    :param data_path: 训练数据的持久化路径</span>
<span class="sd">    :param batch_size: 训练和验证数据集的批次大小</span>
<span class="sd">    :param split: 训练集与验证的划分比例</span>
<span class="sd">    :return: 训练数据生成器, 验证数据生成器, 训练数据数量, 验证数据数量</span>
<span class="sd">    """</span>
    <span class="c1"># 使用pd进行csv数据的读取</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># 打印整体数据集上的正负样本数量</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"数据集的正负样本数量:"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
    <span class="c1"># 打乱数据集的顺序</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># 划分训练集和验证集</span>
    <span class="n">split_point</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="n">split</span><span class="p">)</span>
    <span class="n">valid_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">split_point</span><span class="p">]</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">split_point</span><span class="p">:]</span>

    <span class="c1"># 验证数据集中的数据总数至少能够满足一个批次</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">batch_size</span><span class="p">:</span>
        <span class="k">raise</span><span class="p">(</span><span class="s2">"Batch size or split not match!"</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_loader_generator</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        description: 获得训练集/验证集的每个批次数据的生成器</span>
<span class="sd">        :param data: 训练数据或验证数据</span>
<span class="sd">        :return: 一个批次的训练数据或验证数据的生成器</span>
<span class="sd">        """</span>
        <span class="c1"># 以每个批次的间隔遍历数据集</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># 预定于batch数据的张量列表</span>
            <span class="n">batch_encoded</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">batch_labels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># 将一个bitch_size大小的数据转换成列表形式，[[label, text_1, text_2]]</span>
            <span class="c1"># 并进行逐条遍历</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">batch</span><span class="p">:</span> <span class="n">batch</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                <span class="c1"># 每条数据中都包含两句话, 使用bert中文模型进行编码</span>
                <span class="n">encoded</span> <span class="o">=</span> <span class="n">get_bert_encode</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="c1"># 将编码后的每条数据装进预先定义好的列表中</span>
                <span class="n">batch_encoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
                <span class="c1"># 同样将对应的该batch的标签装进labels列表中</span>
                <span class="n">batch_labels</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="c1"># 使用reduce高阶函数将列表中的数据转换成模型需要的张量形式</span>
            <span class="c1"># encoded的形状是(batch_size, 2*max_len, embedding_size)</span>
            <span class="n">encoded</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">batch_encoded</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">batch_labels</span><span class="p">))</span>
            <span class="c1"># 以生成器的方式返回数据和标签</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">encoded</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

    <span class="c1"># 对训练集和验证集分别使用_loader_generator函数, 返回对应的生成器</span>
    <span class="c1"># 最后还要返回训练集和验证集的样本数量</span>
    <span class="k">return</span> <span class="n">_loader_generator</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="n">_loader_generator</span><span class="p">(</span><span class="n">valid_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
</code></pre></div>

<hr>
<blockquote>
<ul>
<li>代码位置:  /data/doctor_online/bert_serve/train.py</li>
</ul>
</blockquote>
<hr>
<blockquote>
<ul>
<li>输入参数:
<div class="highlight"><pre id="__code_14"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_14 pre, #__code_14 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 数据所在路径</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="s2">"./train_data.csv"</span>
<span class="c1"># 定义batch_size大小</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
</code></pre></div></li>
</ul>
</blockquote>
<hr>
<blockquote>
<ul>
<li>调用:</li>
</ul>
</blockquote>
<div class="highlight"><pre id="__code_15"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_15 pre, #__code_15 code"><span class="md-clipboard__message"></span></button><code><span class="n">train_data_labels</span><span class="p">,</span> <span class="n">valid_data_labels</span><span class="p">,</span> \
<span class="n">train_data_len</span><span class="p">,</span> <span class="n">valid_data_len</span> <span class="o">=</span> <span class="n">data_loader</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">train_data_labels</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">valid_data_labels</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"train_data_len:"</span><span class="p">,</span> <span class="n">train_data_len</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"valid_data_len:"</span><span class="p">,</span> <span class="n">valid_data_len</span><span class="p">)</span>
</code></pre></div>

<hr>
<blockquote>
<ul>
<li>输出效果:</li>
</ul>
</blockquote>
<div class="highlight"><pre id="__code_16"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_16 pre, #__code_16 code"><span class="md-clipboard__message"></span></button><code><span class="p">(</span><span class="n">tensor</span><span class="p">([[[</span><span class="o">-</span><span class="mf">0.7295</span><span class="p">,</span>  <span class="mf">0.8199</span><span class="p">,</span>  <span class="mf">0.8320</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span>  <span class="mf">0.0933</span><span class="p">,</span>  <span class="mf">1.2171</span><span class="p">,</span>  <span class="mf">0.4833</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">0.8707</span><span class="p">,</span>  <span class="mf">1.0131</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2556</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span>  <span class="mf">0.2179</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0671</span><span class="p">,</span>  <span class="mf">0.1946</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">0.0344</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5605</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5658</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span>  <span class="mf">1.0855</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.9122</span><span class="p">,</span>  <span class="mf">0.0222</span><span class="p">]]],</span> <span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>


<span class="p">(</span><span class="n">tensor</span><span class="p">([[[</span><span class="o">-</span><span class="mf">0.5263</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3897</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5725</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span>  <span class="mf">0.5523</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2289</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8796</span><span class="p">],</span>
         <span class="p">[</span> <span class="mf">0.0468</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5291</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0247</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span>  <span class="mf">0.4221</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2501</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0796</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">0.2133</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5552</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0584</span><span class="p">,</span>  <span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8031</span><span class="p">,</span>  <span class="mf">0.1753</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3476</span><span class="p">]]]),</span> <span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>

<span class="n">train_data_len</span><span class="p">:</span> <span class="mi">22186</span> 
<span class="n">valid_data_len</span><span class="p">:</span> <span class="mi">5546</span>
</code></pre></div>

<hr>
<ul>
<li>第二步: 构建模型训练函数
<div class="highlight"><pre id="__code_17"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_17 pre, #__code_17 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 加载微调网络</span>
<span class="kn">from</span> <span class="nn">finetuning_net</span> <span class="kn">import</span> <span class="n">Net</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="kn">as</span> <span class="nn">optim</span>


<span class="c1"># 定义embedding_size, char_size</span>
<span class="n">embedding_size</span> <span class="o">=</span> <span class="mi">768</span>
<span class="n">char_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">max_len</span>
<span class="c1"># 实例化微调网络</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="n">embedding_size</span><span class="p">,</span> <span class="n">char_size</span><span class="p">)</span>
<span class="c1"># 定义交叉熵损失函数</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="c1"># 定义SGD优化方法</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">train_data_labels</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    description: 训练函数, 在这个过程中将更新模型参数, 并收集准确率和损失</span>
<span class="sd">    :param train_data_labels: 训练数据和标签的生成器对象</span>
<span class="sd">    :return: 整个训练过程的平均损失之和以及正确标签的累加数</span>
<span class="sd">    """</span>
    <span class="c1"># 定义训练过程的初始损失和准确率累加数</span>
    <span class="n">train_running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">train_running_acc</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1"># 循环遍历训练数据和标签生成器, 每个批次更新一次模型参数</span>
    <span class="k">for</span> <span class="n">train_tensor</span><span class="p">,</span> <span class="n">train_labels</span> <span class="ow">in</span> <span class="n">train_data_labels</span><span class="p">:</span>
        <span class="c1"># 初始化该批次的优化器</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="c1"># 使用微调网络获得输出</span>
        <span class="n">train_outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">train_tensor</span><span class="p">)</span>
        <span class="c1"># 得到该批次下的平均损失</span>
        <span class="n">train_loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">train_outputs</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
        <span class="c1"># 将该批次的平均损失加到train_running_loss中</span>
        <span class="n">train_running_loss</span> <span class="o">+=</span> <span class="n">train_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="c1"># 损失反向传播</span>
        <span class="n">train_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="c1"># 优化器更新模型参数</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="c1"># 将该批次中正确的标签数量进行累加, 以便之后计算准确率</span>
        <span class="n">train_running_acc</span> <span class="o">+=</span> <span class="p">(</span><span class="n">train_outputs</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">train_labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">train_running_loss</span><span class="p">,</span> <span class="n">train_running_acc</span>
</code></pre></div></li>
</ul>
<hr>
<blockquote>
<ul>
<li>代码位置:  /data/doctor_online/bert_serve/train.py</li>
</ul>
</blockquote>
<hr>
<ul>
<li>第三步: 模型验证函数</li>
</ul>
<div class="highlight"><pre id="__code_18"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_18 pre, #__code_18 code"><span class="md-clipboard__message"></span></button><code><span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="n">valid_data_labels</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    description: 验证函数, 在这个过程中将验证模型的在新数据集上的标签, 收集损失和准确率</span>
<span class="sd">    :param valid_data_labels: 验证数据和标签的生成器对象</span>
<span class="sd">    :return: 整个验证过程的平均损失之和以及正确标签的累加数</span>
<span class="sd">    """</span>
    <span class="c1"># 定义训练过程的初始损失和准确率累加数</span>
    <span class="n">valid_running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">valid_running_acc</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1"># 循环遍历验证数据和标签生成器</span>
    <span class="k">for</span> <span class="n">valid_tensor</span><span class="p">,</span> <span class="n">valid_labels</span> <span class="ow">in</span> <span class="n">valid_data_labels</span><span class="p">:</span>
        <span class="c1"># 不自动更新梯度</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="c1"># 使用微调网络获得输出</span>
            <span class="n">valid_outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">valid_tensor</span><span class="p">)</span>
            <span class="c1"># 得到该批次下的平均损失</span>
            <span class="n">valid_loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">valid_outputs</span><span class="p">,</span> <span class="n">valid_labels</span><span class="p">)</span>
            <span class="c1"># 将该批次的平均损失加到valid_running_loss中</span>
            <span class="n">valid_running_loss</span> <span class="o">+=</span> <span class="n">valid_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="c1"># 将该批次中正确的标签数量进行累加, 以便之后计算准确率</span>
            <span class="n">valid_running_acc</span> <span class="o">+=</span> <span class="p">(</span><span class="n">valid_outputs</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">valid_labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">valid_running_loss</span><span class="p">,</span>  <span class="n">valid_running_acc</span>
</code></pre></div>

<hr>
<blockquote>
<ul>
<li>代码位置:  /data/doctor_online/bert_serve/train.py</li>
</ul>
</blockquote>
<hr>
<ul>
<li>第四步: 调用训练和验证函数并打印日志</li>
</ul>
<div class="highlight"><pre id="__code_19"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_19 pre, #__code_19 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 定义训练轮数</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># 定义盛装每轮次的损失和准确率列表, 用于制图</span>
<span class="n">all_train_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_valid_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_train_acc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_valid_acc</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 进行指定轮次的训练</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
    <span class="c1"># 打印轮次</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Epoch:"</span><span class="p">,</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># 通过数据加载器获得训练数据和验证数据生成器, 以及对应的样本数量</span>
    <span class="n">train_data_labels</span><span class="p">,</span> <span class="n">valid_data_labels</span><span class="p">,</span> <span class="n">train_data_len</span><span class="p">,</span> <span class="n">valid_data_len</span> <span class="o">=</span> <span class="n">data_loader</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
    <span class="c1"># 调用训练函数进行训练</span>
    <span class="n">train_running_loss</span><span class="p">,</span> <span class="n">train_running_acc</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">train_data_labels</span><span class="p">)</span>
    <span class="c1"># 调用验证函数进行验证</span>
    <span class="n">valid_running_loss</span><span class="p">,</span> <span class="n">valid_running_acc</span> <span class="o">=</span> <span class="n">valid</span><span class="p">(</span><span class="n">valid_data_labels</span><span class="p">)</span>
    <span class="c1"># 计算每一轮的平均损失, train_running_loss和valid_running_loss是每个批次的平均损失之和</span>
    <span class="c1"># 因此将它们乘以batch_size就得到了该轮的总损失, 除以样本数即该轮次的平均损失</span>
    <span class="n">train_average_loss</span> <span class="o">=</span> <span class="n">train_running_loss</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="o">/</span> <span class="n">train_data_len</span>
    <span class="n">valid_average_loss</span> <span class="o">=</span> <span class="n">valid_running_loss</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="o">/</span> <span class="n">valid_data_len</span>

    <span class="c1"># train_running_acc和valid_running_acc是每个批次的正确标签累加和,</span>
    <span class="c1"># 因此只需除以对应样本总数即是该轮次的准确率</span>
    <span class="n">train_average_acc</span> <span class="o">=</span> <span class="n">train_running_acc</span> <span class="o">/</span>  <span class="n">train_data_len</span>
    <span class="n">valid_average_acc</span> <span class="o">=</span> <span class="n">valid_running_acc</span> <span class="o">/</span> <span class="n">valid_data_len</span>
    <span class="c1"># 将该轮次的损失和准确率装进全局损失和准确率列表中, 以便制图</span>
    <span class="n">all_train_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_average_loss</span><span class="p">)</span>
    <span class="n">all_valid_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_average_loss</span><span class="p">)</span>
    <span class="n">all_train_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_average_acc</span><span class="p">)</span>
    <span class="n">all_valid_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_average_acc</span><span class="p">)</span>
    <span class="c1"># 打印该轮次下的训练损失和准确率以及验证损失和准确率</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Train Loss:"</span><span class="p">,</span> <span class="n">train_average_loss</span><span class="p">,</span> <span class="s2">"|"</span><span class="p">,</span> <span class="s2">"Train Acc:"</span><span class="p">,</span> <span class="n">train_average_acc</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Valid Loss:"</span><span class="p">,</span> <span class="n">valid_average_loss</span><span class="p">,</span> <span class="s2">"|"</span><span class="p">,</span> <span class="s2">"Valid Acc:"</span><span class="p">,</span> <span class="n">valid_average_acc</span><span class="p">)</span>


<span class="k">print</span><span class="p">(</span><span class="s1">'Finished Training'</span><span class="p">)</span>
</code></pre></div>

<hr>
<blockquote>
<ul>
<li>代码位置:  /data/doctor_online/bert_serve/train.py</li>
</ul>
</blockquote>
<hr>
<blockquote>
<ul>
<li>输出效果:</li>
</ul>
</blockquote>
<div class="highlight"><pre id="__code_20"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_20 pre, #__code_20 code"><span class="md-clipboard__message"></span></button><code><span class="n">Epoch</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.693169563147374</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5084898843930635</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.6931480603018824</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5042777377521613</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.6931440165277162</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.514992774566474</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.6931474804019379</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5026567002881844</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.6931516138804441</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.69314516217633</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5065291786743515</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">4</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.6931474804878235</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5065028901734104</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.6931472256650842</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5052233429394812</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">5</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.6931474804878235</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5034320809248555</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.6931475739314165</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5055385446685879</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">6</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.6931492934337241</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5126445086705202</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.6931462547277512</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5033771613832853</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">7</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.6931459204309938</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5095736994219653</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.6931174922229921</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.5065742074927954</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">8</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.5545259035391614</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.759393063583815</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.4199462383770805</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9335374639769453</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">9</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.4011955714294676</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.953757225433526</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.3964169790877045</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9521793948126801</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">10</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.3893018603497158</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9669436416184971</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.3928600374491139</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9525846541786743</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">11</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.3857506763383832</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9741690751445087</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.38195425426582097</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9775306195965417</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">12</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.38368317760484066</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9772398843930635</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.37680484129046155</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9780259365994236</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">13</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.37407022137517876</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9783236994219653</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.3750278927192564</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9792867435158501</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">14</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.3707401707682306</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9801300578034682</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.37273150721097886</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9831592219020173</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">15</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.37279492521906177</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9817557803468208</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.3706809586123362</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9804574927953891</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">16</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.37660940017314315</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9841040462427746</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.3688154769390392</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.984600144092219</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">17</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.3749892661681754</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9841040462427746</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.3688570175760074</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9817633285302594</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">18</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.37156562515765945</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9826589595375722</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.36880484627028365</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9853656340057637</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">19</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.3674713007976554</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9830202312138728</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.366314563545954</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9850954610951008</span>
<span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">14015</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">13720</span><span class="p">}</span>
<span class="n">Epoch</span><span class="p">:</span> <span class="mi">20</span>
<span class="n">Train</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.36878046806837095</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9842846820809249</span>
<span class="n">Valid</span> <span class="n">Loss</span><span class="p">:</span> <span class="mf">0.367835852100114</span> <span class="o">|</span> <span class="n">Valid</span> <span class="n">Acc</span><span class="p">:</span> <span class="mf">0.9793317723342939</span>
<span class="n">Finished</span> <span class="n">Training</span>
</code></pre></div>

<hr>
<ul>
<li>第五步: 绘制训练和验证的损失和准确率对照曲线</li>
</ul>
<div class="highlight"><pre id="__code_21"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_21 pre, #__code_21 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入制图工具包</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">MultipleLocator</span>


<span class="c1"># 创建第一张画布</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># 绘制训练损失曲线</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_train_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Train Loss"</span><span class="p">)</span>
<span class="c1"># 绘制验证损失曲线, 颜色为红色</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_valid_losses</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Valid Loss"</span><span class="p">)</span>
<span class="c1"># 定义横坐标刻度间隔对象, 间隔为1, 代表每一轮次</span>
<span class="n">x_major_locator</span><span class="o">=</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># 获得当前坐标图句柄</span>
<span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="c1"># 设置横坐标刻度间隔</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">x_major_locator</span><span class="p">)</span>
<span class="c1"># 设置横坐标取值范围</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">epochs</span><span class="p">)</span>
<span class="c1"># 曲线说明在左上方</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper left'</span><span class="p">)</span>
<span class="c1"># 保存图片</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">"./loss.png"</span><span class="p">)</span>



<span class="c1"># 创建第二张画布</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 绘制训练准确率曲线</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_train_acc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Train Acc"</span><span class="p">)</span>

<span class="c1"># 绘制验证准确率曲线, 颜色为红色</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_valid_acc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Valid Acc"</span><span class="p">)</span>
<span class="c1"># 定义横坐标刻度间隔对象, 间隔为1, 代表每一轮次</span>
<span class="n">x_major_locator</span><span class="o">=</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># 获得当前坐标图句柄</span>
<span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="c1"># 设置横坐标刻度间隔</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">x_major_locator</span><span class="p">)</span>
<span class="c1"># 设置横坐标取值范围</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">epochs</span><span class="p">)</span>
<span class="c1"># 曲线说明在左上方</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper left'</span><span class="p">)</span>
<span class="c1"># 保存图片</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">"./acc.png"</span><span class="p">)</span>
</code></pre></div>

<hr>
<blockquote>
<ul>
<li>代码位置:  /data/doctor_online/bert_serve/train.py</li>
</ul>
</blockquote>
<hr>
<blockquote>
<ul>
<li>训练和验证损失对照曲线:</li>
</ul>
</blockquote>
<p></p><center><img alt="avatar" src="./index_files/loss.png"></center><p></p>
<hr>
<blockquote>
<ul>
<li>训练和验证准确率对照曲线:</li>
</ul>
</blockquote>
<p></p><center><img alt="avatar" src="./index_files/acc.png"></center><p></p>
<hr>
<blockquote>
<ul>
<li>分析:<ul>
<li>根据损失对照曲线, 微调模型在第6轮左右开始掌握数据规律迅速下降, 说明模型能够从数据中获取语料特征，正在收敛. 根据准确率对照曲线中验证准确率在第10轮左右区域稳定，最终维持在98%左右.</li>
</ul>
</li>
</ul>
</blockquote>
<hr>
<ul>
<li>第六步: 模型保存
<div class="highlight"><pre id="__code_22"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_22 pre, #__code_22 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 模型保存时间</span>
<span class="n">time_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
<span class="c1"># 保存路径</span>
<span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="s1">'./model/BERT_net_</span><span class="si">%d</span><span class="s1">.pth'</span> <span class="o">%</span> <span class="n">time_</span>
<span class="c1"># 保存模型参数</span>
<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">rnn</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">MODEL_PATH</span><span class="p">)</span>
</code></pre></div></li>
</ul>
<hr>
<blockquote>
<ul>
<li>代码位置:  /data/doctor_online/bert_serve/train.py</li>
</ul>
</blockquote>
<hr>
<blockquote>
<ul>
<li>输出效果: <ul>
<li>在/data/bert_serve/路径下生成BERT_net_ + 时间戳.pth的文件.</li>
</ul>
</li>
</ul>
</blockquote>
<hr>
<ul>
<li>小节总结:<ul>
<li>学习了进行模型训练的步骤:<ul>
<li>第一步: 构建数据加载器函数.</li>
<li>第二步: 构建模型训练函数.</li>
<li>第三步: 构建模型验证函数.</li>
<li>第四步: 调用训练和验证函数并打印日志.</li>
<li>第五步: 绘制训练和验证的损失和准确率对照曲线.</li>
<li>第六步: 模型保存.</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="86">8.6 模型部署<a class="headerlink" href="#86" title="Permanent link">¶</a></h2>
<ul>
<li>学习目标:<ul>
<li>掌握使用Flask框架进行模型部署的实现过程.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>使用Flask框架进行模型部署的步骤:<ul>
<li>第一步: 部署模型预测代码.</li>
<li>第二步: 以挂起的方式启动服务.</li>
<li>第三步: 进行测试.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>第一步: 部署模型预测代码</li>
</ul>
<div class="highlight"><pre id="__code_23"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_23 pre, #__code_23 code"><span class="md-clipboard__message"></span></button><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="kn">import</span> <span class="nn">torch</span>
<span class="c1"># 导入中文预训练模型编码函数</span>
<span class="kn">from</span> <span class="nn">bert_chinese_encode</span> <span class="kn">import</span> <span class="n">get_bert_encode</span>
<span class="c1"># 导入微调网络</span>
<span class="kn">from</span> <span class="nn">finetuning_net</span> <span class="kn">import</span> <span class="n">Net</span>

<span class="c1"># 导入训练好的模型</span>
<span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="s2">"./model/BERT_net.pth"</span>
<span class="c1"># 定义实例化模型参数</span>
<span class="n">embedding_size</span> <span class="o">=</span> <span class="mi">768</span>
<span class="n">char_size</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="c1"># 初始化微调网络模型</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="n">embedding_size</span><span class="p">,</span> <span class="n">char_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
<span class="c1"># 加载模型参数</span>
<span class="n">net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">))</span>
<span class="c1"># 使用评估模式</span>
<span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="c1"># 定义服务请求路径和方式</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/v1/recognition/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">recognition</span><span class="p">():</span>
    <span class="c1"># 接收数据</span>
    <span class="n">text_1</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">'text1'</span><span class="p">]</span>
    <span class="n">text_2</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">'text2'</span><span class="p">]</span>
    <span class="c1"># 对原始文本进行编码</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">get_bert_encode</span><span class="p">(</span><span class="n">text_1</span><span class="p">,</span> <span class="n">text_2</span><span class="p">,</span> <span class="n">mark</span><span class="o">=</span><span class="mi">102</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="c1"># 使用微调模型进行预测</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="c1"># 获得预测结果</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># 返回字符串类型的结果</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</code></pre></div>

<hr>
<blockquote>
<ul>
<li>代码位置: /data/doctor_online/bert_serve/app.py</li>
</ul>
</blockquote>
<hr>
<ul>
<li>第二步: 启动服务
<div class="highlight"><pre id="__code_24"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_24 pre, #__code_24 code"><span class="md-clipboard__message"></span></button><code><span class="n">gunicorn</span> <span class="o">-</span><span class="n">w</span> <span class="mi">1</span> <span class="o">-</span><span class="n">b</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">5001</span> <span class="n">app</span><span class="p">:</span><span class="n">app</span> 
</code></pre></div></li>
</ul>
<hr>
<ul>
<li>第三步: 进行测试</li>
</ul>
<blockquote>
<ul>
<li>测试脚本:</li>
</ul>
</blockquote>
<div class="highlight"><pre id="__code_25"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_25 pre, #__code_25 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">"http://0.0.0.0:5001/v1/recognition/"</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"text1"</span><span class="p">:</span><span class="s2">"人生该如何起头"</span><span class="p">,</span> <span class="s2">"text2"</span><span class="p">:</span> <span class="s2">"改变要如何起手"</span><span class="p">}</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"预测样本:"</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">"text_1"</span><span class="p">],</span> <span class="s2">"|"</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">"text_2"</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"预测结果:"</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>

<hr>
<blockquote>
<ul>
<li>代码位置: /data/doctor_online/bert_serve/test.py</li>
</ul>
</blockquote>
<hr>
<blockquote>
<ul>
<li>
<p>运行脚本:
</p><div class="highlight"><pre id="__code_26"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_26 pre, #__code_26 code"><span class="md-clipboard__message"></span></button><code><span class="n">python</span> <span class="n">test</span><span class="o">.</span><span class="n">py</span>
</code></pre></div><p></p>
</li>
<li>
<p>输出效果:</p>
</li>
</ul>
</blockquote>
<div class="highlight"><pre id="__code_27"><span></span><button class="md-clipboard" title="Copy to clipboard" data-clipboard-target="#__code_27 pre, #__code_27 code"><span class="md-clipboard__message"></span></button><code><span class="err">预测样本</span><span class="p">:</span> <span class="err">人生该如何起头</span> <span class="o">|</span> <span class="err">改变要如何起手</span>
<span class="err">预测结果</span><span class="p">:</span> <span class="mi">1</span>
</code></pre></div>

<hr>
<ul>
<li>小节总结:<ul>
<li>学习了使用Flask框架进行模型部署的实现过程:<ul>
<li>第一步: 部署模型预测代码.</li>
<li>第二步: 以挂起的方式启动服务.</li>
<li>第三步: 进行测试. </li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="./index7.html" title="第七章:在线部分" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                第七章:在线部分
              </span>
            </div>
          </a>
        
        
          <a href="./index9.html" title="第九章:系统联调与测试" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                第九章:系统联调与测试
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            ©Copyright 2019, itcast.cn.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org/">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="./index_files/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:".."}})</script>
      
    
  
</body></html>