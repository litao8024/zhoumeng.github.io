<!DOCTYPE html>
<!-- saved from url=(0031)http://121.199.45.168:8818/7_1/ -->
<html lang="zh" class="js json svg checked target dataset details fetch supports csstransforms3d no-ios" style=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
      
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://0.0.0.0:8818/7_1/">
      
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="ja">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="./index_files/AI.jpg">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-4.4.0">
    
    
      
        <title>7.1 硬件优化与模型部署 - 文本摘要项目</title>
      
    
    
      <link rel="stylesheet" href="./index_files/application.0284f74d.css">
      
      
    
    
      <script src="./index_files/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin="">
        <link rel="stylesheet" href="./index_files/css">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="./index_files/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-36723568-3", "mkdocs.org")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async="" src="./index_files/analytics.js"></script>
      
    
    
  <script type="text/javascript">(function(){var s=document.createElement("script");var port=window.location.port;s.src="//"+window.location.hostname+":"+port+ "/livereload.js?port=" + port;document.head.appendChild(s);})();</script><script src="./index_files/livereload.js"></script></head>
  
    <body dir="ltr" data-md-state="">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"></path></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#_1" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header" data-md-state="shadow">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="./1_1.html" title="文本摘要项目" class="md-header-nav__button md-logo">
          
            <img src="./index_files/AI.jpg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic" style="width: 648px;">
              文本摘要项目
            </span>
            <span class="md-header-nav__topic" style="width: 648px;">
              
                7.1 硬件优化与模型部署
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix="">
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/AITutorials/manuals" title="前往 Github 仓库" class="md-source" data-md-source="github" data-md-state="done">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Github
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" style="height: 509px;">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="./1_1.html" title="文本摘要项目" class="md-nav__button md-logo">
      
        <img src="./index_files/AI.jpg" width="48" height="48">
      
    </a>
    文本摘要项目
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/AITutorials/manuals" title="前往 Github 仓库" class="md-source" data-md-source="github" data-md-state="done">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Github
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix="">
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      第一章:文本摘要项目简介
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: none; overflow: hidden;">
      <label class="md-nav__title" for="nav-1">
        第一章:文本摘要项目简介
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./1_1.html" title="1.1 项目背景介绍" class="md-nav__link">
      1.1 项目背景介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./1_2.html" title="1.2 项目中的数据集初探" class="md-nav__link">
      1.2 项目中的数据集初探
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      第二章:TextRank模型
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: none; overflow: hidden;">
      <label class="md-nav__title" for="nav-2">
        第二章:TextRank模型
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./2_1.html" title="2.1 TextRank算法理论基础" class="md-nav__link">
      2.1 TextRank算法理论基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./2_2.html" title="2.2 TextRank实现baseline-0模型" class="md-nav__link">
      2.2 TextRank实现baseline-0模型
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      第三章:seq2seq经典架构
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: none; overflow: hidden;">
      <label class="md-nav__title" for="nav-3">
        第三章:seq2seq经典架构
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./3_1.html" title="3.1 seq2seq实现baseline-1模型" class="md-nav__link">
      3.1 seq2seq实现baseline-1模型
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./3_2.html" title="3.2 baseline-1模型的优化" class="md-nav__link">
      3.2 baseline-1模型的优化
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      第四章:PGN先进架构
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: none; overflow: hidden;">
      <label class="md-nav__title" for="nav-4">
        第四章:PGN先进架构
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./4_1.html" title="4.1 PGN架构解析" class="md-nav__link">
      4.1 PGN架构解析
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./4_2.html" title="4.2 PGN模型的数据处理" class="md-nav__link">
      4.2 PGN模型的数据处理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./4_3.html" title="4.3 PGN实现baseline-2模型" class="md-nav__link">
      4.3 PGN实现baseline-2模型
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      第五章:生成式模型的评估方法
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: none; overflow: hidden;">
      <label class="md-nav__title" for="nav-5">
        第五章:生成式模型的评估方法
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./5_1.html" title="5.1 文本摘要评估方法" class="md-nav__link">
      5.1 文本摘要评估方法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./5_2.html" title="5.2 ROUGE评估算法实现" class="md-nav__link">
      5.2 ROUGE评估算法实现
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      第六章:模型的迭代优化
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: none; overflow: hidden;">
      <label class="md-nav__title" for="nav-6">
        第六章:模型的迭代优化
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./6_1.html" title="6.1 PGN + coverage的优化模型" class="md-nav__link">
      6.1 PGN + coverage的优化模型
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./6_2.html" title="6.2 PGN + beam-search的优化模型" class="md-nav__link">
      6.2 PGN + beam-search的优化模型
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./6_3.html" title="6.3 数据增强的优化" class="md-nav__link">
      6.3 数据增强的优化
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./6_4.html" title="6.4 训练策略的优化" class="md-nav__link">
      6.4 训练策略的优化
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" checked="">
    
    <label class="md-nav__link" for="nav-7">
      第七章:模型的部署与总结
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: block; overflow: visible;">
      <label class="md-nav__title" for="nav-7">
        第七章:模型的部署与总结
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        7.1 硬件优化与模型部署
      </label>
    
    <a href="" title="7.1 硬件优化与模型部署" class="md-nav__link md-nav__link--active">
      7.1 硬件优化与模型部署
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix="">
      
        <li class="md-nav__item">
  <a href="#_1" title="硬件优化与模型部署" class="md-nav__link">
    硬件优化与模型部署
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" title="学习目标" class="md-nav__link">
    学习目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="硬件优化" class="md-nav__link">
    硬件优化
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpu" title="GPU优化" class="md-nav__link">
    GPU优化
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu" title="CPU优化" class="md-nav__link">
    CPU优化
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="模型部署" class="md-nav__link">
    模型部署
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpuflask" title="GPU环境Flask部署" class="md-nav__link">
    GPU环境Flask部署
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpuflask" title="CPU环境Flask部署" class="md-nav__link">
    CPU环境Flask部署
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="小节总结" class="md-nav__link">
    小节总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./7_2.html" title="7.2 项目总结" class="md-nav__link">
      7.2 项目总结
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" style="height: 509px;">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix="">
      
        <li class="md-nav__item">
  <a href="#_1" title="硬件优化与模型部署" class="md-nav__link">
    硬件优化与模型部署
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" title="学习目标" class="md-nav__link">
    学习目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="硬件优化" class="md-nav__link">
    硬件优化
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpu" title="GPU优化" class="md-nav__link">
    GPU优化
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu" title="CPU优化" class="md-nav__link">
    CPU优化
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="模型部署" class="md-nav__link">
    模型部署
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gpuflask" title="GPU环境Flask部署" class="md-nav__link">
    GPU环境Flask部署
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpuflask" title="CPU环境Flask部署" class="md-nav__link">
    CPU环境Flask部署
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="小节总结" class="md-nav__link">
    小节总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>7.1 硬件优化与模型部署</h1>
                
                <h2 id="_1">硬件优化与模型部署</h2>
<hr>
<h3 id="_2">学习目标</h3>
<ul>
<li>掌握对模型的硬件优化.</li>
<li>掌握模型的部署实践.</li>
</ul>
<hr>
<h3 id="_3">硬件优化</h3>
<h4 id="gpu">GPU优化</h4>
<p></p><center><img alt="" src="./index_files/35.png"></center><p></p>
<hr>
<ul>
<li>我们在考虑GPU优化时, 会考虑两种情况:<ul>
<li>第一种: GPU训练 + GPU部署.</li>
<li>第二种: GPU训练 + CPU部署.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<p>第一种: GPU训练 + GPU部署.</p>
</li>
<li>
<p>这种情况就是前面从第三章到第六章所做的工作, 同学们已经很熟悉了, 再次不做复述了.</p>
</li>
</ul>
<hr>
<ul>
<li>
<p>第二种: GPU训练 + CPU部署.</p>
</li>
<li>
<p>这种情况的核心操作在于将GPU训练好的参数加载到CPU上执行.</p>
<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/server/transform_model.py</li>
</ul>
</li>
</ul>
<hr>
<div class="codehilite" id="__code_0"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_0 pre, #__code_0 code"><span class="md-clipboard__message"></span></button><pre id="__code_1"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_1 pre, #__code_1 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">utils.vocab</span> <span class="kn">import</span> <span class="n">Vocab</span>
<span class="kn">from</span> <span class="nn">utils.dataset</span> <span class="kn">import</span> <span class="n">PairDataset</span>
<span class="kn">from</span> <span class="nn">utils.func_utils</span> <span class="kn">import</span> <span class="n">timer</span>
<span class="kn">from</span> <span class="nn">src.model</span> <span class="kn">import</span> <span class="n">PGN</span>


<span class="nd">@timer</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s1">'initalize and transform model...'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">transform_GPU_to_CPU</span><span class="p">(</span><span class="n">origin_model_path</span><span class="p">,</span> <span class="n">to_device</span><span class="o">=</span><span class="s1">'cpu'</span><span class="p">):</span>
    <span class="c1"># 第一步: 构造数据集字典</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">PairDataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train_data_path</span><span class="p">,</span>
                          <span class="n">max_enc_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_enc_len</span><span class="p">,</span>
                          <span class="n">max_dec_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_len</span><span class="p">,</span>
                          <span class="n">truncate_enc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_enc</span><span class="p">,</span>
                          <span class="n">truncate_dec</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_dec</span><span class="p">)</span>

    <span class="c1"># 第二步: 利用字典, 实例化模型对象</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">build_vocab</span><span class="p">(</span><span class="n">embed_file</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">embed_file</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">PGN</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>

    <span class="c1"># 判断待加载的模型是否存在</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">origin_model_path</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'The model file is not exists!'</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">origin_model_path</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'cpu'</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'-------------------------------------------------------------------'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">to_device</span> <span class="o">!=</span> <span class="s1">'cpu'</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Transform model to CPU!'</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 将在GPU上训练好的模型加载到CPU上</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">origin_model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="k">lambda</span> <span class="n">storage</span><span class="p">,</span> <span class="n">loc</span><span class="p">:</span><span class="n">storage</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">to_device</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_2"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_2 pre, #__code_2 code"><span class="md-clipboard__message"></span></button><pre id="__code_3"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_3 pre, #__code_3 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">transform_GPU_to_CPU</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="s1">'cpu'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'OK...'</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_4"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_4 pre, #__code_4 code"><span class="md-clipboard__message"></span></button><pre id="__code_5"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_5 pre, #__code_5 code"><span class="md-clipboard__message"></span></button><code>Reading dataset /home/ec2-user/ec2-user/zhudejun/text_summary/text_summary/pgn/data/train.txt... 69999 pairs.
PGN(
  (attention): Attention(
    (Wh): Linear(in_features=1024, out_features=1024, bias=False)
    (Ws): Linear(in_features=1024, out_features=1024, bias=True)
    (wc): Linear(in_features=1, out_features=1024, bias=False)
    (v): Linear(in_features=1024, out_features=1, bias=False)
  )
  (encoder): Encoder(
    (embedding): Embedding(20004, 512)
    (lstm): LSTM(512, 512, batch_first=True, bidirectional=True)
  )
  (decoder): Decoder(
    (embedding): Embedding(20004, 512)
    (lstm): LSTM(512, 512, batch_first=True)
    (W1): Linear(in_features=1536, out_features=512, bias=True)
    (W2): Linear(in_features=512, out_features=20004, bias=True)
    (w_gen): Linear(in_features=2560, out_features=1, bias=True)
  )
  (reduce_state): ReduceState()
)
-------------------------------------------------------------------
PGN(
  (attention): Attention(
    (Wh): Linear(in_features=1024, out_features=1024, bias=False)
    (Ws): Linear(in_features=1024, out_features=1024, bias=True)
    (wc): Linear(in_features=1, out_features=1024, bias=False)
    (v): Linear(in_features=1024, out_features=1, bias=False)
  )
  (encoder): Encoder(
    (embedding): Embedding(20004, 512)
    (lstm): LSTM(512, 512, batch_first=True, bidirectional=True)
  )
  (decoder): Decoder(
    (embedding): Embedding(20004, 512)
    (lstm): LSTM(512, 512, batch_first=True)
    (W1): Linear(in_features=1536, out_features=512, bias=True)
    (W2): Linear(in_features=512, out_features=20004, bias=True)
    (w_gen): Linear(in_features=2560, out_features=1, bias=True)
  )
  (reduce_state): ReduceState()
)
10.31801986694336 secs used for  initalize and transform model...
OK...
</code></pre></div>


<hr>
<ul>
<li>将模型转移到CPU上执行预测程序:<ul>
<li>第一步: 实现预测代码predict.py编写.</li>
<li>第二步: 实现rouge_eval.py编写.</li>
<li>第三步: 实现inference.py编写.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>第一步: 实现预测代码predict.py编写. <ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/server/predict.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_6"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_6 pre, #__code_6 code"><span class="md-clipboard__message"></span></button><pre id="__code_7"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_7 pre, #__code_7 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入相关系统工具包</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">jieba</span>

<span class="c1"># 设置项目的root路径, 方便后续相关代码文件的导入</span>
<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="c1"># 导入项目的相关代码文件</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">src.model</span> <span class="kn">import</span> <span class="n">PGN</span>
<span class="kn">from</span> <span class="nn">utils.dataset</span> <span class="kn">import</span> <span class="n">PairDataset</span>
<span class="kn">from</span> <span class="nn">utils.func_utils</span> <span class="kn">import</span> <span class="n">source2ids</span><span class="p">,</span> <span class="n">outputids2words</span><span class="p">,</span> <span class="n">Beam</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">add2heap</span><span class="p">,</span> <span class="n">replace_oovs</span>


<span class="c1"># 构建核心预测类Predict</span>
<span class="k">class</span> <span class="nc">Predict</span><span class="p">():</span>
    <span class="nd">@timer</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s1">'initalize predicter'</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">DEVICE</span>

        <span class="c1"># 产生数据对, 为接下来的迭代器做数据准备, 注意这里面用的是训练集数据</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">PairDataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train_data_path</span><span class="p">,</span>
                              <span class="n">max_enc_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_enc_len</span><span class="p">,</span>
                              <span class="n">max_dec_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_len</span><span class="p">,</span>
                              <span class="n">truncate_enc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_enc</span><span class="p">,</span>
                              <span class="n">truncate_dec</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_dec</span><span class="p">)</span>

        <span class="c1"># 生成词汇表</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">build_vocab</span><span class="p">(</span><span class="n">embed_file</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">embed_file</span><span class="p">)</span>

        <span class="c1"># 实例化PGN模型类, 这里面的模型是基于baseline-3的模型.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">PGN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_word</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">stop_word_file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]))</span>

        <span class="c1"># --------------------------------------------------------------------------------------</span>
        <span class="c1"># 下面两行代码是将模型加载到CPU上的核心部分, 也是相比于baseline-4模型唯一变动的地方.</span>
        <span class="c1"># 将在GPU上训练好的模型加载到CPU上</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span>
                                              <span class="n">map_location</span><span class="o">=</span><span class="k">lambda</span> <span class="n">storage</span><span class="p">,</span>
                                              <span class="n">loc</span><span class="p">:</span><span class="n">storage</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="c1"># --------------------------------------------------------------------------------------</span>


    <span class="k">def</span> <span class="nf">greedy_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">max_sum_len</span><span class="p">,</span> <span class="n">len_oovs</span><span class="p">,</span> <span class="n">x_padding_masks</span><span class="p">):</span>
        <span class="n">encoder_output</span><span class="p">,</span> <span class="n">encoder_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">replace_oovs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c1"># 用encoder的hidden state初始化decoder的hidden state</span>
        <span class="n">decoder_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reduce_state</span><span class="p">(</span><span class="n">encoder_states</span><span class="p">)</span>

        <span class="c1"># 利用SOS作为解码器的初始化输入字符</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">SOS</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">x_t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">SOS</span><span class="p">]</span>
        <span class="n">coverage_vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>

        <span class="c1"># 循环解码, 最多解码max_sum_len步</span>
        <span class="k">while</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_t</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">EOS</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_sum_len</span><span class="p">:</span>
            <span class="n">context_vector</span><span class="p">,</span> <span class="n">attention_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">decoder_states</span><span class="p">,</span>
                                                                     <span class="n">encoder_output</span><span class="p">,</span>
                                                                     <span class="n">x_padding_masks</span><span class="p">,</span>
                                                                     <span class="n">coverage_vector</span><span class="p">)</span>

            <span class="n">p_vocab</span><span class="p">,</span> <span class="n">decoder_states</span><span class="p">,</span> <span class="n">p_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">x_t</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                                                                <span class="n">decoder_states</span><span class="p">,</span>
                                                                <span class="n">context_vector</span><span class="p">)</span>

            <span class="n">final_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_final_distribution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p_gen</span><span class="p">,</span> <span class="n">p_vocab</span><span class="p">,</span>
                                                           <span class="n">attention_weights</span><span class="p">,</span>
                                                           <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">len_oovs</span><span class="p">))</span>

            <span class="c1"># 以贪心解码策略预测字符</span>
            <span class="n">x_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">final_dist</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">decoder_word_idx</span> <span class="o">=</span> <span class="n">x_t</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="c1"># 将预测的字符添加进结果摘要中</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decoder_word_idx</span><span class="p">)</span>
            <span class="n">x_t</span> <span class="o">=</span> <span class="n">replace_oovs</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">summary</span>


    <span class="c1"># 利用解码器产生出一个vocab distribution, 来预测下一个token.</span>
    <span class="k">def</span> <span class="nf">best_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">encoder_output</span><span class="p">,</span> <span class="n">x_padding_masks</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">len_oovs</span><span class="p">):</span>
        <span class="c1"># beam: 代表Beam类的一个实例化对象.</span>
        <span class="c1"># k: 代表Beam-search中的重要参数beam_size=k.</span>
        <span class="c1"># encoder_output: 编码器的输出张量.</span>
        <span class="c1"># x_padding_masks: 输入序列的padding mask, 用于遮掩那些无效的PAD位置字符</span>
        <span class="c1"># x: 编码器的输入张量.</span>
        <span class="c1"># len_oovs: OOV列表的长度.</span>
        <span class="c1"># 当前时间步t的对应解析字符token, 将作为Decoder端的输入, 产生最终的vocab distribution.</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">x_t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>

        <span class="c1"># 通过注意力层attention, 得到context_vector</span>
        <span class="n">context_vector</span><span class="p">,</span> <span class="n">attention_weights</span><span class="p">,</span> <span class="n">coverage_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">decoder_states</span><span class="p">,</span>
                                                                                  <span class="n">encoder_output</span><span class="p">,</span>
                                                                                  <span class="n">x_padding_masks</span><span class="p">,</span>
                                                                                  <span class="n">beam</span><span class="o">.</span><span class="n">coverage_vector</span><span class="p">)</span>

        <span class="c1"># 函数replace_oovs()将OOV单词替换成新的id值, 来避免解码器出现index-out-of-bound error</span>
        <span class="n">p_vocab</span><span class="p">,</span> <span class="n">decoder_states</span><span class="p">,</span> <span class="n">p_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">replace_oovs</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">),</span>
                                                            <span class="n">beam</span><span class="o">.</span><span class="n">decoder_states</span><span class="p">,</span>
                                                            <span class="n">context_vector</span><span class="p">)</span>

        <span class="c1"># 调用PGN网络中的函数, 得到最终的单词分布(包含OOV)</span>
        <span class="n">final_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_final_distribution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p_gen</span><span class="p">,</span> <span class="n">p_vocab</span><span class="p">,</span>
                                                       <span class="n">attention_weights</span><span class="p">,</span>
                                                       <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">len_oovs</span><span class="p">))</span>

        <span class="c1"># 计算序列的log_probs分数</span>
        <span class="n">log_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">final_dist</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="c1"># 如果当前Beam序列只有1个token, 要将一些无效字符删除掉, 以免影响序列的计算.</span>
        <span class="c1"># 至于这个无效字符的列表都包含什么, 也是利用bad case的分析, 结合数据观察得到的, 属于调优的一部分.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">forbidden_ids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="sa">u</span><span class="s2">"这"</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="sa">u</span><span class="s2">"此"</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="sa">u</span><span class="s2">"采用"</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="sa">u</span><span class="s2">"，"</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="sa">u</span><span class="s2">"。"</span><span class="p">]]</span>

            <span class="n">log_probs</span><span class="p">[</span><span class="n">forbidden_ids</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">'inf'</span><span class="p">)</span>
        <span class="c1"># 对于EOS token的一个罚分处理.</span>
        <span class="c1"># 具体做法参考了https://opennmt.net/OpenNMT/translation/beam_search/.</span>
        <span class="n">log_probs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">EOS</span><span class="p">]</span> <span class="o">*=</span> <span class="n">config</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">log_probs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">UNK</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">'inf'</span><span class="p">)</span>

        <span class="c1"># 从log_probs中获取top_k分数的tokens, 这也正好符合beam-search的逻辑.</span>
        <span class="n">topk_probs</span><span class="p">,</span> <span class="n">topk_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">log_probs</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="c1"># 非常关键的一行代码: 利用top_k的单词, 来扩展beam-search搜索序列, 等效于将top_k单词追加到候选序列的末尾.</span>
        <span class="n">best_k</span> <span class="o">=</span> <span class="p">[</span><span class="n">beam</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">log_probs</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">decoder_states</span><span class="p">,</span> <span class="n">coverage_vector</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">topk_idx</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

        <span class="c1"># 返回追加后的结果列表</span>
        <span class="k">return</span> <span class="n">best_k</span>


    <span class="c1"># 支持beam-search解码策略的主逻辑函数.</span>
    <span class="k">def</span> <span class="nf">beam_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">max_sum_len</span><span class="p">,</span> <span class="n">beam_width</span><span class="p">,</span> <span class="n">len_oovs</span><span class="p">,</span> <span class="n">x_padding_masks</span><span class="p">):</span>
        <span class="c1"># x: 编码器的输入张量, 即article(source document)</span>
        <span class="c1"># max_sum_len: 本质上就是最大解码长度max_dec_len</span>
        <span class="c1"># beam_size: 采用beam-search策略下的搜索宽度k</span>
        <span class="c1"># len_oovs: OOV列表的长度</span>
        <span class="c1"># x_padding_masks: 针对编码器的掩码张量, 把无效的PAD字符遮掩掉.</span>
        <span class="c1"># 第一步: 通过Encoder计算得到编码器的输出张量.</span>
        <span class="n">encoder_output</span><span class="p">,</span> <span class="n">encoder_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">replace_oovs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">))</span>

        <span class="c1"># 全零张量初始化coverage vector</span>
        <span class="n">coverage_vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="c1"># 对encoder_states进行加和降维处理, 赋值给decoder_states.</span>
        <span class="n">decoder_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reduce_state</span><span class="p">(</span><span class="n">encoder_states</span><span class="p">)</span>

        <span class="c1"># 初始化hypothesis, 第一个token给SOS, 分数给0.</span>
        <span class="n">init_beam</span> <span class="o">=</span> <span class="n">Beam</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">SOS</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decoder_states</span><span class="p">,</span> <span class="n">coverage_vector</span><span class="p">)</span>

        <span class="c1"># beam_size本质上就是搜索宽度k</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">beam_size</span>
        <span class="c1"># 初始化curr作为当前候选集, completed作为最终的hypothesis列表</span>
        <span class="n">curr</span><span class="p">,</span> <span class="n">completed</span> <span class="o">=</span> <span class="p">[</span><span class="n">init_beam</span><span class="p">],</span> <span class="p">[]</span>

        <span class="c1"># 通过for循环连续解码max_sum_len步, 每一步应用beam-search策略产生预测token.</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_sum_len</span><span class="p">):</span>
            <span class="c1"># 初始化当前时间步的topk列表为空, 后续将beam-search的解码结果存储在topk中.</span>
            <span class="n">topk</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">curr</span><span class="p">:</span>
                <span class="c1"># 如果产生了一个EOS token, 则将beam对象追加进最终的hypothesis列表, 并将k值减1, 然后继续搜索.</span>
                <span class="k">if</span> <span class="n">beam</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">EOS</span><span class="p">:</span>
                    <span class="n">completed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
                    <span class="n">k</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="c1"># 遍历最好的k个候选集序列.</span>
                <span class="k">for</span> <span class="n">can</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_k</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">encoder_output</span><span class="p">,</span> <span class="n">x_padding_masks</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">len_oovs</span><span class="p">)):</span>
                    <span class="c1"># 利用小顶堆来维护一个top_k的candidates.</span>
                    <span class="c1"># 小顶堆的值以当前序列的得分为准, 顺便也把候选集的id和候选集本身存储起来.</span>
                    <span class="n">add2heap</span><span class="p">(</span><span class="n">topk</span><span class="p">,</span> <span class="p">(</span><span class="n">can</span><span class="o">.</span><span class="n">seq_score</span><span class="p">(),</span> <span class="nb">id</span><span class="p">(</span><span class="n">can</span><span class="p">),</span> <span class="n">can</span><span class="p">),</span> <span class="n">k</span><span class="p">)</span>

            <span class="c1"># 当前候选集是堆元素的index=2的值can.</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">topk</span><span class="p">]</span>
            <span class="c1"># 候选集数量已经达到搜索宽度的时候, 停止搜索.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">completed</span><span class="p">)</span> <span class="o">==</span> <span class="n">beam_size</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># 将最后产生的候选集追加进completed中.</span>
        <span class="n">completed</span> <span class="o">+=</span> <span class="n">curr</span>

        <span class="c1"># 按照得分进行降序排列, 取分数最高的作为当前解码结果序列.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">completed</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">seq_score</span><span class="p">(),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tokens</span>
        <span class="k">return</span> <span class="n">result</span>


    <span class="nd">@timer</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s1">'doing prediction'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">beam_search</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># 很重要的一个参数是将beam_search设置为True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tokenize</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="c1"># 做模型所需的若干张量的初始化操作</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">oov</span> <span class="o">=</span> <span class="n">source2ids</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">len_oovs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">oov</span><span class="p">)])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">x_padding_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="c1"># 采用Beam search策略进行解码</span>
        <span class="k">if</span> <span class="n">beam_search</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_search</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                       <span class="n">max_sum_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_steps</span><span class="p">,</span>
                                       <span class="n">beam_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">beam_size</span><span class="p">,</span>
                                       <span class="n">len_oovs</span><span class="o">=</span><span class="n">len_oovs</span><span class="p">,</span>
                                       <span class="n">x_padding_masks</span><span class="o">=</span><span class="n">x_padding_masks</span><span class="p">)</span>
        <span class="c1"># 采用贪心策略进行解码</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy_search</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                         <span class="n">max_sum_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_steps</span><span class="p">,</span>
                                         <span class="n">len_oovs</span><span class="o">=</span><span class="n">len_oovs</span><span class="p">,</span>
                                         <span class="n">x_padding_masks</span><span class="o">=</span><span class="n">x_padding_masks</span><span class="p">)</span>

        <span class="c1"># 将数字化ids张量转换为自然语言文本</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">outputids2words</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">oov</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>

        <span class="c1"># 在模型摘要结果中删除掉&lt;SOS&gt;, &lt;EOS&gt;字符.</span>
        <span class="k">return</span> <span class="n">summary</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'&lt;SOS&gt;'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'&lt;EOS&gt;'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> 
</code></pre></div>


<hr>
<ul>
<li>第二步: 实现rouge_eval.py编写.<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/server/rouge_eval.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_8"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_8 pre, #__code_8 code"><span class="md-clipboard__message"></span></button><pre id="__code_9"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_9 pre, #__code_9 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">rouge</span> <span class="kn">import</span> <span class="n">Rouge</span>
<span class="kn">import</span> <span class="nn">jieba</span>

<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">utils.func_utils</span> <span class="kn">import</span> <span class="n">timer</span>


<span class="k">class</span> <span class="nc">RougeEval</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rouge</span> <span class="o">=</span> <span class="n">Rouge</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hypos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Reading from '</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">test</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">test</span><span class="p">:</span>
                <span class="n">source</span><span class="p">,</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'&lt;SEP&gt;'</span><span class="p">)</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'。'</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">'self.refs[]包含的样本数: '</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refs</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'Test set contains {len(self.sources)} samples.'</span><span class="p">)</span>

    <span class="nd">@timer</span><span class="p">(</span><span class="s1">'building hypotheses'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">build_hypos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predict</span><span class="p">):</span>
        <span class="c1"># Generate hypos for the dataset.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Building hypotheses.'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hypos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predict</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">get_average</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'Build hypotheses first!'</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Calculating average rouge scores.'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rouge</span><span class="o">.</span><span class="n">get_scores</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refs</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">one_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hypo</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rouge</span><span class="o">.</span><span class="n">get_scores</span><span class="p">(</span><span class="n">hypo</span><span class="p">,</span> <span class="n">ref</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>


<hr>
<ul>
<li>第三步: 实现inference.py编写.<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/server/inference.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_10"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_10 pre, #__code_10 code"><span class="md-clipboard__message"></span></button><pre id="__code_11"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_11 pre, #__code_11 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">utils.vocab</span> <span class="kn">import</span> <span class="n">Vocab</span>
<span class="kn">from</span> <span class="nn">utils.dataset</span> <span class="kn">import</span> <span class="n">PairDataset</span>
<span class="kn">from</span> <span class="nn">utils.func_utils</span> <span class="kn">import</span> <span class="n">timer</span>
<span class="kn">from</span> <span class="nn">src.model</span> <span class="kn">import</span> <span class="n">PGN</span>
<span class="kn">from</span> <span class="nn">server.predict</span> <span class="kn">import</span> <span class="n">Predict</span>
<span class="kn">from</span> <span class="nn">server.rouge_eval</span> <span class="kn">import</span> <span class="n">RougeEval</span>


<span class="c1"># 真实的测试机是val_data_path: dev.txt</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'实例化Rouge对象......'</span><span class="p">)</span>
<span class="n">rouge_eval</span> <span class="o">=</span> <span class="n">RougeEval</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">val_data_path</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'实例化Predict对象......'</span><span class="p">)</span>
<span class="n">predict</span> <span class="o">=</span> <span class="n">Predict</span><span class="p">()</span>

<span class="c1"># 利用模型对article进行预测</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'利用模型对article进行预测, 并通过Rouge对象进行评估......'</span><span class="p">)</span>
<span class="n">rouge_eval</span><span class="o">.</span><span class="n">build_hypos</span><span class="p">(</span><span class="n">predict</span><span class="p">)</span>

<span class="c1"># 将预测结果和标签abstract进行ROUGE规则计算</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'开始用Rouge规则进行评估......'</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">rouge_eval</span><span class="o">.</span><span class="n">get_average</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s1">'rouge1: '</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">'rouge-1'</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'rouge2: '</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">'rouge-2'</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'rougeL: '</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">'rouge-l'</span><span class="p">])</span>

<span class="c1"># 最后将计算评估结果写入文件中</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'将评估结果写入结果文件中......'</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/eval_result/rouge_result_greedy_cpu.txt'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">metric</span> <span class="o">+</span> <span class="s1">': '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_12"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_12 pre, #__code_12 code"><span class="md-clipboard__message"></span></button><pre id="__code_13"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_13 pre, #__code_13 code"><span class="md-clipboard__message"></span></button><code><span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ec2</span><span class="o">-</span><span class="n">user</span><span class="o">/</span><span class="n">text_summary</span><span class="o">/</span><span class="n">pgn</span><span class="o">/</span><span class="n">server</span><span class="o">/</span>

<span class="n">python</span> <span class="n">inference</span><span class="o">.</span><span class="n">py</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_14"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_14 pre, #__code_14 code"><span class="md-clipboard__message"></span></button><pre id="__code_15"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_15 pre, #__code_15 code"><span class="md-clipboard__message"></span></button><code>实例化Rouge对象......
Reading from  /home/ec2-user/text_summary/pgn/data/dev.txt
self.refs[]包含的样本数:  3000
Test set contains 3000 samples.
实例化Predict对象......
Reading dataset /home/ec2-user/text_summary/pgn/data/train.txt... 70000 pairs.
9.418930053710938 secs used for  initalize predicter
利用模型对article进行预测, 并通过Rouge对象进行评估......
Building hypotheses.
0.15330982208251953 secs used for  doing prediction
0.18052959442138672 secs used for  doing prediction
0.04963088035583496 secs used for  doing prediction
0.0351109504699707 secs used for  doing prediction
0.11708974838256836 secs used for  doing prediction
0.04735374450683594 secs used for  doing prediction
0.04634213447570801 secs used for  doing prediction
0.1311793327331543 secs used for  doing prediction
0.150376558303833 secs used for  doing prediction
0.06444954872131348 secs used for  doing prediction
0.12553858757019043 secs used for  doing prediction
0.07853579521179199 secs used for  doing prediction
0.051067352294921875 secs used for  doing prediction
0.11544156074523926 secs used for  doing prediction
0.11416888236999512 secs used for  doing prediction


......
......
......


0.12541508674621582 secs used for  doing prediction
0.4589982032775879 secs used for  doing prediction
0.033342838287353516 secs used for  doing prediction
0.09662842750549316 secs used for  doing prediction
0.17136907577514648 secs used for  doing prediction
0.18829894065856934 secs used for  doing prediction
0.05489516258239746 secs used for  doing prediction
0.24480724334716797 secs used for  doing prediction
0.04336810111999512 secs used for  doing prediction
0.04814314842224121 secs used for  doing prediction
0.06292939186096191 secs used for  doing prediction
0.057683467864990234 secs used for  doing prediction
0.2856731414794922 secs used for  doing prediction
0.19181203842163086 secs used for  doing prediction
0.023878097534179688 secs used for  doing prediction
0.046187400817871094 secs used for  doing prediction
427.7368497848511 secs used for  building hypotheses
开始用Rouge规则进行评估......
Calculating average rouge scores.
rouge1:  {'f': 0.2621586067672694, 'p': 0.30965963799458307, 'r': 0.3154167172567273}
rouge2:  {'f': 0.08909632183395856, 'p': 0.10533893122936726, 'r': 0.10886982715218156}
rougeL:  {'f': 0.2825995304486134, 'p': 0.36590744862195695, 'r': 0.27657798744118395}
将评估结果写入结果文件中......
</code></pre></div>


<hr>
<ul>
<li>这里展示一下批量预测时的服务器状态截图:</li>
</ul>
<p></p><center><img alt="" src="./index_files/37.png"></center><p></p>
<hr>
<blockquote>
<ul>
<li>结论1: 可以很清楚的看到两点, 第一点是单条样本的预测时间基本处于[0.05s, 0.5s]之间, 大量样本处于0.2-0.3秒之间. 对比于GPU上的预测, 单条样本的预测时间基本处于[0.01s, 0.08s]之间, 大量样本处于0.01-0.05秒之间.</li>
</ul>
</blockquote>
<hr>
<blockquote>
<ul>
<li>结论2: 在当前4核16GB的服务器上, 因为采用了CPU做推断, 因此CPU资源被占用了53%. 相比于GPU推断时, CPU资源被占用大约10%.</li>
</ul>
</blockquote>
<hr>
<blockquote>
<ul>
<li>结论3: 同样的模型在CPU上做推断的时间, 基本上是在GPU上做推断的5-10倍, 因此如果有条件的话尽量安排GPU部署. 实在为了节省预算那也只好在CPU上了.</li>
</ul>
</blockquote>
<hr>
<hr>
<h4 id="cpu">CPU优化</h4>
<ul>
<li>所谓的CPU优化, 工业场景下基本都放在预测阶段.(因为用CPU训练模型, 也就谈不上什么硬件优化了)</li>
</ul>
<hr>
<ul>
<li>CPU上唯一能做的优化, 就是模型量化.(当然也可以分布式CPU部署)<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/server/quantized_model.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_16"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_16 pre, #__code_16 code"><span class="md-clipboard__message"></span></button><pre id="__code_17"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_17 pre, #__code_17 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">utils.vocab</span> <span class="kn">import</span> <span class="n">Vocab</span>
<span class="kn">from</span> <span class="nn">utils.dataset</span> <span class="kn">import</span> <span class="n">PairDataset</span>
<span class="kn">from</span> <span class="nn">utils.func_utils</span> <span class="kn">import</span> <span class="n">timer</span>
<span class="kn">from</span> <span class="nn">src.model</span> <span class="kn">import</span> <span class="n">PGN</span>


<span class="c1"># 打印模型大小</span>
<span class="k">def</span> <span class="nf">print_size_of_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="c1"># 保存模型中的参数部分到持久化文件</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">"temp.p"</span><span class="p">)</span>
    <span class="c1"># 打印持久化文件的大小</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Size (MB):'</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="s2">"temp.p"</span><span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span>
    <span class="c1"># 移除该文件</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">'temp.p'</span><span class="p">)</span>


<span class="nd">@timer</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s1">'initalize and quantize model...'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">quantize_model</span><span class="p">(</span><span class="n">origin_model_path</span><span class="p">):</span>
    <span class="c1"># 第一步: 构造数据集字典</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">PairDataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train_data_path</span><span class="p">,</span>
                          <span class="n">max_enc_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_enc_len</span><span class="p">,</span>
                          <span class="n">max_dec_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_len</span><span class="p">,</span>
                          <span class="n">truncate_enc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_enc</span><span class="p">,</span>
                          <span class="n">truncate_dec</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_dec</span><span class="p">)</span>

    <span class="c1"># 第二步: 利用字典, 实例化模型对象</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">build_vocab</span><span class="p">(</span><span class="n">embed_file</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">embed_file</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">PGN</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>

    <span class="c1"># 判断待加载的模型是否存在</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">origin_model_path</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'The model file is not exists!'</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">origin_model_path</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'-------------------------------------------------------------------'</span><span class="p">)</span>
    <span class="c1"># 使用torch.quantization.quantize_dynamic获得动态量化的模型</span>
    <span class="c1"># 量化的网络层为所有的nn.Linear的权重，使其成为int8</span>
    <span class="n">quantized_model_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">quantize_dynamic</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">{</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">},</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">qint8</span><span class="p">)</span>

    <span class="c1"># 将在GPU上训练好的模型加载到GPU上</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'cpu'</span><span class="p">)</span>
    <span class="n">quantized_model_1</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># quantized_model_2 = torch.quantization.quantize_dynamic(model, </span>
    <span class="c1">#                     {torch.nn.Linear, torch.nn.LSTM, torch.nn.Embedding}, dtype=torch.qint8)</span>

    <span class="c1"># 打印动态量化后的模型</span>
    <span class="k">print</span><span class="p">(</span><span class="n">quantized_model</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'-------------------------------------------------------------------'</span><span class="p">)</span>

    <span class="c1"># 分别打印model和quantized_model</span>
    <span class="n">print_size_of_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">print_size_of_model</span><span class="p">(</span><span class="n">quantized_model</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'-------------------------------------------------------------------'</span><span class="p">)</span>

    <span class="c1"># 将在GPU上训练好的模型加载到CPU上</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">origin_model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="k">lambda</span> <span class="n">storage</span><span class="p">,</span> <span class="n">loc</span><span class="p">:</span><span class="n">storage</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">'cpu'</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_18"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_18 pre, #__code_18 code"><span class="md-clipboard__message"></span></button><pre id="__code_19"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_19 pre, #__code_19 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">quantize_model</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'OK...'</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_20"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_20 pre, #__code_20 code"><span class="md-clipboard__message"></span></button><pre id="__code_21"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_21 pre, #__code_21 code"><span class="md-clipboard__message"></span></button><code>Reading dataset /home/ec2-user/text_summary/pgn/data/train.txt... 70000 pairs.
PGN(
  (attention): Attention(
    (Wh): Linear(in_features=1024, out_features=1024, bias=False)
    (Ws): Linear(in_features=1024, out_features=1024, bias=True)
    (wc): Linear(in_features=1, out_features=1024, bias=False)
    (v): Linear(in_features=1024, out_features=1, bias=False)
  )
  (encoder): Encoder(
    (embedding): Embedding(20004, 512)
    (lstm): LSTM(512, 512, batch_first=True, bidirectional=True)
  )
  (decoder): Decoder(
    (embedding): Embedding(20004, 512)
    (lstm): LSTM(512, 512, batch_first=True)
    (W1): Linear(in_features=1536, out_features=512, bias=True)
    (W2): Linear(in_features=512, out_features=20004, bias=True)
    (w_gen): Linear(in_features=2560, out_features=1, bias=True)
  )
  (reduce_state): ReduceState()
)
-------------------------------------------------------------------
PGN(
  (attention): Attention(
    (Wh): DynamicQuantizedLinear(in_features=1024, out_features=1024, dtype=torch.qint8, qscheme=torch.per_tensor_affine)
    (Ws): DynamicQuantizedLinear(in_features=1024, out_features=1024, dtype=torch.qint8, qscheme=torch.per_tensor_affine)
    (wc): DynamicQuantizedLinear(in_features=1, out_features=1024, dtype=torch.qint8, qscheme=torch.per_tensor_affine)
    (v): DynamicQuantizedLinear(in_features=1024, out_features=1, dtype=torch.qint8, qscheme=torch.per_tensor_affine)
  )
  (encoder): Encoder(
    (embedding): Embedding(20004, 512)
    (lstm): LSTM(512, 512, batch_first=True, bidirectional=True)
  )
  (decoder): Decoder(
    (embedding): Embedding(20004, 512)
    (lstm): LSTM(512, 512, batch_first=True)
    (W1): DynamicQuantizedLinear(in_features=1536, out_features=512, dtype=torch.qint8, qscheme=torch.per_tensor_affine)
    (W2): DynamicQuantizedLinear(in_features=512, out_features=20004, dtype=torch.qint8, qscheme=torch.per_tensor_affine)
    (w_gen): DynamicQuantizedLinear(in_features=2560, out_features=1, dtype=torch.qint8, qscheme=torch.per_tensor_affine)
  )
  (reduce_state): ReduceState()
)
-------------------------------------------------------------------
Size (MB): 159.766928
Size (MB): 120.379636
-------------------------------------------------------------------
PGN(
  (attention): Attention(
    (Wh): Linear(in_features=1024, out_features=1024, bias=False)
    (Ws): Linear(in_features=1024, out_features=1024, bias=True)
    (wc): Linear(in_features=1, out_features=1024, bias=False)
    (v): Linear(in_features=1024, out_features=1, bias=False)
  )
  (encoder): Encoder(
    (embedding): Embedding(20004, 512)
    (lstm): LSTM(512, 512, batch_first=True, bidirectional=True)
  )
  (decoder): Decoder(
    (embedding): Embedding(20004, 512)
    (lstm): LSTM(512, 512, batch_first=True)
    (W1): Linear(in_features=1536, out_features=512, bias=True)
    (W2): Linear(in_features=512, out_features=20004, bias=True)
    (w_gen): Linear(in_features=2560, out_features=1, bias=True)
  )
  (reduce_state): ReduceState()
)
10.895822525024414 secs used for  initalize and quantize model...
OK...
</code></pre></div>


<hr>
<ul>
<li>利用量化后的模型执行CPU预测:<ul>
<li>第一步: 编写量化模型的Predict类</li>
<li>第二步: 修改推断函数inference.py</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>第一步: 编写量化模型的Predict类.<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/server/predict_quantized.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_22"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_22 pre, #__code_22 code"><span class="md-clipboard__message"></span></button><pre id="__code_23"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_23 pre, #__code_23 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">jieba</span>

<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">src.model</span> <span class="kn">import</span> <span class="n">PGN</span>
<span class="kn">from</span> <span class="nn">utils.dataset</span> <span class="kn">import</span> <span class="n">PairDataset</span>
<span class="kn">from</span> <span class="nn">utils.func_utils</span> <span class="kn">import</span> <span class="n">source2ids</span><span class="p">,</span> <span class="n">outputids2words</span><span class="p">,</span> <span class="n">Beam</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">add2heap</span><span class="p">,</span> <span class="n">replace_oovs</span>


<span class="k">class</span> <span class="nc">Predict</span><span class="p">():</span>
    <span class="nd">@timer</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s1">'initalize predicter'</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 此处的设备设定的是CPU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">DEVICE</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="n">PairDataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train_data_path</span><span class="p">,</span>
                              <span class="n">max_enc_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_enc_len</span><span class="p">,</span>
                              <span class="n">max_dec_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_len</span><span class="p">,</span>
                              <span class="n">truncate_enc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_enc</span><span class="p">,</span>
                              <span class="n">truncate_dec</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_dec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">build_vocab</span><span class="p">(</span><span class="n">embed_file</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">embed_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_word</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">stop_word_file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]))</span>


        <span class="c1"># -------------------------------------------------------------------------------------------</span>
        <span class="c1"># 关于模型的量化在CPU上推断, Predict类中只有初始化函数__init__()中的如下部分需要修改.</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">PGN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>

        <span class="c1"># 将在GPU上训练好的模型执行量化</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">quantize_dynamic</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">{</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">},</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">qint8</span><span class="p">)</span>

        <span class="c1"># 并将量化后的模型放到CPU上执行.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="c1"># -------------------------------------------------------------------------------------------</span>
</code></pre></div>


<hr>
<ul>
<li>第二步: 修改推断函数inference.py<ul>
<li>/home/ec2-user/text_summary/pgn/server/inference.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_24"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_24 pre, #__code_24 code"><span class="md-clipboard__message"></span></button><pre id="__code_25"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_25 pre, #__code_25 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">utils.vocab</span> <span class="kn">import</span> <span class="n">Vocab</span>
<span class="kn">from</span> <span class="nn">utils.dataset</span> <span class="kn">import</span> <span class="n">PairDataset</span>
<span class="kn">from</span> <span class="nn">utils.func_utils</span> <span class="kn">import</span> <span class="n">timer</span>
<span class="kn">from</span> <span class="nn">src.model</span> <span class="kn">import</span> <span class="n">PGN</span>

<span class="c1"># --------------------------------------------------------------------------</span>
<span class="c1"># 代码文件inference.py中只有下面一行导入代码需要修改成量化的专门类Predict</span>
<span class="kn">from</span> <span class="nn">server.predict_quantized</span> <span class="kn">import</span> <span class="n">Predict</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="kn">from</span> <span class="nn">server.rouge_eval</span> <span class="kn">import</span> <span class="n">RougeEval</span>


<span class="c1"># 真实的测试机是val_data_path: dev.txt</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'实例化Rouge对象......'</span><span class="p">)</span>
<span class="n">rouge_eval</span> <span class="o">=</span> <span class="n">RougeEval</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">val_data_path</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'实例化Predict对象......'</span><span class="p">)</span>
<span class="n">predict</span> <span class="o">=</span> <span class="n">Predict</span><span class="p">()</span>

<span class="c1"># 利用模型对article进行预测</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'利用模型对article进行预测, 并通过Rouge对象进行评估......'</span><span class="p">)</span>
<span class="n">rouge_eval</span><span class="o">.</span><span class="n">build_hypos</span><span class="p">(</span><span class="n">predict</span><span class="p">)</span>

<span class="c1"># 将预测结果和标签abstract进行ROUGE规则计算</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'开始用Rouge规则进行评估......'</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">rouge_eval</span><span class="o">.</span><span class="n">get_average</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s1">'rouge1: '</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">'rouge-1'</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'rouge2: '</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">'rouge-2'</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'rougeL: '</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">'rouge-l'</span><span class="p">])</span>


<span class="c1"># 最后将计算评估结果写入文件中</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'将评估结果写入结果文件中......'</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/eval_result/rouge_result_greedy_quantized_cpu.txt'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">metric</span> <span class="o">+</span> <span class="s1">': '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_26"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_26 pre, #__code_26 code"><span class="md-clipboard__message"></span></button><pre id="__code_27"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_27 pre, #__code_27 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/server/

python inference.py
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_28"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_28 pre, #__code_28 code"><span class="md-clipboard__message"></span></button><pre id="__code_29"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_29 pre, #__code_29 code"><span class="md-clipboard__message"></span></button><code>实例化Rouge对象......
Reading from  /home/ec2-user/text_summary/pgn/data/dev.txt
self.refs[]包含的样本数:  3000
Test set contains 3000 samples.
实例化Predict对象......
Reading dataset /home/ec2-user/text_summary/pgn/data/train.txt... 70000 pairs.
7.1838977336883545 secs used for  initalize predicter
利用模型对article进行预测, 并通过Rouge对象进行评估......
Building hypotheses.
0.15610480308532715 secs used for  doing prediction
0.1115419864654541 secs used for  doing prediction
0.05811333656311035 secs used for  doing prediction
0.07978630065917969 secs used for  doing prediction
0.15957856178283691 secs used for  doing prediction
0.12763476371765137 secs used for  doing prediction
0.14662504196166992 secs used for  doing prediction
0.2054615020751953 secs used for  doing prediction
0.1559920310974121 secs used for  doing prediction
0.09707760810852051 secs used for  doing prediction
0.2866971492767334 secs used for  doing prediction
0.16721463203430176 secs used for  doing prediction


......
......
......


0.09558749198913574 secs used for  doing prediction
0.29911351203918457 secs used for  doing prediction
0.1019902229309082 secs used for  doing prediction
0.21161389350891113 secs used for  doing prediction
0.07252025604248047 secs used for  doing prediction
0.08644890785217285 secs used for  doing prediction
0.13550138473510742 secs used for  doing prediction
0.08260917663574219 secs used for  doing prediction
0.168992280960083 secs used for  doing prediction
0.13071942329406738 secs used for  doing prediction
0.0772707462310791 secs used for  doing prediction
0.07240629196166992 secs used for  doing prediction
372.257691860199 secs used for  building hypotheses
开始用Rouge规则进行评估......
Calculating average rouge scores.
rouge1:  {'f': 0.061165070886269, 'p': 0.0538045977011489, 'r': 0.08881012927232167}
rouge2:  {'f': 0.0005556327981289956, 'p': 0.00048809523809523826, 'r': 0.0009438901855072961}
rougeL:  {'f': 0.097887394577256, 'p': 0.6118333333333333, 'r': 0.054991099072330796}
将评估结果写入结果文件中......
</code></pre></div>


<hr>
<ul>
<li>对比CPU量化前后两个版本的模型表现:</li>
</ul>
<div class="codehilite" id="__code_30"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_30 pre, #__code_30 code"><span class="md-clipboard__message"></span></button><pre id="__code_31"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_31 pre, #__code_31 code"><span class="md-clipboard__message"></span></button><code># 量化前在CPU上运行的评估结果
rouge1:  {'f': 0.2621586067672694, 'p': 0.30965963799458307, 'r': 0.3154167172567273}
rouge2:  {'f': 0.08909632183395856, 'p': 0.10533893122936726, 'r': 0.10886982715218156}
rougeL:  {'f': 0.2825995304486134, 'p': 0.36590744862195695, 'r': 0.27657798744118395}

# --------------------------------------------------------------------------------------

# 量化后在CPU上运行的评估结果
rouge1:  {'f': 0.061165070886269, 'p': 0.0538045977011489, 'r': 0.08881012927232167}
rouge2:  {'f': 0.0005556327981289956, 'p': 0.00048809523809523826, 'r': 0.0009438901855072961}
rougeL:  {'f': 0.097887394577256, 'p': 0.6118333333333333, 'r': 0.054991099072330796}
</code></pre></div>


<hr>
<blockquote>
<ul>
<li>结论: 至少在目前的版本下, 量化后模型的表现下降了太多, 所以在文本摘要的具体任务下, 不适宜进行量化操作!!!</li>
</ul>
</blockquote>
<hr>
<ul>
<li>注意: 如果出现一种稍微特殊的情况, 就是对外提供服务的是一台GPU服务器, 但是手头只有一个CPU训练好的模型, 这个时候只要在加载模型的时候采用下面的代码就可以了:</li>
</ul>
<div class="codehilite" id="__code_32"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_32 pre, #__code_32 code"><span class="md-clipboard__message"></span></button><pre id="__code_33"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_33 pre, #__code_33 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 实例化模型类对象</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">PGN</span><span class="p">()</span>

<span class="c1"># CPU的模型参数, 加载到GPU服务器上运行</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="k">lambda</span> <span class="n">storage</span><span class="p">,</span> <span class="n">loc</span><span class="p">:</span><span class="n">storage</span><span class="o">.</span><span class="n">cuda</span><span class="p">)</span>
</code></pre></div>


<hr>
<hr>
<h3 id="_4">模型部署</h3>
<h4 id="gpuflask">GPU环境Flask部署</h4>
<ul>
<li>首先进行GPU部署的测试.<ul>
<li>第一步: 编写主服务逻辑代码.</li>
<li>第二步: 启动Flask服务.</li>
<li>第三步: 编写测试代码.</li>
<li>第四步: 执行测试并检验结果.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>第一步: 编写主服务逻辑代码.<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/server/app.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_34"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_34 pre, #__code_34 code"><span class="md-clipboard__message"></span></button><pre id="__code_35"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_35 pre, #__code_35 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入必备工具包</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">jieba</span>

<span class="c1"># 设定项目的root路径, 方便后续相关代码文件的导入</span>
<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="c1"># 服务框架使用Flask, 导入工具包</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># 导入发送http请求的requests工具</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># 导入项目相关的代码文件</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">src.model</span> <span class="kn">import</span> <span class="n">PGN</span>
<span class="kn">from</span> <span class="nn">utils.dataset</span> <span class="kn">import</span> <span class="n">PairDataset</span>
<span class="kn">from</span> <span class="nn">utils.func_utils</span> <span class="kn">import</span> <span class="n">source2ids</span><span class="p">,</span> <span class="n">outputids2words</span><span class="p">,</span> <span class="n">Beam</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">add2heap</span><span class="p">,</span> <span class="n">replace_oovs</span>
<span class="c1"># 导入专门针对GPU的预测类Predict</span>
<span class="kn">from</span> <span class="nn">server.predict</span> <span class="kn">import</span> <span class="n">Predict</span>

<span class="c1"># 加载自定义的停用词字典</span>
<span class="n">jieba</span><span class="o">.</span><span class="n">load_userdict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">stop_word_file</span><span class="p">)</span>

<span class="c1"># 实例化Predict对象, 用于推断摘要, 提供服务请求</span>
<span class="n">predict</span> <span class="o">=</span> <span class="n">Predict</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'预测类Predict实例化完毕...'</span><span class="p">)</span>

<span class="c1"># 设定文本摘要服务的路由和请求方法</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/v1/main_server/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">main_server</span><span class="p">():</span>
    <span class="c1"># 接收来自请求方发送的服务字段</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">'uid'</span><span class="p">]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span>

    <span class="c1"># 对请求文本进行处理</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">jieba</span><span class="o">.</span><span class="n">lcut</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="c1"># 调用预测类对象执行摘要提取</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">predict</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>
</code></pre></div>


<hr>
<ul>
<li>第二步: 启动Flask服务.</li>
</ul>
<div class="codehilite" id="__code_36"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_36 pre, #__code_36 code"><span class="md-clipboard__message"></span></button><pre id="__code_37"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_37 pre, #__code_37 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/server/

gunicorn -w <span class="m">1</span> -b <span class="m">0</span>.0.0.0:5000 app:app
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_38"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_38 pre, #__code_38 code"><span class="md-clipboard__message"></span></button><pre id="__code_39"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_39 pre, #__code_39 code"><span class="md-clipboard__message"></span></button><code>[2021-03-18 14:33:50 +0000] [21460] [INFO] Starting gunicorn 20.0.4
[2021-03-18 14:33:50 +0000] [21460] [INFO] Listening at: http://0.0.0.0:5000 (21460)
[2021-03-18 14:33:50 +0000] [21460] [INFO] Using worker: sync
[2021-03-18 14:33:50 +0000] [21463] [INFO] Booting worker with pid: 21463
Building prefix dict from the default dictionary ...
Loading model from cache /tmp/jieba.cache
Loading model cost 0.814 seconds.
Prefix dict has been built successfully.
Reading dataset /home/ec2-user/text_summary/pgn/data/train.txt... 70000 pairs.
9.655232667922974 secs used for  initalize predicter
预测类Predict实例化完毕...
</code></pre></div>


<hr>
<ul>
<li>第三步: 编写测试代码.<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/server/test.py </li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_40"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_40 pre, #__code_40 code"><span class="md-clipboard__message"></span></button><pre id="__code_41"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_41 pre, #__code_41 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># 定义请求url和传入的data</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">"http://0.0.0.0:5000/v1/main_server/"</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"uid"</span><span class="p">:</span> <span class="s2">"AI-6-202104"</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">:</span> <span class="s2">"丰田花冠行驶十万公里皮带要换正时皮带，这种车型10万公里最好更换一次。皮&gt;带时间长会出现老化出现断裂，会损坏发动机，造成车辆抛锚。发电机皮带都需要检查一下。"</span><span class="p">}</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1"># 向服务发送post请求</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="n">cost_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="c1"># 打印返回的结果</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'文本摘要是: '</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'单条样本耗时: '</span><span class="p">,</span> <span class="n">cost_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">'ms'</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>第四步: 执行测试并检验结果.</li>
</ul>
<div class="codehilite" id="__code_42"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_42 pre, #__code_42 code"><span class="md-clipboard__message"></span></button><pre id="__code_43"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_43 pre, #__code_43 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/server/

python test.py
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_44"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_44 pre, #__code_44 code"><span class="md-clipboard__message"></span></button><pre id="__code_45"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_45 pre, #__code_45 code"><span class="md-clipboard__message"></span></button><code>文本摘要是:  长会 出现 这种 情况 ， 需要 更换 。 皮带 时间 长 会 出现 这种 情况 。10 万公里 需要
单条样本耗时:  59.73529815673828 ms
</code></pre></div>


<hr>
<blockquote>
<ul>
<li>GPU部署结论: 总体来说模型效果不错, 单条样本运行时间在60ms附近, 可以大规模应用于离线分析. 或者并发性不高的在线预测. </li>
</ul>
</blockquote>
<hr>
<h4 id="cpuflask">CPU环境Flask部署</h4>
<ul>
<li>然后进行CPU部署的测试.<ul>
<li>第一步: 编写主服务逻辑代码.</li>
<li>第二步: 启动Flask服务.</li>
<li>第三步: 编写测试代码.</li>
<li>第四步: 执行测试并检验结果.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>第一步: 编写主服务逻辑代码.<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/server/app.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_46"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_46 pre, #__code_46 code"><span class="md-clipboard__message"></span></button><pre id="__code_47"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_47 pre, #__code_47 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入必备工具包</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">jieba</span>

<span class="c1"># 设定项目的root路径, 方便后续相关代码文件的导入</span>
<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="c1"># 服务框架使用Flask, 导入工具包</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># 导入发送http请求的requests工具</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># 导入项目相关的代码文件</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">src.model</span> <span class="kn">import</span> <span class="n">PGN</span>
<span class="kn">from</span> <span class="nn">utils.dataset</span> <span class="kn">import</span> <span class="n">PairDataset</span>
<span class="kn">from</span> <span class="nn">utils.func_utils</span> <span class="kn">import</span> <span class="n">source2ids</span><span class="p">,</span> <span class="n">outputids2words</span><span class="p">,</span> <span class="n">Beam</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">add2heap</span><span class="p">,</span> <span class="n">replace_oovs</span>
<span class="c1"># 导入专门针对CPU的预测类Predict</span>
<span class="kn">from</span> <span class="nn">server.predict_cpu</span> <span class="kn">import</span> <span class="n">Predict</span>

<span class="c1"># 加载自定义的停用词字典</span>
<span class="n">jieba</span><span class="o">.</span><span class="n">load_userdict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">stop_word_file</span><span class="p">)</span>

<span class="c1"># 实例化Predict对象, 用于推断摘要, 提供服务请求</span>
<span class="n">predict</span> <span class="o">=</span> <span class="n">Predict</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'预测类Predict实例化完毕...'</span><span class="p">)</span>

<span class="c1"># 设定文本摘要服务的路由和请求方法</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/v1/main_server/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">main_server</span><span class="p">():</span>
    <span class="c1"># 接收来自请求方发送的服务字段</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">'uid'</span><span class="p">]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span>

    <span class="c1"># 对请求文本进行处理</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">jieba</span><span class="o">.</span><span class="n">lcut</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="c1"># 调用预测类对象执行摘要提取</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">predict</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>
</code></pre></div>


<hr>
<ul>
<li>第二步: 启动Flask服务:</li>
</ul>
<div class="codehilite" id="__code_48"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_48 pre, #__code_48 code"><span class="md-clipboard__message"></span></button><pre id="__code_49"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_49 pre, #__code_49 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/server/

gunicorn -w <span class="m">1</span> -b <span class="m">0</span>.0.0.0:5000 app:app
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_50"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_50 pre, #__code_50 code"><span class="md-clipboard__message"></span></button><pre id="__code_51"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_51 pre, #__code_51 code"><span class="md-clipboard__message"></span></button><code>[2021-03-19 08:32:16 +0000] [4293] [INFO] Starting gunicorn 20.0.4
[2021-03-19 08:32:16 +0000] [4293] [INFO] Listening at: http://0.0.0.0:5000 (4293)
[2021-03-19 08:32:16 +0000] [4293] [INFO] Using worker: sync
[2021-03-19 08:32:16 +0000] [4302] [INFO] Booting worker with pid: 4302
Building prefix dict from the default dictionary ...
Loading model from cache /tmp/jieba.cache
Loading model cost 0.746 seconds.
Prefix dict has been built successfully.
Reading dataset /home/ec2-user/text_summary/pgn/data/train.txt... 70000 pairs.
6.9905993938446045 secs used for  initalize predicter
预测类Predict实例化完毕...
</code></pre></div>


<hr>
<ul>
<li>第三步: 编写测试代码.<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/server/test.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_52"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_52 pre, #__code_52 code"><span class="md-clipboard__message"></span></button><pre id="__code_53"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_53 pre, #__code_53 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># 定义请求url和传入的data</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">"http://0.0.0.0:5000/v1/main_server/"</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"uid"</span><span class="p">:</span> <span class="s2">"AI-6-202104"</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">:</span> <span class="s2">"丰田花冠行驶十万公里皮带要换正时皮带，这种车型10万公里最好更换一次。皮&gt;带时间长会出现老化出现断裂，会损坏发动机，造成车辆抛锚。发电机皮带都需要检查一下。"</span><span class="p">}</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1"># 向服务发送post请求</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="n">cost_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="c1"># 打印返回的结果</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'文本摘要是: '</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'单条样本耗时: '</span><span class="p">,</span> <span class="n">cost_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">'ms'</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>第四步: 执行测试并检验结果.</li>
</ul>
<div class="codehilite" id="__code_54"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_54 pre, #__code_54 code"><span class="md-clipboard__message"></span></button><pre id="__code_55"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_55 pre, #__code_55 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/server/

python test.py
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_56"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_56 pre, #__code_56 code"><span class="md-clipboard__message"></span></button><pre id="__code_57"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_57 pre, #__code_57 code"><span class="md-clipboard__message"></span></button><code>文本摘要是:  长会 出现 这种 情况 ， 需要 更换 。 皮带 时间 长 会 出现 这种 情况 。10 万公里 需要
单条样本耗时:  154.26969528198242 ms
</code></pre></div>


<hr>
<blockquote>
<ul>
<li>CPU部署结论: 因为采用的模型是同一个模型, 这里是baseline-3, 所以CPU部署后的模型输出和GPU完全一样. 唯一不同就是单条样本的耗时大概为150ms级别, 对于更长的文本耗时会更高. 因此更适合离线作业, 对于在线提取只能是分布式部署, 或者低并发量的业务场景.</li>
</ul>
</blockquote>
<hr>
<hr>
<h3 id="_5">小节总结</h3>
<ul>
<li>
<p>小节总结: 本小节主要针对硬件优化和模型部署展开讨论.</p>
</li>
<li>
<p>硬件优化:</p>
<ul>
<li>GPU优化:<ul>
<li>训练阶段可以极大的提升效率, 预测阶段可以提高速度.</li>
<li>GPU训练好的模型, 如果部署在CPU上面, 需要做特殊的转换, 将GPU tensor转换成CPU上的数据格式.</li>
</ul>
</li>
<li>CPU优化:<ul>
<li>CPU优化主要指模型量化操作, 量化本身是一项重要的模型优化方法, 但是在具体的尝试中发现文本摘要任务的量化模型表现很差, 无法实际应用.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>模型部署:</p>
<ul>
<li>GPU部署:<ul>
<li>编写app.py主逻辑代码时要注意加载GPU版本的模型.</li>
<li>启动Flask服务进行测试, GPU部署大概可以在50ms级别完成预测.</li>
</ul>
</li>
<li>CPU部署:<ul>
<li>编写app.py主逻辑代码时要注意加载CPU版本的模型.</li>
<li>启动Flask服务进行测试, CPU部署大概可以在150ms级别完成预测.</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<hr>
<hr>
<hr>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="./6_4.html" title="6.4 训练策略的优化" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  上一页
                </span>
                6.4 训练策略的优化
              </span>
            </div>
          </a>
        
        
          <a href="./7_2.html" title="7.2 项目总结" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  下一页
                </span>
                7.2 项目总结
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            ©Copyright 2020, AITutorials.CN This website has been reviewed by the review agency. 京ICP备19006137号
          </div>
        
        powered by
        <a href="https://www.mkdocs.org/">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="./index_files/font-awesome.css">
    
      <a href="https://www.linkedin.com/in/%E7%A7%91%E6%8A%80%E6%9C%89%E9%99%90%E5%85%AC%E5%8F%B8-%E5%8C%97%E4%BA%AC%E6%A9%98%E6%98%9F-6bb7081a1/" class="md-footer-social__link fa fa-linkedin"></a>
    
      <a href="https://weibo.com/u/3469990762?is_all=1" class="md-footer-social__link fa fa-weibo"></a>
    
      <a href="http://bitbucket.org/AITutorials" class="md-footer-social__link fa fa-bitbucket"></a>
    
      <a href="https://github.com/AITutorials/datasets/issues" class="md-footer-social__link fa fa-gitlab"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="./index_files/application.245445c6.js"></script>
      
        
        
          
          <script src="./index_files/lunr.stemmer.support.js"></script>
          
            
              
                <script src="./index_files/tinyseg.js"></script>
              
              
                <script src="./index_files/lunr.ja.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.1.2",url:{base:".."}})</script>
      
    
  
</body></html>