<!DOCTYPE html>
<!-- saved from url=(0031)http://121.199.45.168:8818/6_3/ -->
<html lang="zh" class="js json svg checked target dataset details fetch supports csstransforms3d no-ios" style=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
      
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://0.0.0.0:8818/6_3/">
      
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="ja">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="./index_files/AI.jpg">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-4.4.0">
    
    
      
        <title>6.3 数据增强的优化 - 文本摘要项目</title>
      
    
    
      <link rel="stylesheet" href="./index_files/application.0284f74d.css">
      
      
    
    
      <script src="./index_files/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin="">
        <link rel="stylesheet" href="./index_files/css">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="./index_files/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-36723568-3", "mkdocs.org")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async="" src="./index_files/analytics.js"></script>
      
    
    
  <script type="text/javascript">(function(){var s=document.createElement("script");var port=window.location.port;s.src="//"+window.location.hostname+":"+port+ "/livereload.js?port=" + port;document.head.appendChild(s);})();</script><script src="./index_files/livereload.js"></script></head>
  
    <body dir="ltr" data-md-state="">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"></path></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#_1" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header" data-md-state="shadow">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="./1_1.html" title="文本摘要项目" class="md-header-nav__button md-logo">
          
            <img src="./index_files/AI.jpg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic" style="width: 648px;">
              文本摘要项目
            </span>
            <span class="md-header-nav__topic" style="width: 648px;">
              
                6.3 数据增强的优化
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix="">
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/AITutorials/manuals" title="前往 Github 仓库" class="md-source" data-md-source="github" data-md-state="done">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Github
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" style="height: 509px;">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="./1_1.html" title="文本摘要项目" class="md-nav__button md-logo">
      
        <img src="./index_files/AI.jpg" width="48" height="48">
      
    </a>
    文本摘要项目
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/AITutorials/manuals" title="前往 Github 仓库" class="md-source" data-md-source="github" data-md-state="done">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Github
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix="">
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      第一章:文本摘要项目简介
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: none; overflow: hidden;">
      <label class="md-nav__title" for="nav-1">
        第一章:文本摘要项目简介
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./1_1.html" title="1.1 项目背景介绍" class="md-nav__link">
      1.1 项目背景介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./1_2.html" title="1.2 项目中的数据集初探" class="md-nav__link">
      1.2 项目中的数据集初探
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      第二章:TextRank模型
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: none; overflow: hidden;">
      <label class="md-nav__title" for="nav-2">
        第二章:TextRank模型
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./2_1.html" title="2.1 TextRank算法理论基础" class="md-nav__link">
      2.1 TextRank算法理论基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./2_2.html" title="2.2 TextRank实现baseline-0模型" class="md-nav__link">
      2.2 TextRank实现baseline-0模型
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      第三章:seq2seq经典架构
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: none; overflow: hidden;">
      <label class="md-nav__title" for="nav-3">
        第三章:seq2seq经典架构
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./3_1.html" title="3.1 seq2seq实现baseline-1模型" class="md-nav__link">
      3.1 seq2seq实现baseline-1模型
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./3_2.html" title="3.2 baseline-1模型的优化" class="md-nav__link">
      3.2 baseline-1模型的优化
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      第四章:PGN先进架构
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: none; overflow: hidden;">
      <label class="md-nav__title" for="nav-4">
        第四章:PGN先进架构
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./4_1.html" title="4.1 PGN架构解析" class="md-nav__link">
      4.1 PGN架构解析
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./4_2.html" title="4.2 PGN模型的数据处理" class="md-nav__link">
      4.2 PGN模型的数据处理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./4_3.html" title="4.3 PGN实现baseline-2模型" class="md-nav__link">
      4.3 PGN实现baseline-2模型
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      第五章:生成式模型的评估方法
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: none; overflow: hidden;">
      <label class="md-nav__title" for="nav-5">
        第五章:生成式模型的评估方法
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./5_1.html" title="5.1 文本摘要评估方法" class="md-nav__link">
      5.1 文本摘要评估方法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./5_2.html" title="5.2 ROUGE评估算法实现" class="md-nav__link">
      5.2 ROUGE评估算法实现
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked="">
    
    <label class="md-nav__link" for="nav-6">
      第六章:模型的迭代优化
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: block; overflow: visible;">
      <label class="md-nav__title" for="nav-6">
        第六章:模型的迭代优化
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./6_1.html" title="6.1 PGN + coverage的优化模型" class="md-nav__link">
      6.1 PGN + coverage的优化模型
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./6_2.html" title="6.2 PGN + beam-search的优化模型" class="md-nav__link">
      6.2 PGN + beam-search的优化模型
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        6.3 数据增强的优化
      </label>
    
    <a href="" title="6.3 数据增强的优化" class="md-nav__link md-nav__link--active">
      6.3 数据增强的优化
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix="">
      
        <li class="md-nav__item">
  <a href="#_1" title="从数据角度优化模型" class="md-nav__link">
    从数据角度优化模型
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" title="学习目标" class="md-nav__link">
    学习目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="数据优化策略简介" class="md-nav__link">
    数据优化策略简介
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="单词替换法" class="md-nav__link">
    单词替换法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tf-idf" title="TF-IDF算法介绍" class="md-nav__link">
    TF-IDF算法介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tf-idf_1" title="训练TF-IDF模型" class="md-nav__link">
    训练TF-IDF模型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="构建替换单词的类代码" class="md-nav__link">
    构建替换单词的类代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#baseline-5" title="训练baseline-5模型" class="md-nav__link">
    训练baseline-5模型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#baseline-5_1" title="评估baseline-5模型" class="md-nav__link">
    评估baseline-5模型
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="回译数据法" class="md-nav__link">
    回译数据法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#google" title="Google翻译接口" class="md-nav__link">
    Google翻译接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#baseline-6" title="训练baseline-6模型" class="md-nav__link">
    训练baseline-6模型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#baseline-6_1" title="评估baseline-6模型" class="md-nav__link">
    评估baseline-6模型
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="半监督学习法" class="md-nav__link">
    半监督学习法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" title="半监督数据增强法" class="md-nav__link">
    半监督数据增强法
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="小节总结" class="md-nav__link">
    小节总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./6_4.html" title="6.4 训练策略的优化" class="md-nav__link">
      6.4 训练策略的优化
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      第七章:模型的部署与总结
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1" style="display: none; overflow: hidden;">
      <label class="md-nav__title" for="nav-7">
        第七章:模型的部署与总结
      </label>
      <ul class="md-nav__list" data-md-scrollfix="">
        
        
          
          
          


  <li class="md-nav__item">
    <a href="./7_1.html" title="7.1 硬件优化与模型部署" class="md-nav__link">
      7.1 硬件优化与模型部署
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./7_2.html" title="7.2 项目总结" class="md-nav__link">
      7.2 项目总结
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" style="height: 509px;">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix="">
      
        <li class="md-nav__item">
  <a href="#_1" title="从数据角度优化模型" class="md-nav__link">
    从数据角度优化模型
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" title="学习目标" class="md-nav__link">
    学习目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="数据优化策略简介" class="md-nav__link">
    数据优化策略简介
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="单词替换法" class="md-nav__link">
    单词替换法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tf-idf" title="TF-IDF算法介绍" class="md-nav__link">
    TF-IDF算法介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tf-idf_1" title="训练TF-IDF模型" class="md-nav__link">
    训练TF-IDF模型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" title="构建替换单词的类代码" class="md-nav__link">
    构建替换单词的类代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#baseline-5" title="训练baseline-5模型" class="md-nav__link">
    训练baseline-5模型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#baseline-5_1" title="评估baseline-5模型" class="md-nav__link">
    评估baseline-5模型
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="回译数据法" class="md-nav__link">
    回译数据法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#google" title="Google翻译接口" class="md-nav__link">
    Google翻译接口
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#baseline-6" title="训练baseline-6模型" class="md-nav__link">
    训练baseline-6模型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#baseline-6_1" title="评估baseline-6模型" class="md-nav__link">
    评估baseline-6模型
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="半监督学习法" class="md-nav__link">
    半监督学习法
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" title="半监督数据增强法" class="md-nav__link">
    半监督数据增强法
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" title="小节总结" class="md-nav__link">
    小节总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>6.3 数据增强的优化</h1>
                
                <h2 id="_1">从数据角度优化模型</h2>
<hr>
<h3 id="_2">学习目标</h3>
<ul>
<li>理解几种重要的数据优化策略.</li>
<li>掌握相应数据优化策略的代码实现.</li>
</ul>
<hr>
<h3 id="_3">数据优化策略简介</h3>
<ul>
<li>人工智能从本质上就是"数据" + "算法" + "算力"的合成体. 算法基本全世界公开化, 算力在国内的大环境下也不是太大的难题, 很多项目最终能否上线, 以及能否在竞争中杀出重围的关键就落在"数据"上.</li>
</ul>
<hr>
<ul>
<li>曾经有一家德国的小型AI创业公司, 在若干NLP任务上取得了比谷歌更棒的效果, 究其原因就在于研究团队将70%以上的精力放在优化数据上, 这家德国公司在数据标注上做到了非常精深的地步, 从而让模型"吃饱吃好", 学到更"优质的特征".</li>
</ul>
<hr>
<ul>
<li>少样本问题: 除了从源头上优化标注数据, 在NLP领域经常面临的一个困扰就是"少样本问题", 尤其在最值钱的金融, 医疗, 法律等垂直领域, 更是缺乏高质量的标注语料. 因此数据优化的很大一部分内容即是"数据增强技术". 目前工业界主要应用三种方法:<ul>
<li>单词替换法</li>
<li>回译数据法</li>
<li>半监督学习法</li>
</ul>
</li>
</ul>
<hr>
<hr>
<h3 id="_4">单词替换法</h3>
<h4 id="tf-idf">TF-IDF算法介绍</h4>
<ul>
<li>首先思考一个问题: 如何在一篇很长的文章中, 完全不加以人工干预的提取到它的关键词?</li>
</ul>
<p></p><center><img alt="" src="./index_files/36.png"></center><p></p>
<hr>
<ul>
<li>TF-IDF算法介绍: 一个很清晰的思路是要找到标准来衡量什么特点的单词是关键词?<ul>
<li>TF算法: 词频(Term Frequency)</li>
<li>IDF算法: 逆文档频率(Inverse Document Frequency)</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>TF算法: 词频(Term Frequency)<ul>
<li>如果一个单词很重要, 那么最直观的想法是这个单词在整篇文章中出现的次数比较多, 这也就是词频的来源.</li>
<li>TF = 某个词在文章中出现的次数/该文章的总词数</li>
<li>一个词在文章中出现次数越多, TF值越大.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>IDF算法: 逆文档频率(Inverse Document Frequency)<ul>
<li>同时要考虑到一个现实情况, 那就是"的", "是", "了"这样的单词出现次数一定特别多, 但是对于文章来说肯定不是关键词, 原因就是这些词"太普遍了"! 我们不仅仅要考察哪些词出现次数多, 同时还要考虑这些词在总体文档中是否普遍出现.</li>
<li>IDF = log(语料库的文档总数/(包含该单词的文档数 + 1))</li>
<li>一个词越常见, 那么分母就越大, log函数内值越接近1, IDF值越小.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>TF-IDF算法:<ul>
<li>TFIDF = TF * IDF</li>
<li>这里用到了乘法效应, 单词出现次数越大, 同时越不普遍, 则TF和IDF都大, 则TFIDF也越大.</li>
<li>如果单词出现次数很多, 但是属于很常见的词, 则TF大同时IDF小, 乘积得到一个中和效应.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<p>利用gensim实现TF-IDF算法.</p>
</li>
<li>
<p>利用gensim为工具包实现TF-IDF, 需要依次执行下面的几个步骤:</p>
<ul>
<li>第一步: 完成语句的分词.</li>
<li>第二步: 构造映射字典.</li>
<li>第三步: 训练得到TF-IDF模型.</li>
<li>第四步: 加载模型完成文本向量化.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/optim/demo.py</li>
</ul>
<hr>
<ul>
<li>第一步: 完成语句的分词.</li>
</ul>
<div class="codehilite" id="__code_0"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_0 pre, #__code_0 code"><span class="md-clipboard__message"></span></button><pre id="__code_1"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_1 pre, #__code_1 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入gensim中的字典和模型工具包</span>
<span class="kn">from</span> <span class="nn">gensim.corpora</span> <span class="kn">import</span> <span class="n">Dictionary</span>
<span class="kn">from</span> <span class="nn">gensim</span> <span class="kn">import</span> <span class="n">models</span>

<span class="c1"># 模拟一段输入文本数据</span>
<span class="n">corpus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'this is the first document'</span><span class="p">,</span>
          <span class="s1">'this is the second second document'</span><span class="p">,</span>
          <span class="s1">'and the third one'</span><span class="p">,</span>
          <span class="s1">'is this the first document'</span>
         <span class="p">]</span>

<span class="c1"># 手动分词并构造列表</span>
<span class="n">word_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)):</span>
    <span class="n">word_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corpus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_2"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_2 pre, #__code_2 code"><span class="md-clipboard__message"></span></button><pre id="__code_3"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_3 pre, #__code_3 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/optim/

python demo.py
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_4"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_4 pre, #__code_4 code"><span class="md-clipboard__message"></span></button><pre id="__code_5"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_5 pre, #__code_5 code"><span class="md-clipboard__message"></span></button><code>[['this', 'is', 'the', 'first', 'document'],
 ['this', 'is', 'the', 'second', 'second', 'document'],
 ['and', 'the', 'third', 'one'],
 ['is', 'this', 'the', 'first', 'document']]
</code></pre></div>


<hr>
<ul>
<li>第二步: 构造映射字典.</li>
</ul>
<div class="codehilite" id="__code_6"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_6 pre, #__code_6 code"><span class="md-clipboard__message"></span></button><pre id="__code_7"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_7 pre, #__code_7 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入gensim中的字典和模型工具包</span>
<span class="kn">from</span> <span class="nn">gensim.corpora</span> <span class="kn">import</span> <span class="n">Dictionary</span>
<span class="kn">from</span> <span class="nn">gensim</span> <span class="kn">import</span> <span class="n">models</span>

<span class="c1"># 模拟一段输入文本数据</span>
<span class="n">corpus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'this is the first document'</span><span class="p">,</span>
          <span class="s1">'this is the second second document'</span><span class="p">,</span>
          <span class="s1">'and the third one'</span><span class="p">,</span>
          <span class="s1">'is this the first document'</span>
         <span class="p">]</span>

<span class="c1"># 手动分词并构造列表</span>
<span class="n">word_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)):</span>
    <span class="n">word_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corpus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'*******************************'</span><span class="p">)</span>

<span class="c1"># 将分词后的列表结构送入字典类中, 得到实例化对象.</span>
<span class="c1"># 本质作用是给语料库中的每个词(不重复的词)赋值一个整数id</span>
<span class="n">dictionary</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>

<span class="c1"># 调用.doc2bow()方法即可得到文本的字典映射.</span>
<span class="c1"># 结果元组中的第一个元素是单词在词典中对应的id, 第二个元素是单词在文档中出现的次数.</span>
<span class="n">new_corpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">dictionary</span><span class="o">.</span><span class="n">doc2bow</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">word_list</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="n">new_corpus</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'*******************************'</span><span class="p">)</span>

<span class="c1"># 将单词到数字的映射字典打印出来.</span>
<span class="k">print</span><span class="p">(</span><span class="n">dictionary</span><span class="o">.</span><span class="n">token2id</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_8"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_8 pre, #__code_8 code"><span class="md-clipboard__message"></span></button><pre id="__code_9"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_9 pre, #__code_9 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/optim/

python demo.py
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_10"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_10 pre, #__code_10 code"><span class="md-clipboard__message"></span></button><pre id="__code_11"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_11 pre, #__code_11 code"><span class="md-clipboard__message"></span></button><code>[['this', 'is', 'the', 'first', 'document'], ['this', 'is', 'the', 'second', 'second', 'document'], ['and', 'the', 'third', 'one'], ['is', 'this', 'the', 'first', 'document']]
*******************************
[[(0, 1), (1, 1), (2, 1), (3, 1), (4, 1)], [(0, 1), (2, 1), (3, 1), (4, 1), (5, 2)], [(3, 1), (6, 1), (7, 1), (8, 1)], [(0, 1), (1, 1), (2, 1), (3, 1), (4, 1)]]
*******************************
{'document': 0, 'first': 1, 'is': 2, 'the': 3, 'this': 4, 'second': 5, 'and': 6, 'one': 7, 'third': 8}
</code></pre></div>


<hr>
<ul>
<li>第三步: 训练得到TF-IDF模型.</li>
</ul>
<div class="codehilite" id="__code_12"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_12 pre, #__code_12 code"><span class="md-clipboard__message"></span></button><pre id="__code_13"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_13 pre, #__code_13 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入gensim中的字典和模型工具包</span>
<span class="kn">from</span> <span class="nn">gensim.corpora</span> <span class="kn">import</span> <span class="n">Dictionary</span>
<span class="kn">from</span> <span class="nn">gensim</span> <span class="kn">import</span> <span class="n">models</span>

<span class="c1"># 模拟一段输入文本数据</span>
<span class="n">corpus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'this is the first document'</span><span class="p">,</span>
          <span class="s1">'this is the second second document'</span><span class="p">,</span>
          <span class="s1">'and the third one'</span><span class="p">,</span>
          <span class="s1">'is this the first document'</span>
         <span class="p">]</span>

<span class="c1"># 手动分词并构造列表</span>
<span class="n">word_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)):</span>
    <span class="n">word_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corpus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>

<span class="c1"># 将分词后的列表结构送入字典类中, 得到实例化对象.</span>
<span class="n">dictionary</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>

<span class="c1"># 调用.doc2bow()方法即可得到文本的字典映射.</span>
<span class="c1"># 结果元组中的第一个元素是单词在词典中对应的id, 第二个元素是单词在文档中出现的次数.</span>
<span class="n">new_corpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">dictionary</span><span class="o">.</span><span class="n">doc2bow</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">word_list</span><span class="p">]</span>

<span class="c1"># 将单词到数字的映射字典打印出来.</span>
<span class="k">print</span><span class="p">(</span><span class="n">dictionary</span><span class="o">.</span><span class="n">token2id</span><span class="p">)</span>

<span class="c1"># 将由字典Dictionary生成的数字化文档作为参数, 传入模型类中训练TF-IDF模型</span>
<span class="n">tfidf</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TfidfModel</span><span class="p">(</span><span class="n">new_corpus</span><span class="p">)</span>

<span class="c1"># 保存训练好的模型并打印</span>
<span class="n">tfidf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">'demo.tfidf'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">tfidf</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_14"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_14 pre, #__code_14 code"><span class="md-clipboard__message"></span></button><pre id="__code_15"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_15 pre, #__code_15 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/optim/

python demo.py
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_16"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_16 pre, #__code_16 code"><span class="md-clipboard__message"></span></button><pre id="__code_17"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_17 pre, #__code_17 code"><span class="md-clipboard__message"></span></button><code>{'document': 0, 'first': 1, 'is': 2, 'the': 3, 'this': 4, 'second': 5, 'and': 6, 'one': 7, 'third': 8}
*******************************
TfidfModel(num_docs=4, num_nnz=19)
</code></pre></div>


<hr>
<ul>
<li>第四步: 加载模型完成文本向量化.</li>
</ul>
<div class="codehilite" id="__code_18"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_18 pre, #__code_18 code"><span class="md-clipboard__message"></span></button><pre id="__code_19"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_19 pre, #__code_19 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入gensim中的字典和模型工具包</span>
<span class="kn">from</span> <span class="nn">gensim.corpora</span> <span class="kn">import</span> <span class="n">Dictionary</span>
<span class="kn">from</span> <span class="nn">gensim</span> <span class="kn">import</span> <span class="n">models</span>

<span class="c1"># 模拟一段输入文本数据</span>
<span class="n">corpus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'this is the first document'</span><span class="p">,</span>
          <span class="s1">'this is the second second document'</span><span class="p">,</span>
          <span class="s1">'and the third one'</span><span class="p">,</span>
          <span class="s1">'is this the first document'</span>
         <span class="p">]</span>

<span class="c1"># 手动分词并构造列表</span>
<span class="n">word_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)):</span>
    <span class="n">word_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corpus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>

<span class="c1"># 将分词后的列表结构送入字典类中, 得到实例化对象.</span>
<span class="n">dictionary</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>

<span class="c1"># 调用.doc2bow()方法即可得到文本的字典映射.</span>
<span class="c1"># 结果元组中的第一个元素是单词在词典中对应的id, 第二个元素是单词在文档中出现的次数.</span>
<span class="n">new_corpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">dictionary</span><span class="o">.</span><span class="n">doc2bow</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">word_list</span><span class="p">]</span>

<span class="c1"># 将第三步保存的模型加载进内存</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TfidfModel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'demo.tfidf'</span><span class="p">)</span>

<span class="c1"># 将原始文本利用训练好的TF-IDF模型进行数字化映射.</span>
<span class="n">tfidf_vec</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">corpus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">s_bow</span> <span class="o">=</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">doc2bow</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">s_tfidf</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">s_bow</span><span class="p">]</span>
    <span class="n">tfidf_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_tfidf</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">tfidf_vec</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_20"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_20 pre, #__code_20 code"><span class="md-clipboard__message"></span></button><pre id="__code_21"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_21 pre, #__code_21 code"><span class="md-clipboard__message"></span></button><code>[[(0, 0.33699829595119235), (1, 0.8119707171924228), (2, 0.33699829595119235), (4, 0.33699829595119235)],
 [(0, 0.10212329019650272), (2, 0.10212329019650272), (4, 0.10212329019650272), (5, 0.9842319344536239)],
 [(6, 0.5773502691896258), (7, 0.5773502691896258), (8, 0.5773502691896258)],
 [(0, 0.33699829595119235), (1, 0.8119707171924228), (2, 0.33699829595119235), (4, 0.33699829595119235)]]
</code></pre></div>


<hr>
<blockquote>
<ul>
<li>思考: 上面最后得到的映射文档有何特点? 有没有什么问题?</li>
</ul>
</blockquote>
<hr>
<ul>
<li>疑问点: 生成的向量在维度上并不和原始文本单词数匹配! 而我们想得到每一个词的TF-IDF值, 这是什么原因呢? 我们通过一个测试代码来一探究竟:</li>
</ul>
<div class="codehilite" id="__code_22"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_22 pre, #__code_22 code"><span class="md-clipboard__message"></span></button><pre id="__code_23"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_23 pre, #__code_23 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入gensim中的字典和模型工具包</span>
<span class="kn">from</span> <span class="nn">gensim.corpora</span> <span class="kn">import</span> <span class="n">Dictionary</span>
<span class="kn">from</span> <span class="nn">gensim</span> <span class="kn">import</span> <span class="n">models</span>

<span class="c1"># 模拟一段输入文本数据</span>
<span class="n">corpus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'this is the first document'</span><span class="p">,</span>
          <span class="s1">'this is the second second document'</span><span class="p">,</span>
          <span class="s1">'and the third one'</span><span class="p">,</span>
          <span class="s1">'is this the first document'</span>
         <span class="p">]</span>

<span class="c1"># 手动分词并构造列表</span>
<span class="n">word_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)):</span>
    <span class="n">word_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corpus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>

<span class="c1"># 将分词后的列表结构送入字典类中, 得到实例化对象.</span>
<span class="n">dictionary</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>

<span class="c1"># 将保存的模型加载进内存</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TfidfModel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'demo.tfidf'</span><span class="p">)</span>

<span class="c1"># 随便给一行文本进行测试, 看看输出的张量有何特点.</span>
<span class="n">s</span> <span class="o">=</span> <span class="s1">'the i first second name'</span>
<span class="n">s_bow</span> <span class="o">=</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">doc2bow</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="n">s_tfidf</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">s_bow</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">s_tfidf</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_24"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_24 pre, #__code_24 code"><span class="md-clipboard__message"></span></button><pre id="__code_25"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_25 pre, #__code_25 code"><span class="md-clipboard__message"></span></button><code><span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ec2</span><span class="o">-</span><span class="n">user</span><span class="o">/</span><span class="n">text_summary</span><span class="o">/</span><span class="n">pgn</span><span class="o">/</span><span class="n">optim</span><span class="o">/</span>

<span class="n">python</span> <span class="n">demo</span><span class="o">.</span><span class="n">py</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_26"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_26 pre, #__code_26 code"><span class="md-clipboard__message"></span></button><pre id="__code_27"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_27 pre, #__code_27 code"><span class="md-clipboard__message"></span></button><code># 从输出结果看, 只输出了first, second两个单词对应的id和TF-IDF的值
[(1, 0.4472135954999579), (5, 0.8944271909999159)]
</code></pre></div>


<hr>
<ul>
<li>分析结果:</li>
</ul>
<div class="codehilite" id="__code_28"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_28 pre, #__code_28 code"><span class="md-clipboard__message"></span></button><pre id="__code_29"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_29 pre, #__code_29 code"><span class="md-clipboard__message"></span></button><code>1: gensim有自动去除停用词的功能, 比如the
2: gensim会自动去除单个字母, 比如i
3: gensim会去除没有在训练集中的词, 比如name
</code></pre></div>


<hr>
<blockquote>
<ul>
<li>结论: 综上得到最重要的一条结论, gensim并不能计算每个单词的TF-IDF值!</li>
</ul>
</blockquote>
<hr>
<ul>
<li>纯Python代码实现TF-IDF算法:<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/optim/demo1.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_30"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_30 pre, #__code_30 code"><span class="md-clipboard__message"></span></button><pre id="__code_31"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_31 pre, #__code_31 code"><span class="md-clipboard__message"></span></button><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="n">corpus</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'this is the first document'</span><span class="p">,</span>
          <span class="s1">'this is the second second document'</span><span class="p">,</span>
          <span class="s1">'and the third one'</span><span class="p">,</span>
          <span class="s1">'is this the first document'</span>
         <span class="p">]</span>

<span class="n">word_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="p">)):</span>
    <span class="n">word_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corpus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'**********************************'</span><span class="p">)</span>
<span class="n">countlist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word_list</span><span class="p">)):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">word_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">countlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">countlist</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'**********************************'</span><span class="p">)</span>

<span class="c1"># word可以通过count得到, count可以通过countlist得到</span>
<span class="c1"># count[word]可以得到每个单词的词频, sum(count.values())得到整个句子的单词总数</span>
<span class="k">def</span> <span class="nf">tf</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">count</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="c1"># 统计的是含有该单词的句子数</span>
<span class="k">def</span> <span class="nf">n_containing</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">count_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">count_list</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">count</span><span class="p">)</span>

<span class="c1"># len(count_list)是指句子的总数</span>
<span class="c1"># n_containing(word, count_list)是指含有该单词的句子的总数, 加1是为了防止分母为0</span>
<span class="k">def</span> <span class="nf">idf</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">count_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">count_list</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">n_containing</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">count_list</span><span class="p">)))</span>

<span class="c1"># 将tf和idf相乘</span>
<span class="k">def</span> <span class="nf">tfidf</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">count_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="o">*</span> <span class="n">idf</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">count_list</span><span class="p">)</span>

<span class="c1"># 循环遍历countlist, 并计算每个词的TF-IDF值.</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">countlist</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Top words in document {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">word</span><span class="p">:</span> <span class="n">tfidf</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">countlist</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">count</span><span class="p">}</span>
    <span class="n">sorted_words</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">sorted_words</span><span class="p">[:]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\t</span><span class="s2">Word: {}, TF-IDF: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_32"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_32 pre, #__code_32 code"><span class="md-clipboard__message"></span></button><pre id="__code_33"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_33 pre, #__code_33 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/optim/

python demo1.py
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_34"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_34 pre, #__code_34 code"><span class="md-clipboard__message"></span></button><pre id="__code_35"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_35 pre, #__code_35 code"><span class="md-clipboard__message"></span></button><code>[['this', 'is', 'the', 'first', 'document'],
 ['this', 'is', 'the', 'second', 'second', 'document'],
 ['and', 'the', 'third', 'one'],
 ['is', 'this', 'the', 'first', 'document']]
**********************************
[Counter({'this': 1, 'is': 1, 'the': 1, 'first': 1, 'document': 1}),
 Counter({'second': 2, 'this': 1, 'is': 1, 'the': 1, 'document': 1}),
 Counter({'and': 1, 'the': 1, 'third': 1, 'one': 1}),
 Counter({'is': 1, 'this': 1, 'the': 1, 'first': 1, 'document': 1})]
**********************************
Top words in document 1
        Word: first, TF-IDF: 0.05754
        Word: this, TF-IDF: 0.0
        Word: is, TF-IDF: 0.0
        Word: document, TF-IDF: 0.0
        Word: the, TF-IDF: -0.04463
Top words in document 2
        Word: second, TF-IDF: 0.23105
        Word: this, TF-IDF: 0.0
        Word: is, TF-IDF: 0.0
        Word: document, TF-IDF: 0.0
        Word: the, TF-IDF: -0.03719
Top words in document 3
        Word: and, TF-IDF: 0.17329
        Word: third, TF-IDF: 0.17329
        Word: one, TF-IDF: 0.17329
        Word: the, TF-IDF: -0.05579
Top words in document 4
        Word: first, TF-IDF: 0.05754
        Word: is, TF-IDF: 0.0
        Word: this, TF-IDF: 0.0
        Word: document, TF-IDF: 0.0
        Word: the, TF-IDF: -0.04463
</code></pre></div>


<hr>
<h4 id="tf-idf_1">训练TF-IDF模型</h4>
<ul>
<li>训练TF-IDF模型: 为了提高编码和训练效率, 我们采用gensim来辅助训练TF-IDF模型.<ul>
<li>目的: 利用训练好的模型帮助我们自动提取关键词, 以在单词替换时使用.</li>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/optim/train_tfidf.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_36"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_36 pre, #__code_36 code"><span class="md-clipboard__message"></span></button><pre id="__code_37"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_37 pre, #__code_37 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 导入工具包并设置项目的root路径, 方便后续相关代码文件的导入</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="c1"># 导入项目配置信息</span>
<span class="kn">from</span> <span class="nn">utils.config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1"># 导入gensim相关工具包</span>
<span class="kn">from</span> <span class="nn">gensim.corpora</span> <span class="kn">import</span> <span class="n">Dictionary</span>
<span class="kn">from</span> <span class="nn">gensim</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">gensim.models</span> <span class="kn">import</span> <span class="n">word2vec</span>

<span class="c1"># 指定训练集数据路径, 这里采用70000条完整训练集数据进行TF-IDF模型的训练.</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/train.txt'</span>

<span class="n">word_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">article</span><span class="p">,</span> <span class="n">abstract</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'&lt;SEP&gt;'</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">article</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="n">abstract</span>
        <span class="n">word_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'n='</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">'n='</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'word_list='</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_list</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'***********************************'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">'开始创建数字化字典......'</span><span class="p">)</span>
<span class="n">dictionary</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>
<span class="n">new_corpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">dictionary</span><span class="o">.</span><span class="n">doc2bow</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">word_list</span><span class="p">]</span>

<span class="n">saved_path</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/tf_idf/'</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'开始训练TF-IDF模型......'</span><span class="p">)</span>
<span class="n">tfidf</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TfidfModel</span><span class="p">(</span><span class="n">new_corpus</span><span class="p">)</span>

<span class="n">tfidf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">saved_path</span> <span class="o">+</span> <span class="s1">'text_summary_baseline-5.tfidf'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'保存TF-IDF模型完毕, 文件为text_summary_baseline-5.tfidf'</span><span class="p">)</span>

<span class="n">dictionary</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">saved_path</span> <span class="o">+</span> <span class="s1">'text_summary_baseline-5.dict'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'保存TF-IDF字典完毕, 文件为text_summary_baseline-5.dict'</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_38"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_38 pre, #__code_38 code"><span class="md-clipboard__message"></span></button><pre id="__code_39"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_39 pre, #__code_39 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/optim/train_tfidf.py

python train_tfidf.py
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_40"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_40 pre, #__code_40 code"><span class="md-clipboard__message"></span></button><pre id="__code_41"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_41 pre, #__code_41 code"><span class="md-clipboard__message"></span></button><code>n= 10000
n= 20000
n= 30000
n= 40000
n= 50000
n= 60000
n= 70000
n= 70000
word_list= 70000
***********************************
开始创建数字化字典......
开始训练TF-IDF模型......
保存TF-IDF模型完毕, 文件为text_summary_baseline-5.tfidf
保存TF-IDF字典完毕, 文件为text_summary_baseline-5.dict
</code></pre></div>


<hr>
<ul>
<li>查看保存的模型:</li>
</ul>
<div class="codehilite" id="__code_42"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_42 pre, #__code_42 code"><span class="md-clipboard__message"></span></button><pre id="__code_43"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_43 pre, #__code_43 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/tf_idf

ll
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_44"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_44 pre, #__code_44 code"><span class="md-clipboard__message"></span></button><pre id="__code_45"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_45 pre, #__code_45 code"><span class="md-clipboard__message"></span></button><code>-rw-rw-r-- 1 ec2-user ec2-user 3231294 3月  14 07:42 text_summary_baseline-5.dict
-rw-rw-r-- 1 ec2-user ec2-user 6219208 3月  14 07:42 text_summary_baseline-5.tfidf
</code></pre></div>


<hr>
<h4 id="_5">构建替换单词的类代码</h4>
<ul>
<li>辅助工具函数:<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/optim/data_utils.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_46"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_46 pre, #__code_46 code"><span class="md-clipboard__message"></span></button><pre id="__code_47"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_47 pre, #__code_47 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_samples</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">samples</span>


<span class="k">def</span> <span class="nf">write_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="s1">'w'</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">isChinese</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">'</span><span class="se">\u4e00</span><span class="s1">'</span> <span class="o">&lt;=</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="s1">'</span><span class="se">\u9fff</span><span class="s1">'</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="bp">False</span>
</code></pre></div>


<hr>
<ul>
<li>单词替换的核心类代码:<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/optim/word_replace.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_48"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_48 pre, #__code_48 code"><span class="md-clipboard__message"></span></button><pre id="__code_49"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_49 pre, #__code_49 code"><span class="md-clipboard__message"></span></button><code><span class="kn">from</span> <span class="nn">gensim.models</span> <span class="kn">import</span> <span class="n">KeyedVectors</span><span class="p">,</span> <span class="n">TfidfModel</span>
<span class="kn">from</span> <span class="nn">gensim.corpora</span> <span class="kn">import</span> <span class="n">Dictionary</span>
<span class="kn">from</span> <span class="nn">data_utils</span> <span class="kn">import</span> <span class="n">read_samples</span><span class="p">,</span> <span class="n">isChinese</span><span class="p">,</span> <span class="n">write_samples</span>
<span class="kn">from</span> <span class="nn">gensim</span> <span class="kn">import</span> <span class="n">matutils</span>
<span class="kn">from</span> <span class="nn">gensim.models.word2vec</span> <span class="kn">import</span> <span class="n">Word2Vec</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EmbedReplace</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_path</span><span class="p">,</span> <span class="n">wv_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">read_samples</span><span class="p">(</span><span class="n">sample_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'&lt;SEP&gt;'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">)</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wv</span> <span class="o">=</span> <span class="n">Word2Vec</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">wv_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tfidf_model</span> <span class="o">=</span> <span class="n">TfidfModel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/tf_idf/text_summary_baseline-5.tfidf'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/tf_idf/text_summary_baseline-5.dict'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corpus</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">doc2bow</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="o">.</span><span class="n">token2id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dic</span><span class="p">,</span> <span class="n">tfidf</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">tfidf</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tfidf</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">islice</span><span class="p">([</span><span class="n">dic</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">tfidf</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">],</span> <span class="n">topk</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_list</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_keywords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfidf_model</span><span class="p">[</span><span class="n">doc</span><span class="p">])</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token_list</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">)</span>
        <span class="n">new_tokens</span> <span class="o">=</span> <span class="n">token_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">num</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token_list</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">):</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token_list</span><span class="p">),</span> <span class="n">num</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">token_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">isChinese</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keywords</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wv</span><span class="p">:</span>
                    <span class="n">new_tokens</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wv</span><span class="o">.</span><span class="n">most_similar</span><span class="p">(</span><span class="n">positive</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">negative</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">topn</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">num</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_tokens</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_path</span><span class="p">):</span>
        <span class="n">replaced</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">token_list</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corpus</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">2000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">'count='</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                <span class="n">write_samples</span><span class="p">(</span><span class="n">replaced</span><span class="p">,</span> <span class="n">write_path</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>
                <span class="n">replaced</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">replaced</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'&lt;SEP&gt;'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'&lt;SEP&gt;'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">token_list</span><span class="p">,</span> <span class="n">doc</span><span class="p">))</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_50"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_50 pre, #__code_50 code"><span class="md-clipboard__message"></span></button><pre id="__code_51"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_51 pre, #__code_51 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">sample_path</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/train.txt'</span>
    <span class="n">wv_path</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/wv/word2vec.model'</span>
    <span class="n">replacer</span> <span class="o">=</span> <span class="n">EmbedReplace</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">wv_path</span><span class="p">)</span>
    <span class="n">replacer</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">(</span><span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/optim_word_replaced.txt'</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_52"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_52 pre, #__code_52 code"><span class="md-clipboard__message"></span></button><pre id="__code_53"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_53 pre, #__code_53 code"><span class="md-clipboard__message"></span></button><code>count= 2000
count= 4000
count= 6000
count= 8000
count= 10000
count= 12000
count= 14000
count= 16000
count= 18000
count= 20000
count= 22000
count= 24000
count= 26000
count= 28000
count= 30000
count= 32000
count= 34000
count= 36000
count= 38000
count= 40000
count= 42000
count= 44000
count= 46000
count= 48000
count= 50000
count= 52000
count= 54000
count= 56000
count= 58000
count= 60000
count= 62000
count= 64000
count= 66000
count= 68000
count= 70000
</code></pre></div>


<hr>
<ul>
<li>对比训练集数据:</li>
</ul>
<div class="codehilite" id="__code_54"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_54 pre, #__code_54 code"><span class="md-clipboard__message"></span></button><pre id="__code_55"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_55 pre, #__code_55 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 首先查看原始训练集数据</span>
<span class="nb">cd</span> /home/ec2-user/text_summary/pgn/data/
vim train.txt

<span class="c1"># 然后查看替换后新生成的数据</span>
<span class="nb">cd</span> /home/ec2-user/text_summary/pgn/data/
vim optim_word_replaced.txt
</code></pre></div>


<hr>
<ul>
<li>对比结果(原始训练集): /home/ec2-user/text_summary/pgn/data/train.txt</li>
</ul>
<div class="codehilite" id="__code_56"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_56 pre, #__code_56 code"><span class="md-clipboard__message"></span></button><pre id="__code_57"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_57 pre, #__code_57 code"><span class="md-clipboard__message"></span></button><code>丰田 花冠 行驶 十万 公里 皮带 要换 正 时 皮带 ， 这种 车型 最 10 万公里 ， 最好 更换 一次 。 皮带 时间 长 会 &gt;出现 老化 ， 出现 断裂 ， 会 损坏 发动机 ， 造成 车辆 抛锚 。 发电机 皮带 都 需要 检查一下 ， 最 6 8 万公里 。需要 ， 检查 ， 更换 新件 。&lt;SEP&gt;现在 公里 数 ， 最好 检查一下 皮带 ， 应该 老化 现象 ， 皮带 。 寿命 8 10 万公里 。 建议 最好 更换 一下 。

大师 好 ！ 新 时代 全顺 ， 中 门板 手 钱 ？ 右门 玻璃 升降 开关 钱 ？ 拉手 价格 60 元 ， 开关 60 元 ， 拿货 价格&lt;SEP&gt;拉手 升降 开关 价格 120 左右 ， 进货价格

昌河Q35 音响 拆装 发个 中控 看看 圈起来 面板 翘出来 不行 如图所示 没有 螺丝 新车 紧翘 断 不 出来 绿色 圈 先 下来 上边 螺丝 没有 拆完 内部 卡扣 固定&lt;SEP&gt;面板 内部 卡子 固定 ， 没有 固定 螺丝

长安 35 朝阳 轮胎 不要 里面 钢圈 。 钢圈 钱 外面 换 钱 意思 只 更换 新 轮胎 。 只 更换 单独 轮胎 ， 价格 350 &gt;块钱 左右 。 只换 轮胎 皮皮 轮毂 350 ， 轮胎 品牌 轮胎 ， 轮胎 型号 比较 大 ， 说 价格 都 比较 贵 ， 最 便宜 &gt;。 网上 购买 ， 200 ， 地区 不 ， 价格 略有 浮动 。 额额 谢谢 回答 ？ ？ 晓得 。 不 客气 ！ 祝您 用车 愉快 ！&lt;SEP&gt;单独 购买 轮胎 ， 车胎 型号 比较 大 卖 轮胎 地方 ， 去 修理厂 费用 350 左右 ， 网购 ， 更换 比较 便宜 一点。
</code></pre></div>


<hr>
<ul>
<li>对比结果(新替换的训练集): /home/ec2-user/text_summary/pgn/data/optim_word_replaced.txt</li>
</ul>
<div class="codehilite" id="__code_58"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_58 pre, #__code_58 code"><span class="md-clipboard__message"></span></button><pre id="__code_59"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_59 pre, #__code_59 code"><span class="md-clipboard__message"></span></button><code>丰田 花冠 行驶 十万 公里 皮带 要换 正 时 皮带 ， 这种 车型 最 10 万公里 ， 最好 更换 一次 。 皮带 时间 长 会 &gt;出现 老化 ， 出现 断裂 ， 会 损坏 发动机 ， 造成 车辆 抛锚 。 发电机 皮带 都 需要 检查一下 ， 最 6 8 万公里 。需要 ， 检查 ， 更换 新件 。&lt;SEP&gt;现在 公里 数 ， 最好 检查一下 皮带 ， 应该 老化 现象 ， 皮带 。 寿命 8 10 万公里 。 建议您 最好 更换 清醒 。

大师 好 ！ 新 时代 全顺 ， 中 门板 手 钱 ？ 右门 玻璃 升降 开关 钱 ？ 拉手 价格 60 元 ， 开关 60 元 ， 拿货 价格&lt;SEP&gt;拉手 升降 开关 价格 120 左右 ， 进货价格

昌河Q35 音响 拆装 发个 中控 看看 圈起来 面板 翘出来 不行 如图所示 没有 螺丝 新车 紧翘 断 不 出来 绿色 圈 先 下来 上边 螺丝 没有 拆完 内部 卡扣 固定&lt;SEP&gt;面板 内部 卡子 固定 ， 没 固定 螺丝

长安 35 朝阳 轮胎 不要 里面 钢圈 。 钢圈 钱 外面 换 钱 意思 只 更换 新 轮胎 。 只 更换 单独 轮胎 ， 价格 350 &gt;块钱 左右 。 只换 轮胎 皮皮 轮毂 350 ， 轮胎 品牌 轮胎 ， 轮胎 型号 比较 大 ， 说 价格 都 比较 贵 ， 最 便宜 &gt;。 网上 购买 ， 200 ， 地区 不 ， 价格 略有 浮动 。 额额 谢谢 回答 ？ ？ 晓得 。 不 客气 ！ 祝您 用车 愉快 ！&lt;SEP&gt;单独 购买 轮胎 ， 车胎 型号 比较 大才 卖 轮胎 地方 ， 去 修理厂 费用 350 左右 ， 网购 ， 换 公认 贵 一点 &gt;。
</code></pre></div>


<hr>
<blockquote>
<ul>
<li>结论: 通过单词替换后, 有的样本摘要完全和之前一样, 有的样本摘要发生了几个单词的变化. 而且有的变化合理, 有的变化目测并不合理, 后续需要对代码流程继续调优. 这里对同学们最重要的是获取一个新的优化思路, 同时掌握新的代码实践方法, 未来面对新的项目反复迭代试验就好. 同时思考一个问题: 面对单词替换的bad case分析, 后续你如何调优?</li>
</ul>
</blockquote>
<hr>
<h4 id="baseline-5">训练baseline-5模型</h4>
<ul>
<li>有了增强后的数据集, 就可以在baseline-4模型的基础上优化训练baseline-5模型了:<ul>
<li>注意: 整个训练相关的代码完全和baseline-4模型一模一样, 仅有train.py调用中稍作修改.</li>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/src/train.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_60"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_60 pre, #__code_60 code"><span class="md-clipboard__message"></span></button><pre id="__code_61"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_61 pre, #__code_61 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="c1"># Prepare dataset for training.</span>
    <span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'cpu'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'DEVICE: '</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------------------</span>
    <span class="c1"># baseline-5模型只在下面这一块对baseline-4稍作修改.</span>
    <span class="c1"># 将构建数据集的路径改为config.train_data_optim_1_path, 即融合了经过单词替换后的训练集</span>
    <span class="c1"># 相比于baseline-4训练集的7万条样本, 在baseline-5中被扩充成了14万条样本.</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">PairDataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train_data_optim_1_path</span><span class="p">,</span>
                          <span class="n">max_enc_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_enc_len</span><span class="p">,</span>
                          <span class="n">max_dec_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_len</span><span class="p">,</span>
                          <span class="n">truncate_enc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_enc</span><span class="p">,</span>
                          <span class="n">truncate_dec</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_dec</span><span class="p">)</span>
    <span class="c1"># -------------------------------------------------------------------------------------</span>

    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">PairDataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">val_data_path</span><span class="p">,</span>
                              <span class="n">max_enc_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_enc_len</span><span class="p">,</span>
                              <span class="n">max_dec_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_len</span><span class="p">,</span>
                              <span class="n">truncate_enc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_enc</span><span class="p">,</span>
                              <span class="n">truncate_dec</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_dec</span><span class="p">)</span>

    <span class="n">vocab</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">build_vocab</span><span class="p">(</span><span class="n">embed_file</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">embed_file</span><span class="p">)</span>

    <span class="n">train</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">start_epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_62"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_62 pre, #__code_62 code"><span class="md-clipboard__message"></span></button><pre id="__code_63"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_63 pre, #__code_63 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 因为模型训练要持续10多个小时, 直接放到后台, 以非中断模式训练.</span>

nohup python train.py <span class="p">&amp;</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_64"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_64 pre, #__code_64 code"><span class="md-clipboard__message"></span></button><pre id="__code_65"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_65 pre, #__code_65 code"><span class="md-clipboard__message"></span></button><code>DEVICE:  cuda
Reading dataset /home/ec2-user/text_summary/pgn/data/train_word_optim.txt... 140000 pairs.
Reading dataset /home/ec2-user/text_summary/pgn/data/dev.txt...
[[0%|          | 0/5 [00:00&lt;?, ?it/s]
[[0%|          | 0/43 [00:00&lt;?, ?it/s]
[[0%|          | 0/4375 [00:00&lt;?, ?it/s]
[[Epoch 0:   0%|          | 0/43 [00:02&lt;?, ?it/s]
[[Epoch 0:   0%|          | 0/43 [00:02&lt;?, ?it/s, Batch=0, Loss=6.66]
[[Epoch 0:   2%|▏         | 1/43 [00:02&lt;01:46,  2.54s/it, Batch=0, Loss=6.66]
[[0%|          | 1/4375 [00:02&lt;3:05:02,  2.54s/it]
[[0%|          | 2/4375 [00:04&lt;2:46:21,  2.28s/it]
[[0%|          | 3/4375 [00:06&lt;2:49:43,  2.33s/it]
[[0%|          | 4/4375 [00:08&lt;2:34:36,  2.12s/it]
[[0%|          | 5/4375 [00:09&lt;2:13:39,  1.84s/it]


......
......
......


[[91%|█████████▏| 85/93 [00:55&lt;00:05,  1.49it/s]
[[92%|█████████▏| 86/93 [00:55&lt;00:04,  1.60it/s]
[[94%|█████████▎| 87/93 [00:56&lt;00:03,  1.67it/s]
[[95%|█████████▍| 88/93 [00:56&lt;00:02,  1.68it/s]
[[96%|█████████▌| 89/93 [00:57&lt;00:02,  1.57it/s]
[[97%|█████████▋| 90/93 [00:58&lt;00:01,  1.60it/s]
[[98%|█████████▊| 91/93 [00:58&lt;00:01,  1.62it/s]
[[99%|█████████▉| 92/93 [00:59&lt;00:00,  1.83it/s]
[[100%|██████████| 93/93 [00:59&lt;00:00,  1.77it/s]
[[100%|██████████| 93/93 [00:59&lt;00:00,  1.55it/s]
[[0%|          | 0/43 [00:00&lt;?, ?it/s]
[[0%|          | 0/4375 [00:00&lt;?, ?it/s]
[[Epoch 1:   0%|          | 0/43 [00:01&lt;?, ?it/s]
[[Epoch 1:   0%|          | 0/43 [00:01&lt;?, ?it/s, Batch=0, Loss=3.68]
[[Epoch 1:   2%|▏         | 1/43 [00:01&lt;00:54,  1.29s/it, Batch=0, Loss=3.68]
[[0%|          | 1/4375 [00:01&lt;1:33:58,  1.29s/it]
[[0%|          | 2/4375 [00:02&lt;1:36:24,  1.32s/it]


......
......
......


[[98%|█████████▊| 91/93 [00:57&lt;00:01,  1.57it/s]
[[99%|█████████▉| 92/93 [00:58&lt;00:00,  1.73it/s]
[[100%|██████████| 93/93 [00:59&lt;00:00,  1.48it/s]
[[100%|██████████| 93/93 [00:59&lt;00:00,  1.57it/s]
Epoch 4: 100%|██████████| 5/5 [10:29:52&lt;00:00, 7558.48s/it, Loss=2.24]
2999 pairs.
loading data......
initializing optimizer......
model_name = pgn_model, pointer = True, coverage = True, fine_tune = False, scheduled_sampling = False, weight_tying = False,source = train
teacher_forcing = True
validating
training loss:4.2041042657034735 validation loss:4.174842016671294
model_name = pgn_model, pointer = True, coverage = True, fine_tune = False, scheduled_sampling = False, weight_tying = False,source = train
teacher_forcing = True
validating
training loss:3.2948868374415805 validation loss:4.355987264264014
model_name = pgn_model, pointer = True, coverage = True, fine_tune = False, scheduled_sampling = False, weight_tying = False,source = train
teacher_forcing = True
validating
training loss:2.752900101198469 validation loss:4.662438987403788
model_name = pgn_model, pointer = True, coverage = True, fine_tune = False, scheduled_sampling = False, weight_tying = False,source = train
teacher_forcing = True
validating
training loss:2.4371365354537966 validation loss:4.97526418009112
model_name = pgn_model, pointer = True, coverage = True, fine_tune = False, scheduled_sampling = False, weight_tying = False,source = train
teacher_forcing = True
validating
training loss:2.2446208192007884 validation loss:5.230078948441372
</code></pre></div>


<hr>
<h4 id="baseline-5_1">评估baseline-5模型</h4>
<ul>
<li>首先展示一下预测代码predict.py的运行结果, 唯一需要在类Predict的初始化函数中稍作修改:<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/src/predict.py </li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_66"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_66 pre, #__code_66 code"><span class="md-clipboard__message"></span></button><pre id="__code_67"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_67 pre, #__code_67 code"><span class="md-clipboard__message"></span></button><code><span class="k">class</span> <span class="nc">Predict</span><span class="p">():</span>
    <span class="nd">@timer</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s1">'initalize predicter'</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">DEVICE</span>

        <span class="c1"># ----------------------------------------------------------------------</span>
        <span class="c1"># 在baseline-5模型评估中, 只需修改第一行的训练集路径即可.</span>
        <span class="c1"># 改成单词替换后的14万条的train_data_optim_1_path数据集.</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">PairDataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train_data_optim_1_path</span><span class="p">,</span>
                              <span class="n">max_enc_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_enc_len</span><span class="p">,</span>
                              <span class="n">max_dec_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_len</span><span class="p">,</span>
                              <span class="n">truncate_enc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_enc</span><span class="p">,</span>
                              <span class="n">truncate_dec</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_dec</span><span class="p">)</span>
        <span class="c1"># ---------------------------------------------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">build_vocab</span><span class="p">(</span><span class="n">embed_file</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">embed_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">PGN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_word</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">stop_word_file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_68"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_68 pre, #__code_68 code"><span class="md-clipboard__message"></span></button><pre id="__code_69"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_69 pre, #__code_69 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'实例化Predict对象, 构建dataset和vocab......'</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">Predict</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'vocab_size: '</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">vocab</span><span class="p">))</span>
    <span class="c1"># Randomly pick a sample in test set to predict.</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">val_data_path</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">test</span><span class="p">:</span>
        <span class="n">picked</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
        <span class="n">source</span><span class="p">,</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">picked</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'&lt;SEP&gt;'</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">'source: '</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'******************************************'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'ref: '</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'******************************************'</span><span class="p">)</span>
    <span class="n">greedy_prediction</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span>  <span class="n">beam_search</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'greedy: '</span><span class="p">,</span> <span class="n">greedy_prediction</span><span class="p">,</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'******************************************'</span><span class="p">)</span>
    <span class="n">beam_prediction</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span>  <span class="n">beam_search</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'beam: '</span><span class="p">,</span> <span class="n">beam_prediction</span><span class="p">,</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_70"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_70 pre, #__code_70 code"><span class="md-clipboard__message"></span></button><pre id="__code_71"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_71 pre, #__code_71 code"><span class="md-clipboard__message"></span></button><code>实例化Predict对象, 构建dataset和vocab......
Reading dataset /home/ec2-user/text_summary/pgn/data/train_word_optim.txt... 140000 pairs.
16.072141647338867 secs used for  initalize predicter
vocab_size:  20004
source:  怠速时 转速表 轻微 摆动 ， 车身 轻微 抖动 ， 感觉 动力 没有 以前 强 ， 火花塞 空气 格 汽油 格 万多公里 前换 2017 年 7 月 ， 一家 加油站 加 油 。 请问 原因 造成 ？ ， 检查 节气门 积碳 多不多 ， 看 一下 进气管 ， 燃烧室 积碳 ， 吊瓶 清洗 一下 常理 来说 ， 三万 公里 不 应该 有积 碳 影响 明显 ？ 加油站 加油 中石化 95 ？ 

******************************************
ref:  节气门 清洗 ， 燃油 添加剂 拉 高速 清洗 缸 内积 碳 

******************************************
0.03769087791442871 secs used for  doing prediction
greedy:  清洗 一下 喷油嘴 ， 再 跑跑 试试 。 进气管 ， 燃烧室 积碳 ， 吊瓶 清洗 

******************************************
0.3405790328979492 secs used for  doing prediction
beam:  清洗 一下 喷油嘴 ， 再 跑跑 试试 。 吊瓶 清洗 一下 。 ， 再 跑跑 试试 。 看 一下 有没有 漏油 地方 。 吊瓶 清洗 积碳 。
</code></pre></div>


<hr>
<ul>
<li>
<p>测试完毕后, 直接在和之前版本相同的测试集上进行评估:</p>
</li>
<li>
<p>类Predict的代码只需要稍作修改:</p>
<ul>
<li>代码文件地址: /home/ec2-user/text_summary/pgn/src/predict.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_72"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_72 pre, #__code_72 code"><span class="md-clipboard__message"></span></button><pre id="__code_73"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_73 pre, #__code_73 code"><span class="md-clipboard__message"></span></button><code>    <span class="c1"># 类Predict的内部函数, 评估函数会调用predict.py中的类进行处理.</span>
    <span class="c1"># 采用贪心解码策略时将beam_search=False; 采用Beam-search解码策略时将beam_search=True</span>
    <span class="nd">@timer</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s1">'doing prediction'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">beam_search</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tokenize</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">oov</span> <span class="o">=</span> <span class="n">source2ids</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">len_oovs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">oov</span><span class="p">)])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">x_padding_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">beam_search</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_search</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                       <span class="n">max_sum_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_steps</span><span class="p">,</span>
                                       <span class="n">beam_width</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">beam_size</span><span class="p">,</span>
                                       <span class="n">len_oovs</span><span class="o">=</span><span class="n">len_oovs</span><span class="p">,</span>
                                       <span class="n">x_padding_masks</span><span class="o">=</span><span class="n">x_padding_masks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy_search</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                         <span class="n">max_sum_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_steps</span><span class="p">,</span>
                                         <span class="n">len_oovs</span><span class="o">=</span><span class="n">len_oovs</span><span class="p">,</span>
                                         <span class="n">x_padding_masks</span><span class="o">=</span><span class="n">x_padding_masks</span><span class="p">)</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">outputids2words</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">oov</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>评估主函数rouge_eval完全不需要修改<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/src/rouge_eval.py</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>调用(贪心解码):</li>
</ul>
<div class="codehilite" id="__code_74"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_74 pre, #__code_74 code"><span class="md-clipboard__message"></span></button><pre id="__code_75"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_75 pre, #__code_75 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 首先将上面代码文件中的参数beam_search设置为False</span>

<span class="nb">cd</span> /home/ec2-user/text_summary/pgn/src/

python rouge_eval.py
</code></pre></div>


<hr>
<ul>
<li>输出结果(贪心解码):</li>
</ul>
<div class="codehilite" id="__code_76"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_76 pre, #__code_76 code"><span class="md-clipboard__message"></span></button><pre id="__code_77"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_77 pre, #__code_77 code"><span class="md-clipboard__message"></span></button><code>实例化Rouge对象......
Reading from  /home/ec2-user/text_summary/pgn/data/dev.txt
self.refs[]包含的样本数:  3000
Test set contains 3000 samples.
实例化Predict对象......
Reading dataset /home/ec2-user/text_summary/pgn/data/train_word_optim.txt... 140000 pairs.
16.086021661758423 secs used for  initalize predicter
利用模型对article进行预测, 并通过Rouge对象进行评估......
Building hypotheses.
0.035405635833740234 secs used for  doing prediction
0.05810713768005371 secs used for  doing prediction
0.051779747009277344 secs used for  doing prediction
0.05352973937988281 secs used for  doing prediction
0.061347246170043945 secs used for  doing prediction
0.047524452209472656 secs used for  doing prediction
0.014091968536376953 secs used for  doing prediction
0.021171092987060547 secs used for  doing prediction


......
......
......


0.02424907684326172 secs used for  doing prediction
0.0540165901184082 secs used for  doing prediction
0.0701298713684082 secs used for  doing prediction
0.020273208618164062 secs used for  doing prediction
0.021963834762573242 secs used for  doing prediction
0.0258636474609375 secs used for  doing prediction
0.021762609481811523 secs used for  doing prediction
0.01562952995300293 secs used for  doing prediction
0.012730836868286133 secs used for  doing prediction
0.015019893646240234 secs used for  doing prediction
0.013356447219848633 secs used for  doing prediction
0.05282020568847656 secs used for  doing prediction
0.014577150344848633 secs used for  doing prediction
120.08142113685608 secs used for  building hypotheses
开始用Rouge规则进行评估......
Calculating average rouge scores.
rouge1:  {'f': 0.24856651392979245, 'p': 0.2798775863861886, 'r': 0.31694090956505816}
rouge2:  {'f': 0.07876241371737112, 'p': 0.08768004109197018, 'r': 0.10274573842579217}
rougeL:  {'f': 0.2734870775154685, 'p': 0.34682583339947426, 'r': 0.27245196203151145}
将评估结果写入结果文件中......
</code></pre></div>


<hr>
<ul>
<li>调用(Beam search解码):</li>
</ul>
<div class="codehilite" id="__code_78"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_78 pre, #__code_78 code"><span class="md-clipboard__message"></span></button><pre id="__code_79"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_79 pre, #__code_79 code"><span class="md-clipboard__message"></span></button><code><span class="c1"># 首先要将predict.py文件中参数设置为beam_search=True</span>

<span class="nb">cd</span> /home/ec2-user/text_summary/pgn/src/

python rouge_eval.py
</code></pre></div>


<hr>
<ul>
<li>输出结果(Beam search解码):</li>
</ul>
<div class="codehilite" id="__code_80"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_80 pre, #__code_80 code"><span class="md-clipboard__message"></span></button><pre id="__code_81"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_81 pre, #__code_81 code"><span class="md-clipboard__message"></span></button><code>实例化Rouge对象......
Reading from  /home/ec2-user/text_summary/pgn/data/dev.txt
self.refs[]包含的样本数:  3000
Test set contains 3000 samples.
实例化Predict对象......
Reading dataset /home/ec2-user/text_summary/pgn/data/train_word_optim.txt... 140000 pairs.
16.08588480949402 secs used for  initalize predicter
利用模型对article进行预测, 并通过Rouge对象进行评估......
Building hypotheses.
0.36016082763671875 secs used for  doing prediction
0.3373758792877197 secs used for  doing prediction
0.3348877429962158 secs used for  doing prediction
0.33213067054748535 secs used for  doing prediction
0.3412024974822998 secs used for  doing prediction
0.3547537326812744 secs used for  doing prediction
0.337308406829834 secs used for  doing prediction
0.3540971279144287 secs used for  doing prediction
0.33278846740722656 secs used for  doing prediction
0.331463098526001 secs used for  doing prediction
0.3486611843109131 secs used for  doing prediction


......
......
......


0.3724033832550049 secs used for  doing prediction
0.34821534156799316 secs used for  doing prediction
0.34289073944091797 secs used for  doing prediction
0.32703256607055664 secs used for  doing prediction
0.32860231399536133 secs used for  doing prediction
0.3314642906188965 secs used for  doing prediction
0.32858800888061523 secs used for  doing prediction
0.33380556106567383 secs used for  doing prediction
0.3321969509124756 secs used for  doing prediction
0.3724205493927002 secs used for  doing prediction
0.32953882217407227 secs used for  doing prediction
1024.8375618457794 secs used for  building hypotheses
开始用Rouge规则进行评估......
Calculating average rouge scores.
rouge1:  {'f': 0.21761298996967154, 'p': 0.17647193879827075, 'r': 0.37561127997163163}
rouge2:  {'f': 0.06866650115912178, 'p': 0.05509031711696027, 'r': 0.12487954175828382}
rougeL:  {'f': 0.27141952833427696, 'p': 0.28759791074006696, 'r': 0.31386396066086725}
将评估结果写入结果文件中......
</code></pre></div>


<hr>
<ul>
<li>对比几个版本的模型关键指标数据:</li>
</ul>
<div class="codehilite" id="__code_82"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_82 pre, #__code_82 code"><span class="md-clipboard__message"></span></button><pre id="__code_83"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_83 pre, #__code_83 code"><span class="md-clipboard__message"></span></button><code># baseline-2             baseline-3               baseline-4              baseline-5              baseline-5
# PGN                    PGN + coverage           PGN + coverage          数据增强优化            数据增强优化
                                                      + beam-search       (贪心解码)              (Beam search)
# -------------------------------------------------------------------------------------------------------------------------

rouge-1                | rouge-1                | rouge-1               | rouge-1               | rouge-1
f: 22.4840567492723    | f: 23.891369972642877  | f: 22.37876211830499  | f: 24.856651392979245 | f: 21.761298996967156
p: 22.48892685096682   | p: 27.884799447410742  | p: 18.11883439712568  | p: 27.98775863861886  | p: 17.647193879827075
r: 36.152107385286506  | r: 32.746511025920974  | r: 38.41843120305152  | r: 31.694090956505818 | r: 37.56112799716316

# -------------------------------------------------------------------------------------------------------------------------

rouge-2                | rouge-2                | rouge-2               | rouge-2               | rouge-2
f: 7.6855293213852995  | f: 8.145260844937683   | f: 7.272050441375325  | f: 7.8762413717371125 | f: 6.8666501159121776
p: 7.633592816230374   | p: 9.507772545428752   | p: 5.774983504844641  | p: 8.768004109197019  | p: 5.509031711696027
r: 12.992180038436171  | r: 11.403972188579534  | r: 13.46595763700352  | r: 10.274573842579217 | r: 12.487954175828381

# ------------------------------------------------------------------------------------------------------------------------

rouge-l                | rouge-l                | rouge-l               | rouge-l               | rouge-l
f: 29.79190839597577   | f: 28.112397619052885  | f: 27.544194926579234 | f: 27.348707751546854 | f: 27.141952833427695
p: 35.022548049923934  | p: 35.51625333014313   | p: 28.64224165624092  | p: 34.68258333994743  | p: 28.759791074006696
r: 31.245311823639828  | r: 28.567520633785175  | r: 32.28687273073168  | r: 27.245196203151146 | r: 31.386396066086725
</code></pre></div>


<hr>
<blockquote>
<ul>
<li>结论: 采用单词替换的数据增强后, 模型在精确率上表现较好, 但是召回率上有些许下降. 总体效果一般.</li>
</ul>
</blockquote>
<hr>
<hr>
<h3 id="_6">回译数据法</h3>
<h4 id="google">Google翻译接口</h4>
<ul>
<li>利用Google提供的接口实现回译数据法: 当样本数量不足时, NLP领域内最容易想到也是最容易实现的就是回译数据增强法. 通过不同语言之间的翻译, 使得训练文本的表达方式产生差异, 可以丰富语料语义, 增强模型的效果.</li>
</ul>
<hr>
<ul>
<li>测试代码:<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/optim/back_translate.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_84"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_84 pre, #__code_84 code"><span class="md-clipboard__message"></span></button><pre id="__code_85"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_85 pre, #__code_85 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">jieba</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="c1"># 导入最新的Google翻译接口, 这个API接口已经和2020年夏天不同了, 未来还会发生变化.</span>
<span class="kn">from</span> <span class="nn">google_trans_new</span> <span class="kn">import</span> <span class="n">google_translator</span>
<span class="c1"># 实例化翻译对象</span>
<span class="n">translator</span> <span class="o">=</span> <span class="n">google_translator</span><span class="p">()</span>


<span class="c1"># 回译数据函数</span>
<span class="k">def</span> <span class="nf">back_translate</span><span class="p">(</span><span class="n">batch_data</span><span class="p">):</span>
    <span class="c1"># 进行第一次翻译, 翻译目标是韩语</span>
    <span class="n">ko_res</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">batch_data</span><span class="p">,</span> <span class="n">lang_src</span><span class="o">=</span><span class="s1">'zh-cn'</span><span class="p">,</span> <span class="n">lang_tgt</span><span class="o">=</span><span class="s1">'ko'</span><span class="p">)</span>
    <span class="c1"># 为了让调用延时顺利进行, 程序等待1秒钟.</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="c1"># 最后在翻译回中文, 完成回译全部流程</span>
    <span class="n">cn_res</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">ko_res</span><span class="p">,</span> <span class="n">lang_src</span><span class="o">=</span><span class="s1">'ko'</span><span class="p">,</span> <span class="n">lang_tgt</span><span class="o">=</span><span class="s1">'zh-cn'</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cn_res</span>


<span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">translate_path</span><span class="p">):</span>
    <span class="c1"># 将原始文本sample_path经过回译数据法处理后, 写入到生成文本translate_path中.</span>
    <span class="n">translated</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="c1"># article调用back_translate, 并且abstract调用back_translate.</span>
            <span class="n">article</span><span class="p">,</span> <span class="n">abstract</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'&lt;SEP&gt;'</span><span class="p">)</span>
            <span class="n">article</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>
            <span class="n">abstract</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abstract</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'******************************************'</span><span class="p">)</span>
            <span class="n">back_article</span> <span class="o">=</span> <span class="n">back_translate</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
            <span class="n">back_abstract</span> <span class="o">=</span> <span class="n">back_translate</span><span class="p">(</span><span class="n">abstract</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">back_article</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'******************************************'</span><span class="p">)</span>

            <span class="n">source</span> <span class="o">=</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">back_article</span><span class="p">)))</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">back_abstract</span><span class="p">)))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'******************************************'</span><span class="p">)</span>
            <span class="n">translated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span> <span class="o">+</span> <span class="s1">'&lt;SEP&gt;'</span> <span class="o">+</span> <span class="n">ref</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">translated</span><span class="p">)</span>
            <span class="k">break</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_86"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_86 pre, #__code_86 code"><span class="md-clipboard__message"></span></button><pre id="__code_87"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_87 pre, #__code_87 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">sample_path</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/train.txt'</span>
    <span class="n">translate_path</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/back_translated.txt'</span>
    <span class="n">translate</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">translate_path</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_88"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_88 pre, #__code_88 code"><span class="md-clipboard__message"></span></button><pre id="__code_89"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_89 pre, #__code_89 code"><span class="md-clipboard__message"></span></button><code>方向机重，助力泵，方向机都换新都换助力泵，方向机换方向机带助力重，这车匹配不需要更换部件问题跑快还好点，倒车重很。非常重，累人觉得，车主以前没重，选助理泵换不行，放机换，现在还不知道车主解释。
******************************************
方向，升压泵，取向机的方向取代了所有新泵和方向的方向。此车匹配不需要更换组件问题。 它也很好......非常沉重，疲惫的事故，主人不重要。 辅助泵的选择不会改变，并且您将机器放置并解释的所有者。 
******************************************
Building prefix dict from the default dictionary ...
Loading model from cache /tmp/jieba.cache
Loading model cost 0.751 seconds.
Prefix dict has been built successfully.
方向 ， 升压 泵 ， 取向 机 的 方向 取代 了 所有 新泵 和 方向 的 方向 。 此车 匹配 不 需要 更换 组件 问题 。   它 也 很 好 ...... 非常 沉重 ， 疲惫 的 事故 ， 主人 不 重要 。   辅助 泵 的 选择 不会 改变 ， 并且 您 将 机器 放置 并 解释 的 所有者 。  
******************************************
['方向 ， 升压 泵 ， 取向 机 的 方向 取代 了 所有 新泵 和 方向 的 方向 。 此车 匹配 不 需要 更换 组件 问题 。   它 也 很 好 ...... 非常 沉重 ， 疲惫 的 事故 ， 主人 不 重要 。   辅助 泵 的 选择 不会 改变 ， 并且 您 将 机器 放置 并 解释 的 所有者 。  &lt;SEP&gt;随身携带 联系  ']
</code></pre></div>


<hr>
<ul>
<li>测试正确后, 就开始批量的翻译:<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/optim/back_translate.py</li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_90"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_90 pre, #__code_90 code"><span class="md-clipboard__message"></span></button><pre id="__code_91"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_91 pre, #__code_91 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">jieba</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">optim.data_utils</span> <span class="kn">import</span> <span class="n">write_samples</span>

<span class="c1"># 导入最新的Google翻译接口, 这个API接口已经和2020年夏天不同了, 未来还会发生变化.</span>
<span class="kn">from</span> <span class="nn">google_trans_new</span> <span class="kn">import</span> <span class="n">google_translator</span>
<span class="c1"># 实例化翻译对象</span>
<span class="n">translator</span> <span class="o">=</span> <span class="n">google_translator</span><span class="p">()</span>

<span class="c1"># 回译数据函数</span>
<span class="k">def</span> <span class="nf">back_translate</span><span class="p">(</span><span class="n">batch_data</span><span class="p">):</span>
    <span class="c1"># 进行第一次翻译, 翻译目标是韩语</span>
    <span class="n">ko_res</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">batch_data</span><span class="p">,</span> <span class="n">lang_src</span><span class="o">=</span><span class="s1">'zh-cn'</span><span class="p">,</span> <span class="n">lang_tgt</span><span class="o">=</span><span class="s1">'ko'</span><span class="p">)</span>
    <span class="c1"># 为了让调用延时顺利进行, 程序等待1秒钟.</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="c1"># 最后在翻译回中文, 完成回译全部流程</span>
    <span class="n">cn_res</span> <span class="o">=</span> <span class="n">translator</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">ko_res</span><span class="p">,</span> <span class="n">lang_src</span><span class="o">=</span><span class="s1">'ko'</span><span class="p">,</span> <span class="n">lang_tgt</span><span class="o">=</span><span class="s1">'zh-cn'</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cn_res</span>

<span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">translate_path</span><span class="p">):</span>
    <span class="c1"># 将原始文本sample_path经过回译数据法处理后, 写入到生成文本translate_path中.</span>
    <span class="n">translated</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="c1"># article调用back_translate, 并且abstract调用back_translate.</span>
            <span class="n">article</span><span class="p">,</span> <span class="n">abstract</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'&lt;SEP&gt;'</span><span class="p">)</span>
            <span class="n">article</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>
            <span class="n">abstract</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abstract</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>

            <span class="c1"># 传入回译函数的参数都是没有空格分隔的连续字符串</span>
            <span class="n">back_article</span> <span class="o">=</span> <span class="n">back_translate</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
            <span class="n">back_abstract</span> <span class="o">=</span> <span class="n">back_translate</span><span class="p">(</span><span class="n">abstract</span><span class="p">)</span>

            <span class="c1"># 回译结果需要重新经过分词, 然后以空格进行分隔, 以满足训练集数据的格式要求</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">back_article</span><span class="p">)))</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">back_abstract</span><span class="p">)))</span>
            <span class="c1"># 文本和摘要之间还是以&lt;SEP&gt;进行分隔, 所有的数据格式保持一致.</span>
            <span class="n">translated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span> <span class="o">+</span> <span class="s1">'&lt;SEP&gt;'</span> <span class="o">+</span> <span class="n">ref</span><span class="p">)</span>

            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># 每处理20条数据后, 将回译数据后的样本存储进文件中.</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">'count='</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                <span class="c1"># 每隔100条进行一次抽取打印, 以确保程序正常运行(尤其是Google接口正常服务).</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">translated</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># 回译后的数据追加模式写入文件中</span>
                <span class="n">write_samples</span><span class="p">(</span><span class="n">translated</span><span class="p">,</span> <span class="n">translate_path</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>
                <span class="c1"># 将结果列表清空, 以为后续的数据添加做准备</span>
                <span class="n">translated</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_92"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_92 pre, #__code_92 code"><span class="md-clipboard__message"></span></button><pre id="__code_93"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_93 pre, #__code_93 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">sample_path</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/train.txt'</span>
    <span class="n">translate_path</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/back_translated.txt'</span>
    <span class="n">translate</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">translate_path</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_94"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_94 pre, #__code_94 code"><span class="md-clipboard__message"></span></button><pre id="__code_95"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_95 pre, #__code_95 code"><span class="md-clipboard__message"></span></button><code>Building prefix dict from the default dictionary ...
Loading model from cache /tmp/jieba.cache
Loading model cost 0.755 seconds.
Prefix dict has been built successfully.
count= 20
count= 40
count= 60
count= 80
count= 100
Cruze 你 有 这 本书 吗 ？   ， 车辆 错误信息 代码 徽标 。   故障 转向 系统 有 缺陷 ， 因此 您 必须 专注 于 检查 车辆 转向 灯泡 ， 右后 灯灯 未 打开 。   改变 解决方案  &lt;SEP&gt;， 车辆 错误信息 代码 徽标 。   故障 转向 您 必须 确保 系统 错误 ， 车辆 更 改为 灯泡 。  
count= 120
count= 140
count= 160
count= 180
count= 200
大师 ， 车辆 最近 出现 在 左脚 座位 踏板 振动 ， 足部 质量 。 扁平 包装 封装 道路 非常 清晰 ， 凸块 与 道路 混合 ， 光泽 表面 不会 摇动 ， 速度 降至 10 以下 频率 降低 。 它 感觉 像 轮胎 压力 包 。   4S   Storount 储存 浓缩 索赔 。 这种 情况 主要 假设 底盘 是否 在 共振 区域 。 安装 橡胶 缓冲 粘合剂 以 减少 问题 。   ... 在 ！ 汽车 前面 没有 这样 的 问题 。 有 问题 吗 ？ 当 您 添加 减震器 粘合剂 标准 时 ， 4S 商店 不是 很 合作 ， 没有 问题 。 我 以前 以前 进行 了 全面 的 测试 。 没有 这样 的 问题 ， 将 驱动器 测试 到 同一 车辆 并 检查 此 问题 。 事实上 ， 没有 人 反映 这种 情况 。 主要 是 发动机 传输 连接 在 基本 支架 中 找到 ， 并且 是 一个 松动 的 硬 接触 共振 。 发动机 Footpad 确认 问题 是否 在 左侧 的 圆形 塔 口香糖 有 问题 ？ 这种 高频 振动 基本上 是 高频 振动 。 再次 确认 4S 商店 。 谢谢 ！   ， 不 。  &lt;SEP&gt;应 检查 这种 情况 ， 运输 底盘 主体 连接 到 夹克 是否 松动 并 导致 接触 谐振 。  
count= 220
count= 240
count= 260
count= 280
count= 300
没有 加入 透射 流量 ， 半 升起 的 油 ， 4S 储存 ， 并 为 新 的 汽车 工厂 齿轮箱 提供 更 多 的 油 ， 而 无需 添加 正常 的 油 表面 。 工厂 变速器 油 正常 ， 蜱 虫 ， 不 需要 流动 ， 不 需要 流动 ， 不 需要 添加 ， 请问 你 英俊 的 男人 ， 这辆 车 样本 检查 足够 的 变速箱 油 ， 点燃 齿轮箱 油 ， 可以 吗 ？ 在 2016 年 比亚迪 歌 自动 精英 中 ， 是 一个 湿双 离合器 自动 变速器 4S 商店 ， 没有 汽车 检查 。 别 担心 ， 别 担心 ， 不用 担心 ， 火 检查 ， 油流 不是 很大 ， 但 很酷 的 水 在 外面 ， 在 外面 指出 外面 ， 汽车 不 在 外面 ， 不 流出 石油 和 优秀 水 ， 没有 必要 担心 ， 谢谢 ！ 别 担心 ， 我 想 问 一下 。 当 汽车 开始 时 ， 无法 在 情况 下 输入 燃料 废墟 ， 并且 不能 进入 箭头 ， 并 增加 一半 以上 的 崛起 ， 并 有 一个 工厂 添加 ？ 谢谢 你 ， 当 你 进入 汽车 时 ， 油 不是 很 宽 ， 不是 很 宽 ， 而且 连续 油 不是 很 宽 ， 齿轮箱 的 右侧 ， 底部 不是 全 齿轮箱 ， 而 不是 整个 变速箱 ， 而 不是 整个 变速箱 整个 变速箱 。  &lt;SEP&gt;工厂 变速器 油 正常 ， 您 不 需要 在 勾号 内 添加 一半 的 规模 。  


......
......
......


count= 9920
count= 9940
count= 9960
count= 9980
count= 10000
买 一个 间接 车 15 年 。 现在 我 开车 。 后座 里 有 水 。 地毯 是 潮湿 的 ， 主 驾驶 没有 水 ， 不买 它 10 天 ， 不要 买 它 。 清洗 ， 昨天 冲洗 内饰 。 这 与 水 不 一样 吗 ？ 我 不 知道 怎么 去车 ， 我 想 问 主人 ！ 这种 单 边缘 条件 基本上 是 湿水 的 原因 。 密封 的 地方 泄漏 ， 门 密封 ， 风会 泄漏 ， 你 必须 闭 上门 ， 车 蓬勃发展 ， 车 慢慢 地 寻找 水 ， 车 很慢 ， 海绵 有水来 搜索 在线 的 。 类似 的 试验 ， 空调 排水 块 不 知道 如果 您 有 排水 块 。 如果 出现 楼层 和 空调 断路器 ， 建议您 在 检查 ， 检查 ， 检查和 检查 检查 ， 检查 ， 共 调节 手套 是否 易于 检查 ， 检查 ， 检查和 检查 问题 。   1.5 手动 阳光 ， 开始 天气 ， 告诉 离合器 脚 ， 然后 去 维修 店 。 您 将 无法 调整 更换 ， 您 应该 易于 启动 ， 应该 没有 控制 离合器 ， 没有 控制 离合器 ， 抛出 ， 慢慢 习惯性 地 改变 速度 箱 ， 并 改变 三个 离合器 的 换档 压力 板 。 害怕 你 需要 害怕 ， 你 需要 更换 缓解 ， 8001000 海绵 的 价格 处理 自然 干水 。 海绵 差距 洗涤 泡沫 海绵 放在 挤压 的 顶部 ， 大 的 阳光 打开 门口 到 门口 ， 差异 主要 是 水 ， 干水 ， 下次 ， 下次 ， 时间 ， 时间 ， 海绵 ， 谢谢 ， 谢谢 ， 谢谢 ， 谢谢 ， 谢谢 ， 谢谢 ， 谢谢 ， 谢谢 你 ，   不 客气 ！  &lt;SEP&gt;截面 水 不是 水泡 。   如果 胶体 密封件 不 严格 ， 则 必须 检查 玻璃门 密封条 并 检查 前 玻璃 密封 界面 。


......
......
......
</code></pre></div>


<hr>
<ul>
<li>查看结果文件:</li>
</ul>
<div class="codehilite" id="__code_96"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_96 pre, #__code_96 code"><span class="md-clipboard__message"></span></button><pre id="__code_97"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_97 pre, #__code_97 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/data/

vim back_translated.txt
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_98"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_98 pre, #__code_98 code"><span class="md-clipboard__message"></span></button><pre id="__code_99"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_99 pre, #__code_99 code"><span class="md-clipboard__message"></span></button><code>方向 ， 升压 泵 ， 取向 机 的 方向 取代 了 所有 新泵 和 方向 的 方向 。 此车 匹配 不 需要 更换 组件 问题 。   它 也 很 好 ...... 非常 沉重 ， 疲惫 的 事故 ， 主人 不 重要 。   辅助 泵 的 选择 不会 改变 ， 并且 您 将 机器放置 并 解释 的 所有者 。  &lt;SEP&gt;随身携带 联系

梅赛德斯   -   奔驰 ML500 排气 凸轮轴 调整 误差 没有 计算机 检测 错误代码 。   在 发送 引擎 之前 显示 火灾 的 错误 指示器 是 一个 故障 排除 位 。   以前 的 错误报告 错误 没有 位 抖动 ， 以 确保 先前 的 错误报告 错误 不会太大而 无法 通过 发动机 抖动 火焰 罐 。   直接 联系 。   左右 排气 凸轮轴 电磁铁 阳极 短路 短路 线路 开关 镂&gt;空 阀门 多 电磁阀 门 您 想 检测 您 的 第一个 缺陷 直接 关系 方法 并 检测 质量 吗 ？   谢谢  &lt;SEP&gt;随身携带 联系

2010   BMW   X1 , 2011 , 2.0 位移 ， 通用 6L45 变速箱 ， 原始 换档 炸锅 ， 操作 升降级 正常 ， 转移 油 12L 取&gt;代 转化 油 ， 没有 变化 。 尝试 2014 年 进口 X1 的 感觉 。 这是 一个 问题 ， 四缸 自然 摄入 发动机 N46 。 第一悬挂 空间 不 慷慨 ， 调节 变速器 水平 的 正常 流体 ND 不是 ND ， PR 。 最 重要 的 驾驶 ， 红绿灯 ， 红灯 停车停车 DN 震撼 ， 绿灯 通行证 ， 如果 绿灯 已经 过去 ， 绿灯 非常 小 ， 齿轮箱 油位 调整 标准 级别 ， 擦除 齿轮箱 适应 值 ， 程序 ， 会议 液体 扭矩 计 问题 升级 变速箱 节目 刷 模块 问题 停车 岗位 后 刹车踏板 ， 我 觉得 车辆 将 首次 移动 变速箱 适应 。 但是 ， 可能 的 程序 问题 包括 液体 变矩器 轴 磨损 ， 减压 ， 要求 特殊 计算机 清晰 传动 齿轮箱 适应 值 升级 变速箱 程序 模糊 ， 传输 ， 变化 ， 无 味道 和 过滤器 元件 ， 汽车 不 在 框架 中。 框架 中有 4 个 音符 。 由于 首先 需要 休克 ， 因此 需要 在 需要 冲击 之前 再次 更换 油 ， 因此 您 需要 再&gt;次 更换 油 ， 因此 您 需要 再次 更换 油 ， 并且 没有 问题 。 程序 假定 发生 。 阀体 的 问题 ， 阀门 计算机 为 93 , 000 公里 。 昨天 ， 我 前往 支付 40 , 000 公里 或 以上 。 此刻 是 正常 的 ， 制动器 侧重于 不 需要 踩 在 制动器 上 的 制动 撞击 。   。 原始 装舱 不会 影响 。 如果 没有 影响 ， 那 就 应该 没有 问题 。 谢谢 不用谢 。&lt;SEP&gt;没有 感觉 ， 原始 变化 转变 。   制动器 没有 治疗 ， 不 应该 有 问题 。
</code></pre></div>


<hr>
<hr>
<h4 id="baseline-6">训练baseline-6模型</h4>
<ul>
<li>整个训练部分的核心代码没有任何变化:<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/src/model.py</li>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/src/evaluate.py</li>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/src/train.py</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>唯一就是调用train.py之前, 要将配置文件中的config.train_data_path设置成融合了回译数据后的训练集.</li>
</ul>
<div class="codehilite" id="__code_100"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_100 pre, #__code_100 code"><span class="md-clipboard__message"></span></button><pre id="__code_101"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_101 pre, #__code_101 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'cpu'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'DEVICE: '</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------------------</span>
    <span class="c1"># 将构建数据集的路径改为config.train_data_path, 即融合了回译数据的训练集</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">PairDataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train_data_path</span><span class="p">,</span>
                          <span class="n">max_enc_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_enc_len</span><span class="p">,</span>
                          <span class="n">max_dec_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_len</span><span class="p">,</span>
                          <span class="n">truncate_enc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_enc</span><span class="p">,</span>
                          <span class="n">truncate_dec</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_dec</span><span class="p">)</span>
    <span class="c1"># ------------------------------------------------------------------------------</span>

    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">PairDataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">val_data_path</span><span class="p">,</span>
                              <span class="n">max_enc_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_enc_len</span><span class="p">,</span>
                              <span class="n">max_dec_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_len</span><span class="p">,</span>
                              <span class="n">truncate_enc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_enc</span><span class="p">,</span>
                              <span class="n">truncate_dec</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_dec</span><span class="p">)</span>

    <span class="n">vocab</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">build_vocab</span><span class="p">(</span><span class="n">embed_file</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">embed_file</span><span class="p">)</span>

    <span class="n">train</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">start_epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_102"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_102 pre, #__code_102 code"><span class="md-clipboard__message"></span></button><pre id="__code_103"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_103 pre, #__code_103 code"><span class="md-clipboard__message"></span></button><code>[[99%|█████████▉| 398/402 [04:01&lt;00:01,  2.11it/s]
[[99%|█████████▉| 399/402 [04:02&lt;00:01,  1.59it/s]
[[100%|█████████▉| 400/402 [04:02&lt;00:01,  1.74it/s]
[[100%|█████████▉| 401/402 [04:03&lt;00:00,  1.63it/s]
[[100%|██████████| 402/402 [04:03&lt;00:00,  1.91it/s]
[[100%|██████████| 402/402 [04:03&lt;00:00,  1.65it/s]
Epoch 4: 100%|██████████| 5/5 [5:34:36&lt;00:00, 4015.39s/it, Loss=2.66]
12870 pairs.
loading data......
initializing optimizer......
model_name = pgn_model, pointer = True, coverage = True, fine_tune = False, scheduled_sampling = False, weight_tying = False,source = train
teacher_forcing = True
validating
training loss:4.41877871146003 validation loss:4.262211465716955
model_name = pgn_model, pointer = True, coverage = True, fine_tune = False, scheduled_sampling = False, weight_tying = False,source = train
teacher_forcing = True
validating
training loss:3.762527957910202 validation loss:4.172838443547339
model_name = pgn_model, pointer = True, coverage = True, fine_tune = False, scheduled_sampling = False, weight_tying = False,source = train
teacher_forcing = True
validating
training loss:3.3460291977802767 validation loss:4.2719492852984375
model_name = pgn_model, pointer = True, coverage = True, fine_tune = False, scheduled_sampling = False, weight_tying = False,source = train
teacher_forcing = True
validating
training loss:2.964604283309459 validation loss:4.436206663425882
model_name = pgn_model, pointer = True, coverage = True, fine_tune = False, scheduled_sampling = False, weight_tying = False,source = train
teacher_forcing = True
validating
training loss:2.660262194605791 validation loss:4.636601883973649
</code></pre></div>


<hr>
<ul>
<li>查看模型:</li>
</ul>
<div class="codehilite" id="__code_104"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_104 pre, #__code_104 code"><span class="md-clipboard__message"></span></button><pre id="__code_105"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_105 pre, #__code_105 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/saved_model/

ll
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_106"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_106 pre, #__code_106 code"><span class="md-clipboard__message"></span></button><pre id="__code_107"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_107 pre, #__code_107 code"><span class="md-clipboard__message"></span></button><code>-rw-rw-r-- 1 ec2-user ec2-user   8403804 3月  15 16:23 model_attention.pt
-rw-rw-r-- 1 ec2-user ec2-user  93584247 3月  15 16:23 model_decoder.pt
-rw-rw-r-- 1 ec2-user ec2-user  57781249 3月  15 16:23 model_encoder.pt
-rw-rw-r-- 1 ec2-user ec2-user       751 3月  15 16:23 model_reduce_state.pt
-rw-rw-r-- 1 ec2-user ec2-user 159765238 3月  15 16:23 pgn_model_optim1.pt
</code></pre></div>


<hr>
<h4 id="baseline-6_1">评估baseline-6模型</h4>
<ul>
<li>
<p>首先评估贪心解码策略的模型表现.</p>
</li>
<li>
<p>唯一需要改动的是predict.py文件:</p>
<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/src/predict.py</li>
</ul>
</li>
</ul>
<hr>
<div class="codehilite" id="__code_108"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_108 pre, #__code_108 code"><span class="md-clipboard__message"></span></button><pre id="__code_109"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_109 pre, #__code_109 code"><span class="md-clipboard__message"></span></button><code><span class="k">class</span> <span class="nc">Predict</span><span class="p">():</span>
    <span class="nd">@timer</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s1">'initalize predicter'</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">DEVICE</span>

        <span class="c1"># ----------------------------------------------------------------------------</span>
        <span class="c1"># 在baseline-6模型评估中, 只需修改第一行的训练集路径即可.</span>
        <span class="c1"># 改成回译数据后的train_data_path数据集.</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">PairDataset</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">train_data_path</span><span class="p">,</span>
                              <span class="n">max_enc_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_enc_len</span><span class="p">,</span>
                              <span class="n">max_dec_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_len</span><span class="p">,</span>
                              <span class="n">truncate_enc</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_enc</span><span class="p">,</span>
                              <span class="n">truncate_dec</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">truncate_dec</span><span class="p">)</span>
        <span class="c1"># ----------------------------------------------------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">build_vocab</span><span class="p">(</span><span class="n">embed_file</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">embed_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">PGN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_word</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">stop_word_file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>


    <span class="c1"># -------------------------------------------------------------------------------</span>
    <span class="c1"># 类中间的三个函数完全不做改变.</span>
    <span class="c1"># def greedy_search()</span>
    <span class="c1"># def best_k()</span>
    <span class="c1"># def beam_search()</span>
    <span class="c1"># -------------------------------------------------------------------------------</span>


    <span class="c1"># -------------------------------------------------------------------------------</span>
    <span class="c1"># 唯一需要注意的是predict()函数中最后一个参数设置为beam_search=False</span>
    <span class="nd">@timer</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s1">'doing prediction'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">beam_search</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c1"># -------------------------------------------------------------------------------</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tokenize</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">oov</span> <span class="o">=</span> <span class="n">source2ids</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">len_oovs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">oov</span><span class="p">)])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">x_padding_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">beam_search</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_search</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                       <span class="n">max_sum_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_steps</span><span class="p">,</span>
                                       <span class="n">beam_width</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">beam_size</span><span class="p">,</span>
                                       <span class="n">len_oovs</span><span class="o">=</span><span class="n">len_oovs</span><span class="p">,</span>
                                       <span class="n">x_padding_masks</span><span class="o">=</span><span class="n">x_padding_masks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy_search</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                         <span class="n">max_sum_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_steps</span><span class="p">,</span>
                                         <span class="n">len_oovs</span><span class="o">=</span><span class="n">len_oovs</span><span class="p">,</span>
                                         <span class="n">x_padding_masks</span><span class="o">=</span><span class="n">x_padding_masks</span><span class="p">)</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">outputids2words</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">oov</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">summary</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'&lt;SOS&gt;'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'&lt;EOS&gt;'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_110"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_110 pre, #__code_110 code"><span class="md-clipboard__message"></span></button><pre id="__code_111"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_111 pre, #__code_111 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/src/

python rouge_eval.py
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_112"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_112 pre, #__code_112 code"><span class="md-clipboard__message"></span></button><pre id="__code_113"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_113 pre, #__code_113 code"><span class="md-clipboard__message"></span></button><code>实例化Rouge对象......
Reading from  /home/ec2-user/text_summary/pgn/data/dev.txt
self.refs[]包含的样本数:  3000
Test set contains 3000 samples.
实例化Predict对象......
Reading dataset /home/ec2-user/text_summary/pgn/data/train.txt... 140000 pairs.
9.629374980926514 secs used for  initalize predicter
利用模型对article进行预测, 并通过Rouge对象进行评估......
Building hypotheses.
0.03845691680908203 secs used for  doing prediction
0.019861459732055664 secs used for  doing prediction
0.05215024948120117 secs used for  doing prediction
0.010435342788696289 secs used for  doing prediction
0.062055110931396484 secs used for  doing prediction
0.0130157470703125 secs used for  doing prediction
0.013869047164916992 secs used for  doing prediction
0.019742965698242188 secs used for  doing prediction
0.056656599044799805 secs used for  doing prediction
0.0303499698638916 secs used for  doing prediction
0.021750926971435547 secs used for  doing prediction
0.016774654388427734 secs used for  doing prediction


......
......
......


0.022000551223754883 secs used for  doing prediction
0.021669626235961914 secs used for  doing prediction
0.02123737335205078 secs used for  doing prediction
0.010778188705444336 secs used for  doing prediction
0.05450749397277832 secs used for  doing prediction
0.02147197723388672 secs used for  doing prediction
0.05725407600402832 secs used for  doing prediction
0.02341461181640625 secs used for  doing prediction
0.03106856346130371 secs used for  doing prediction
133.5088288784027 secs used for  building hypotheses
开始用Rouge规则进行评估......
Calculating average rouge scores.
rouge1:  {'f': 0.24714167362734157, 'p': 0.25608566917386133, 'r': 0.3358231463860842}
rouge2:  {'f': 0.0820226961990237, 'p': 0.08403909663144762, 'r': 0.11412232564349624}
rougeL:  {'f': 0.2764039465471819, 'p': 0.3332359770989586, 'r': 0.28641434732418697}
将评估结果写入结果文件中......
</code></pre></div>


<hr>
<ul>
<li>
<p>然后评估Beam search解码策略的模型表现:</p>
</li>
<li>
<p>唯一需要改动的是predict.py文件:</p>
<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/src/predict.py</li>
</ul>
</li>
</ul>
<hr>
<div class="codehilite" id="__code_114"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_114 pre, #__code_114 code"><span class="md-clipboard__message"></span></button><pre id="__code_115"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_115 pre, #__code_115 code"><span class="md-clipboard__message"></span></button><code>    <span class="c1"># -------------------------------------------------------------------------------</span>
    <span class="c1"># 唯一需要注意的是predict()函数中最后一个参数设置为beam_search=True</span>
    <span class="nd">@timer</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="s1">'doing prediction'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">tokenize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">beam_search</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="c1"># -------------------------------------------------------------------------------</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tokenize</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">oov</span> <span class="o">=</span> <span class="n">source2ids</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">len_oovs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">oov</span><span class="p">)])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">x_padding_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">beam_search</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_search</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                       <span class="n">max_sum_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_steps</span><span class="p">,</span>
                                       <span class="n">beam_width</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">beam_size</span><span class="p">,</span>
                                       <span class="n">len_oovs</span><span class="o">=</span><span class="n">len_oovs</span><span class="p">,</span>
                                       <span class="n">x_padding_masks</span><span class="o">=</span><span class="n">x_padding_masks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy_search</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                         <span class="n">max_sum_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_dec_steps</span><span class="p">,</span>
                                         <span class="n">len_oovs</span><span class="o">=</span><span class="n">len_oovs</span><span class="p">,</span>
                                         <span class="n">x_padding_masks</span><span class="o">=</span><span class="n">x_padding_masks</span><span class="p">)</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">outputids2words</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">oov</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">summary</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'&lt;SOS&gt;'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'&lt;EOS&gt;'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre></div>


<hr>
<ul>
<li>调用:</li>
</ul>
<div class="codehilite" id="__code_116"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_116 pre, #__code_116 code"><span class="md-clipboard__message"></span></button><pre id="__code_117"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_117 pre, #__code_117 code"><span class="md-clipboard__message"></span></button><code><span class="nb">cd</span> /home/ec2-user/text_summary/pgn/src/

python rouge_eval.py
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_118"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_118 pre, #__code_118 code"><span class="md-clipboard__message"></span></button><pre id="__code_119"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_119 pre, #__code_119 code"><span class="md-clipboard__message"></span></button><code>实例化Rouge对象......
Reading from  /home/ec2-user/text_summary/pgn/data/dev.txt
self.refs[]包含的样本数:  3000
Test set contains 3000 samples.
实例化Predict对象......
Reading dataset /home/ec2-user/text_summary/pgn/data/train.txt... 140000 pairs.
9.626121044158936 secs used for  initalize predicter
利用模型对article进行预测, 并通过Rouge对象进行评估......
Building hypotheses.
0.35624098777770996 secs used for  doing prediction
0.3338348865509033 secs used for  doing prediction
0.33432435989379883 secs used for  doing prediction
0.3342163562774658 secs used for  doing prediction
0.34050464630126953 secs used for  doing prediction
0.33318519592285156 secs used for  doing prediction
0.33368706703186035 secs used for  doing prediction
0.37041473388671875 secs used for  doing prediction
0.3328053951263428 secs used for  doing prediction
0.33130455017089844 secs used for  doing prediction
0.35515427589416504 secs used for  doing prediction


......
......
......


0.33437108993530273 secs used for  doing prediction
0.34429430961608887 secs used for  doing prediction
0.3546004295349121 secs used for  doing prediction
0.3333625793457031 secs used for  doing prediction
0.33243417739868164 secs used for  doing prediction
0.3309314250946045 secs used for  doing prediction
0.3401467800140381 secs used for  doing prediction
0.33484387397766113 secs used for  doing prediction
0.33845043182373047 secs used for  doing prediction
0.3364748954772949 secs used for  doing prediction
1021.2585122585297 secs used for  building hypotheses
开始用Rouge规则进行评估......
Calculating average rouge scores.
rouge1:  {'f': 0.22248546386135054, 'p': 0.17989035729605285, 'r': 0.38541637147660435}
rouge2:  {'f': 0.07306576745365218, 'p': 0.058211302200456325, 'r': 0.13246926854571667}
rougeL:  {'f': 0.2737105514741625, 'p': 0.28581698245427, 'r': 0.3234800390139786}
将评估结果写入结果文件中......
</code></pre></div>


<hr>
<ul>
<li>模型效果对比:</li>
</ul>
<div class="codehilite" id="__code_120"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_120 pre, #__code_120 code"><span class="md-clipboard__message"></span></button><pre id="__code_121"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_121 pre, #__code_121 code"><span class="md-clipboard__message"></span></button><code># baseline-2| baseline-3     | baseline-4     | baseline-5   | baseline-5    | baseline-6 | baseline-6
# PGN       | PGN + coverage | PGN + coverage | 单词替换优化   | 单词替换优化    | 回译数据法   | 回译数据法
#           |                | + beam-search  | 贪心解码      | Beam search   | 贪心解码     | Beam search
# --------------------------------------------------------------------------------------------------------

rouge-1     | rouge-1        | rouge-1        | rouge-1      | rouge-1       | rouge-1    | rouge-1
f: 22.484   | f: 23.891      | f: 22.378      | f: 24.856    | f: 21.761     | f: 24.714  | f: 22.248
p: 22.488   | p: 27.884      | p: 18.118      | p: 27.987    | p: 17.647     | p: 25.608  | p: 17.989
r: 36.152   | r: 32.746      | r: 38.418      | r: 31.694    | r: 37.561     | r: 33.582  | r: 38.541

# --------------------------------------------------------------------------------------------------------

rouge-2     | rouge-2        | rouge-2        | rouge-2      | rouge-2       | rouge-2    | rouge-2 
f: 7.685    | f: 8.145       | f: 7.272       | f: 7.876     | f: 6.866      | f: 8.202   | f: 7.306
p: 7.633    | p: 9.507       | p: 5.774       | p: 8.768     | p: 5.509      | p: 8.403   | p: 5.821
r: 12.992   | r: 11.403      | r: 13.465      | r: 10.274    | r: 12.487     | r: 11.412  | r: 13.247

# --------------------------------------------------------------------------------------------------------

rouge-l     | rouge-l        | rouge-l        | rouge-l      | rouge-l       | rouge-l    | rouge-l 
f: 29.791   | f: 28.112      | f: 27.544      | f: 27.348    | f: 27.141     | f: 27.640  | f: 27.371
p: 35.022   | p: 35.516      | p: 28.642      | p: 34.682    | p: 28.759     | p: 33.323  | p: 28.581
r: 31.245   | r: 28.567      | r: 32.286      | r: 27.245    | r: 31.386     | r: 28.641  | r: 32.348
</code></pre></div>


<hr>
<hr>
<h3 id="_7">半监督学习法</h3>
<h4 id="_8">半监督数据增强法</h4>
<ul>
<li>当训练样本不足, 或者需要更进一步在更大规模的数据集上优化模型时, 可以采用半监督学习法.</li>
</ul>
<hr>
<ul>
<li>半监督数据增强法: 当我们已经训练出一个文本生成模型后, 可以利用这个模型为原始训练集中的abstract生成新的article, 将这个新生成的article作为新样本的source document, 继续训练模型.</li>
</ul>
<hr>
<ul>
<li>在半监督算法的实践中, 我们选取baseline-4为基准模型(具体选取哪个模型为基准, 可以多次尝试, 或者程序员指定!)<ul>
<li>代码文件路径: /home/ec2-user/text_summary/pgn/optim/semi_supervised.py </li>
</ul>
</li>
</ul>
<div class="codehilite" id="__code_122"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_122 pre, #__code_122 code"><span class="md-clipboard__message"></span></button><pre id="__code_123"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_123 pre, #__code_123 code"><span class="md-clipboard__message"></span></button><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="c1"># 设定项目的root路径, 方便后续相关代码文件的导入</span>
<span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>

<span class="c1"># 导入项目相关的代码文件</span>
<span class="kn">from</span> <span class="nn">src.predict</span> <span class="kn">import</span> <span class="n">Predict</span>
<span class="kn">from</span> <span class="nn">optim.data_utils</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># 半监督数据增强的实现函数</span>
<span class="k">def</span> <span class="nf">semi_supervised</span><span class="p">(</span><span class="n">samples_path</span><span class="p">,</span> <span class="n">write_path</span><span class="p">,</span> <span class="n">beam_search</span><span class="p">):</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">Predict</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'vocab_size: '</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">vocab</span><span class="p">))</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">semi</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">samples_path</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">picked</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># 原始训练集数据, 每行样本以&lt;SEP&gt;进行分隔.</span>
            <span class="n">source</span><span class="p">,</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">picked</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'&lt;SEP&gt;'</span><span class="p">)</span>

            <span class="c1"># 调用预测类Predict对摘要给出生成文本.</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">beam_search</span><span class="o">=</span><span class="n">beam_search</span><span class="p">)</span>
            <span class="c1"># 将模型生成的文本重新作为source document, 拼接成新的训练样本.</span>
            <span class="n">semi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span> <span class="o">+</span> <span class="s1">'&lt;SEP&gt;'</span> <span class="o">+</span> <span class="n">ref</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">'count='</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                <span class="n">write_samples</span><span class="p">(</span><span class="n">semi</span><span class="p">,</span> <span class="n">write_path</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>
                <span class="n">semi</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>


<hr>
<ul>
<li>第一步: 尝试利用贪心策略生成半监督样本数据.</li>
</ul>
<div class="codehilite" id="__code_124"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_124 pre, #__code_124 code"><span class="md-clipboard__message"></span></button><pre id="__code_125"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_125 pre, #__code_125 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">samples_path</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/train2.txt'</span>
    <span class="n">write_path_greedy</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/semi_greedy.txt'</span>
    <span class="n">write_path_beam</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/semi_beam.txt'</span>

    <span class="c1"># 贪心策略生成半监督数据, 关键在于参数设置为False</span>
    <span class="n">beam_search</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">beam_search</span><span class="p">:</span>
        <span class="n">write_path</span> <span class="o">=</span> <span class="n">write_path_beam</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">write_path</span> <span class="o">=</span> <span class="n">write_path_greedy</span>
    <span class="n">semi_supervised</span><span class="p">(</span><span class="n">samples_path</span><span class="p">,</span> <span class="n">write_path</span><span class="p">,</span> <span class="n">beam_search</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_126"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_126 pre, #__code_126 code"><span class="md-clipboard__message"></span></button><pre id="__code_127"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_127 pre, #__code_127 code"><span class="md-clipboard__message"></span></button><code>随时 联系 随时 联系 ！ 联系 联系 随时 联系 ！ 联系 联系 联系 联系 联系 联系 联系 联系 联系 联系 联系 联系 联系
 联系 联系 联系 联系 联系 联系&lt;SEP&gt;随时 联系
没有 问题 ， 应该 没有 问题&lt;SEP&gt;行驶 没有 顿挫 感觉 ， 原地 换挡 闯动 ， 刹车 踩 重 没有 ， 力 限制 作用 ， 应
该 没有 问题
上 车辆 车辆 缸体 缸体 上 上 ， 前轮 前轮 缸体 上 举起 ， 车辆 前轮 缸体 上 上 ， 车辆 前轮 缸体 上 上 ， 车辆
 前轮 缸体&lt;SEP&gt;举起 车辆 ， 左 前轮 缸体 上
入手 。 车况 好 ， 车况 好 ， 车况 好 ， 车况 好 ， 车况 好 ， 耐用&lt;SEP&gt;家庭 用车 入手 ， 维修保养 价格 还 。 车况 好 ， 价格合理 入手
这种 情况 ， 变速器 变速器 一轴 油封 漏油 ， 需要 拆下来 检查一下 ， 必要 更换 新 油封 ， 最好 去 修理厂 检查&gt;一下 ， 两个 方面 都 没有 问题 ，&lt;SEP&gt;这种 情况 ， 机油 不 缺少 ， 应该 变速器 一轴 油封 漏油 情况 ， 需要 拆&gt;下来 检查一下 ， 两个 油封 最好 都 检查一下 ， 出现 问题 直接 更换 。
这种 情况 需要 检查 汽车 电脑 ， 防盗 系统 ， 需要 电脑 匹配 复位 学习 ， 希望 帮到 ！ 希望 帮到 ！ 希望 帮到 ！ 希望 帮到 ！ 希望&lt;SEP&gt;！ 车子 断电 后 ， 重新 车 启动 会 车子 怠速 偏低 不 稳 抖动 需要 重新 清洗 干净 节气
门 后 匹配 节气门 ， 防盗 ， 车子 正常 解锁 正常 ， 音响 方面 正常 开机 启动 不 需要 解码 ， 不能 正常 开机 需
要 输入 密码 开机 ， 密码 车子 多媒体 机 后面 条码 上 读取 密码 ， 不是 所有 节气门 匹配 方法 都 ， 车型 需要 连接 汽车 专用 电脑 匹配 节气门 ， 希望 帮到 ！
面板 面板 螺丝 固定&lt;SEP&gt;面板 内部 卡子 固定 ， 没有 固定 螺丝
</code></pre></div>


<hr>
<ul>
<li>第二步: 尝试利用Beam search策略生成半监督样本数据. </li>
</ul>
<div class="codehilite" id="__code_128"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_128 pre, #__code_128 code"><span class="md-clipboard__message"></span></button><pre id="__code_129"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_129 pre, #__code_129 code"><span class="md-clipboard__message"></span></button><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">samples_path</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/train2.txt'</span>
    <span class="n">write_path_greedy</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/semi_greedy.txt'</span>
    <span class="n">write_path_beam</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s1">'/data/semi_beam.txt'</span>

    <span class="c1"># Beam search策略生成半监督数据, 关键在于参数设置为True</span>
    <span class="n">beam_search</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">beam_search</span><span class="p">:</span>
        <span class="n">write_path</span> <span class="o">=</span> <span class="n">write_path_beam</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">write_path</span> <span class="o">=</span> <span class="n">write_path_greedy</span>
    <span class="n">semi_supervised</span><span class="p">(</span><span class="n">samples_path</span><span class="p">,</span> <span class="n">write_path</span><span class="p">,</span> <span class="n">beam_search</span><span class="p">)</span>
</code></pre></div>


<hr>
<ul>
<li>输出结果:</li>
</ul>
<div class="codehilite" id="__code_130"><button class="md-clipboard" title="复制" data-clipboard-target="#__code_130 pre, #__code_130 code"><span class="md-clipboard__message"></span></button><pre id="__code_131"><span></span><button class="md-clipboard" title="复制" data-clipboard-target="#__code_131 pre, #__code_131 code"><span class="md-clipboard__message"></span></button><code>随时 联系 随时 联系 ！ 随时 联系 ！ 联系 联系 联系 联系 联系 联系 联系 联系 联系 联系 联系 联系 联系 联系 联系
 联系 联系 联系 联系 联系 联系 联系&lt;SEP&gt;随时 联系
没有 问题 ， 应该 没有 问题 ， 应该 没有 问题 ， 应该 没有 问题 ， 应该 没有 问题 ， 应该 没有 问题 ， 应该 没
有 问题 ， 应该 没有 问题&lt;SEP&gt;行驶 没有 顿挫 感觉 ， 原地 换挡 闯动 ， 刹车 踩 重 没有 ， 力 限制 作用 ， 应该
 没有 问题
上 车辆 车辆 缸体 缸体 上 上 ， ， 前轮 前轮 缸体 上 举起 ， 车辆 前轮 缸体 上 上 ， 车辆 前轮 缸体 上 上 ， &gt;车辆 前轮 缸体&lt;SEP&gt;举起 车辆 ， 左 前轮 缸体 上
用车 愉快 。 车况 好 。 车况 好 。 车况 好 。 车况 好 。 车况 好 。 车况 好 。 车况 好 。 车况 好 。 车况 好 &gt;。&lt;SEP&gt;家庭 用车 入手 ， 维修保养 价格 还 。 车况 好 ， 价格合理 入手
一轴 变速器 油封 漏油 ， 需要 拆下来 检查一下 ， 油封 漏油 没有 问题 ， 需要 更换 变速器 油 ， 两个 方面 都 会
 出现 这种 情况 ， 应该 不 一轴&lt;SEP&gt;这种 情况 ， 机油 不 缺少 ， 应该 变速器 一轴 油封 漏油 情况 ， 需要 拆下&gt;来 检查一下 ， 两个 油封 最好 都 检查一下 ， 出现 问题 直接 更换 。
这种 情况 需要 清洗 一下 节气门 ， 匹配 节气门 ， 希望 帮到 ！ 希望 帮到 ！ 希望 帮到 ！ 希望 帮到 ！ 希望 帮&gt;到 ！ 希望 帮到 ！ 希望 帮到&lt;SEP&gt;！ 车子 断电 后 ， 重新 车 启动 会 车子 怠速 偏低 不 稳 抖动 需要 重新 清洗 &gt;干净 节气门 后 匹配 节气门 ， 防盗 ， 车子 正常 解锁 正常 ， 音响 方面 正常 开机 启动 不 需要 解码 ， 不能 正&gt;常 开机 需要 输入 密码 开机 ， 密码 车子 多媒体 机 后面 条码 上 读取 密码 ， 不是 所有 节气门 匹配 方法 都 ， 车型 需要 连接 汽车 专用 电脑 匹配 节气门 ， 希望 帮到 ！
面板 内部 螺丝 固定 ， 没有 固定 螺丝 ， 固定 固定 螺丝 固定 ， 没有 固定 螺丝 ， 固定 固定 螺丝 固定 ， 没有 固定 螺丝 ， 没有 固定 螺丝&lt;SEP&gt;面板 内部 卡子 固定 ， 没有 固定 螺丝
</code></pre></div>


<hr>
<blockquote>
<ul>
<li>结论: 我们可以通过生成文件中的新的样本数据很清楚的看到, 对于当前模型的表现, 以及当前任务下, 半监督生成的样本数据比较差, 很难用来优化模型, 所以后续不再使用. </li>
</ul>
</blockquote>
<hr>
<hr>
<h3 id="_9">小节总结</h3>
<ul>
<li>小节总结:<ul>
<li>单词替换法: <ul>
<li>TF-IDF算法来自动提取关键词.</li>
<li>在对训练集进行普遍替换的过程中, 不替换上一步得到的关键词.</li>
<li>单词替换后的样本可以表达更丰富的语义, 更丰富的表达形式, 增强模型的表现.</li>
</ul>
</li>
<li>回译数据法:<ul>
<li>采用Google翻译接口.</li>
<li>不同语言间的翻译可以得到更多的样本, 更丰富的语义, 更丰富的表达形式, 增强模型的表现, 并弥补样本量的不足.</li>
</ul>
</li>
<li>半监督学习法:<ul>
<li>前提是已经有一个表现不错的模型.</li>
<li>利用这个模型将摘要作为输入生成新的文本, 这个文本将作为新样本的输入文本.</li>
<li>但这种方法依赖于已有模型要表现较好, 同时原始训练样本的质量也要较高.</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<hr>
<hr>
<hr>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="./6_2.html" title="6.2 PGN + beam-search的优化模型" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  上一页
                </span>
                6.2 PGN + beam-search的优化模型
              </span>
            </div>
          </a>
        
        
          <a href="./6_4.html" title="6.4 训练策略的优化" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  下一页
                </span>
                6.4 训练策略的优化
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            ©Copyright 2020, AITutorials.CN This website has been reviewed by the review agency. 京ICP备19006137号
          </div>
        
        powered by
        <a href="https://www.mkdocs.org/">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="./index_files/font-awesome.css">
    
      <a href="https://www.linkedin.com/in/%E7%A7%91%E6%8A%80%E6%9C%89%E9%99%90%E5%85%AC%E5%8F%B8-%E5%8C%97%E4%BA%AC%E6%A9%98%E6%98%9F-6bb7081a1/" class="md-footer-social__link fa fa-linkedin"></a>
    
      <a href="https://weibo.com/u/3469990762?is_all=1" class="md-footer-social__link fa fa-weibo"></a>
    
      <a href="http://bitbucket.org/AITutorials" class="md-footer-social__link fa fa-bitbucket"></a>
    
      <a href="https://github.com/AITutorials/datasets/issues" class="md-footer-social__link fa fa-gitlab"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="./index_files/application.245445c6.js"></script>
      
        
        
          
          <script src="./index_files/lunr.stemmer.support.js"></script>
          
            
              
                <script src="./index_files/tinyseg.js"></script>
              
              
                <script src="./index_files/lunr.ja.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.1.2",url:{base:".."}})</script>
      
    
  
</body></html>