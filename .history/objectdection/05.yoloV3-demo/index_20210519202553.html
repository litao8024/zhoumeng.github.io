
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.5">
    
    
      
        <title>YOLOV3案例 - 深度学习与CV</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bde7dde4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#45-yolov3" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="深度学习与CV" class="md-header__button md-logo" aria-label="深度学习与CV" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            深度学习与CV
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              YOLOV3案例
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="深度学习与CV" class="md-nav__button md-logo" aria-label="深度学习与CV" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    深度学习与CV
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      <label class="md-nav__link" for="__nav_1">
        课程介绍
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="课程介绍" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          课程介绍
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/section1/index.html" class="md-nav__link">
        深度学习
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/section2/index.html" class="md-nav__link">
        计算机视觉（CV）
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        tensorflow入门
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="tensorflow入门" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          tensorflow入门
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tensorFlow/section1/index.html" class="md-nav__link">
        tensorflow和keras简介
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tensorFlow/section2/index.html" class="md-nav__link">
        快速入门模型
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        深度神经网络
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="深度神经网络" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          深度神经网络
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deeplearning/section1/index.html" class="md-nav__link">
        神经网络简介
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deeplearning/section2/index.html" class="md-nav__link">
        常见的损失函数
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deeplearning/section3/index.html" class="md-nav__link">
        深度学习的优化方法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deeplearning/section4/index.html" class="md-nav__link">
        深度学习的正则化
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deeplearning/section5/index.html" class="md-nav__link">
        神经网络案例
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../deeplearning/section6/index.html" class="md-nav__link">
        卷积神经网络CNN
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        图像分类
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="图像分类" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          图像分类
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../imageClassification/section1/index.html" class="md-nav__link">
        图像分类简介
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../imageClassification/section2/index.html" class="md-nav__link">
        AlexNet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../imageClassification/section3/index.html" class="md-nav__link">
        VGG
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../imageClassification/section4/index.html" class="md-nav__link">
        GoogLeNet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../imageClassification/section5/index.html" class="md-nav__link">
        ResNet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../imageClassification/section6/index.html" class="md-nav__link">
        图像增强方法
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../imageClassification/section7/index.html" class="md-nav__link">
        模型微调
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      <label class="md-nav__link" for="__nav_5">
        目标检测
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="目标检测" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          目标检测
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../01.overview/index.html" class="md-nav__link">
        目标检测概述
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../02.RCNN/index.html" class="md-nav__link">
        RCNN网络基础
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../03.Faster-RCNN/index.html" class="md-nav__link">
        Faster-RCNN原理与实现
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../04.yolo/index.html" class="md-nav__link">
        YOLO系列算法
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          YOLOV3案例
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="#" class="md-nav__link md-nav__link--active">
        YOLOV3案例
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1.数据获取
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2tfrecord" class="md-nav__link">
    2.TFrecord文件
  </a>
  
    <nav class="md-nav" aria-label="2.TFrecord文件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-tfrecord" class="md-nav__link">
    2.1 什么是TFrecord文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-tfrecord" class="md-nav__link">
    2.2 将数据转换为TFRecord文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-tfrecord" class="md-nav__link">
    2.3 读取TFRecord文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24" class="md-nav__link">
    2.4. 数据处理
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3.模型构建
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4.模型训练
  </a>
  
    <nav class="md-nav" aria-label="4.模型训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    4.1损失函数的计算
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2 正负样本的设定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43" class="md-nav__link">
    4.3 模型训练
  </a>
  
    <nav class="md-nav" aria-label="4.3 模型训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#431" class="md-nav__link">
    4.3.1 获取数据集
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#432" class="md-nav__link">
    4.3.2 加载模型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#433" class="md-nav__link">
    4.3.3 模型训练
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5.模型预测
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        目标分割
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="目标分割" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          目标分割
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../imageSegmentation/section1/index.html" class="md-nav__link">
        目标分割介绍
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../imageSegmentation/section2/index.html" class="md-nav__link">
        语义分割：FCN和UNet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../imageSegmentation/section3/index.html" class="md-nav__link">
        UNet案例
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../imageSegmentation/section4/index.html" class="md-nav__link">
        实例分割：Mask RCNN
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1.数据获取
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2tfrecord" class="md-nav__link">
    2.TFrecord文件
  </a>
  
    <nav class="md-nav" aria-label="2.TFrecord文件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-tfrecord" class="md-nav__link">
    2.1 什么是TFrecord文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-tfrecord" class="md-nav__link">
    2.2 将数据转换为TFRecord文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-tfrecord" class="md-nav__link">
    2.3 读取TFRecord文件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24" class="md-nav__link">
    2.4. 数据处理
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3.模型构建
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4.模型训练
  </a>
  
    <nav class="md-nav" aria-label="4.模型训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    4.1损失函数的计算
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2 正负样本的设定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43" class="md-nav__link">
    4.3 模型训练
  </a>
  
    <nav class="md-nav" aria-label="4.3 模型训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#431" class="md-nav__link">
    4.3.1 获取数据集
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#432" class="md-nav__link">
    4.3.2 加载模型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#433" class="md-nav__link">
    4.3.3 模型训练
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5.模型预测
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="45-yolov3">4.5 YoloV3 案例<a class="headerlink" href="#45-yolov3" title="Permanent link">&para;</a></h1>
<p><strong>学习目标</strong></p>
<ul>
<li>熟悉TFRecord文件的使用方法</li>
<li>知道YoloV3模型结构及构建方法</li>
<li>知道数据处理方法</li>
<li>能够利用yoloV3模型进行训练和预测</li>
</ul>
<hr />
<p><img alt="2818543934-5e4ba4d2823ec" src="../assets/2818543934-5e4ba4d2823ec.png" /></p>
<h2 id="1">1.数据获取<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<p>根据要实现的业务场景，需要收集大量的图像数据，一般来说包含两大来源，一部分是网络数据，可以是开源数据，也可以通过百度、Google图片爬虫得到，另一部分是用户场景的视频录像，这一部分的数据量会更大。对于开源数据我们不需要进行标注，而爬取的数据和视频录像需要进行标注，这时我们可以使用开源工具labelImg进行标注，该软件截图如下：</p>
<p><img alt="image-20201231173621946" src="../assets/image-20201231173621946.png" /></p>
<p>具体的操作：</p>
<p><a href="https://www.pianshen.com/article/5220613836/">labelImage使用方法</a></p>
<p>数据标注完成后，我们就可以使用其进行模型训练，在接下来的课程中我们就使用标注好的数据进行模型训练，模型预测。使用的工程如下所示：</p>
<p><img alt="image-20201231174145613" src="../assets/image-20201231174145613.png" /></p>
<p>主要内容是：</p>
<p>1.config中是网络的配置信息：anchors,类别信息</p>
<p>2.core中是损失函数计算，网络预测的内容</p>
<p>3.dateset中是对数据的处理</p>
<p>4.model是对模型的构建</p>
<p>5.utils是一些辅助文件，包括anchor,类别信息的获取等</p>
<p>6.weights中保存了一个使用coco数据集训练的预训练模型</p>
<h2 id="2tfrecord">2.TFrecord文件<a class="headerlink" href="#2tfrecord" title="Permanent link">&para;</a></h2>
<p>该案例中我们依然使用VOC数据集来进行目标检测，不同的是我们要利用tfrecord文件来存储和读取数据，首先来看一下tfrecord文件的相关内容。</p>
<p>为什么要使用tfrecord文件？</p>
<ul>
<li>TFRecord是Google官方推荐使用的数据格式化存储工具，为TensorFlow量身打造的。</li>
<li>TFRecord规范了数据的读写方式，数据读取和处理的效率都会得到显著的提高。</li>
</ul>
<h3 id="21-tfrecord">2.1 什么是TFrecord文件<a class="headerlink" href="#21-tfrecord" title="Permanent link">&para;</a></h3>
<p>TFRecord 是Google官方推荐的一种数据格式，是Google专门为TensorFlow设计的一种数据格式，利用这种方式存储数据可以使其与网络架构更适配。TFRecord是一种二进制文件，其能更好的利用内存，与csv,hdf5文件是类似的。</p>
<p>TFRecord的文件的内容如下图所示：</p>
<p><img alt="image-20200923142227273" src="../assets/image-20200923142227273.png" /></p>
<p>TFRecord内部包含多个tf.train.Example，一般来说对应一个图像数据，在一个Example消息体中包含了一系列的tf.train.feature属性，而 每一个feature是一个key-value的键值对,key是特征名称，value是特征值。</p>
<p>TFRecord 并非是TensorFlow唯一支持的数据格式，也可以使用CSV或文本等其他格式，但是对于TensorFlow来说，TFRecord 是最友好的，最方便的，而且tensorflow也提供了丰富的API帮助我们轻松的创建和获取TFRecord文件。</p>
<h3 id="22-tfrecord">2.2 将数据转换为TFRecord文件<a class="headerlink" href="#22-tfrecord" title="Permanent link">&para;</a></h3>
<p>对于中大数据集来说，Google官方推荐先将数据集转化为TFRecord数据, 这样可加快在数据读取, 预处理中的速度。接下来我们就将VOC数据集转换为Records格式，将数据写入TFRecords文件中,直接使用write_to_tfrecord即可实现，首先导入工具包：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">dataset.vocdata_tfrecord</span> <span class="kn">import</span> <span class="n">load_labels</span><span class="p">,</span><span class="n">write_to_tfrecord</span>
<span class="kn">import</span> <span class="nn">os</span>
</code></pre></div>
<p>将数据写入tfrecord中的流程是：</p>
<ol>
<li>指定要写入的数据集路径</li>
<li>获取所有的XML标注文件</li>
<li>指定tfrecord的存储位置</li>
<li>获取图像的路径</li>
<li>将数据写入到tfrecord文件中</li>
</ol>
<p>实现如下：</p>
<p><img alt="image-20210106150711334" src="../assets/image-20210106150711334.png" /></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 指定要写入的数据集路径</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="s1">&#39;/Users/yaoxiaoying/Desktop/yoloV3-tf2/dataset/VOCdevkit/VOC2007&#39;</span>
<span class="c1"># 获取所有的XML标注文件</span>
<span class="n">all_xml</span> <span class="o">=</span> <span class="n">load_labels</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="c1"># 指定tfrecord的存储位置</span>
<span class="n">tfrecord_path</span> <span class="o">=</span> <span class="s1">&#39;voc_train.tfrecords&#39;</span>
<span class="c1"># 获取图像的路径</span>
<span class="n">voc_img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;JPEGImages&#39;</span><span class="p">)</span>
<span class="c1"># 将数据写入到tfrecord文件中</span>
<span class="n">write_to_tfrecord</span><span class="p">(</span><span class="n">all_xml</span><span class="p">,</span> <span class="n">tfrecord_path</span><span class="p">,</span> <span class="n">voc_img_path</span><span class="p">)</span>
</code></pre></div>
<p>结果如下所示：</p>
<p><img alt="image-20200923150511394" src="../assets/image-20200923150511394.png" /></p>
<h3 id="23-tfrecord">2.3 读取TFRecord文件<a class="headerlink" href="#23-tfrecord" title="Permanent link">&para;</a></h3>
<p>VOC数据集已经被写入到TFRecord文件中了，那我们就要从TFrecord文件中将数据读取出来。只使用 getdata就能够轻松的读取数据。</p>
<p>导入工具包：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 读取tfrecords文件所需的工具包</span>
<span class="kn">from</span> <span class="nn">dataset.get_tfdata</span> <span class="kn">import</span> <span class="n">getdata</span>
<span class="c1"># 绘图</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
</code></pre></div>
<p>接下来使用getdata就可以获取文件中的所有数据：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 指定tfrecord文件的位置，获取tfrecord文件中的数据</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="n">getdata</span><span class="p">(</span><span class="s2">&quot;dataset/voc_val.tfrecords&quot;</span><span class="p">)</span>
</code></pre></div>
<p>我们将从TFRecord文件中读取的数据展示出来：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
<span class="c1"># 数据类别</span>
<span class="kn">from</span> <span class="nn">utils.config_utils</span> <span class="kn">import</span> <span class="n">read_class_names</span>
<span class="n">classes</span> <span class="o">=</span> <span class="n">read_class_names</span><span class="p">(</span><span class="s2">&quot;config/classname&quot;</span><span class="p">)</span>
<span class="c1"># 将tfrecord中的图像进行展示</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="c1"># 初始化：第几个图像</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># 从datasets中选取3个样本，获取图像，大小，框的标注信息和类别信息</span>
<span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">boxes_category</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="c1"># 进行绘图</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># 绘制图像</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="c1"># 获取坐标区域</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="c1"># 遍历所有的框</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># 绘制框</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># 将框显示在图像上</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="c1"># 显示标注信息</span>
        <span class="c1"># 获取标注信息的id</span>
        <span class="n">label_id</span> <span class="o">=</span> <span class="n">boxes_category</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># 获取标准信息</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label_id</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="c1"># 将标注信息添加在图像上</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="c1"># 下一个结果</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c1"># 显示图像</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>结果为：</p>
<p><img alt="image-20210106151241266" src="../assets/image-20210106151241266.png" /></p>
<h3 id="24">2.4. 数据处理<a class="headerlink" href="#24" title="Permanent link">&para;</a></h3>
<p>yoloV3模型的输入图像的大小是32的倍数，所以我们需要对图像进行处理。在这里我们将图像的尺度调整为416x416的大小，为了保持长宽比，我将四周为0的像素以灰度值128进行填充，如下图所示：</p>
<p><img alt="image-20210106145050791" src="../assets/image-20210106145050791.png" /></p>
<p>实现该功能使用dataset.preprocess来完成，如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 输入：原图像及图像上的标准框</span>
<span class="c1"># 输出：将尺度调整后的图像，及相应的目标框</span>
<span class="n">image</span><span class="p">,</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">oriimage</span><span class="p">,</span><span class="n">oribbox</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">416</span><span class="p">,</span><span class="mi">416</span><span class="p">))</span>
</code></pre></div>
<p>我们对读取的数据进行处理并绘制结果：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1.导入工具包，</span>
<span class="kn">from</span> <span class="nn">dataset.preprocess</span> <span class="kn">import</span> <span class="n">preprocess</span> <span class="k">as</span> <span class="n">ppro</span>
<span class="c1"># 2.创建画布</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="c1"># 3.获取数据遍历</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">image</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">boxes</span><span class="p">,</span><span class="n">boxes_category</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="c1"># 4.进行数据处理</span>
    <span class="n">image</span><span class="p">,</span><span class="n">boxes</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">boxes</span><span class="p">)</span>
    <span class="c1"># 5.划分不同的坐标轴subplot()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># 6.显示图像：plt.imshow()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># 7.显示box,遍历所有的bbox,rectange进行绘制</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="c1"># 8.显示类别</span>
        <span class="n">label_id</span> <span class="o">=</span> <span class="n">boxes_category</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label_id</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<h2 id="3">3.模型构建<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<p>yoloV3的模型结构如下所示：整个v3结构里面，没有池化层和全连接层，网络的下采样是通过设置卷积的stride为2来达到的，每当通过这个卷积层之后图像的尺寸就会减小到一半。</p>
<p><img alt="image-20210106154747841" src="../assets/image-20210106154747841.png" /></p>
<p>在构建网络时，使用model.yoloV3来进行构建：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 导入工具包</span>
<span class="kn">from</span> <span class="nn">model.yoloV3</span> <span class="kn">import</span> <span class="n">YOLOv3</span>
<span class="c1"># 模型实例化：指定输入图像的大小，和类别数</span>
<span class="n">yolov3</span> <span class="o">=</span> <span class="n">YOLOv3</span><span class="p">((</span><span class="mi">416</span><span class="p">,</span><span class="mi">416</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="mi">80</span><span class="p">)</span>
<span class="c1"># 获取模型架构</span>
<span class="n">yolov3</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>
<p><img alt="image-20210106154444551" src="../assets/image-20210106154444551.png" /></p>
<p>那到这里模型就构建好了。</p>
<h2 id="4">4.模型训练<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1损失函数的计算<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<p>YoloV3的损失函数分为三部分：</p>
<ul>
<li>box的损失：</li>
</ul>
<p>只有负责检测的gridcell中的anchor才会计入损失,对x,y,w,h分别求均方误差</p>
<p><img alt="image-20200923173056196" src="../assets/image-20200923173056196.png" /></p>
<ul>
<li>置信度的损失</li>
</ul>
<p>置信度的损失是二分类的交叉熵损失函数，所有的box都计入损失计算</p>
<p><img alt="image-20200923172717434" src="../assets/image-20200923172717434.png" /></p>
<ul>
<li>分类的损失：</li>
</ul>
<p>分类的损失是二分类的交叉熵损失，只有负责检测目标的才计算损失</p>
<p><img alt="image-20200923172749873" src="../assets/image-20200923172749873.png" /></p>
<p>在计算损失函数时使用core.loss来完成：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 导入所需的工具包</span>
<span class="kn">from</span> <span class="nn">core.loss</span> <span class="kn">import</span> <span class="n">Loss</span>
<span class="c1"># 实例化</span>
<span class="n">yolov3_loss</span> <span class="o">=</span> <span class="n">Loss</span><span class="p">((</span><span class="mi">416</span><span class="p">,</span><span class="mi">416</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="mi">80</span><span class="p">)</span>
</code></pre></div>
<p>我们来看下损失的输入输出：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 损失输入</span>
<span class="n">yolov3_loss</span><span class="o">.</span><span class="n">inputs</span>
</code></pre></div>
<p><img alt="image-20210106160029787" src="../assets/image-20210106160029787.png" /></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 损失输出</span>
<span class="n">yolov3_loss</span><span class="o">.</span><span class="n">outputs</span>
</code></pre></div>
<p><img alt="image-20210106160114501" src="../assets/image-20210106160114501.png" /></p>
<p>输出的结果就是网络的损失值，是一个标量，使用它就可以来完成网络的训练。</p>
<h3 id="42">4.2 正负样本的设定<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<p>在上述的loss计算中，负责进行目标预测的anchor就是正样本，而不负责进行目标预测的就是负样本，也就是背景，那在这里我们是如何设置正负样本的呢？如下图所示：</p>
<p><img alt="image-20200924115029615" src="../assets/image-20200924115029615.png" /></p>
<ul>
<li><strong>正样本</strong>：首先计算目标中心点落在哪个grid上，然后计算这个grid对应的3个先验框（anchor）和目标真实位置的IOU值，取IOU值最大的先验框和目标匹配。那么该anchor 就负责预测这个目标，那这个anchor就作为正样本，将其置信度设为1，其他的目标值根据标注信息设置。</li>
<li><strong>负样本</strong>：所有不是正样本的anchor都是负样本，将其置信度设为0，参与损失计算，其它的值不参与损失计算，默认为0。</li>
</ul>
<p>对于每一个anchor我们都要4+1+80维的目标值，其中前4维是坐标值，正样本是GT的bbox框的值，第5维是置信度，正样本设置为1，负样本设置为0，最后的80是类别数，正样本对应的类别设置为1，其余为0，若使用voc数据集类别数是20 。</p>
<p><img alt="image-20210107114405658" src="../assets/image-20210107114405658.png" /></p>
<p>可以通过bbox_to_target来完成样本的设置，获取图像及其标注信息，获取目标值，如下：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 导入目标值设置所需方法</span>
<span class="kn">from</span> <span class="nn">core.bbox_target</span> <span class="kn">import</span> <span class="n">bbox_to_target</span>
<span class="c1"># 获取图像及其标注信息</span>
<span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># 获取anchor的目标值，label1是13*13的目标值，label2是26*26的目标值，label3是52*52的目标值，</span>
    <span class="n">label1</span><span class="p">,</span><span class="n">label2</span><span class="p">,</span><span class="n">label3</span> <span class="o">=</span> <span class="n">bbox_to_target</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="n">boxes</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div>
<p><img alt="image-20210106172406512" src="../assets/image-20210106172406512.png" /></p>
<p>正样本的anchor的置信度为1，所以我们通过置信度为1来获取正样本：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 导入工具包</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="c1"># label1[...,0:4]坐标值，label1[...,4]置信度，label1[...,5:]类别分数</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">label1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># index.numpy(),说明索引为12 12 0 个像素中Anchor是正样本</span>
<span class="n">array</span><span class="p">([[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">0</span><span class="p">]])</span>
</code></pre></div>
<p>它对应的坐标值是：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># label1[12, 12,0,0:4].numpy()</span>
<span class="n">array</span><span class="p">([</span><span class="mf">209.</span><span class="p">,</span> <span class="mf">318.</span><span class="p">,</span>  <span class="mf">88.</span><span class="p">,</span> <span class="mf">108.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</code></pre></div>
<p>分类的目标值是：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># label1[12,12,0,5:].numpy()</span>
<span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span>
       <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
</code></pre></div>
<p>我们将目标值绘制在图像上：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
<span class="c1"># 1.获取类别信息</span>
<span class="kn">from</span> <span class="nn">utils.config_utils</span> <span class="kn">import</span> <span class="n">read_class_names</span>
<span class="n">classes</span> <span class="o">=</span> <span class="n">read_class_names</span><span class="p">(</span><span class="s1">&#39;config/classname&#39;</span><span class="p">)</span>
<span class="c1"># 2.创建画布</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="c1"># 3.获取数据遍历</span>
<span class="k">for</span> <span class="n">image</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">boxes</span><span class="p">,</span><span class="n">boxes_category</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># 4.显示图像：plt.imshow()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="c1"># 5.显示box,遍历所有的bbox,rectange进行绘制</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="c1"># 6.显示类别</span>
        <span class="n">label_id</span> <span class="o">=</span> <span class="n">boxes_category</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label_id</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="c1"># 7.绘制正样本的anchor的目标值</span>
    <span class="n">anchor</span> <span class="o">=</span> <span class="n">label1</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">rect2</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">anchor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">anchor</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">anchor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">anchor</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">anchor</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">anchor</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="image-20210106172231076" src="../assets/image-20210106172231076.png" /></p>
<h3 id="43">4.3 模型训练<a class="headerlink" href="#43" title="Permanent link">&para;</a></h3>
<p>前面我们已经详细介绍了网络模型架构，在网络预测前我们需要对网络进行训练，接下来使用端到端的方式进行模型训练，基本步骤是：</p>
<p>1、加载数据集：我们在这里使用VOC数据集，所以需要从TFrecord文件中加载VOC数据集</p>
<p>2、模型实例化：加载yoloV3模型和损失函数的实现</p>
<p>3、模型训练：计算损失函数，使用反向传播算法对模型进行训练</p>
<h4 id="431">4.3.1 获取数据集<a class="headerlink" href="#431" title="Permanent link">&para;</a></h4>
<p>我们从tfrecords文件中获取训练集数据:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 导入</span>
<span class="kn">from</span> <span class="nn">dataset.preprocess</span> <span class="kn">import</span> <span class="n">dataset</span>
<span class="c1"># 设置batch_size</span>
<span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span>
<span class="c1"># 获取训练集数据，并指定batchsize,返回训练集数据</span>
<span class="n">trainset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">(</span><span class="s2">&quot;dataset/voc_train.tfrecords&quot;</span><span class="p">,</span><span class="n">batch_size</span><span class="p">)</span>
</code></pre></div>
<h4 id="432">4.3.2 加载模型<a class="headerlink" href="#432" title="Permanent link">&para;</a></h4>
<p>将在yoloV3模型和损失函数的计算进行实例化：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># V3模型的实例化，指定输入图像的大小，即目标检测的类别个数</span>
<span class="n">yolov3</span> <span class="o">=</span> <span class="n">YOLOv3</span><span class="p">((</span><span class="mi">416</span><span class="p">,</span> <span class="mi">416</span><span class="p">,</span> <span class="mi">3</span><span class="p">,),</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">yolov3_loss</span> <span class="o">=</span> <span class="n">Loss</span><span class="p">((</span><span class="mi">416</span><span class="p">,</span><span class="mi">416</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>
</code></pre></div>
<h4 id="433">4.3.3 模型训练<a class="headerlink" href="#433" title="Permanent link">&para;</a></h4>
<p>模型训练也就是要使用损失函数，进行反向传播，利用优化器进行参数更新，训练的流程是：</p>
<p>1、指定优化器：在这里我们使用加动量的SGD方法</p>
<p>2、设置epoch，进行遍历获取batch数据送入网络中进行预测</p>
<p>3、计算损失函数，使用反向传播更新参数，我们使用tf.GradientTape实现：</p>
<ul>
<li>定义上下文环境：tf.GradientTape</li>
<li>计算损失函数loss</li>
<li>使用 <code>tape.gradient(loss,model.trainable_variables)</code> 自动计算梯度，loss是损失结果，trainable_variables为所有需要训练的变量。</li>
<li>使用 <code>optimizer.apply_gradients(zip(grads,model.trainable_variables))</code> 自动更新模型参数，zip(grads, trainable_variables)将梯度和参数关联起来，然后apply_gradients会自动的利用梯度对参数进行更新。</li>
</ul>
<p>接下来我们按照这个流程完成模型训练，并保存模型训练结果。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1、定义优化方法</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.9</span><span class="p">)</span>
<span class="c1"># 2.设置epoch，获取batch数据送入网络中进行预测</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">300</span><span class="p">):</span>
    <span class="n">loss_history</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># 遍历每一个batch的图像和目标值，进行更新</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trainset</span><span class="p">):</span>
        <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="c1"># 3.计算损失函数，使用反向传播更新参数</span>
        <span class="c1"># 3.1 定义上下文环境</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
            <span class="c1"># 3.2 将图像送入网络中</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">yolov3</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
            <span class="c1"># 3.3 计算损失函数</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">yolov3_loss</span><span class="p">([</span><span class="o">*</span><span class="n">outputs</span><span class="p">,</span> <span class="o">*</span><span class="n">labels</span><span class="p">])</span>
            <span class="c1"># 3.4 计算梯度</span>
            <span class="n">grads</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">yolov3</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">)</span>
            <span class="c1"># 3.5 梯度更新</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">yolov3</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">))</span>
            <span class="c1"># 3.6 打印信息</span>
            <span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;epoch: </span><span class="si">%d</span><span class="s1">, batch: </span><span class="si">%d</span><span class="s1"> ,loss: </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_history</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="n">loss_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="n">yolov3</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;yolov3.h5&#39;</span><span class="p">)</span>
</code></pre></div>
<p>损失函数的变化为：</p>
<div class="highlight"><pre><span></span><code>epoch: 0, batch: 0 ,loss: 701318.312500
epoch: 0, batch: 1 ,loss: 765384.625000
epoch: 0, batch: 2 ,loss: 747363.000000
epoch: 0, batch: 3 ,loss: 708547.187500
epoch: 0, batch: 4 ,loss: 699261.500000
epoch: 0, batch: 5 ,loss: 727906.812500
epoch: 0, batch: 6 ,loss: 696439.875000
epoch: 0, batch: 7 ,loss: 669801.500000
epoch: 0, batch: 8 ,loss: 669526.875000
</code></pre></div>
<p>当我们训练好模型后，就可以使用训练好的模型进行预测了。</p>
<h2 id="5">5.模型预测<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<p>我们使用训练好的模型进行预测,在这里我们通过yoloV3模型进行预测，并将预测结果绘制在图像上。首先导入工具包，预训练好的模型是使用coco数据集进行训练的，所以指定相应的类别信息：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 读取图像，绘图的工具包</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
<span class="c1"># yoloV3的预测器</span>
<span class="kn">from</span> <span class="nn">core.predicter</span> <span class="kn">import</span> <span class="n">Predictor</span>

<span class="c1"># coco数据集中的类别信息</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="s1">&#39;bicycle&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">,</span> <span class="s1">&#39;motorcycle&#39;</span><span class="p">,</span> <span class="s1">&#39;airplane&#39;</span><span class="p">,</span> <span class="s1">&#39;bus&#39;</span><span class="p">,</span> 
           <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;truck&#39;</span><span class="p">,</span> <span class="s1">&#39;boat&#39;</span><span class="p">,</span> <span class="s1">&#39;traffic light&#39;</span><span class="p">,</span> <span class="s1">&#39;fire hydrant&#39;</span><span class="p">,</span> 
           <span class="s1">&#39;stop sign&#39;</span><span class="p">,</span> <span class="s1">&#39;parking meter&#39;</span><span class="p">,</span> <span class="s1">&#39;bench&#39;</span><span class="p">,</span> <span class="s1">&#39;bird&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">,</span>
           <span class="s1">&#39;horse&#39;</span><span class="p">,</span> <span class="s1">&#39;sheep&#39;</span><span class="p">,</span> <span class="s1">&#39;cow&#39;</span><span class="p">,</span> <span class="s1">&#39;elephant&#39;</span><span class="p">,</span> <span class="s1">&#39;bear&#39;</span><span class="p">,</span> <span class="s1">&#39;zebra&#39;</span><span class="p">,</span> <span class="s1">&#39;giraffe&#39;</span><span class="p">,</span>
           <span class="s1">&#39;backpack&#39;</span><span class="p">,</span> <span class="s1">&#39;umbrella&#39;</span><span class="p">,</span> <span class="s1">&#39;handbag&#39;</span><span class="p">,</span> <span class="s1">&#39;tie&#39;</span><span class="p">,</span> <span class="s1">&#39;suitcase&#39;</span><span class="p">,</span> <span class="s1">&#39;frisbee&#39;</span><span class="p">,</span> 
           <span class="s1">&#39;skis&#39;</span><span class="p">,</span> <span class="s1">&#39;snowboard&#39;</span><span class="p">,</span> <span class="s1">&#39;sports ball&#39;</span><span class="p">,</span> <span class="s1">&#39;kite&#39;</span><span class="p">,</span> <span class="s1">&#39;baseball bat&#39;</span><span class="p">,</span> <span class="s1">&#39;baseball glove&#39;</span><span class="p">,</span> 
           <span class="s1">&#39;skateboard&#39;</span><span class="p">,</span> <span class="s1">&#39;surfboard&#39;</span><span class="p">,</span><span class="s1">&#39;tennis racket&#39;</span><span class="p">,</span> <span class="s1">&#39;bottle&#39;</span><span class="p">,</span> <span class="s1">&#39;wine glass&#39;</span><span class="p">,</span> <span class="s1">&#39;cup&#39;</span><span class="p">,</span> <span class="s1">&#39;fork&#39;</span><span class="p">,</span> 
           <span class="s1">&#39;knife&#39;</span><span class="p">,</span> <span class="s1">&#39;spoon&#39;</span><span class="p">,</span> <span class="s1">&#39;bowl&#39;</span><span class="p">,</span> <span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;sandwich&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;broccoli&#39;</span><span class="p">,</span> 
           <span class="s1">&#39;carrot&#39;</span><span class="p">,</span> <span class="s1">&#39;hot dog&#39;</span><span class="p">,</span> <span class="s1">&#39;pizza&#39;</span><span class="p">,</span> <span class="s1">&#39;donut&#39;</span><span class="p">,</span> <span class="s1">&#39;cake&#39;</span><span class="p">,</span> <span class="s1">&#39;chair&#39;</span><span class="p">,</span> <span class="s1">&#39;couch&#39;</span><span class="p">,</span> <span class="s1">&#39;potted plant&#39;</span><span class="p">,</span> 
           <span class="s1">&#39;bed&#39;</span><span class="p">,</span> <span class="s1">&#39;dining table&#39;</span><span class="p">,</span> <span class="s1">&#39;toilet&#39;</span><span class="p">,</span> <span class="s1">&#39;tv&#39;</span><span class="p">,</span> <span class="s1">&#39;laptop&#39;</span><span class="p">,</span> <span class="s1">&#39;mouse&#39;</span><span class="p">,</span> <span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="s1">&#39;keyboard&#39;</span><span class="p">,</span> 
           <span class="s1">&#39;cell phone&#39;</span><span class="p">,</span> <span class="s1">&#39;microwave&#39;</span><span class="p">,</span> <span class="s1">&#39;oven&#39;</span><span class="p">,</span> <span class="s1">&#39;toaster&#39;</span><span class="p">,</span> <span class="s1">&#39;sink&#39;</span><span class="p">,</span> <span class="s1">&#39;refrigerator&#39;</span><span class="p">,</span> <span class="s1">&#39;book&#39;</span><span class="p">,</span> 
           <span class="s1">&#39;clock&#39;</span><span class="p">,</span> <span class="s1">&#39;vase&#39;</span><span class="p">,</span> <span class="s1">&#39;scissors&#39;</span><span class="p">,</span> <span class="s1">&#39;teddy bear&#39;</span><span class="p">,</span> <span class="s1">&#39;hair drier&#39;</span><span class="p">,</span> <span class="s1">&#39;toothbrush&#39;</span><span class="p">]</span>
</code></pre></div>
<p>整个流程是：</p>
<p>1.读取要进行目标检测的图像</p>
<p>2.实例化yoloV3的预测器，并加载预训练模型。</p>
<p>3.利用预测器对图片进行目标检测</p>
<p>4.将检测结果绘制在图像上</p>
<p>实现如下：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 图像读取</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;image.jpg&quot;</span><span class="p">)</span>
<span class="c1"># 2.实例化，并加载预训练模型</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">Predictor</span><span class="p">(</span><span class="n">class_num</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">yolov3</span><span class="o">=</span><span class="s2">&quot;weights/yolov3.h5&quot;</span><span class="p">)</span>
<span class="c1"># 3.获取检测结果</span>
<span class="n">boundings</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="c1"># 4.将检测结果绘制在图像上</span>
<span class="c1"># 4.1 显示图像</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># 获取坐标区域</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="c1"># 4.2 遍历检测框，将检测框绘制在图像上</span>
<span class="k">for</span> <span class="n">bounding</span> <span class="ow">in</span> <span class="n">boundings</span><span class="p">:</span>
    <span class="c1"># 绘制框</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">((</span><span class="n">bounding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bounding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()),</span> <span class="n">bounding</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(</span>
    <span class="p">)</span> <span class="o">-</span> <span class="n">bounding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bounding</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">-</span><span class="n">bounding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># 将框显示在图像上</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
    <span class="c1"># 显示类别信息</span>
    <span class="c1"># 获取类别信息的id</span>
    <span class="n">label_id</span> <span class="o">=</span> <span class="n">bounding</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="c1"># 获取类别</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">classes</span><span class="p">[</span><span class="n">label_id</span><span class="p">]</span>
    <span class="c1"># 将标注信息添加在图像上</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bounding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bounding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span>
            <span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">backgroundcolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="c1"># 显示图像</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>预测结果如下图所示：</p>
<p><img alt="image-20200923165753557" src="../assets/image-20200923165753557.png" /></p>
<hr />
<p><strong>总结</strong></p>
<ul>
<li>熟悉TFRecord文件的使用方法</li>
</ul>
<p>TFRecord是Google官方推荐使用的数据格式化存储工具，为TensorFlow量身打造的。TFRecord内部包含多个tf.train.Example，一般来说对应一个图像数据，在一个Example消息体中包含了一系列的tf.train.feature属性，而 每一个feature是一个key-value的键值对。</p>
<ul>
<li>知道YoloV3模型结构及构建方法</li>
</ul>
<p>基本组件的构建，backbone，output, yoloV3, 输出值的转换</p>
<ul>
<li>知道数据处理方法</li>
</ul>
<p>知道对图像进行resize,保持宽高比，进行pad的方法</p>
<ul>
<li>能够利用yoloV3模型进行训练和预测</li>
</ul>
<p>知道损失函数，正负样本设置，进行训练，并预测的过程。</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../04.yolo/index.html" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              YOLO系列算法
            </div>
          </div>
        </a>
      
      
        <a href="../../imageSegmentation/section1/index.html" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              目标分割介绍
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.d351de03.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.a1609d9a.min.js"></script>
      
        <script src="../../js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>