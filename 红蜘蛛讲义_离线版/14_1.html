
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="img/logo.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.11">
    
    
      
        <title>14.1 CR-CNN关系抽取模型详解 - 红蜘蛛知识图谱项目 V3.0</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.50e68009.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cr-cnn" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="." title="红蜘蛛知识图谱项目 V3.0" class="md-header__button md-logo" aria-label="红蜘蛛知识图谱项目 V3.0" data-md-component="logo">
      
  <img src="img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            红蜘蛛知识图谱项目 V3.0
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              14.1 CR-CNN关系抽取模型详解
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
    <img src="assets/images/logo.svg" height="45px" alt="logo">

  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="红蜘蛛知识图谱项目 V3.0" class="md-nav__button md-logo" aria-label="红蜘蛛知识图谱项目 V3.0" data-md-component="logo">
      
  <img src="img/logo.png" alt="logo">

    </a>
    红蜘蛛知识图谱项目 V3.0
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          第一章:项目背景
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第一章:项目背景" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          第一章:项目背景
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="1_1.html" class="md-nav__link">
        1.1 红蜘蛛项目背景
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="1_2.html" class="md-nav__link">
        1.2 知识图谱概述
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          第二章:知识查询
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第二章:知识查询" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          第二章:知识查询
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="2_1.html" class="md-nav__link">
        2.1 知识查询方法介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="2_2.html" class="md-nav__link">
        2.2 知识图谱的数值表示
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          第三章:实体抽取
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第三章:实体抽取" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          第三章:实体抽取
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="3_1.html" class="md-nav__link">
        3.1 快速部署的IDCNN模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="3_2.html" class="md-nav__link">
        3.2 FLAT模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="3_3.html" class="md-nav__link">
        3.3 实体消歧与实体对齐
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="3_4.html" class="md-nav__link">
        3.4 基于规则派的NER
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          第四章:关系抽取
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第四章:关系抽取" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          第四章:关系抽取
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="4_1.html" class="md-nav__link">
        4.1 multi-head-selection模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="4_2.html" class="md-nav__link">
        4.2 Casrel模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="4_3.html" class="md-nav__link">
        4.3 基于规则派的RE
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          第五章:事件抽取
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第五章:事件抽取" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          第五章:事件抽取
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="5_1.html" class="md-nav__link">
        5.1 中文场景下的事件抽取
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          第六章:知识构建
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第六章:知识构建" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          第六章:知识构建
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="6_1.html" class="md-nav__link">
        6.1 概念图谱的构建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="6_2.html" class="md-nav__link">
        6.2 百科图谱的构建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="6_3.html" class="md-nav__link">
        6.3 知识图谱的众包
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          第七章:知识存储
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第七章:知识存储" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          第七章:知识存储
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="7_1.html" class="md-nav__link">
        7.1 知识图谱建模与存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="7_2.html" class="md-nav__link">
        7.2 neo4j技术解析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          第八章:知识补全
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第八章:知识补全" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          第八章:知识补全
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="8_1.html" class="md-nav__link">
        8.1 经典知识补全
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="8_2.html" class="md-nav__link">
        8.2 知识图谱质量控制
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          第九章:知识推理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第九章:知识推理" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          第九章:知识推理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="9_1.html" class="md-nav__link">
        9.1 常用推理方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="9_2.html" class="md-nav__link">
        9.2 常用推理引擎
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="9_3.html" class="md-nav__link">
        9.3 知识推理展望
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          第十章:红蜘蛛上线
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十章:红蜘蛛上线" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          第十章:红蜘蛛上线
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="10_1.html" class="md-nav__link">
        10.1 总体设计方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="10_2.html" class="md-nav__link">
        10.2 搭建红蜘蛛机器人
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="10_3.html" class="md-nav__link">
        10.3 上线部署与联调测试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" type="checkbox" id="__nav_11" >
      
      
      
      
        <label class="md-nav__link" for="__nav_11">
          第十一章:扩展章节之一
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十一章:扩展章节之一" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          第十一章:扩展章节之一
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="11_1.html" class="md-nav__link">
        11.1 TENER模型
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12" type="checkbox" id="__nav_12" >
      
      
      
      
        <label class="md-nav__link" for="__nav_12">
          第十二章:扩展章节之二
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十二章:扩展章节之二" data-md-level="1">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          第十二章:扩展章节之二
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="12_1.html" class="md-nav__link">
        12.1 Soft-lexicon模型
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13" type="checkbox" id="__nav_13" >
      
      
      
      
        <label class="md-nav__link" for="__nav_13">
          第十三章:扩展章节之三
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十三章:扩展章节之三" data-md-level="1">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          第十三章:扩展章节之三
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="13_1.html" class="md-nav__link">
        13.1 基于CNN的关系抽取模型
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14" type="checkbox" id="__nav_14" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_14">
          第十四章:扩展章节之四
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十四章:扩展章节之四" data-md-level="1">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          第十四章:扩展章节之四
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          14.1 CR-CNN关系抽取模型详解
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="14_1.html" class="md-nav__link md-nav__link--active">
        14.1 CR-CNN关系抽取模型详解
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cr-cnn" class="md-nav__link">
    CR-CNN关系抽取模型
  </a>
  
    <nav class="md-nav" aria-label="CR-CNN关系抽取模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    学习目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr-cnn_1" class="md-nav__link">
    CR-CNN关系抽取模型实现
  </a>
  
    <nav class="md-nav" aria-label="CR-CNN关系抽取模型实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    第1步: 工具类函数的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    第2步: 模型类的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    第3步: 评估函数的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    第4步: 训练代码的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    第5步: 模型的训练
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    小节总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_15" type="checkbox" id="__nav_15" >
      
      
      
      
        <label class="md-nav__link" for="__nav_15">
          第十五章:扩展章节之五
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十五章:扩展章节之五" data-md-level="1">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          第十五章:扩展章节之五
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="15_1.html" class="md-nav__link">
        15.1 中文NER的SOTA
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cr-cnn" class="md-nav__link">
    CR-CNN关系抽取模型
  </a>
  
    <nav class="md-nav" aria-label="CR-CNN关系抽取模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    学习目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cr-cnn_1" class="md-nav__link">
    CR-CNN关系抽取模型实现
  </a>
  
    <nav class="md-nav" aria-label="CR-CNN关系抽取模型实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    第1步: 工具类函数的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    第2步: 模型类的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    第3步: 评估函数的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    第4步: 训练代码的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    第5步: 模型的训练
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    小节总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

  <h1>14.1 CR-CNN关系抽取模型详解</h1>

<h2 id="cr-cnn">CR-CNN关系抽取模型<a class="headerlink" href="#cr-cnn" title="Permanent link">&para;</a></h2>
<hr />
<h3 id="_1">学习目标<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<ul>
<li>掌握CR-CNN关系抽取模型的代码实现.</li>
</ul>
<hr />
<h3 id="cr-cnn_1">CR-CNN关系抽取模型实现<a class="headerlink" href="#cr-cnn_1" title="Permanent link">&para;</a></h3>
<ul>
<li>CR-CNN模型的总体构建流程有如下几个步骤:<ul>
<li>第1步: 工具类函数的实现</li>
<li>第2步: 模型类的实现</li>
<li>第3步: 评估函数的实现</li>
<li>第4步: 训练代码的实现</li>
<li>第5步: 模型的训练</li>
</ul>
</li>
</ul>
<hr />
<h4 id="1">第1步: 工具类函数的实现<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<ul>
<li>代码文件路径: /home/ec2-user/code/relation/relation-classify/utils.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">now</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">save_pr</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">fp_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">opt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_PR.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_PR.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fp_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fp_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_FP.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fp_res</span><span class="p">:</span>
            <span class="n">fp_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
        <span class="n">fp_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">rec</span><span class="p">):</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>

    <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">eval_metric</span><span class="p">(</span><span class="n">true_y</span><span class="p">,</span> <span class="n">pred_y</span><span class="p">,</span> <span class="n">pred_p</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    calculate the precision and recall for p-r curve</span>
<span class="sd">    reglect the NA relation</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_y</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_y</span><span class="p">)</span>
    <span class="n">positive_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">true_y</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pred_p</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">tp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">all_pre</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">all_rec</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fp_res</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">true_y</span><span class="p">)):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">true_y</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">pred_y</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># NA relation</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fp_res</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span> <span class="n">pred_p</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">]]))</span>
                <span class="n">fp</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                        <span class="n">tp</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">break</span>

        <span class="k">if</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">tp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span>
        <span class="n">recall</span> <span class="o">=</span> <span class="n">tp</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">positive_num</span>
        <span class="k">if</span> <span class="n">precision</span> <span class="o">!=</span> <span class="n">all_pre</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">recall</span> <span class="o">!=</span> <span class="n">all_rec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">all_pre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
            <span class="n">all_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tp=</span><span class="si">{}</span><span class="s2">; fp=</span><span class="si">{}</span><span class="s2">; fn=</span><span class="si">{}</span><span class="s2">; positive_num=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">positive_num</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">all_pre</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">all_rec</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">fp_res</span>
</code></pre></div>
<hr />
<h4 id="2">第2步: 模型类的实现<a class="headerlink" href="#2" title="Permanent link">&para;</a></h4>
<ul>
<li>代码文件路径: /home/ec2-user/code/relation/relation-classify/models/crcnn.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">init</span>


<span class="k">class</span> <span class="nc">CRCNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_vec</span><span class="p">,</span> <span class="n">class_num</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_vec</span> <span class="o">=</span> <span class="n">word_vec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_num</span> <span class="o">=</span> <span class="n">class_num</span>

        <span class="c1"># hyper parameters and others</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_dim</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">word_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pos_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pos_dis</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">filter_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">window</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_dim</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span>

        <span class="c1"># net structures and operations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="n">embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">word_vec</span><span class="p">,</span>
            <span class="n">freeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos1_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">num_embeddings</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos2_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">num_embeddings</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">out_channels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span>
            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># same padding</span>
            <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
            <span class="n">in_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span><span class="p">,</span>
            <span class="n">out_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_num</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># initialize weight</span>
        <span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos1_embedding</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos2_embedding</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="c1"># init.constant_(self.dense.bias, 0.)</span>

    <span class="k">def</span> <span class="nf">encoder_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">):</span>
        <span class="n">word_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_embedding</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>  <span class="c1"># B*L*word_dim</span>
        <span class="n">pos1_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos1_embedding</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span>  <span class="c1"># B*L*pos_dim</span>
        <span class="n">pos2_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos2_embedding</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span>  <span class="c1"># B*L*pos_dim</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">tensors</span><span class="o">=</span><span class="p">[</span><span class="n">word_emb</span><span class="p">,</span> <span class="n">pos1_emb</span><span class="p">,</span> <span class="n">pos2_emb</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">emb</span>  <span class="c1"># B*L*D, D=word_dim+2*pos_dim</span>

    <span class="k">def</span> <span class="nf">conv_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emb</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="n">emb</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># B*1*L*D</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">emb</span><span class="p">)</span>  <span class="c1"># B*C*L*1</span>

        <span class="c1"># mask, remove the effect of &#39;PAD&#39;</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>  <span class="c1"># B*C*L</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># B*1*L</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># B*C*L</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">))</span>  <span class="c1"># B*C*L</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># B*C*L*1</span>
        <span class="k">return</span> <span class="n">conv</span>

    <span class="k">def</span> <span class="nf">single_maxpool_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>  <span class="c1"># B*C*1*1</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span><span class="p">)</span>  <span class="c1"># B*C</span>
        <span class="k">return</span> <span class="n">pool</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="n">pos1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="n">pos2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layer</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">)</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">emb</span><span class="p">)</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_layer</span><span class="p">(</span><span class="n">emb</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_maxpool_layer</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scores</span>

<span class="k">class</span> <span class="nc">PairwiseRankingLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin_positive</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">margin_positive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin_negative</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">margin_negative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">gamma</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">positive_scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">negative_scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">positive_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margin_positive</span><span class="o">-</span><span class="n">positive_scores</span><span class="p">)))</span>
        <span class="n">positive_loss</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># exclusive `Other` loss</span>
        <span class="n">negative_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margin_negative</span><span class="o">+</span><span class="n">negative_scores</span><span class="p">)))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">positive_loss</span> <span class="o">+</span> <span class="n">negative_loss</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>
<hr />
<h4 id="3">第3步: 评估函数的实现<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<ul>
<li>代码文件路径: /home/ec2-user/code/relation/relation-classify/evaluate.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>


<span class="k">def</span> <span class="nf">semeval_scorer</span><span class="p">(</span><span class="n">predict_label</span><span class="p">,</span> <span class="n">true_label</span><span class="p">,</span> <span class="n">class_num</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="k">assert</span> <span class="n">true_label</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">predict_label</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">class_num</span><span class="p">,</span> <span class="n">class_num</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">xDIRx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">class_num</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">true_label</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">true_idx</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">true_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">predict_idx</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">predict_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">true_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">predict_label</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">confusion_matrix</span><span class="p">[</span><span class="n">predict_idx</span><span class="p">][</span><span class="n">true_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">true_idx</span> <span class="o">==</span> <span class="n">predict_idx</span><span class="p">:</span>
                <span class="n">xDIRx</span><span class="p">[</span><span class="n">predict_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">confusion_matrix</span><span class="p">[</span><span class="n">predict_idx</span><span class="p">][</span><span class="n">true_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">col_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">row_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">class_num</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">class_num</span><span class="p">):</span>  <span class="c1"># ignore the &#39;Other&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">col_sum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">xDIRx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">row_sum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">xDIRx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">f1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">p</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">r</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">actual_class</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_f1</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">class_num</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>  <span class="c1"># classes that not in the predict label are not considered</span>
            <span class="n">actual_class</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">total_f1</span> <span class="o">+=</span> <span class="n">f1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">macro_f1</span> <span class="o">=</span> <span class="n">total_f1</span> <span class="o">/</span> <span class="n">actual_class</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">macro_f1</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">macro_f1</span>


<span class="k">class</span> <span class="nc">Eval</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">device</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">):</span>
        <span class="n">predict_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">true_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
                <span class="n">sent_feat</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">lex_feat</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">sent_feat</span><span class="p">,</span> <span class="n">lex_feat</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

                <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">scores</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">scores</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="c1"># During prediction time, a relation is classified as Other</span>
                <span class="c1"># only if all actual classes have negative scores.</span>
                <span class="c1"># Otherwise, it is classified with the class which has the largest score.</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">predict_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
                <span class="n">true_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">predict_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">predict_label</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">true_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">true_label</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">eval_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="n">predict_label</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">f1</span> <span class="o">=</span> <span class="n">semeval_scorer</span><span class="p">(</span><span class="n">predict_label</span><span class="p">,</span> <span class="n">true_label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f1</span><span class="p">,</span> <span class="n">eval_loss</span><span class="p">,</span> <span class="n">predict_label</span>
</code></pre></div>
<hr />
<h4 id="4">第4步: 训练代码的实现<a class="headerlink" href="#4" title="Permanent link">&para;</a></h4>
<ul>
<li>代码文件路径: /home/ec2-user/code/relation/relation-classify/cr_cnn_train.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">config_cr_cnn</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">dataset.dataset</span> <span class="kn">import</span> <span class="n">WordEmbeddingLoader</span><span class="p">,</span> <span class="n">RelationLoader</span><span class="p">,</span> <span class="n">SemEvalDataLoader</span><span class="p">,</span><span class="n">VocabGenerator</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">evaluate</span> <span class="kn">import</span> <span class="n">Eval</span>


<span class="k">def</span> <span class="nf">print_result</span><span class="p">(</span><span class="n">predict_label</span><span class="p">,</span> <span class="n">id2rel</span><span class="p">,</span> <span class="n">start_idx</span><span class="o">=</span><span class="mi">8001</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;script/predicted_result.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">predict_label</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">id2rel</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">predict_label</span><span class="p">[</span><span class="n">i</span><span class="p">])]))</span>


<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">train_loader</span><span class="p">,</span> <span class="n">dev_loader</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">loader</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">L2_decay</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;traning model parameters:&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start to train the model ...&#39;</span><span class="p">)</span>

    <span class="n">eval_tool</span> <span class="o">=</span> <span class="n">Eval</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">min_f1</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)):</span>

            <span class="n">sent_feat</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">lex_feat</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">sent_feat</span><span class="p">,</span> <span class="n">lex_feat</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">eval_tool</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">)</span>
        <span class="n">f1</span><span class="p">,</span> <span class="n">dev_loss</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">eval_tool</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">dev_loader</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%03d</span><span class="s1">] train_loss: </span><span class="si">%.3f</span><span class="s1"> | dev_loss: </span><span class="si">%.3f</span><span class="s1"> | micro f1 on dev: </span><span class="si">%.4f</span><span class="s1">&#39;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="n">dev_loss</span><span class="p">,</span> <span class="n">f1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f1</span> <span class="o">&gt;</span> <span class="n">min_f1</span><span class="p">:</span>
            <span class="n">min_f1</span> <span class="o">=</span> <span class="n">f1</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;model.pt&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; save models!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start test ...&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">loader</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;model.pt&#39;</span><span class="p">)))</span>
    <span class="n">eval_tool</span> <span class="o">=</span> <span class="n">Eval</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">f1</span><span class="p">,</span> <span class="n">test_loss</span><span class="p">,</span> <span class="n">predict_label</span> <span class="o">=</span> <span class="n">eval_tool</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;test_loss: </span><span class="si">%.3f</span><span class="s1"> | micro f1 on test:  </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_loss</span><span class="p">,</span> <span class="n">f1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">predict_label</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some config:&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">print_config</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start to load data ...&#39;</span><span class="p">)</span>
    <span class="n">vocab</span><span class="o">=</span><span class="n">VocabGenerator</span><span class="p">(</span><span class="s1">&#39;data/train.json&#39;</span><span class="p">,</span><span class="s1">&#39;data/test.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_vocab</span><span class="p">()</span>
    <span class="n">word2id</span><span class="p">,</span> <span class="n">word_vec</span> <span class="o">=</span> <span class="n">WordEmbeddingLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">trim_from_pre_embedding</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
    <span class="n">rel2id</span><span class="p">,</span> <span class="n">id2rel</span><span class="p">,</span> <span class="n">class_num</span> <span class="o">=</span> <span class="n">RelationLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">get_relation</span><span class="p">()</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">SemEvalDataLoader</span><span class="p">(</span><span class="n">rel2id</span><span class="p">,</span> <span class="n">word2id</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="n">train_loader</span><span class="p">,</span> <span class="n">dev_loader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># train mode</span>
        <span class="n">train_loader</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_train</span><span class="p">()</span>
        <span class="n">dev_loader</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_dev</span><span class="p">()</span>
    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_test</span><span class="p">()</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">dev_loader</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finish!&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">CRCNN</span><span class="p">(</span><span class="n">word_vec</span><span class="o">=</span><span class="n">word_vec</span><span class="p">,</span> <span class="n">class_num</span><span class="o">=</span><span class="n">class_num</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="c1">#criterion = nn.CrossEntropyLoss()</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">PairwiseRankingLoss</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># train mode</span>
        <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="n">predict_label</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="n">predict_label</span><span class="p">,</span> <span class="n">id2rel</span><span class="p">)</span>
</code></pre></div>
<hr />
<h4 id="5">第5步: 模型的训练<a class="headerlink" href="#5" title="Permanent link">&para;</a></h4>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre><span></span><code>python cr_cnn_train.py
</code></pre></div>
<hr />
<ul>
<li>输出结果:</li>
</ul>
<div class="highlight"><pre><span></span><code>--------------------------------------
some config:
data_dir = ./data
output_dir = ./output
embedding_path = ./embedding/glove.6B.50d.txt
word_dim = 50
model_name = CNN2
mode = 1
seed = 666
cuda = 0
epoch = 500
dropout = 0.3
batch_size = 64
lr = 0.001
max_len = 256
pos_dis = 50
pos_dim = 5
hidden_size = 128
filter_num = 512
window = 3
margin_positive = 2.5
margin_negative = 0.5
gamma = 2.0
L2_decay = 0.0001
device = cuda:0
model_dir = ./output/CNN2
--------------------------------------
start to load data ...
finish!
--------------------------------------
CRCNN(
  (word_embedding): Embedding(23503, 50)
  (pos1_embedding): Embedding(103, 5)
  (pos2_embedding): Embedding(103, 5)
  (conv): Conv2d(1, 512, kernel_size=(3, 60), stride=(1, 1), padding=(1, 0))
  (maxpool): MaxPool2d(kernel_size=(256, 1), stride=(256, 1), padding=0, dilation=1, ceil_mode=False)
  (tanh): Tanh()
  (dropout): Dropout(p=0.3, inplace=False)
  (dense): Linear(in_features=512, out_features=19, bias=False)
)
traning model parameters:
word_embedding.weight :  torch.Size([23503, 50])
pos1_embedding.weight :  torch.Size([103, 5])
pos2_embedding.weight :  torch.Size([103, 5])
conv.weight :  torch.Size([512, 1, 3, 60])
conv.bias :  torch.Size([512])
dense.weight :  torch.Size([19, 512])
--------------------------------------
start to train the model ...
125it [00:01, 72.47it/s]                                                                                                              | 0/500 [00:00&lt;?, ?it/s]
[001] train_loss: 4.986 | dev_loss: 5.102 | micro f1 on dev: 0.4993 &gt;&gt;&gt; save models!
125it [00:01, 93.19it/s]                                                                                                      | 1/500 [00:03&lt;25:11,  3.03s/it]
[002] train_loss: 4.124 | dev_loss: 4.298 | micro f1 on dev: 0.6539 &gt;&gt;&gt; save models!
125it [00:01, 91.50it/s]                                                                                                      | 2/500 [00:05&lt;24:10,  2.91s/it]
[003] train_loss: 3.470 | dev_loss: 3.678 | micro f1 on dev: 0.6978 &gt;&gt;&gt; save models!
125it [00:01, 92.03it/s]                                                                                                      | 3/500 [00:08&lt;23:31,  2.84s/it]
[004] train_loss: 3.028 | dev_loss: 3.391 | micro f1 on dev: 0.7196 &gt;&gt;&gt; save models!
125it [00:01, 92.32it/s]                                                                                                      | 4/500 [00:11&lt;23:02,  2.79s/it]
[005] train_loss: 2.651 | dev_loss: 3.176 | micro f1 on dev: 0.7371 &gt;&gt;&gt; save models!
125it [00:01, 92.14it/s]                                                                                                      | 5/500 [00:13&lt;22:41,  2.75s/it]
[006] train_loss: 2.321 | dev_loss: 3.027 | micro f1 on dev: 0.7531 &gt;&gt;&gt; save models!
125it [00:01, 91.87it/s]                                                                                                      | 6/500 [00:16&lt;22:24,  2.72s/it]
[007] train_loss: 2.024 | dev_loss: 2.894 | micro f1 on dev: 0.7687 &gt;&gt;&gt; save models!
125it [00:01, 92.68it/s]                                                                                                      | 7/500 [00:18&lt;22:14,  2.71s/it]
[008] train_loss: 1.760 | dev_loss: 2.832 | micro f1 on dev: 0.7757 &gt;&gt;&gt; save models!
125it [00:01, 91.36it/s]                                                                                                      | 8/500 [00:21&lt;22:02,  2.69s/it]
[009] train_loss: 1.503 | dev_loss: 2.747 | micro f1 on dev: 0.7829 &gt;&gt;&gt; save models!
125it [00:01, 92.58it/s]                                                                                                      | 9/500 [00:24&lt;21:57,  2.68s/it]
[010] train_loss: 1.278 | dev_loss: 2.696 | micro f1 on dev: 0.7832 &gt;&gt;&gt; save models!
125it [00:01, 93.99it/s]                                                                                                     | 10/500 [00:26&lt;21:48,  2.67s/it]
[011] train_loss: 1.079 | dev_loss: 2.682 | micro f1 on dev: 0.7864 &gt;&gt;&gt; save models!
125it [00:01, 92.89it/s]                                                                                                     | 11/500 [00:29&lt;21:41,  2.66s/it]
[012] train_loss: 0.908 | dev_loss: 2.643 | micro f1 on dev: 0.7915 &gt;&gt;&gt; save models!
125it [00:01, 93.47it/s]                                                                                                     | 12/500 [00:32&lt;21:37,  2.66s/it]
[013] train_loss: 0.832 | dev_loss: 2.651 | micro f1 on dev: 0.7943 &gt;&gt;&gt; save models!
125it [00:01, 92.52it/s]                                                                                                     | 13/500 [00:34&lt;21:32,  2.65s/it]
[014] train_loss: 0.649 | dev_loss: 2.656 | micro f1 on dev: 0.7931 
125it [00:01, 93.09it/s]                                                                                                     | 14/500 [00:37&lt;21:25,  2.64s/it]
[015] train_loss: 0.529 | dev_loss: 2.646 | micro f1 on dev: 0.7933 
125it [00:01, 92.17it/s]                                                                                                     | 15/500 [00:40&lt;21:18,  2.64s/it]
[016] train_loss: 0.466 | dev_loss: 2.664 | micro f1 on dev: 0.7947 &gt;&gt;&gt; save models!
125it [00:01, 92.91it/s]                                                                                                     | 16/500 [00:42&lt;21:18,  2.64s/it]
[017] train_loss: 0.417 | dev_loss: 2.670 | micro f1 on dev: 0.7935 
125it [00:01, 91.00it/s]                                                                                                     | 17/500 [00:45&lt;21:12,  2.64s/it]
[018] train_loss: 0.349 | dev_loss: 2.718 | micro f1 on dev: 0.7946 
125it [00:01, 92.02it/s]                                                                                                     | 18/500 [00:48&lt;21:11,  2.64s/it]
[019] train_loss: 0.258 | dev_loss: 2.706 | micro f1 on dev: 0.7894 
125it [00:01, 92.72it/s]                                                                                                     | 19/500 [00:50&lt;21:10,  2.64s/it]
[020] train_loss: 0.232 | dev_loss: 2.734 | micro f1 on dev: 0.7881 
125it [00:01, 92.14it/s]                                                                                                     | 20/500 [00:53&lt;21:05,  2.64s/it]
[021] train_loss: 0.212 | dev_loss: 2.791 | micro f1 on dev: 0.7891 
125it [00:01, 92.74it/s]                                                                                                     | 21/500 [00:55&lt;21:00,  2.63s/it]
[022] train_loss: 0.147 | dev_loss: 2.758 | micro f1 on dev: 0.7909 
125it [00:01, 91.67it/s]                                                                                                     | 22/500 [00:58&lt;20:54,  2.62s/it]
[023] train_loss: 0.124 | dev_loss: 2.772 | micro f1 on dev: 0.7903 
125it [00:01, 92.53it/s]                                                                                                     | 23/500 [01:01&lt;20:50,  2.62s/it]
[024] train_loss: 0.115 | dev_loss: 2.797 | micro f1 on dev: 0.7948 &gt;&gt;&gt; save models!
125it [00:01, 92.38it/s]                                                                                                     | 24/500 [01:03&lt;20:52,  2.63s/it]
[025] train_loss: 0.091 | dev_loss: 2.819 | micro f1 on dev: 0.7944 
125it [00:01, 93.38it/s]                                                                                                     | 25/500 [01:06&lt;20:47,  2.63s/it]
[026] train_loss: 0.073 | dev_loss: 2.886 | micro f1 on dev: 0.7922 
125it [00:01, 92.56it/s]                                                                                                     | 26/500 [01:09&lt;20:42,  2.62s/it]
[027] train_loss: 0.069 | dev_loss: 2.942 | micro f1 on dev: 0.7913 
125it [00:01, 92.54it/s]                                                                                                     | 27/500 [01:11&lt;20:38,  2.62s/it]
[028] train_loss: 0.057 | dev_loss: 2.944 | micro f1 on dev: 0.7929 
125it [00:01, 91.92it/s]                                                                                                     | 28/500 [01:14&lt;20:34,  2.62s/it]
[029] train_loss: 0.063 | dev_loss: 2.988 | micro f1 on dev: 0.7911 
125it [00:01, 91.53it/s]                                                                                                     | 29/500 [01:16&lt;20:33,  2.62s/it]
[030] train_loss: 0.048 | dev_loss: 2.972 | micro f1 on dev: 0.7892 
125it [00:01, 91.76it/s]                                                                                                     | 30/500 [01:19&lt;20:34,  2.63s/it]
[031] train_loss: 0.041 | dev_loss: 3.001 | micro f1 on dev: 0.7874 
125it [00:01, 92.71it/s]                                                                                                     | 31/500 [01:22&lt;20:33,  2.63s/it]
[032] train_loss: 0.026 | dev_loss: 3.040 | micro f1 on dev: 0.7864 
125it [00:01, 92.16it/s]                                                                                                     | 32/500 [01:24&lt;20:27,  2.62s/it]
[033] train_loss: 0.022 | dev_loss: 3.027 | micro f1 on dev: 0.7892 
125it [00:01, 92.27it/s]                                                                                                     | 33/500 [01:27&lt;20:22,  2.62s/it]
[034] train_loss: 0.030 | dev_loss: 3.082 | micro f1 on dev: 0.7859 
125it [00:01, 92.45it/s]                                                                                                     | 34/500 [01:30&lt;20:21,  2.62s/it]
[035] train_loss: 0.020 | dev_loss: 3.103 | micro f1 on dev: 0.7902 
125it [00:01, 91.99it/s]                                                                                                     | 35/500 [01:32&lt;20:18,  2.62s/it]
[036] train_loss: 0.016 | dev_loss: 3.073 | micro f1 on dev: 0.7888 
125it [00:01, 92.85it/s]                                                                                                     | 36/500 [01:35&lt;20:16,  2.62s/it]
[037] train_loss: 0.014 | dev_loss: 3.077 | micro f1 on dev: 0.7890 
125it [00:01, 92.45it/s]                                                                                                     | 37/500 [01:37&lt;20:15,  2.63s/it]
[038] train_loss: 0.012 | dev_loss: 3.081 | micro f1 on dev: 0.7905 
125it [00:01, 92.11it/s]                                                                                                     | 38/500 [01:40&lt;20:11,  2.62s/it]
[039] train_loss: 0.014 | dev_loss: 3.088 | micro f1 on dev: 0.7888 
125it [00:01, 92.07it/s]                                                                                                     | 39/500 [01:43&lt;20:09,  2.62s/it]
[040] train_loss: 0.022 | dev_loss: 3.170 | micro f1 on dev: 0.7899 
125it [00:01, 92.35it/s]                                                                                                     | 40/500 [01:45&lt;20:04,  2.62s/it]
[041] train_loss: 0.013 | dev_loss: 3.135 | micro f1 on dev: 0.7890 
125it [00:01, 91.45it/s]                                                                                                     | 41/500 [01:48&lt;20:02,  2.62s/it]
[042] train_loss: 0.015 | dev_loss: 3.166 | micro f1 on dev: 0.7907 
125it [00:01, 92.23it/s]                                                                                                     | 42/500 [01:51&lt;20:02,  2.63s/it]
[043] train_loss: 0.006 | dev_loss: 3.240 | micro f1 on dev: 0.7893 
125it [00:01, 91.28it/s]                                                                                                     | 43/500 [01:53&lt;19:59,  2.63s/it]
[044] train_loss: 0.008 | dev_loss: 3.148 | micro f1 on dev: 0.7909 
125it [00:01, 91.91it/s]                                                                                                     | 44/500 [01:56&lt;20:01,  2.64s/it]
[045] train_loss: 0.011 | dev_loss: 3.219 | micro f1 on dev: 0.7886 
125it [00:01, 90.89it/s]                                                                                                     | 45/500 [01:58&lt;20:00,  2.64s/it]
[046] train_loss: 0.009 | dev_loss: 3.241 | micro f1 on dev: 0.7823 
125it [00:01, 91.49it/s]                                                                                                     | 46/500 [02:01&lt;20:00,  2.64s/it]
[047] train_loss: 0.004 | dev_loss: 3.310 | micro f1 on dev: 0.7829 
125it [00:01, 91.44it/s]                                                                                                     | 47/500 [02:04&lt;19:57,  2.64s/it]
[048] train_loss: 0.008 | dev_loss: 3.284 | micro f1 on dev: 0.7847 
125it [00:01, 91.50it/s]                                                                                                     | 48/500 [02:06&lt;19:52,  2.64s/it]
[049] train_loss: 0.005 | dev_loss: 3.320 | micro f1 on dev: 0.7867 
125it [00:01, 91.67it/s]                                                                                                     | 49/500 [02:09&lt;19:50,  2.64s/it]
[050] train_loss: 0.007 | dev_loss: 3.354 | micro f1 on dev: 0.7833 
125it [00:01, 91.29it/s]                                                                                                     | 50/500 [02:12&lt;19:46,  2.64s/it]
[051] train_loss: 0.007 | dev_loss: 3.352 | micro f1 on dev: 0.7831 
125it [00:01, 91.35it/s]


......
......
......
......
......
......


125it [00:01, 91.35it/s]████████████████████████████████████████████████████████████████████████████████████████▎           | 451/500 [19:49&lt;02:09,  2.65s/it]
[452] train_loss: 0.001 | dev_loss: 3.575 | micro f1 on dev: 0.7664 
125it [00:01, 91.33it/s]████████████████████████████████████████████████████████████████████████████████████████▌           | 452/500 [19:52&lt;02:06,  2.64s/it]
[453] train_loss: 0.002 | dev_loss: 3.567 | micro f1 on dev: 0.7705 
125it [00:01, 91.46it/s]████████████████████████████████████████████████████████████████████████████████████████▊           | 453/500 [19:55&lt;02:04,  2.64s/it]
[454] train_loss: 0.001 | dev_loss: 3.575 | micro f1 on dev: 0.7750 
125it [00:01, 91.57it/s]█████████████████████████████████████████████████████████████████████████████████████████           | 454/500 [19:57&lt;02:01,  2.64s/it]
[455] train_loss: 0.002 | dev_loss: 3.555 | micro f1 on dev: 0.7721 
125it [00:01, 91.27it/s]█████████████████████████████████████████████████████████████████████████████████████████▎          | 455/500 [20:00&lt;01:58,  2.64s/it]
[456] train_loss: 0.001 | dev_loss: 3.630 | micro f1 on dev: 0.7656 
125it [00:01, 91.73it/s]█████████████████████████████████████████████████████████████████████████████████████████▌          | 456/500 [20:03&lt;01:56,  2.64s/it]
[457] train_loss: 0.001 | dev_loss: 3.574 | micro f1 on dev: 0.7624 
125it [00:01, 91.71it/s]█████████████████████████████████████████████████████████████████████████████████████████▊          | 457/500 [20:05&lt;01:53,  2.63s/it]
[458] train_loss: 0.002 | dev_loss: 3.534 | micro f1 on dev: 0.7666 
125it [00:01, 92.20it/s]██████████████████████████████████████████████████████████████████████████████████████████          | 458/500 [20:08&lt;01:50,  2.63s/it]
[459] train_loss: 0.001 | dev_loss: 3.593 | micro f1 on dev: 0.7624 
125it [00:01, 91.57it/s]██████████████████████████████████████████████████████████████████████████████████████████▏         | 459/500 [20:11&lt;01:47,  2.63s/it]
[460] train_loss: 0.002 | dev_loss: 3.513 | micro f1 on dev: 0.7653 
125it [00:01, 90.88it/s]██████████████████████████████████████████████████████████████████████████████████████████▍         | 460/500 [20:13&lt;01:45,  2.63s/it]
[461] train_loss: 0.001 | dev_loss: 3.623 | micro f1 on dev: 0.7630 
125it [00:01, 90.88it/s]██████████████████████████████████████████████████████████████████████████████████████████▋         | 461/500 [20:16&lt;01:42,  2.63s/it]
[462] train_loss: 0.001 | dev_loss: 3.616 | micro f1 on dev: 0.7657 
125it [00:01, 92.40it/s]██████████████████████████████████████████████████████████████████████████████████████████▉         | 462/500 [20:18&lt;01:40,  2.64s/it]
[463] train_loss: 0.001 | dev_loss: 3.542 | micro f1 on dev: 0.7658 
125it [00:01, 90.01it/s]███████████████████████████████████████████████████████████████████████████████████████████▏        | 463/500 [20:21&lt;01:37,  2.63s/it]
[464] train_loss: 0.001 | dev_loss: 3.535 | micro f1 on dev: 0.7681 
125it [00:01, 90.92it/s]███████████████████████████████████████████████████████████████████████████████████████████▍        | 464/500 [20:24&lt;01:34,  2.64s/it]
[465] train_loss: 0.001 | dev_loss: 3.603 | micro f1 on dev: 0.7693 
125it [00:01, 91.30it/s]███████████████████████████████████████████████████████████████████████████████████████████▋        | 465/500 [20:26&lt;01:32,  2.64s/it]
[466] train_loss: 0.002 | dev_loss: 3.590 | micro f1 on dev: 0.7676 
125it [00:01, 91.11it/s]███████████████████████████████████████████████████████████████████████████████████████████▉        | 466/500 [20:29&lt;01:29,  2.64s/it]
[467] train_loss: 0.001 | dev_loss: 3.568 | micro f1 on dev: 0.7664 
125it [00:01, 91.60it/s]████████████████████████████████████████████████████████████████████████████████████████████▏       | 467/500 [20:32&lt;01:27,  2.64s/it]
[468] train_loss: 0.002 | dev_loss: 3.587 | micro f1 on dev: 0.7680 
125it [00:01, 91.54it/s]████████████████████████████████████████████████████████████████████████████████████████████▍       | 468/500 [20:34&lt;01:24,  2.64s/it]
[469] train_loss: 0.001 | dev_loss: 3.603 | micro f1 on dev: 0.7640 
125it [00:01, 91.40it/s]████████████████████████████████████████████████████████████████████████████████████████████▌       | 469/500 [20:37&lt;01:21,  2.64s/it]
[470] train_loss: 0.001 | dev_loss: 3.551 | micro f1 on dev: 0.7668 
125it [00:01, 91.04it/s]████████████████████████████████████████████████████████████████████████████████████████████▊       | 470/500 [20:40&lt;01:19,  2.63s/it]
[471] train_loss: 0.001 | dev_loss: 3.595 | micro f1 on dev: 0.7672 
125it [00:01, 91.39it/s]█████████████████████████████████████████████████████████████████████████████████████████████       | 471/500 [20:42&lt;01:16,  2.63s/it]
[472] train_loss: 0.001 | dev_loss: 3.582 | micro f1 on dev: 0.7666 
125it [00:01, 91.65it/s]█████████████████████████████████████████████████████████████████████████████████████████████▎      | 472/500 [20:45&lt;01:13,  2.64s/it]
[473] train_loss: 0.001 | dev_loss: 3.543 | micro f1 on dev: 0.7672 
125it [00:01, 91.70it/s]█████████████████████████████████████████████████████████████████████████████████████████████▌      | 473/500 [20:47&lt;01:11,  2.63s/it]
[474] train_loss: 0.002 | dev_loss: 3.566 | micro f1 on dev: 0.7662 
125it [00:01, 92.36it/s]█████████████████████████████████████████████████████████████████████████████████████████████▊      | 474/500 [20:50&lt;01:08,  2.64s/it]
[475] train_loss: 0.001 | dev_loss: 3.634 | micro f1 on dev: 0.7628 
125it [00:01, 91.30it/s]██████████████████████████████████████████████████████████████████████████████████████████████      | 475/500 [20:53&lt;01:05,  2.63s/it]
[476] train_loss: 0.001 | dev_loss: 3.693 | micro f1 on dev: 0.7624 
125it [00:01, 91.98it/s]██████████████████████████████████████████████████████████████████████████████████████████████▎     | 476/500 [20:55&lt;01:03,  2.63s/it]
[477] train_loss: 0.002 | dev_loss: 3.640 | micro f1 on dev: 0.7622 
125it [00:01, 91.08it/s]██████████████████████████████████████████████████████████████████████████████████████████████▌     | 477/500 [20:58&lt;01:00,  2.63s/it]
[478] train_loss: 0.001 | dev_loss: 3.635 | micro f1 on dev: 0.7642 
125it [00:01, 90.69it/s]██████████████████████████████████████████████████████████████████████████████████████████████▊     | 478/500 [21:01&lt;00:58,  2.64s/it]
[479] train_loss: 0.001 | dev_loss: 3.563 | micro f1 on dev: 0.7687 
125it [00:01, 91.59it/s]███████████████████████████████████████████████████████████████████████████████████████████████     | 479/500 [21:03&lt;00:55,  2.65s/it]
[480] train_loss: 0.001 | dev_loss: 3.607 | micro f1 on dev: 0.7688 
125it [00:01, 91.57it/s]███████████████████████████████████████████████████████████████████████████████████████████████▏    | 480/500 [21:06&lt;00:52,  2.65s/it]
[481] train_loss: 0.001 | dev_loss: 3.532 | micro f1 on dev: 0.7674 
125it [00:01, 90.23it/s]███████████████████████████████████████████████████████████████████████████████████████████████▍    | 481/500 [21:09&lt;00:50,  2.64s/it]
[482] train_loss: 0.001 | dev_loss: 3.606 | micro f1 on dev: 0.7714 
125it [00:01, 91.32it/s]███████████████████████████████████████████████████████████████████████████████████████████████▋    | 482/500 [21:11&lt;00:47,  2.65s/it]
[483] train_loss: 0.002 | dev_loss: 3.573 | micro f1 on dev: 0.7689 
125it [00:01, 90.71it/s]███████████████████████████████████████████████████████████████████████████████████████████████▉    | 483/500 [21:14&lt;00:45,  2.65s/it]
[484] train_loss: 0.001 | dev_loss: 3.534 | micro f1 on dev: 0.7704 
125it [00:01, 91.12it/s]████████████████████████████████████████████████████████████████████████████████████████████████▏   | 484/500 [21:17&lt;00:42,  2.65s/it]
[485] train_loss: 0.003 | dev_loss: 3.540 | micro f1 on dev: 0.7655 
125it [00:01, 90.58it/s]████████████████████████████████████████████████████████████████████████████████████████████████▍   | 485/500 [21:19&lt;00:39,  2.65s/it]
[486] train_loss: 0.002 | dev_loss: 3.533 | micro f1 on dev: 0.7610 
125it [00:01, 91.35it/s]████████████████████████████████████████████████████████████████████████████████████████████████▋   | 486/500 [21:22&lt;00:37,  2.65s/it]
[487] train_loss: 0.001 | dev_loss: 3.556 | micro f1 on dev: 0.7661 
125it [00:01, 91.92it/s]████████████████████████████████████████████████████████████████████████████████████████████████▉   | 487/500 [21:24&lt;00:34,  2.65s/it]
[488] train_loss: 0.001 | dev_loss: 3.533 | micro f1 on dev: 0.7650 
125it [00:01, 91.90it/s]█████████████████████████████████████████████████████████████████████████████████████████████████▏  | 488/500 [21:27&lt;00:31,  2.64s/it]
[489] train_loss: 0.002 | dev_loss: 3.597 | micro f1 on dev: 0.7590 
125it [00:01, 90.40it/s]█████████████████████████████████████████████████████████████████████████████████████████████████▍  | 489/500 [21:30&lt;00:28,  2.63s/it]
[490] train_loss: 0.003 | dev_loss: 3.524 | micro f1 on dev: 0.7665 
125it [00:01, 91.52it/s]█████████████████████████████████████████████████████████████████████████████████████████████████▌  | 490/500 [21:32&lt;00:26,  2.64s/it]
[491] train_loss: 0.001 | dev_loss: 3.568 | micro f1 on dev: 0.7617 
125it [00:01, 91.35it/s]█████████████████████████████████████████████████████████████████████████████████████████████████▊  | 491/500 [21:35&lt;00:23,  2.63s/it]
[492] train_loss: 0.001 | dev_loss: 3.574 | micro f1 on dev: 0.7619 
125it [00:01, 90.90it/s]██████████████████████████████████████████████████████████████████████████████████████████████████  | 492/500 [21:38&lt;00:21,  2.64s/it]
[493] train_loss: 0.001 | dev_loss: 3.536 | micro f1 on dev: 0.7673 
125it [00:01, 91.73it/s]██████████████████████████████████████████████████████████████████████████████████████████████████▎ | 493/500 [21:40&lt;00:18,  2.65s/it]
[494] train_loss: 0.002 | dev_loss: 3.542 | micro f1 on dev: 0.7645 
125it [00:01, 91.76it/s]██████████████████████████████████████████████████████████████████████████████████████████████████▌ | 494/500 [21:43&lt;00:15,  2.64s/it]
[495] train_loss: 0.002 | dev_loss: 3.509 | micro f1 on dev: 0.7662 
125it [00:01, 91.15it/s]██████████████████████████████████████████████████████████████████████████████████████████████████▊ | 495/500 [21:46&lt;00:13,  2.64s/it]
[496] train_loss: 0.001 | dev_loss: 3.584 | micro f1 on dev: 0.7671 
125it [00:01, 91.37it/s]███████████████████████████████████████████████████████████████████████████████████████████████████ | 496/500 [21:48&lt;00:10,  2.63s/it]
[497] train_loss: 0.001 | dev_loss: 3.549 | micro f1 on dev: 0.7625 
125it [00:01, 91.07it/s]███████████████████████████████████████████████████████████████████████████████████████████████████▎| 497/500 [21:51&lt;00:07,  2.63s/it]
[498] train_loss: 0.001 | dev_loss: 3.578 | micro f1 on dev: 0.7593 
125it [00:01, 90.88it/s]███████████████████████████████████████████████████████████████████████████████████████████████████▌| 498/500 [21:53&lt;00:05,  2.64s/it]
[499] train_loss: 0.001 | dev_loss: 3.546 | micro f1 on dev: 0.7663 
125it [00:01, 92.01it/s]███████████████████████████████████████████████████████████████████████████████████████████████████▊| 499/500 [21:56&lt;00:02,  2.64s/it]
[500] train_loss: 0.001 | dev_loss: 3.600 | micro f1 on dev: 0.7644 
100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 500/500 [21:59&lt;00:00,  2.64s/it]
--------------------------------------
start test ...
test_loss: 2.797 | micro f1 on test:  0.7948
</code></pre></div>
<hr />
<hr />
<h3 id="_2">小节总结<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ul>
<li>本小节学习了CR-CNN关系抽取模型的代码实现, 并完成了模型的训练与性能测试.</li>
</ul>
<hr />
<hr />
<hr />
<hr />

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="13_1.html" class="md-footer__link md-footer__link--prev" aria-label="上一页: 13.1 基于CNN的关系抽取模型" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              13.1 基于CNN的关系抽取模型
            </div>
          </div>
        </a>
      
      
        
        <a href="15_1.html" class="md-footer__link md-footer__link--next" aria-label="下一页: 15.1 中文NER的SOTA" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              15.1 中文NER的SOTA
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": ".", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "search": "assets/javascripts/workers/search.092fa1f6.min.js"}</script>
    
    
      <script src="assets/javascripts/bundle.5a9542cf.min.js"></script>
      
        <script src="js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>