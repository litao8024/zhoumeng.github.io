
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="img/logo.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.11">
    
    
      
        <title>13.1 基于CNN的关系抽取模型 - 红蜘蛛知识图谱项目 V3.0</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.50e68009.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cnnre" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="." title="红蜘蛛知识图谱项目 V3.0" class="md-header__button md-logo" aria-label="红蜘蛛知识图谱项目 V3.0" data-md-component="logo">
      
  <img src="img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            红蜘蛛知识图谱项目 V3.0
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              13.1 基于CNN的关系抽取模型
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
    <img src="assets/images/logo.svg" height="45px" alt="logo">

  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="红蜘蛛知识图谱项目 V3.0" class="md-nav__button md-logo" aria-label="红蜘蛛知识图谱项目 V3.0" data-md-component="logo">
      
  <img src="img/logo.png" alt="logo">

    </a>
    红蜘蛛知识图谱项目 V3.0
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          第一章:项目背景
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第一章:项目背景" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          第一章:项目背景
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="1_1.html" class="md-nav__link">
        1.1 红蜘蛛项目背景
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="1_2.html" class="md-nav__link">
        1.2 知识图谱概述
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          第二章:知识查询
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第二章:知识查询" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          第二章:知识查询
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="2_1.html" class="md-nav__link">
        2.1 知识查询方法介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="2_2.html" class="md-nav__link">
        2.2 知识图谱的数值表示
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          第三章:实体抽取
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第三章:实体抽取" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          第三章:实体抽取
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="3_1.html" class="md-nav__link">
        3.1 快速部署的IDCNN模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="3_2.html" class="md-nav__link">
        3.2 FLAT模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="3_3.html" class="md-nav__link">
        3.3 实体消歧与实体对齐
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="3_4.html" class="md-nav__link">
        3.4 基于规则派的NER
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          第四章:关系抽取
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第四章:关系抽取" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          第四章:关系抽取
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="4_1.html" class="md-nav__link">
        4.1 multi-head-selection模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="4_2.html" class="md-nav__link">
        4.2 Casrel模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="4_3.html" class="md-nav__link">
        4.3 基于规则派的RE
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          第五章:事件抽取
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第五章:事件抽取" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          第五章:事件抽取
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="5_1.html" class="md-nav__link">
        5.1 中文场景下的事件抽取
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          第六章:知识构建
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第六章:知识构建" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          第六章:知识构建
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="6_1.html" class="md-nav__link">
        6.1 概念图谱的构建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="6_2.html" class="md-nav__link">
        6.2 百科图谱的构建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="6_3.html" class="md-nav__link">
        6.3 知识图谱的众包
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          第七章:知识存储
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第七章:知识存储" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          第七章:知识存储
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="7_1.html" class="md-nav__link">
        7.1 知识图谱建模与存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="7_2.html" class="md-nav__link">
        7.2 neo4j技术解析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          第八章:知识补全
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第八章:知识补全" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          第八章:知识补全
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="8_1.html" class="md-nav__link">
        8.1 经典知识补全
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="8_2.html" class="md-nav__link">
        8.2 知识图谱质量控制
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          第九章:知识推理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第九章:知识推理" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          第九章:知识推理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="9_1.html" class="md-nav__link">
        9.1 常用推理方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="9_2.html" class="md-nav__link">
        9.2 常用推理引擎
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="9_3.html" class="md-nav__link">
        9.3 知识推理展望
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          第十章:红蜘蛛上线
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十章:红蜘蛛上线" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          第十章:红蜘蛛上线
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="10_1.html" class="md-nav__link">
        10.1 总体设计方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="10_2.html" class="md-nav__link">
        10.2 搭建红蜘蛛机器人
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="10_3.html" class="md-nav__link">
        10.3 上线部署与联调测试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" type="checkbox" id="__nav_11" >
      
      
      
      
        <label class="md-nav__link" for="__nav_11">
          第十一章:扩展章节之一
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十一章:扩展章节之一" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          第十一章:扩展章节之一
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="11_1.html" class="md-nav__link">
        11.1 TENER模型
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12" type="checkbox" id="__nav_12" >
      
      
      
      
        <label class="md-nav__link" for="__nav_12">
          第十二章:扩展章节之二
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十二章:扩展章节之二" data-md-level="1">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          第十二章:扩展章节之二
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="12_1.html" class="md-nav__link">
        12.1 Soft-lexicon模型
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13" type="checkbox" id="__nav_13" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_13">
          第十三章:扩展章节之三
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十三章:扩展章节之三" data-md-level="1">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          第十三章:扩展章节之三
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          13.1 基于CNN的关系抽取模型
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="13_1.html" class="md-nav__link md-nav__link--active">
        13.1 基于CNN的关系抽取模型
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cnnre" class="md-nav__link">
    CNN模型处理RE问题
  </a>
  
    <nav class="md-nav" aria-label="CNN模型处理RE问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    学习目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cnnre_1" class="md-nav__link">
    CNN处理RE问题的架构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cnnre_2" class="md-nav__link">
    CNN处理RE的实现
  </a>
  
    <nav class="md-nav" aria-label="CNN处理RE的实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    数据预处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    工具类函数的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    模型类的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    训练与评估函数的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    推理代码的实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    小节总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14" type="checkbox" id="__nav_14" >
      
      
      
      
        <label class="md-nav__link" for="__nav_14">
          第十四章:扩展章节之四
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十四章:扩展章节之四" data-md-level="1">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          第十四章:扩展章节之四
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="14_1.html" class="md-nav__link">
        14.1 CR-CNN关系抽取模型详解
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_15" type="checkbox" id="__nav_15" >
      
      
      
      
        <label class="md-nav__link" for="__nav_15">
          第十五章:扩展章节之五
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十五章:扩展章节之五" data-md-level="1">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          第十五章:扩展章节之五
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="15_1.html" class="md-nav__link">
        15.1 中文NER的SOTA
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cnnre" class="md-nav__link">
    CNN模型处理RE问题
  </a>
  
    <nav class="md-nav" aria-label="CNN模型处理RE问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    学习目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cnnre_1" class="md-nav__link">
    CNN处理RE问题的架构
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cnnre_2" class="md-nav__link">
    CNN处理RE的实现
  </a>
  
    <nav class="md-nav" aria-label="CNN处理RE的实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    数据预处理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    工具类函数的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    模型类的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    训练与评估函数的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    推理代码的实现
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    小节总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

  <h1>13.1 基于CNN的关系抽取模型</h1>

<h2 id="cnnre">CNN模型处理RE问题<a class="headerlink" href="#cnnre" title="Permanent link">&para;</a></h2>
<hr />
<h3 id="_1">学习目标<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<ul>
<li>理解CNN模型是如何处理RE问题的.</li>
<li>掌握CNN处理RE的具体代码实现.</li>
</ul>
<hr />
<h3 id="cnnre_1">CNN处理RE问题的架构<a class="headerlink" href="#cnnre_1" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>原始论文&lt;&lt; Relation Classification via Convolutional Deep Neural Network &gt;&gt;.</p>
</li>
<li>
<p>整个模型的架构图如下所示:</p>
</li>
</ul>
<p><center><img alt="" src="img/4_2_1.png" /></center></p>
<hr />
<ul>
<li>CNN模型的核心操作有2个:<ul>
<li>特征抽取融合了语法层面的特征 + 语句层面的特征.</li>
<li>语句层面的特征抽取, 除了word embedding外, 还融入了position embedding的信息.</li>
</ul>
</li>
</ul>
<hr />
<hr />
<h3 id="cnnre_2">CNN处理RE的实现<a class="headerlink" href="#cnnre_2" title="Permanent link">&para;</a></h3>
<h4 id="_2">数据预处理<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<ul>
<li>本项目采用医疗数据集CMeIE_train.json, 但是所展示的数据格式对CNN模型并不友好, 需要对原始数据集做格式转换的预处理.</li>
</ul>
<hr />
<ul>
<li>首先展示原始医疗数据: /home/ec2-user/information_extraction/relation/cnn_medical/data/CMeIE_train.json</li>
</ul>
<div class="highlight"><pre><span></span><code>{&quot;text&quot;: &quot;产后抑郁症@区分产后抑郁症与轻度情绪失调（产后忧郁或“婴儿忧郁”）是重要的，因为轻度情绪失调不需要治疗。&quot;, &quot;spo_list&quot;: [{&quot;Combined&quot;: false, &quot;predicate&quot;: &quot;鉴别诊断&quot;, &quot;subject&quot;: &quot;产后抑郁症&quot;, &quot;subject_type&quot;: &quot;疾病&quot;, &quot;object&quot;: {&quot;@value&quot;: &quot;轻度情绪失调&quot;}, &quot;object_type&quot;: {&quot;@value&quot;: &quot;疾病&quot;}}]}

{&quot;text&quot;: &quot;类风湿关节炎@尺侧偏斜是由于MCP关节炎症造成的。&quot;, &quot;spo_list&quot;: [{&quot;Combined&quot;: false, &quot;predicate&quot;: &quot;临床表现&quot;, &quot;subject&quot;: &quot;MCP关节炎症&quot;, &quot;subject_type&quot;: &quot;疾病&quot;, &quot;object&quot;: {&quot;@value&quot;: &quot;尺侧偏斜&quot;}, &quot;object_type&quot;: {&quot;@value&quot;: &quot;症状&quot;}}]}
</code></pre></div>
<hr />
<ul>
<li>需要将原始数据转变成更有利于CNN模型处理的如下格式:</li>
</ul>
<div class="highlight"><pre><span></span><code>{&quot;id&quot;: &quot;1&quot;, &quot;sentence&quot;: [&quot;产&quot;, &quot;后&quot;, &quot;抑&quot;, &quot;郁&quot;, &quot;症&quot;, &quot;@&quot;, &quot;区&quot;, &quot;分&quot;, &quot;产&quot;, &quot;后&quot;, &quot;抑&quot;, &quot;郁&quot;, &quot;症&quot;, &quot;与&quot;, &quot;轻&quot;, &quot;度&quot;, &quot;情&quot;, &quot;绪&quot;, &quot;失&quot;, &quot;调&quot;, &quot;（&quot;, &quot;产&quot;, &quot;后&quot;, &quot;忧&quot;, &quot;郁&quot;, &quot;或&quot;, &quot;“&quot;, &quot;婴&quot;, &quot;儿&quot;, &quot;忧&quot;, &quot;郁&quot;, &quot;”&quot;, &quot;）&quot;, &quot;是&quot;, &quot;重&quot;, &quot;要&quot;, &quot;的&quot;, &quot;，&quot;, &quot;因&quot;, &quot;为&quot;, &quot;轻&quot;, &quot;度&quot;, &quot;情&quot;, &quot;绪&quot;, &quot;失&quot;, &quot;调&quot;, &quot;不&quot;, &quot;需&quot;, &quot;要&quot;, &quot;治&quot;, &quot;疗&quot;, &quot;。&quot;], &quot;head&quot;: &quot;产后抑郁症&quot;, &quot;tail&quot;: &quot;轻度情绪失调&quot;, &quot;relation&quot;: &quot;鉴别诊断&quot;, &quot;subj_start&quot;: 0, &quot;subj_end&quot;: 4, &quot;obj_start&quot;: 14, &quot;obj_end&quot;: 19, &quot;comment&quot;: &quot;&quot;}

{&quot;id&quot;: &quot;2&quot;, &quot;sentence&quot;: [&quot;类&quot;, &quot;风&quot;, &quot;湿&quot;, &quot;关&quot;, &quot;节&quot;, &quot;炎&quot;, &quot;@&quot;, &quot;尺&quot;, &quot;侧&quot;, &quot;偏&quot;, &quot;斜&quot;, &quot;是&quot;, &quot;由&quot;, &quot;于&quot;, &quot;M&quot;, &quot;C&quot;, &quot;P&quot;, &quot;关&quot;, &quot;节&quot;, &quot;炎&quot;, &quot;症&quot;, &quot;造&quot;, &quot;成&quot;, &quot;的&quot;, &quot;。&quot;], &quot;head&quot;: &quot;MCP关节炎症&quot;, &quot;tail&quot;: &quot;尺侧偏斜&quot;, &quot;relation&quot;: &quot;临床表现&quot;, &quot;subj_start&quot;: 14, &quot;subj_end&quot;: 20, &quot;obj_start&quot;: 7, &quot;obj_end&quot;: 10, &quot;comment&quot;: &quot;&quot;}
</code></pre></div>
<hr />
<blockquote>
<ul>
<li>作业: 上述数据格式转换属于工作中的基本操作, 以作业的形式完成, 锻炼自己真实进行数据处理的代码能力!</li>
</ul>
</blockquote>
<hr />
<ul>
<li>关系数据定义文件: /home/ec2-user/information_extraction/relation/cnn_medical/data/53_schemas.json</li>
</ul>
<div class="highlight"><pre><span></span><code>{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;预防&quot;, &quot;object_type&quot;: &quot;其他&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;阶段&quot;, &quot;object_type&quot;: &quot;其他&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;就诊科室&quot;, &quot;object_type&quot;: &quot;其他&quot;}
{&quot;subject_type&quot;: &quot;其他&quot;, &quot;predicate&quot;: &quot;同义词-其他&quot;, &quot;object_type&quot;: &quot;其他&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;辅助治疗&quot;, &quot;object_type&quot;: &quot;其他治疗&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;化疗&quot;, &quot;object_type&quot;: &quot;其他治疗&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;放射治疗&quot;, &quot;object_type&quot;: &quot;其他治疗&quot;}
{&quot;subject_type&quot;: &quot;其他治疗&quot;, &quot;predicate&quot;: &quot;同义词-其他治疗&quot;, &quot;object_type&quot;: &quot;其他治疗&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;手术治疗&quot;, &quot;object_type&quot;: &quot;手术治疗&quot;}
{&quot;subject_type&quot;: &quot;手术治疗&quot;, &quot;predicate&quot;: &quot;同义词-手术治疗&quot;, &quot;object_type&quot;: &quot;手术治疗&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;实验室检查&quot;, &quot;object_type&quot;: &quot;检查&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;影像学检查&quot;, &quot;object_type&quot;: &quot;检查&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;辅助检查&quot;, &quot;object_type&quot;: &quot;检查&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;组织学检查&quot;, &quot;object_type&quot;: &quot;检查&quot;}
{&quot;subject_type&quot;: &quot;检查&quot;, &quot;predicate&quot;: &quot;同义词-检查&quot;, &quot;object_type&quot;: &quot;检查&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;内窥镜检查&quot;, &quot;object_type&quot;: &quot;检查&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;筛查&quot;, &quot;object_type&quot;: &quot;检查&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;多发群体&quot;, &quot;object_type&quot;: &quot;流行病学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;发病率&quot;, &quot;object_type&quot;: &quot;流行病学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;发病年龄&quot;, &quot;object_type&quot;: &quot;流行病学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;多发地区&quot;, &quot;object_type&quot;: &quot;流行病学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;发病性别倾向&quot;, &quot;object_type&quot;: &quot;流行病学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;死亡率&quot;, &quot;object_type&quot;: &quot;流行病学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;多发季节&quot;, &quot;object_type&quot;: &quot;流行病学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;传播途径&quot;, &quot;object_type&quot;: &quot;流行病学&quot;}
{&quot;subject_type&quot;: &quot;流行病学&quot;, &quot;predicate&quot;: &quot;同义词-流行病学&quot;, &quot;object_type&quot;: &quot;流行病学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;同义词-疾病&quot;, &quot;object_type&quot;: &quot;疾病&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;并发症&quot;, &quot;object_type&quot;: &quot;疾病&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;病理分型&quot;, &quot;object_type&quot;: &quot;疾病&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;相关（导致）&quot;, &quot;object_type&quot;: &quot;疾病&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;鉴别诊断&quot;, &quot;object_type&quot;: &quot;疾病&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;相关（转化）&quot;, &quot;object_type&quot;: &quot;疾病&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;相关（症状）&quot;, &quot;object_type&quot;: &quot;疾病&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;临床表现&quot;, &quot;object_type&quot;: &quot;症状&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;治疗后症状&quot;, &quot;object_type&quot;: &quot;症状&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;侵及周围组织转移的症状&quot;, &quot;object_type&quot;: &quot;症状&quot;}
{&quot;subject_type&quot;: &quot;症状&quot;, &quot;predicate&quot;: &quot;同义词-症状&quot;, &quot;object_type&quot;: &quot;症状&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;病因&quot;, &quot;object_type&quot;: &quot;社会学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;高危因素&quot;, &quot;object_type&quot;: &quot;社会学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;风险评估因素&quot;, &quot;object_type&quot;: &quot;社会学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;病史&quot;, &quot;object_type&quot;: &quot;社会学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;遗传因素&quot;, &quot;object_type&quot;: &quot;社会学&quot;}
{&quot;subject_type&quot;: &quot;社会学&quot;, &quot;predicate&quot;: &quot;同义词-社会学&quot;, &quot;object_type&quot;: &quot;社会学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;发病机制&quot;, &quot;object_type&quot;: &quot;社会学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;病理生理&quot;, &quot;object_type&quot;: &quot;社会学&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;药物治疗&quot;, &quot;object_type&quot;: &quot;药物&quot;}
{&quot;subject_type&quot;: &quot;药物&quot;, &quot;predicate&quot;: &quot;同义词-药物&quot;, &quot;object_type&quot;: &quot;药物&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;发病部位&quot;, &quot;object_type&quot;: &quot;部位&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;转移部位&quot;, &quot;object_type&quot;: &quot;部位&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;外侵部位&quot;, &quot;object_type&quot;: &quot;部位&quot;}
{&quot;subject_type&quot;: &quot;部位&quot;, &quot;predicate&quot;: &quot;同义词-部位&quot;, &quot;object_type&quot;: &quot;部位&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;预后状况&quot;, &quot;object_type&quot;: &quot;预后&quot;}
{&quot;subject_type&quot;: &quot;疾病&quot;, &quot;predicate&quot;: &quot;预后生存率&quot;, &quot;object_type&quot;: &quot;预后&quot;}
</code></pre></div>
<hr />
<ul>
<li>关系映射表: /home/ec2-user/information_extraction/relation/cnn_medical/data/rel2idx.json</li>
</ul>
<div class="highlight"><pre><span></span><code>{&quot;预防&quot;: 0, &quot;阶段&quot;: 1, &quot;就诊科室&quot;: 2, &quot;同义词-其他&quot;: 3, &quot;辅助治疗&quot;: 4, &quot;化疗&quot;: 5, &quot;放射治疗&quot;: 6, &quot;同义词-其他治疗&quot;: 7, &quot;手术治疗&quot;: 8, &quot;同义词-手术治疗&quot;: 9, &quot;实验室检查&quot;: 10, &quot;影像学检查&quot;: 11, &quot;辅助检查&quot;: 12, &quot;组织学检查&quot;: 13, &quot;同义词-检查&quot;: 14, &quot;内窥镜检查&quot;: 15, &quot;筛查&quot;: 16, &quot;多发群体&quot;: 17, &quot;发病率&quot;: 18, &quot;发病年龄&quot;: 19, &quot;多发地区&quot;: 20, &quot;发病性别倾向&quot;: 21, &quot;死亡率&quot;: 22, &quot;多发季节&quot;: 23, &quot;传播途径&quot;: 24, &quot;同义词-流行病学&quot;: 25, &quot;同义词-疾病&quot;: 26, &quot;并发症&quot;: 27, &quot;病理分型&quot;: 28, &quot;相关（导致）&quot;: 29, &quot;鉴别诊断&quot;: 30, &quot;相关（转化）&quot;: 31, &quot;相关（症状）&quot;: 32, &quot;临床表现&quot;: 33, &quot;治疗后症状&quot;: 34, &quot;侵及周围组织转移的症状&quot;: 35, &quot;同义词-症状&quot;: 36, &quot;病因&quot;: 37, &quot;高危因素&quot;: 38, &quot;风险评估因素&quot;: 39, &quot;病史&quot;: 40, &quot;遗传因素&quot;: 41, &quot;同义词-社会学&quot;: 42, &quot;发病机制&quot;: 43, &quot;病理生理&quot;: 44, &quot;药物治疗&quot;: 45, &quot;同义词-药物&quot;: 46, &quot;发病部位&quot;: 47, &quot;转移部位&quot;: 48, &quot;外侵部位&quot;: 49, &quot;同义词-部位&quot;: 50, &quot;预后状况&quot;: 51, &quot;预后生存率&quot;: 52}
</code></pre></div>
<hr />
<h4 id="_3">工具类函数的实现<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<ul>
<li>工具类函数有2个:<ul>
<li>1: 负责处理词嵌入的embedding.py</li>
<li>2: 负责处理数据加载和其他工具类功能的utils.py</li>
</ul>
</li>
</ul>
<hr />
<ul>
<li>1: 代码路径: /home/ec2-user/information_extraction/relation/cnn_medical/embedding.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 导入工具包</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">jieba</span>
<span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="c1"># 获取词典的函数</span>
<span class="k">def</span> <span class="nf">get_vocab</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">):</span>
    <span class="c1"># 初始化一个计数器</span>
    <span class="n">token_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>

    <span class="c1"># 遍历训练集数据, 将分词后的所有中文词放入计数器中</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Counting tokens&#39;</span><span class="p">):</span>
            <span class="n">sent</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># 采用jieba分词作为中文场景下的分词器</span>
            <span class="n">sent_cut</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">sent</span><span class="p">))</span>
            <span class="c1"># 更新计数器</span>
            <span class="n">token_counter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sent_cut</span><span class="p">)</span>

    <span class="c1"># 按照人工设置选定词频最高的vocab_size个中文词</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">token_counter</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">vocab</span>


<span class="c1"># 获取词嵌入向量的函数</span>
<span class="k">def</span> <span class="nf">get_embedding</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">embedding_file_path</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;processing embedding file ...&#39;</span><span class="p">)</span>
    <span class="n">token2embedding</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># 打开新浪微博开源的预训练词向量文件</span>
    <span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">embedding_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">token_vectors</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">meta_info</span> <span class="o">=</span> <span class="n">token_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">meta_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> tokens in embedding file in total, vector size is </span><span class="si">{</span><span class="n">meta_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># 遍历每一行数据</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">token_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="c1"># 第一列是对应的中文词</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="c1"># 第一列之后都是数字化的词向量</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="c1"># 只选取那些已经在词典中的词向量存入词向量词典中</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">:</span>
                <span class="n">token2embedding</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">vector</span><span class="p">]</span>

    <span class="c1"># 将4个特殊字符占据0,1,2,3的标签, 其他单词按序向后排列</span>
    <span class="n">token2idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">token</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">token2embedding</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)}</span>
    <span class="n">UNK</span><span class="p">,</span> <span class="n">PAD</span><span class="p">,</span> <span class="n">BOS</span><span class="p">,</span> <span class="n">EOS</span> <span class="o">=</span> <span class="s1">&#39;&lt;unk&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;pad&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;bos&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;eos&gt;&#39;</span>
    <span class="n">token2idx</span><span class="p">[</span><span class="n">PAD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">token2idx</span><span class="p">[</span><span class="n">UNK</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">token2idx</span><span class="p">[</span><span class="n">BOS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">token2idx</span><span class="p">[</span><span class="n">EOS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">idx2token</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">:</span> <span class="n">token</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">token2idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">idx2embedding</span> <span class="o">=</span> <span class="p">{</span><span class="n">token2idx</span><span class="p">[</span><span class="n">token</span><span class="p">]:</span> <span class="n">embedding</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">embedding</span> <span class="ow">in</span> <span class="n">token2embedding</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">idx2embedding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">idx2embedding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">idx2embedding</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">meta_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">idx2embedding</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">meta_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">emb_mat</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx2embedding</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2embedding</span><span class="p">))]</span>

    <span class="n">emb_mat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">emb_mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">emb_mat</span><span class="p">,</span> <span class="n">token2idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span>
</code></pre></div>
<hr />
<ul>
<li>2: 代码路径: /home/ec2-user/information_extraction/relation/cnn_medical/utils.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 导入工具包</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">jieba</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>


<span class="c1"># 词嵌入张量的加载类代码</span>
<span class="k">class</span> <span class="nc">WordEmbeddingLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">embedding_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_dim</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">word_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_raw</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">train_raw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">vocab_size</span>

    <span class="c1"># 获取词典的类内函数</span>
    <span class="k">def</span> <span class="nf">get_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 初始化一个计数器</span>
        <span class="n">token_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>

        <span class="c1"># 遍历训练集数据, 将分词后的所有中文词放入计数器中</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_raw</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
                <span class="c1"># 采用jieba分词作为中文场景下的分词器</span>
                <span class="n">sentence_words</span> <span class="o">=</span> <span class="n">jieba</span><span class="o">.</span><span class="n">lcut</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="c1"># 更新计数器</span>
                <span class="n">token_counter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sentence_words</span><span class="p">)</span>

        <span class="c1"># 按照人工设置选定词频最高的vocab_size个中文词</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">token_counter</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">vocab</span>

    <span class="c1"># 获取词嵌入向量的类内函数</span>
    <span class="k">def</span> <span class="nf">get_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;processing embedding file ...&#39;</span><span class="p">)</span>
        <span class="n">token2embedding</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 打开新浪微博开源的预训练词向量文件</span>
        <span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">token_vectors</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">meta_info</span> <span class="o">=</span> <span class="n">token_vectors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">meta_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> tokens in embedding file in total, vector size is </span><span class="si">{</span><span class="n">meta_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">token_vectors</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="c1"># 第一列是对应的中文词</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="c1"># 第一列之后都是数字化的词向量</span>
                <span class="n">vector</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                <span class="c1"># 只选取那些已经在词典中的词向量存入词向量词典中</span>
                <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">:</span>
                    <span class="n">token2embedding</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">vector</span><span class="p">]</span>

        <span class="c1"># 将4个特殊字符占据0,1,2,3的标签, 其他单词按序向后排列</span>
        <span class="n">token2idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">token</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">token2embedding</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)}</span>
        <span class="n">UNK</span><span class="p">,</span> <span class="n">PAD</span><span class="p">,</span> <span class="n">BOS</span><span class="p">,</span> <span class="n">EOS</span> <span class="o">=</span> <span class="s1">&#39;UNK&#39;</span><span class="p">,</span> <span class="s1">&#39;PAD&#39;</span><span class="p">,</span> <span class="s1">&#39;BOS&#39;</span><span class="p">,</span> <span class="s1">&#39;EOS&#39;</span>
        <span class="n">token2idx</span><span class="p">[</span><span class="n">PAD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">token2idx</span><span class="p">[</span><span class="n">UNK</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">token2idx</span><span class="p">[</span><span class="n">BOS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">token2idx</span><span class="p">[</span><span class="n">EOS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="n">idx2token</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">:</span> <span class="n">token</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">token2idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">idx2embedding</span> <span class="o">=</span> <span class="p">{</span><span class="n">token2idx</span><span class="p">[</span><span class="n">token</span><span class="p">]:</span> <span class="n">embedding</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">embedding</span> <span class="ow">in</span> <span class="n">token2embedding</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">idx2embedding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">idx2embedding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">idx2embedding</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">meta_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">idx2embedding</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">meta_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">emb_mat</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx2embedding</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2embedding</span><span class="p">))]</span>

        <span class="n">emb_mat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">emb_mat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">emb_mat</span><span class="p">,</span> <span class="n">token2idx</span>


<span class="c1"># 关系加载类代码</span>
<span class="k">class</span> <span class="nc">RelationLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">data_dir</span>

    <span class="c1"># 读取文件将关系映射表加载成字典类型</span>
    <span class="k">def</span> <span class="nf">__load_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">relation_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;relation2id.txt&#39;</span><span class="p">)</span>
        <span class="n">rel2id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">id2rel</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># 遍历关系文件进行数据读取</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">relation_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fr</span><span class="p">:</span>
                <span class="n">relation</span><span class="p">,</span> <span class="n">id_s</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">id_d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">id_s</span><span class="p">)</span>
                <span class="n">rel2id</span><span class="p">[</span><span class="n">relation</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_d</span>
                <span class="n">id2rel</span><span class="p">[</span><span class="n">id_d</span><span class="p">]</span> <span class="o">=</span> <span class="n">relation</span>

        <span class="c1"># 返回两个映射字典, 以及关系数目</span>
        <span class="k">return</span> <span class="n">rel2id</span><span class="p">,</span> <span class="n">id2rel</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rel2id</span><span class="p">)</span>

    <span class="c1"># 外层接口函数, 内部调用上面的类内函数</span>
    <span class="k">def</span> <span class="nf">get_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__load_relation</span><span class="p">()</span>


<span class="c1"># 构建数据集的类代码</span>
<span class="k">class</span> <span class="nc">SemEvalDateset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">rel2id</span><span class="p">,</span> <span class="n">word2id</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel2id</span> <span class="o">=</span> <span class="n">rel2id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word2id</span> <span class="o">=</span> <span class="n">word2id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_len</span>
        <span class="c1"># 在config文件中设定pos_dis默认值为50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pos_dis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">data_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__load_data</span><span class="p">()</span>

    <span class="c1"># 获取位置索引的函数</span>
    <span class="k">def</span> <span class="nf">__get_pos_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># pos_dis默认值为50, 已在config.py文件中设置.</span>
        <span class="c1"># 1: 相对位置编码小于-50, 直接返回位置编码0.</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># 2: 相对位置编码[-50, 50]之间, 采用x + 50 + 1的位置编码值.</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># 3: 相对位置编码大于50, 采用2 * 50 + 2 = 102的位置编码值.</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span> <span class="o">+</span> <span class="mi">2</span>

    <span class="c1"># 获取相对位置编码的函数</span>
    <span class="k">def</span> <span class="nf">__get_relative_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">entity_pos</span><span class="p">):</span>
        <span class="c1"># 1: 索引x在实体的左侧, 采用x - 左边界的相对位置编码</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">entity_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_pos_index</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">entity_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># 2: 索引x在实体的右侧, 采用x - 右边界的相对位置编码</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">entity_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_pos_index</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">entity_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># 3: 索引x在实体区域内, 采用0的相对位置编码</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_pos_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 将文本进行符号化的函数, 核心操作在于设定mask掩码规则</span>
    <span class="k">def</span> <span class="nf">__symbolize_sentence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e1_pos</span><span class="p">,</span> <span class="n">e2_pos</span><span class="p">,</span> <span class="n">sentence</span><span class="p">):</span>
        <span class="c1"># e1_pos (tuple) span of e1</span>
        <span class="c1"># e2_pos (tuple) span of e2</span>
        <span class="c1"># sentence (list)</span>
        <span class="c1"># 初始化mask为全1的列表</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>

        <span class="c1"># 情况1: 如果实体1在实体2的左侧. (e1, e2)</span>
        <span class="k">if</span> <span class="n">e1_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">e2_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># 下面两个for循环, 使得实体1,2的区间被赋值成2, 后面全是3, 前面全是1</span>
            <span class="c1"># 类似效果: [1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e1_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e2_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e2_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">)):</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="c1"># 情况2: 如果实体1在实体2的右侧. (e2, e1)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 下面两个for循环, 使得实体2,1的区间被赋值成2, 后面全是3, 前面全是1</span>
            <span class="c1"># 类似效果: [1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e2_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e1_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e1_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">)):</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="c1"># 初始化若干变量</span>
        <span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pos1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pos2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span>

        <span class="c1"># 进行数字化编码, 添加成列表格式</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
            <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">word2id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sentence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2id</span><span class="p">[</span><span class="s1">&#39;UNK&#39;</span><span class="p">]))</span>
            <span class="n">pos1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_relative_pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e1_pos</span><span class="p">))</span>
            <span class="n">pos2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_relative_pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e2_pos</span><span class="p">))</span>

        <span class="c1"># 进行长度的补齐操作</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">):</span>
                <span class="n">mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># &#39;PAD&#39; mask is zero</span>
                <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">word2id</span><span class="p">[</span><span class="s1">&#39;PAD&#39;</span><span class="p">])</span>

                <span class="n">pos1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_relative_pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e1_pos</span><span class="p">))</span>
                <span class="n">pos2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_relative_pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e2_pos</span><span class="p">))</span>

        <span class="c1"># 封装成numpy数组并调整shape</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">words</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">mask</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">newshape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">))</span>
        <span class="c1"># 返回封装好的数组对象</span>
        <span class="k">return</span> <span class="n">unit</span>

    <span class="c1"># 类内负责加载训练集和验证集的函数</span>
    <span class="k">def</span> <span class="nf">__load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path_data_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># 打开数据文件并遍历读取数据</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_data_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="c1"># 先将原始数据读取并提取不同字段的值</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span>
                <span class="n">sentence</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;sentence&#39;</span><span class="p">]</span>
                <span class="n">e1_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;subj_start&#39;</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;subj_end&#39;</span><span class="p">])</span>
                <span class="n">e2_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;obj_start&#39;</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;obj_end&#39;</span><span class="p">])</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">label_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel2id</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

                <span class="c1"># 核心操作在于将文本进行数字化编码</span>
                <span class="n">one_sentence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__symbolize_sentence</span><span class="p">(</span><span class="n">e1_pos</span><span class="p">,</span> <span class="n">e2_pos</span><span class="p">,</span> <span class="n">sentence</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_sentence</span><span class="p">)</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_idx</span><span class="p">)</span>

        <span class="c1"># 返回数字化文本和对应的数字化标签</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span>

    <span class="c1"># 按照索引读取数据</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span>

    <span class="c1"># 类内数据的长度测量函数</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>


<span class="c1"># 构建数据迭代器的类代码</span>
<span class="k">class</span> <span class="nc">SemEvalDataLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel2id</span><span class="p">,</span> <span class="n">word2id</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel2id</span> <span class="o">=</span> <span class="n">rel2id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word2id</span> <span class="o">=</span> <span class="n">word2id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="c1"># 创建DataLoader的&quot;个性化&quot;处理函数collate_fn()</span>
    <span class="k">def</span> <span class="nf">__collate_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span> <span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">label</span>

    <span class="c1"># 获取数据迭代器的类内函数</span>
    <span class="k">def</span> <span class="nf">__get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># 第一步: 调用构建数据集的类对象</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">SemEvalDateset</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel2id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># 第二步: 在数据集对象的基础上, 构建数据迭代器对象, 其中采用自定义的个性化处理函数</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                            <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
                            <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                            <span class="n">collate_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__collate_fn</span>
                            <span class="p">)</span>
        <span class="k">return</span> <span class="n">loader</span>

    <span class="c1"># 获取训练数据迭代器的对外接口</span>
    <span class="k">def</span> <span class="nf">get_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_data</span><span class="p">(</span><span class="s1">&#39;train.json&#39;</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 获取验证数据迭代器的对外接口(验证集使用测试集代替)</span>
    <span class="k">def</span> <span class="nf">get_dev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_data</span><span class="p">(</span><span class="s1">&#39;test.json&#39;</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># 获取测试数据迭代器的对外接口</span>
    <span class="k">def</span> <span class="nf">get_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_data</span><span class="p">(</span><span class="s1">&#39;test.json&#39;</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">Config</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="n">WordEmbeddingLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">get_vocab</span><span class="p">()</span>
    <span class="n">word_vec</span><span class="p">,</span> <span class="n">word2id</span> <span class="o">=</span> <span class="n">WordEmbeddingLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">get_embedding</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
    <span class="n">rel2id</span><span class="p">,</span> <span class="n">id2rel</span><span class="p">,</span> <span class="n">class_num</span> <span class="o">=</span> <span class="n">RelationLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">get_relation</span><span class="p">()</span>

    <span class="n">loader</span> <span class="o">=</span> <span class="n">SemEvalDataLoader</span><span class="p">(</span><span class="n">rel2id</span><span class="p">,</span> <span class="n">word2id</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_train</span><span class="p">()</span>

    <span class="n">min_v</span><span class="p">,</span> <span class="n">max_v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">),</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_loader</span><span class="p">):</span>
        <span class="c1"># print(type(data), data.shape)</span>
        <span class="c1"># print(type(label), label.shape)</span>
        <span class="c1"># break</span>
        <span class="n">pos1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="n">pos2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="n">min_v</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">max_v</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">min_v</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">max_v</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">min_v</span><span class="p">,</span> <span class="n">max_v</span><span class="p">)</span>
</code></pre></div>
<hr />
<h4 id="_4">模型类的实现<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<ul>
<li>代码路径: /home/ec2-user/information_extraction/relation/cnn_medical/model.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 导入工具包</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">init</span>


<span class="k">class</span> <span class="nc">CNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_vec</span><span class="p">,</span> <span class="n">class_num</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># 初始化关键参数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_vec</span> <span class="o">=</span> <span class="n">word_vec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_num</span> <span class="o">=</span> <span class="n">class_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">max_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_dim</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">word_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pos_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pos_dis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">filter_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">hidden_size</span>
        <span class="c1"># dim维度设置为词嵌入的维度 + 2个单词的位置编码维度</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_dim</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span>

        <span class="c1"># 1: 任意一个单词嵌入张量, 2: 第一个单词的位置嵌入张量, 3: 第二个单词的位置嵌入张量</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">word_vec</span><span class="p">,</span> <span class="n">freeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos1_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos2_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_dis</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_dim</span><span class="p">)</span>

        <span class="c1"># CNN的核心操作, 二维卷积</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">out_channels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span><span class="p">,</span>
                              <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">),</span>
                              <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                              <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                              <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span>
                              <span class="p">)</span>

        <span class="c1"># 设置最大池化层, 激活层, Dropout层</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_value</span><span class="p">)</span>

        <span class="c1"># 卷积层向下一层的映射矩阵, 从卷积核数量 -&gt; 隐藏层维度</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># 整个网络的输出层, 从隐藏层维度 -&gt; 分类数量</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dense</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_num</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 初始化网络中的一些权重</span>
        <span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos1_embedding</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos2_embedding</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">constant_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

    <span class="c1"># 编码层函数</span>
    <span class="k">def</span> <span class="nf">encoder_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">):</span>
        <span class="c1"># word_emb: [batch_size, seq_len, word_dim]</span>
        <span class="n">word_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_embedding</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="c1"># pos1_emb: [batch_size, seq_len, pos_dim]</span>
        <span class="n">pos1_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos1_embedding</span><span class="p">(</span><span class="n">pos1</span><span class="p">)</span>
        <span class="c1"># pos2_emb: [batch_size, seq_len, pos_dim]</span>
        <span class="n">pos2_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos2_embedding</span><span class="p">(</span><span class="n">pos2</span><span class="p">)</span>
        <span class="c1"># 最终的嵌入张量, 是3个子部分的简单拼接</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">tensors</span><span class="o">=</span><span class="p">[</span><span class="n">word_emb</span><span class="p">,</span> <span class="n">pos1_emb</span><span class="p">,</span> <span class="n">pos2_emb</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># emb: [batch_size, seq_len, word_dim + 2 * pos_dim]</span>
        <span class="k">return</span> <span class="n">emb</span>

    <span class="c1"># 卷积层函数</span>
    <span class="k">def</span> <span class="nf">conv_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emb</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="c1"># emb: [batch_size, 1, seq_len, dim]</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="n">emb</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># conv: [batch_size, filter_num, seq_len, 1]</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">emb</span><span class="p">)</span>

        <span class="c1"># conv: [batch_size, filter_num, seq_len]</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="c1"># mask: [batch_size, 1, seq_len]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># mask: [batch_size, filter_num, seq_len]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 所有mask张量等于0的位置, 都用&#39;-inf&#39;填充, 等效于数学上的遮掩</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">masked_fill_</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">))</span>
        <span class="c1"># conv: [batch_size, filter_num, seq_len, 1]</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conv</span>

    <span class="c1"># 最大池化的操作函数</span>
    <span class="k">def</span> <span class="nf">single_maxpool_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conv</span><span class="p">):</span>
        <span class="c1"># pool: [batch_size, filter_num, 1, 1]</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
        <span class="c1"># pool: [batch_size, filter_num]</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_num</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pool</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># 依次取出数据, 并将张量的shape转变成[X, seq_len]</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="n">pos1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="n">pos2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>

        <span class="c1"># 1: 首先进入编码器进行编码</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_layer</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">)</span>
        <span class="c1"># 2: 对输出张量进行Dropout操作</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">emb</span><span class="p">)</span>
        <span class="c1"># 3: 卷积操作是CNN的核心</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_layer</span><span class="p">(</span><span class="n">emb</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="c1"># 4: 最大池化的操作</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_maxpool_layer</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
        <span class="c1"># 5: 全连接层的映射操作</span>
        <span class="n">sentence_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
        <span class="c1"># 6: 激活层运算</span>
        <span class="n">sentence_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">sentence_feature</span><span class="p">)</span>
        <span class="c1"># 7: 再次进行Dropout操作</span>
        <span class="n">sentence_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">sentence_feature</span><span class="p">)</span>
        <span class="c1"># 8: 最后进行全连接层的映射, logits对应分类数目</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">sentence_feature</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">logits</span>
</code></pre></div>
<hr />
<h4 id="_5">训练与评估函数的实现<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<ul>
<li>评估函数代码路径: /home/ec2-user/information_extraction/relation/cnn_medical/evaluate.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 导入工具包</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">math</span>


<span class="c1"># 计算评估分数的函数</span>
<span class="k">def</span> <span class="nf">semeval_scorer</span><span class="p">(</span><span class="n">predict_label</span><span class="p">,</span> <span class="n">true_label</span><span class="p">,</span> <span class="n">class_num</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">true_label</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">predict_label</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># 设置困惑矩阵, 全零初始化即可</span>
    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">class_num</span><span class="p">,</span> <span class="n">class_num</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">xDIRx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">class_num</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># 遍历所有样本标签, 比较正确的预测, 错误的预测</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">true_label</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c1"># 获取真实标签, 预测标签</span>
        <span class="n">true_idx</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">true_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">predict_idx</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">predict_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># 构造困惑矩阵, 每正确预测一个样本, 对应的分类值+1</span>
        <span class="k">if</span> <span class="n">true_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">predict_label</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">confusion_matrix</span><span class="p">[</span><span class="n">predict_idx</span><span class="p">][</span><span class="n">true_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">true_idx</span> <span class="o">==</span> <span class="n">predict_idx</span><span class="p">:</span>
                <span class="n">xDIRx</span><span class="p">[</span><span class="n">predict_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">confusion_matrix</span><span class="p">[</span><span class="n">predict_idx</span><span class="p">][</span><span class="n">true_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">col_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">row_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">class_num</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># 忽略掉&#39;Other&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">class_num</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">col_sum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">xDIRx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">row_sum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">xDIRx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">f1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">p</span> <span class="o">*</span> <span class="n">r</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">r</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">actual_class</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_f1</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">class_num</span><span class="p">):</span>
        <span class="c1"># 不在预测标签中的分类, 不做考虑</span>
        <span class="k">if</span> <span class="n">f1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">actual_class</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">total_f1</span> <span class="o">+=</span> <span class="n">f1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># 防止除零错误</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">macro_f1</span> <span class="o">=</span> <span class="n">total_f1</span> <span class="o">/</span> <span class="n">actual_class</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">macro_f1</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">macro_f1</span>


<span class="c1"># 构建评估类的代码</span>
<span class="k">class</span> <span class="nc">Eval</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">device</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">):</span>
        <span class="n">predict_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">true_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># 评估阶段, 设置评估模式, 并且不进行反向传播和梯度计算</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="c1"># print(&#39;data.shape:&#39;, data.shape)</span>
                <span class="c1"># print(&#39;label:&#39;, label)</span>

                <span class="c1"># 将输入送入模型, 得到概率分布输出, 计算损失值</span>
                <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># print(&#39;logits:&#39;, logits)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># print(&#39;pred:&#39;, pred)</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="c1"># print(&#39;pred1:&#39;, pred)</span>
                <span class="c1"># print(&#39;******&#39;)</span>
                <span class="n">predict_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
                <span class="n">true_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># 将所有batch的预测结果和真实结果, 进行拼接</span>
        <span class="n">predict_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">predict_label</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">true_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">true_label</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">eval_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="n">predict_label</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 调用上面的评估分数函数, 得到测试集上总体的F1值</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">semeval_scorer</span><span class="p">(</span><span class="n">predict_label</span><span class="p">,</span> <span class="n">true_label</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f1</span><span class="p">,</span> <span class="n">eval_loss</span><span class="p">,</span> <span class="n">predict_label</span>
</code></pre></div>
<hr />
<ul>
<li>训练函数代码路径: /home/ec2-user/information_extraction/relation/cnn_medical/run.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 导入工具包</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">WordEmbeddingLoader</span><span class="p">,</span> <span class="n">RelationLoader</span><span class="p">,</span> <span class="n">SemEvalDataLoader</span>
<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">CNN</span>
<span class="kn">from</span> <span class="nn">evaluate</span> <span class="kn">import</span> <span class="n">Eval</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>


<span class="c1"># 将推理后的结果写入文件中</span>
<span class="k">def</span> <span class="nf">print_result</span><span class="p">(</span><span class="n">predict_label</span><span class="p">,</span> <span class="n">id2rel</span><span class="p">,</span> <span class="n">start_idx</span><span class="o">=</span><span class="mi">8001</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;predicted_result.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">predict_label</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">start_idx</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">id2rel</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">predict_label</span><span class="p">[</span><span class="n">i</span><span class="p">])]))</span>


<span class="c1"># 模型的总体训练函数</span>
<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">train_loader</span><span class="p">,</span> <span class="n">dev_loader</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">loader</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">L2_decay</span><span class="p">)</span>

    <span class="c1"># 下面7行代码为显示信息的调试代码, 上线后可以注释掉</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;traning model parameters:&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> :  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start to train the model ...&#39;</span><span class="p">)</span>

    <span class="c1"># 评估类的对象, 用于对模型预测结果计算F1值</span>
    <span class="n">eval_tool</span> <span class="o">=</span> <span class="n">Eval</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">max_f1</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="c1"># 双重for循环模式进行训练</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="c1"># 经典的&quot;老三样&quot; + 模型前向计算 + 损失值计算</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

            <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># 每一个epoch结束后, 进行一轮训练集的评估和验证集的评估</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">eval_tool</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">)</span>
        <span class="n">f1</span><span class="p">,</span> <span class="n">dev_loss</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">eval_tool</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">dev_loader</span><span class="p">)</span>

        <span class="c1"># 将关键评估结果打印出来</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%03d</span><span class="s1">] train_loss: </span><span class="si">%.3f</span><span class="s1"> | dev_loss: </span><span class="si">%.3f</span><span class="s1"> | micro f1 on dev: </span><span class="si">%.4f</span><span class="s1">&#39;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="n">dev_loss</span><span class="p">,</span> <span class="n">f1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="c1"># 以F1值作为标准, 将表现最优的模型保存下来</span>
        <span class="k">if</span> <span class="n">f1</span> <span class="o">&gt;</span> <span class="n">max_f1</span><span class="p">:</span>
            <span class="n">max_f1</span> <span class="o">=</span> <span class="n">f1</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;model.pt&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; save models!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>


<span class="c1"># 测试函数</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start test ...&#39;</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">loader</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;model.pt&#39;</span><span class="p">)))</span>

    <span class="n">eval_tool</span> <span class="o">=</span> <span class="n">Eval</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">f1</span><span class="p">,</span> <span class="n">test_loss</span><span class="p">,</span> <span class="n">predict_label</span> <span class="o">=</span> <span class="n">eval_tool</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;test_loss: </span><span class="si">%.3f</span><span class="s1"> | micro f1 on test:  </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_loss</span><span class="p">,</span> <span class="n">f1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">predict_label</span>


<span class="c1"># 最外层接口, 调起全部函数</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;some config:&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">print_config</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start to load data ...&#39;</span><span class="p">)</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="n">WordEmbeddingLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">get_vocab</span><span class="p">()</span>
    <span class="n">word_vec</span><span class="p">,</span> <span class="n">word2id</span> <span class="o">=</span> <span class="n">WordEmbeddingLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">get_embedding</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
    <span class="n">rel2id</span><span class="p">,</span> <span class="n">id2rel</span><span class="p">,</span> <span class="n">class_num</span> <span class="o">=</span> <span class="n">RelationLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">get_relation</span><span class="p">()</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">SemEvalDataLoader</span><span class="p">(</span><span class="n">rel2id</span><span class="p">,</span> <span class="n">word2id</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="n">train_loader</span><span class="p">,</span> <span class="n">dev_loader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># mode设置为1, 代表训练模式</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">train_loader</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_train</span><span class="p">()</span>
        <span class="n">dev_loader</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_dev</span><span class="p">()</span>
    <span class="n">test_loader</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_test</span><span class="p">()</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="p">[</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">dev_loader</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;finish!&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">CNN</span><span class="p">(</span><span class="n">word_vec</span><span class="o">=</span><span class="n">word_vec</span><span class="p">,</span> <span class="n">class_num</span><span class="o">=</span><span class="n">class_num</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>

    <span class="c1"># model等于1, 处于训练模式</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="c1"># 对模型进行测试并打印结果文件</span>
    <span class="n">predict_label</span> <span class="o">=</span> <span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">criterion</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">print_result</span><span class="p">(</span><span class="n">predict_label</span><span class="p">,</span> <span class="n">id2rel</span><span class="p">)</span>
</code></pre></div>
<hr />
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre><span></span><code>python run.py
</code></pre></div>
<hr />
<ul>
<li>输出结果:</li>
</ul>
<div class="highlight"><pre><span></span><code>some config:
data_dir = ./data
output_dir = ./output
train_raw = ./data/CMeIE_train.json
embedding_path = ./embedding/sgns.weibo.word.bz2
vocab_size = 30000
word_dim = 300
model_name = CNN
mode = 1
seed = 5782
cuda = 0
epoch = 50
dropout = 0.5
batch_size = 64
lr = 0.001
max_len = 100
pos_dis = 50
pos_dim = 5
hidden_size = 128
filter_num = 256
window = 3
L2_decay = 1e-05
device = cuda:0
model_dir = ./output/CNN
--------------------------------------
start to load data ...
Building prefix dict from the default dictionary ...
Loading model from cache /tmp/jieba.cache
Loading model cost 0.760 seconds.
Prefix dict has been built successfully.
processing embedding file ...
b&#39;195202&#39; tokens in embedding file in total, vector size is b&#39;300&#39;
100%|███████████████████████████████████████████████████████████| 195202/195202 [00:03&lt;00:00, 55842.67it/s]
finish!
--------------------------------------
CNN(
  (word_embedding): Embedding(11723, 300)
  (pos1_embedding): Embedding(103, 5)
  (pos2_embedding): Embedding(103, 5)
  (conv): Conv2d(1, 256, kernel_size=(3, 310), stride=(1, 1), padding=(1, 0))
  (maxpool): MaxPool2d(kernel_size=(100, 1), stride=(100, 1), padding=0, dilation=1, ceil_mode=False)
  (tanh): Tanh()
  (dropout): Dropout(p=0.5, inplace=False)
  (linear): Linear(in_features=256, out_features=128, bias=True)
  (dense): Linear(in_features=128, out_features=53, bias=True)
)
traning model parameters:
word_embedding.weight :  torch.Size([11723, 300])
pos1_embedding.weight :  torch.Size([103, 5])
pos2_embedding.weight :  torch.Size([103, 5])
conv.weight :  torch.Size([256, 1, 3, 310])
conv.bias :  torch.Size([256])
linear.weight :  torch.Size([128, 256])
linear.bias :  torch.Size([128])
dense.weight :  torch.Size([53, 128])
dense.bias :  torch.Size([53])
--------------------------------------
start to train the model ...
756it [00:01, 400.37it/s]                                                           | 0/50 [00:00&lt;?, ?it/s]
93it [00:00, 321.20it/s]]
[001] train_loss: 0.825 | dev_loss: 1.145 | micro f1 on dev: 0.6200 &gt;&gt;&gt; save models!
756it [00:01, 401.55it/s]                                                   | 1/50 [00:08&lt;07:03,  8.64s/it]
93it [00:00, 323.06it/s]]
[002] train_loss: 0.466 | dev_loss: 0.999 | micro f1 on dev: 0.6643 &gt;&gt;&gt; save models!
756it [00:01, 400.84it/s]                                                   | 2/50 [00:16&lt;06:49,  8.53s/it]
93it [00:00, 314.22it/s]]
[003] train_loss: 0.314 | dev_loss: 0.955 | micro f1 on dev: 0.7100 &gt;&gt;&gt; save models!
756it [00:01, 401.99it/s]                                                   | 3/50 [00:25&lt;06:37,  8.46s/it]
93it [00:00, 323.06it/s]]
[004] train_loss: 0.239 | dev_loss: 0.994 | micro f1 on dev: 0.7169 &gt;&gt;&gt; save models!
756it [00:01, 396.38it/s]                                                   | 4/50 [00:33&lt;06:28,  8.44s/it]
93it [00:00, 323.16it/s]]
[005] train_loss: 0.196 | dev_loss: 0.973 | micro f1 on dev: 0.7198 &gt;&gt;&gt; save models!
756it [00:01, 389.98it/s]                                                   | 5/50 [00:41&lt;06:18,  8.41s/it]
93it [00:00, 320.01it/s]]
[006] train_loss: 0.154 | dev_loss: 0.999 | micro f1 on dev: 0.7152 
756it [00:01, 400.31it/s]                                                   | 6/50 [00:50&lt;06:08,  8.38s/it]
93it [00:00, 316.25it/s]]
[007] train_loss: 0.136 | dev_loss: 0.999 | micro f1 on dev: 0.7112 
756it [00:01, 400.90it/s]                                                   | 7/50 [00:58&lt;05:58,  8.34s/it]
93it [00:00, 323.26it/s]]
[008] train_loss: 0.122 | dev_loss: 1.039 | micro f1 on dev: 0.7243 &gt;&gt;&gt; save models!
756it [00:01, 388.92it/s]                                                   | 8/50 [01:06&lt;05:50,  8.34s/it]
93it [00:00, 316.58it/s]]
[009] train_loss: 0.102 | dev_loss: 1.059 | micro f1 on dev: 0.7322 &gt;&gt;&gt; save models!
756it [00:01, 390.39it/s]                                                   | 9/50 [01:15&lt;05:42,  8.36s/it]
93it [00:00, 323.51it/s]]
[010] train_loss: 0.094 | dev_loss: 1.063 | micro f1 on dev: 0.7156 
756it [00:01, 395.49it/s]                                                  | 10/50 [01:23&lt;05:34,  8.35s/it]
93it [00:00, 326.63it/s]]
[011] train_loss: 0.084 | dev_loss: 1.090 | micro f1 on dev: 0.7295 
756it [00:01, 399.23it/s]                                                  | 11/50 [01:31&lt;05:24,  8.33s/it]
93it [00:00, 308.80it/s]]
[012] train_loss: 0.078 | dev_loss: 1.089 | micro f1 on dev: 0.7195 
756it [00:01, 393.74it/s]                                                  | 12/50 [01:40&lt;05:16,  8.33s/it]
93it [00:00, 309.83it/s]]
[013] train_loss: 0.069 | dev_loss: 1.143 | micro f1 on dev: 0.7288 
756it [00:01, 388.05it/s]                                                  | 13/50 [01:48&lt;05:08,  8.34s/it]
93it [00:00, 312.54it/s]]
[014] train_loss: 0.067 | dev_loss: 1.195 | micro f1 on dev: 0.7193 
756it [00:01, 391.20it/s]                                                  | 14/50 [01:56&lt;05:00,  8.34s/it]
93it [00:00, 314.68it/s]]
[015] train_loss: 0.059 | dev_loss: 1.144 | micro f1 on dev: 0.7165 
756it [00:01, 393.72it/s]█                                                 | 15/50 [02:05&lt;04:52,  8.35s/it]
93it [00:00, 320.70it/s]]
[016] train_loss: 0.056 | dev_loss: 1.148 | micro f1 on dev: 0.6821 
756it [00:01, 382.80it/s]██▍                                               | 16/50 [02:13&lt;04:44,  8.35s/it]
93it [00:00, 318.80it/s]]
[017] train_loss: 0.053 | dev_loss: 1.123 | micro f1 on dev: 0.7317 
756it [00:01, 391.59it/s]███▊                                              | 17/50 [02:22&lt;04:36,  8.37s/it]
93it [00:00, 320.01it/s]]
[018] train_loss: 0.050 | dev_loss: 1.156 | micro f1 on dev: 0.7513 &gt;&gt;&gt; save models!
756it [00:01, 390.35it/s]█████▏                                            | 18/50 [02:30&lt;04:29,  8.41s/it]
93it [00:00, 314.89it/s]]
[019] train_loss: 0.046 | dev_loss: 1.125 | micro f1 on dev: 0.7299 
756it [00:01, 384.87it/s]██████▌                                           | 19/50 [02:38&lt;04:20,  8.41s/it]
93it [00:00, 319.72it/s]]
[020] train_loss: 0.045 | dev_loss: 1.172 | micro f1 on dev: 0.7255 
756it [00:01, 386.72it/s]████████                                          | 20/50 [02:47&lt;04:12,  8.41s/it]
93it [00:00, 318.43it/s]]
[021] train_loss: 0.040 | dev_loss: 1.195 | micro f1 on dev: 0.7018 
756it [00:01, 395.28it/s]█████████▍                                        | 21/50 [02:55&lt;04:04,  8.43s/it]
93it [00:00, 318.02it/s]]
[022] train_loss: 0.043 | dev_loss: 1.178 | micro f1 on dev: 0.7164 
756it [00:01, 390.67it/s]██████████▊                                       | 22/50 [03:04&lt;03:55,  8.41s/it]
93it [00:00, 315.83it/s]]
[023] train_loss: 0.038 | dev_loss: 1.153 | micro f1 on dev: 0.7326 
756it [00:01, 390.15it/s]████████████▏                                     | 23/50 [03:12&lt;03:47,  8.42s/it]
93it [00:00, 320.54it/s]]
[024] train_loss: 0.035 | dev_loss: 1.191 | micro f1 on dev: 0.7195 
756it [00:01, 390.48it/s]█████████████▌                                    | 24/50 [03:21&lt;03:38,  8.42s/it]
93it [00:00, 315.26it/s]]
[025] train_loss: 0.033 | dev_loss: 1.187 | micro f1 on dev: 0.7206 
756it [00:01, 384.46it/s]███████████████                                   | 25/50 [03:29&lt;03:30,  8.43s/it]
93it [00:00, 315.56it/s]]
[026] train_loss: 0.030 | dev_loss: 1.191 | micro f1 on dev: 0.7059 
756it [00:01, 392.18it/s]████████████████▍                                 | 26/50 [03:37&lt;03:22,  8.44s/it]
93it [00:00, 304.06it/s]]
[027] train_loss: 0.030 | dev_loss: 1.185 | micro f1 on dev: 0.7271 
756it [00:01, 389.80it/s]█████████████████▊                                | 27/50 [03:46&lt;03:14,  8.44s/it]
93it [00:00, 310.55it/s]]
[028] train_loss: 0.030 | dev_loss: 1.193 | micro f1 on dev: 0.7057 
756it [00:01, 379.01it/s]███████████████████▏                              | 28/50 [03:54&lt;03:05,  8.45s/it]
93it [00:00, 312.63it/s]]
[029] train_loss: 0.028 | dev_loss: 1.243 | micro f1 on dev: 0.7497 
756it [00:01, 387.16it/s]████████████████████▌                             | 29/50 [04:03&lt;02:57,  8.47s/it]
93it [00:00, 310.71it/s]]
[030] train_loss: 0.029 | dev_loss: 1.235 | micro f1 on dev: 0.7416 
756it [00:01, 387.02it/s]██████████████████████                            | 30/50 [04:11&lt;02:49,  8.47s/it]
93it [00:00, 321.98it/s]]
[031] train_loss: 0.026 | dev_loss: 1.230 | micro f1 on dev: 0.7244 
756it [00:01, 388.13it/s]███████████████████████▍                          | 31/50 [04:20&lt;02:40,  8.47s/it]
93it [00:00, 319.43it/s]]
[032] train_loss: 0.028 | dev_loss: 1.226 | micro f1 on dev: 0.7267 
756it [00:01, 387.05it/s]████████████████████████▊                         | 32/50 [04:28&lt;02:32,  8.46s/it]
93it [00:00, 315.43it/s]]
[033] train_loss: 0.025 | dev_loss: 1.246 | micro f1 on dev: 0.7370 
756it [00:01, 390.52it/s]██████████████████████████▏                       | 33/50 [04:37&lt;02:24,  8.47s/it]
93it [00:00, 320.73it/s]]
[034] train_loss: 0.023 | dev_loss: 1.216 | micro f1 on dev: 0.7383 
756it [00:01, 380.61it/s]███████████████████████████▌                      | 34/50 [04:45&lt;02:15,  8.47s/it]
93it [00:00, 303.98it/s]]
[035] train_loss: 0.022 | dev_loss: 1.253 | micro f1 on dev: 0.7239 
756it [00:01, 384.96it/s]█████████████████████████████                     | 35/50 [04:54&lt;02:07,  8.49s/it]
93it [00:00, 320.49it/s]]
[036] train_loss: 0.025 | dev_loss: 1.306 | micro f1 on dev: 0.7067 
756it [00:01, 386.49it/s]██████████████████████████████▍                   | 36/50 [05:02&lt;01:58,  8.49s/it]
93it [00:00, 316.58it/s]]
[037] train_loss: 0.021 | dev_loss: 1.293 | micro f1 on dev: 0.7109 
756it [00:01, 389.53it/s]███████████████████████████████▊                  | 37/50 [05:11&lt;01:50,  8.48s/it]
93it [00:00, 312.16it/s]]
[038] train_loss: 0.021 | dev_loss: 1.264 | micro f1 on dev: 0.7156 
756it [00:01, 384.69it/s]█████████████████████████████████▏                | 38/50 [05:19&lt;01:41,  8.48s/it]
93it [00:00, 314.61it/s]]
[039] train_loss: 0.020 | dev_loss: 1.275 | micro f1 on dev: 0.7333 
756it [00:01, 389.65it/s]██████████████████████████████████▌               | 39/50 [05:28&lt;01:33,  8.48s/it]
93it [00:00, 314.57it/s]]
[040] train_loss: 0.024 | dev_loss: 1.233 | micro f1 on dev: 0.7171 
756it [00:01, 384.13it/s]████████████████████████████████████              | 40/50 [05:36&lt;01:24,  8.47s/it]
93it [00:00, 306.72it/s]]
[041] train_loss: 0.019 | dev_loss: 1.287 | micro f1 on dev: 0.7411 
756it [00:01, 390.68it/s]█████████████████████████████████████▍            | 41/50 [05:45&lt;01:16,  8.48s/it]
93it [00:00, 318.88it/s]]
[042] train_loss: 0.021 | dev_loss: 1.321 | micro f1 on dev: 0.7298 
756it [00:01, 389.55it/s]██████████████████████████████████████▊           | 42/50 [05:53&lt;01:07,  8.47s/it]
93it [00:00, 320.90it/s]]
[043] train_loss: 0.018 | dev_loss: 1.256 | micro f1 on dev: 0.7520 &gt;&gt;&gt; save models!
756it [00:01, 392.47it/s]████████████████████████████████████████▏         | 43/50 [06:02&lt;00:59,  8.51s/it]
93it [00:00, 312.12it/s]]
[044] train_loss: 0.018 | dev_loss: 1.284 | micro f1 on dev: 0.7397 
756it [00:01, 382.02it/s]█████████████████████████████████████████▌        | 44/50 [06:10&lt;00:50,  8.50s/it]
93it [00:00, 316.05it/s]]
[045] train_loss: 0.018 | dev_loss: 1.250 | micro f1 on dev: 0.7342 
756it [00:01, 384.63it/s]███████████████████████████████████████████       | 45/50 [06:19&lt;00:42,  8.51s/it]
93it [00:00, 316.54it/s]]
[046] train_loss: 0.018 | dev_loss: 1.288 | micro f1 on dev: 0.7446 
756it [00:01, 387.57it/s]████████████████████████████████████████████▍     | 46/50 [06:27&lt;00:34,  8.50s/it]
93it [00:00, 309.89it/s]]
[047] train_loss: 0.017 | dev_loss: 1.250 | micro f1 on dev: 0.7419 
756it [00:01, 385.43it/s]█████████████████████████████████████████████▊    | 47/50 [06:36&lt;00:25,  8.49s/it]
93it [00:00, 312.21it/s]]
[048] train_loss: 0.018 | dev_loss: 1.282 | micro f1 on dev: 0.7186 
756it [00:01, 381.55it/s]███████████████████████████████████████████████▏  | 48/50 [06:44&lt;00:16,  8.49s/it]
93it [00:00, 310.74it/s]]
[049] train_loss: 0.016 | dev_loss: 1.321 | micro f1 on dev: 0.7359 
756it [00:01, 387.89it/s]████████████████████████████████████████████████▌ | 49/50 [06:53&lt;00:08,  8.51s/it]
93it [00:00, 314.01it/s]]
[050] train_loss: 0.017 | dev_loss: 1.296 | micro f1 on dev: 0.7193 
100%|██████████████████████████████████████████████████████████████████████| 50/50 [07:01&lt;00:00,  8.43s/it]
--------------------------------------
start test ...
93it [00:00, 301.00it/s]
test_loss: 1.256 | micro f1 on test:  0.7520
</code></pre></div>
<hr />
<blockquote>
<ul>
<li>思考: 对于当前项目中的53种关系抽取模型, f1达到75.20%算好的表现吗?</li>
</ul>
</blockquote>
<hr />
<h4 id="_6">推理代码的实现<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<ul>
<li>代码路径: /home/ec2-user/information_extraction/relation/cnn_medical/predict.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">CNN</span>


<span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>

<span class="n">vocab</span> <span class="o">=</span> <span class="n">WordEmbeddingLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">get_vocab</span><span class="p">()</span>
<span class="n">word_vec</span><span class="p">,</span> <span class="n">word2id</span> <span class="o">=</span> <span class="n">WordEmbeddingLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">get_embedding</span><span class="p">(</span><span class="n">vocab</span><span class="p">)</span>
<span class="n">rel2id</span><span class="p">,</span> <span class="n">id2rel</span><span class="p">,</span> <span class="n">class_num</span> <span class="o">=</span> <span class="n">RelationLoader</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">get_relation</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_pos_index</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># pos_dis默认值为50, 已在config.py文件中设置.</span>
    <span class="c1"># 1: 相对位置编码小于-50, 直接返回位置编码0.</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">pos_dis</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># 2: 相对位置编码[-50, 50]之间, 采用x + 50 + 1的位置编码值.</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">pos_dis</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">pos_dis</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">pos_dis</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># 3: 相对位置编码大于50, 采用2 * 50 + 2 = 102的位置编码值.</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">pos_dis</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">pos_dis</span> <span class="o">+</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">get_relative_pos</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">entity_pos</span><span class="p">):</span>
    <span class="c1"># 1: 索引x在实体的左侧, 采用x - 左边界的相对位置编码</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">entity_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">get_pos_index</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">entity_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># 2: 索引x在实体的右侧, 采用x - 右边界的相对位置编码</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">entity_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">get_pos_index</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">entity_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># 3: 索引x在实体区域内, 采用0的相对位置编码</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_pos_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">preprocess_sentence</span><span class="p">(</span><span class="n">e1_pos</span><span class="p">,</span> <span class="n">e2_pos</span><span class="p">,</span> <span class="n">sentence</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">e1_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">e2_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e1_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e2_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e2_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">)):</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e2_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e1_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">e1_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">)):</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="n">words</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word2id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sentence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">word2id</span><span class="p">[</span><span class="s1">&#39;UNK&#39;</span><span class="p">]))</span>
        <span class="n">pos1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_relative_pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e1_pos</span><span class="p">))</span>
        <span class="n">pos2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_relative_pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e2_pos</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">max_len</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">max_len</span><span class="p">):</span>
            <span class="n">mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word2id</span><span class="p">[</span><span class="s1">&#39;PAD&#39;</span><span class="p">])</span>

            <span class="n">pos1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_relative_pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e1_pos</span><span class="p">))</span>
            <span class="n">pos2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_relative_pos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e2_pos</span><span class="p">))</span>

    <span class="n">unit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">words</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">mask</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">newshape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">max_len</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">unit</span>


<span class="n">s1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">CNN</span><span class="p">(</span><span class="n">word_vec</span><span class="o">=</span><span class="n">word_vec</span><span class="p">,</span> <span class="n">class_num</span><span class="o">=</span><span class="n">class_num</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="s1">&#39;model.pt&#39;</span><span class="p">)))</span>
<span class="n">e1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;init model cost time:&#39;</span><span class="p">,</span> <span class="n">e1</span> <span class="o">-</span> <span class="n">s1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">sentence</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sentence&#39;</span><span class="p">]</span>
    <span class="n">e1_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;subject_start&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;subject_end&#39;</span><span class="p">])</span>
    <span class="n">e2_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;object_start&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;object_end&#39;</span><span class="p">])</span>

    <span class="n">one_sentence</span> <span class="o">=</span> <span class="n">preprocess_sentence</span><span class="p">(</span><span class="n">e1_pos</span><span class="p">,</span> <span class="n">e2_pos</span><span class="p">,</span> <span class="n">sentence</span><span class="p">)</span>

    <span class="c1"># input_data: [1, 4, 100]</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">one_sentence</span><span class="p">)</span>

    <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pred_id</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">pred_rel</span> <span class="o">=</span> <span class="n">id2rel</span><span class="p">[</span><span class="n">pred_id</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pred_rel</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;subject_start&quot;</span><span class="p">:</span> <span class="mi">117</span><span class="p">,</span> <span class="s2">&quot;subject_end&quot;</span><span class="p">:</span> <span class="mi">119</span><span class="p">,</span> <span class="s2">&quot;object_start&quot;</span><span class="p">:</span> <span class="mi">163</span><span class="p">,</span> <span class="s2">&quot;object_end&quot;</span><span class="p">:</span> <span class="mi">166</span><span class="p">,</span> <span class="s2">&quot;sentence&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;脑&quot;</span><span class="p">,</span> <span class="s2">&quot;炎&quot;</span><span class="p">,</span> <span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;局&quot;</span><span class="p">,</span> <span class="s2">&quot;灶&quot;</span><span class="p">,</span> <span class="s2">&quot;性&quot;</span><span class="p">,</span> <span class="s2">&quot;神&quot;</span><span class="p">,</span> <span class="s2">&quot;经&quot;</span><span class="p">,</span> <span class="s2">&quot;功&quot;</span><span class="p">,</span> <span class="s2">&quot;能&quot;</span><span class="p">,</span> <span class="s2">&quot;障&quot;</span><span class="p">,</span> <span class="s2">&quot;碍&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;包&quot;</span><span class="p">,</span> <span class="s2">&quot;括&quot;</span><span class="p">,</span> <span class="s2">&quot;失&quot;</span><span class="p">,</span> <span class="s2">&quot;语&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;偏&quot;</span><span class="p">,</span> <span class="s2">&quot;盲&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;偏&quot;</span><span class="p">,</span> <span class="s2">&quot;瘫&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;共&quot;</span><span class="p">,</span> <span class="s2">&quot;济&quot;</span><span class="p">,</span> <span class="s2">&quot;失&quot;</span><span class="p">,</span> <span class="s2">&quot;调&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;腱&quot;</span><span class="p">,</span> <span class="s2">&quot;反&quot;</span><span class="p">,</span> <span class="s2">&quot;射&quot;</span><span class="p">,</span> <span class="s2">&quot;减&quot;</span><span class="p">,</span> <span class="s2">&quot;弱&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;巴&quot;</span><span class="p">,</span> <span class="s2">&quot;彬&quot;</span><span class="p">,</span> <span class="s2">&quot;斯&quot;</span><span class="p">,</span> <span class="s2">&quot;基&quot;</span><span class="p">,</span> <span class="s2">&quot;征&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;颅&quot;</span><span class="p">,</span> <span class="s2">&quot;神&quot;</span><span class="p">,</span> <span class="s2">&quot;经&quot;</span><span class="p">,</span> <span class="s2">&quot;功&quot;</span><span class="p">,</span> <span class="s2">&quot;能&quot;</span><span class="p">,</span> <span class="s2">&quot;缺&quot;</span><span class="p">,</span> <span class="s2">&quot;陷&quot;</span><span class="p">,</span> <span class="s2">&quot;（&quot;</span><span class="p">,</span> <span class="s2">&quot;可&quot;</span><span class="p">,</span> <span class="s2">&quot;见&quot;</span><span class="p">,</span> <span class="s2">&quot;于&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;，&quot;</span><span class="p">,</span> <span class="s2">&quot;结&quot;</span><span class="p">,</span> <span class="s2">&quot;核&quot;</span><span class="p">,</span> <span class="s2">&quot;病&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;梅&quot;</span><span class="p">,</span> <span class="s2">&quot;毒&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;布&quot;</span><span class="p">,</span> <span class="s2">&quot;氏&quot;</span><span class="p">,</span> <span class="s2">&quot;菌&quot;</span><span class="p">,</span> <span class="s2">&quot;病&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;急&quot;</span><span class="p">,</span> <span class="s2">&quot;性&quot;</span><span class="p">,</span> <span class="s2">&quot;播&quot;</span><span class="p">,</span> <span class="s2">&quot;散&quot;</span><span class="p">,</span> <span class="s2">&quot;性&quot;</span><span class="p">,</span> <span class="s2">&quot;脑&quot;</span><span class="p">,</span> <span class="s2">&quot;脊&quot;</span><span class="p">,</span> <span class="s2">&quot;髓&quot;</span><span class="p">,</span> <span class="s2">&quot;炎&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;西&quot;</span><span class="p">,</span> <span class="s2">&quot;尼&quot;</span><span class="p">,</span> <span class="s2">&quot;罗&quot;</span><span class="p">,</span> <span class="s2">&quot;河&quot;</span><span class="p">,</span> <span class="s2">&quot;病&quot;</span><span class="p">,</span> <span class="s2">&quot;毒&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;圣&quot;</span><span class="p">,</span> <span class="s2">&quot;路&quot;</span><span class="p">,</span> <span class="s2">&quot;易&quot;</span><span class="p">,</span> <span class="s2">&quot;斯&quot;</span><span class="p">,</span> <span class="s2">&quot;脑&quot;</span><span class="p">,</span> <span class="s2">&quot;炎&quot;</span><span class="p">,</span> <span class="s2">&quot;病&quot;</span><span class="p">,</span> <span class="s2">&quot;毒&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;水&quot;</span><span class="p">,</span> <span class="s2">&quot;痘&quot;</span><span class="p">,</span> <span class="s2">&quot;带&quot;</span><span class="p">,</span> <span class="s2">&quot;状&quot;</span><span class="p">,</span> <span class="s2">&quot;疱&quot;</span><span class="p">,</span> <span class="s2">&quot;疹&quot;</span><span class="p">,</span> <span class="s2">&quot;病&quot;</span><span class="p">,</span> <span class="s2">&quot;毒&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;乙&quot;</span><span class="p">,</span> <span class="s2">&quot;型&quot;</span><span class="p">,</span> <span class="s2">&quot;疱&quot;</span><span class="p">,</span> <span class="s2">&quot;疹&quot;</span><span class="p">,</span> <span class="s2">&quot;病&quot;</span><span class="p">,</span> <span class="s2">&quot;毒&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;狂&quot;</span><span class="p">,</span> <span class="s2">&quot;犬&quot;</span><span class="p">,</span> <span class="s2">&quot;病&quot;</span><span class="p">,</span> <span class="s2">&quot;）&quot;</span><span class="p">,</span> <span class="s2">&quot;；&quot;</span><span class="p">,</span> <span class="s2">&quot;震&quot;</span><span class="p">,</span> <span class="s2">&quot;颤&quot;</span><span class="p">,</span> <span class="s2">&quot;（&quot;</span><span class="p">,</span> <span class="s2">&quot;虫&quot;</span><span class="p">,</span> <span class="s2">&quot;媒&quot;</span><span class="p">,</span> <span class="s2">&quot;病&quot;</span><span class="p">,</span> <span class="s2">&quot;毒&quot;</span><span class="p">,</span> <span class="s2">&quot;）&quot;</span><span class="p">,</span> <span class="s2">&quot;；&quot;</span><span class="p">,</span> <span class="s2">&quot;肌&quot;</span><span class="p">,</span> <span class="s2">&quot;阵&quot;</span><span class="p">,</span> <span class="s2">&quot;挛&quot;</span><span class="p">,</span> <span class="s2">&quot;（&quot;</span><span class="p">,</span> <span class="s2">&quot;亚&quot;</span><span class="p">,</span> <span class="s2">&quot;急&quot;</span><span class="p">,</span> <span class="s2">&quot;性&quot;</span><span class="p">,</span> <span class="s2">&quot;硬&quot;</span><span class="p">,</span> <span class="s2">&quot;化&quot;</span><span class="p">,</span> <span class="s2">&quot;性&quot;</span><span class="p">,</span> <span class="s2">&quot;全&quot;</span><span class="p">,</span> <span class="s2">&quot;脑&quot;</span><span class="p">,</span> <span class="s2">&quot;炎&quot;</span><span class="p">,</span> <span class="s2">&quot;）&quot;</span><span class="p">,</span> <span class="s2">&quot;；&quot;</span><span class="p">,</span> <span class="s2">&quot;感&quot;</span><span class="p">,</span> <span class="s2">&quot;觉&quot;</span><span class="p">,</span> <span class="s2">&quot;异&quot;</span><span class="p">,</span> <span class="s2">&quot;常&quot;</span><span class="p">,</span> <span class="s2">&quot;（&quot;</span><span class="p">,</span> <span class="s2">&quot;科&quot;</span><span class="p">,</span> <span class="s2">&quot;罗&quot;</span><span class="p">,</span> <span class="s2">&quot;拉&quot;</span><span class="p">,</span> <span class="s2">&quot;多&quot;</span><span class="p">,</span> <span class="s2">&quot;蜱&quot;</span><span class="p">,</span> <span class="s2">&quot;热&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;狂&quot;</span><span class="p">,</span> <span class="s2">&quot;犬&quot;</span><span class="p">,</span> <span class="s2">&quot;病&quot;</span><span class="p">,</span> <span class="s2">&quot;）&quot;</span><span class="p">,</span> <span class="s2">&quot;；&quot;</span><span class="p">,</span> <span class="s2">&quot;全&quot;</span><span class="p">,</span> <span class="s2">&quot;身&quot;</span><span class="p">,</span> <span class="s2">&quot;虚&quot;</span><span class="p">,</span> <span class="s2">&quot;弱&quot;</span><span class="p">,</span> <span class="s2">&quot;（&quot;</span><span class="p">,</span> <span class="s2">&quot;西&quot;</span><span class="p">,</span> <span class="s2">&quot;尼&quot;</span><span class="p">,</span> <span class="s2">&quot;罗&quot;</span><span class="p">,</span> <span class="s2">&quot;河&quot;</span><span class="p">,</span> <span class="s2">&quot;病&quot;</span><span class="p">,</span> <span class="s2">&quot;毒&quot;</span><span class="p">,</span> <span class="s2">&quot;、&quot;</span><span class="p">,</span> <span class="s2">&quot;狂&quot;</span><span class="p">,</span> <span class="s2">&quot;犬&quot;</span><span class="p">,</span> <span class="s2">&quot;病&quot;</span><span class="p">,</span> <span class="s2">&quot;）&quot;</span><span class="p">,</span> <span class="s2">&quot;。&quot;</span><span class="p">]}</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;res=&#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;prediction time:&#39;</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
</code></pre></div>
<hr />
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre><span></span><code>python predict.py
</code></pre></div>
<hr />
<ul>
<li>输出结果:</li>
</ul>
<div class="highlight"><pre><span></span><code>Building prefix dict from the default dictionary ...
Loading model from cache /tmp/jieba.cache
Loading model cost 0.754 seconds.
Prefix dict has been built successfully.
processing embedding file ...
b&#39;195202&#39; tokens in embedding file in total, vector size is b&#39;300&#39;
100%|██████████████████████████████████████████████████████████| 195202/195202 [00:03&lt;00:00, 55853.24it/s]
init model cost time: 2.119168996810913
res= 临床表现
prediction time: 0.0063593387603759766
</code></pre></div>
<hr />
<hr />
<h3 id="_7">小节总结<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<hr />
<hr />
<hr />
<hr />

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="12_1.html" class="md-footer__link md-footer__link--prev" aria-label="上一页: 12.1 Soft-lexicon模型" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              12.1 Soft-lexicon模型
            </div>
          </div>
        </a>
      
      
        
        <a href="14_1.html" class="md-footer__link md-footer__link--next" aria-label="下一页: 14.1 CR-CNN关系抽取模型详解" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              14.1 CR-CNN关系抽取模型详解
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": ".", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "search": "assets/javascripts/workers/search.092fa1f6.min.js"}</script>
    
    
      <script src="assets/javascripts/bundle.5a9542cf.min.js"></script>
      
        <script src="js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>