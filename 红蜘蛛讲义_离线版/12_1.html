
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="img/logo.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.11">
    
    
      
        <title>12.1 Soft-lexicon模型 - 红蜘蛛知识图谱项目 V3.0</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.50e68009.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#soft-lexicon" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="." title="红蜘蛛知识图谱项目 V3.0" class="md-header__button md-logo" aria-label="红蜘蛛知识图谱项目 V3.0" data-md-component="logo">
      
  <img src="img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            红蜘蛛知识图谱项目 V3.0
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              12.1 Soft-lexicon模型
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
    <img src="assets/images/logo.svg" height="45px" alt="logo">

  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="红蜘蛛知识图谱项目 V3.0" class="md-nav__button md-logo" aria-label="红蜘蛛知识图谱项目 V3.0" data-md-component="logo">
      
  <img src="img/logo.png" alt="logo">

    </a>
    红蜘蛛知识图谱项目 V3.0
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          第一章:项目背景
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第一章:项目背景" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          第一章:项目背景
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="1_1.html" class="md-nav__link">
        1.1 红蜘蛛项目背景
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="1_2.html" class="md-nav__link">
        1.2 知识图谱概述
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          第二章:知识查询
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第二章:知识查询" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          第二章:知识查询
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="2_1.html" class="md-nav__link">
        2.1 知识查询方法介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="2_2.html" class="md-nav__link">
        2.2 知识图谱的数值表示
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          第三章:实体抽取
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第三章:实体抽取" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          第三章:实体抽取
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="3_1.html" class="md-nav__link">
        3.1 快速部署的IDCNN模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="3_2.html" class="md-nav__link">
        3.2 FLAT模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="3_3.html" class="md-nav__link">
        3.3 实体消歧与实体对齐
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="3_4.html" class="md-nav__link">
        3.4 基于规则派的NER
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          第四章:关系抽取
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第四章:关系抽取" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          第四章:关系抽取
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="4_1.html" class="md-nav__link">
        4.1 multi-head-selection模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="4_2.html" class="md-nav__link">
        4.2 Casrel模型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="4_3.html" class="md-nav__link">
        4.3 基于规则派的RE
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          第五章:事件抽取
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第五章:事件抽取" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          第五章:事件抽取
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="5_1.html" class="md-nav__link">
        5.1 中文场景下的事件抽取
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          第六章:知识构建
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第六章:知识构建" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          第六章:知识构建
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="6_1.html" class="md-nav__link">
        6.1 概念图谱的构建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="6_2.html" class="md-nav__link">
        6.2 百科图谱的构建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="6_3.html" class="md-nav__link">
        6.3 知识图谱的众包
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          第七章:知识存储
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第七章:知识存储" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          第七章:知识存储
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="7_1.html" class="md-nav__link">
        7.1 知识图谱建模与存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="7_2.html" class="md-nav__link">
        7.2 neo4j技术解析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          第八章:知识补全
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第八章:知识补全" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          第八章:知识补全
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="8_1.html" class="md-nav__link">
        8.1 经典知识补全
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="8_2.html" class="md-nav__link">
        8.2 知识图谱质量控制
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          第九章:知识推理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第九章:知识推理" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          第九章:知识推理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="9_1.html" class="md-nav__link">
        9.1 常用推理方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="9_2.html" class="md-nav__link">
        9.2 常用推理引擎
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="9_3.html" class="md-nav__link">
        9.3 知识推理展望
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          第十章:红蜘蛛上线
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十章:红蜘蛛上线" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          第十章:红蜘蛛上线
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="10_1.html" class="md-nav__link">
        10.1 总体设计方案
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="10_2.html" class="md-nav__link">
        10.2 搭建红蜘蛛机器人
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="10_3.html" class="md-nav__link">
        10.3 上线部署与联调测试
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" type="checkbox" id="__nav_11" >
      
      
      
      
        <label class="md-nav__link" for="__nav_11">
          第十一章:扩展章节之一
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十一章:扩展章节之一" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          第十一章:扩展章节之一
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="11_1.html" class="md-nav__link">
        11.1 TENER模型
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12" type="checkbox" id="__nav_12" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_12">
          第十二章:扩展章节之二
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十二章:扩展章节之二" data-md-level="1">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          第十二章:扩展章节之二
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          12.1 Soft-lexicon模型
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="12_1.html" class="md-nav__link md-nav__link--active">
        12.1 Soft-lexicon模型
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#soft-lexicon" class="md-nav__link">
    Soft-lexicon模型
  </a>
  
    <nav class="md-nav" aria-label="Soft-lexicon模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    学习目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#soft-lexicon_1" class="md-nav__link">
    Soft-lexicon模型代码实现
  </a>
  
    <nav class="md-nav" aria-label="Soft-lexicon模型代码实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    第1步: 构建工具类相关函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    第2步: 构建模型类的代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    第3步: 主函数代码的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    第4步: 训练与测试脚本
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    第5步: 模型的训练
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    小节总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13" type="checkbox" id="__nav_13" >
      
      
      
      
        <label class="md-nav__link" for="__nav_13">
          第十三章:扩展章节之三
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十三章:扩展章节之三" data-md-level="1">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          第十三章:扩展章节之三
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="13_1.html" class="md-nav__link">
        13.1 基于CNN的关系抽取模型
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14" type="checkbox" id="__nav_14" >
      
      
      
      
        <label class="md-nav__link" for="__nav_14">
          第十四章:扩展章节之四
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十四章:扩展章节之四" data-md-level="1">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          第十四章:扩展章节之四
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="14_1.html" class="md-nav__link">
        14.1 CR-CNN关系抽取模型详解
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_15" type="checkbox" id="__nav_15" >
      
      
      
      
        <label class="md-nav__link" for="__nav_15">
          第十五章:扩展章节之五
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="第十五章:扩展章节之五" data-md-level="1">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          第十五章:扩展章节之五
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="15_1.html" class="md-nav__link">
        15.1 中文NER的SOTA
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#soft-lexicon" class="md-nav__link">
    Soft-lexicon模型
  </a>
  
    <nav class="md-nav" aria-label="Soft-lexicon模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    学习目标
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#soft-lexicon_1" class="md-nav__link">
    Soft-lexicon模型代码实现
  </a>
  
    <nav class="md-nav" aria-label="Soft-lexicon模型代码实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    第1步: 构建工具类相关函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    第2步: 构建模型类的代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    第3步: 主函数代码的实现
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    第4步: 训练与测试脚本
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    第5步: 模型的训练
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    小节总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

  <h1>12.1 Soft-lexicon模型</h1>

<h2 id="soft-lexicon">Soft-lexicon模型<a class="headerlink" href="#soft-lexicon" title="Permanent link">&para;</a></h2>
<hr />
<h3 id="_1">学习目标<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<ul>
<li>掌握Soft-lexicon模型的代码实现.</li>
</ul>
<hr />
<h3 id="soft-lexicon_1">Soft-lexicon模型代码实现<a class="headerlink" href="#soft-lexicon_1" title="Permanent link">&para;</a></h3>
<ul>
<li>整个流程的实现步骤如下:<ul>
<li>第1步: 构建工具类相关函数</li>
<li>第2步: 构建模型类的代码</li>
<li>第3步: 主函数代码的实现</li>
<li>第4步: 训练与测试脚本</li>
<li>第5步: 模型的训练</li>
</ul>
</li>
</ul>
<hr />
<h4 id="1">第1步: 构建工具类相关函数<a class="headerlink" href="#1" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p>代码路径: /home/ec2-user/code/ner/soft-lexicon/utils.py</p>
</li>
<li>
<p>1.1: alphabet.py代码实现</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="k">class</span> <span class="nc">Alphabet</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keep_growing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s2">&quot;&lt;/unk&gt;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance2index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_growing</span> <span class="o">=</span> <span class="n">keep_growing</span>

        <span class="c1"># Index 0 is occupied by default, all else following.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_growing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance2index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_growing</span> <span class="o">=</span> <span class="n">keep_growing</span>

        <span class="c1"># Index 0 is occupied by default, all else following.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_index</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance2index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance2index</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance2index</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_growing</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_index</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">index</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance2index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># First index is occupied by the wildcard element.</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING:Alphabet get_instance ,unknown instance index </span><span class="si">{}</span><span class="s1">, return the first label.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># if self.label:</span>
        <span class="c1">#     return len(self.instances)</span>
        <span class="c1"># else:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance2index</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">enumerate_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Enumerate is allowed between [1 : size of the alphabet)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:])</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_growing</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_growing</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;instance2index&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance2index</span><span class="p">,</span> <span class="s1">&#39;instances&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance2index</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;instance2index&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save both alhpabet records to the given directory.</span>
<span class="sd">        :param output_directory: Directory to save model and weights.</span>
<span class="sd">        :param name: The alphabet saving name, optional.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">saving_name</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">__name</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_content</span><span class="p">(),</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">saving_name</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception: Alphabet is not saved: &quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_directory</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load model architecture and weights from the give directory. This allow we use old models even the structure</span>
<span class="sd">        changes.</span>
<span class="sd">        :param input_directory: Directory to save model and weights</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loading_name</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">__name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_directory</span><span class="p">,</span> <span class="n">loading_name</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">))))</span>
</code></pre></div>
<hr />
<ul>
<li>1.2: data.py代码实现</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">utils.functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">utils.gazetteer</span> <span class="kn">import</span> <span class="n">Gazetteer</span>

<span class="n">START</span> <span class="o">=</span> <span class="s2">&quot;&lt;/s&gt;&quot;</span>
<span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s2">&quot;&lt;/unk&gt;&quot;</span>
<span class="n">PADDING</span> <span class="o">=</span> <span class="s2">&quot;&lt;/pad&gt;&quot;</span>
<span class="n">NULLKEY</span> <span class="o">=</span> <span class="s2">&quot;-null-&quot;</span>


<span class="k">class</span> <span class="nc">Data</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAX_SENTENCE_LENGTH</span> <span class="o">=</span> <span class="mi">250</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAX_WORD_LENGTH</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_normalized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_word_emb</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_biword_emb</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_gaz_emb</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_alphabet</span> <span class="o">=</span> <span class="n">Alphabet</span><span class="p">(</span><span class="s1">&#39;word&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biword_alphabet</span> <span class="o">=</span> <span class="n">Alphabet</span><span class="p">(</span><span class="s1">&#39;biword&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char_alphabet</span> <span class="o">=</span> <span class="n">Alphabet</span><span class="p">(</span><span class="s1">&#39;character&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet</span> <span class="o">=</span> <span class="n">Alphabet</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaz_lower</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaz</span> <span class="o">=</span> <span class="n">Gazetteer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaz_lower</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaz_alphabet</span> <span class="o">=</span> <span class="n">Alphabet</span><span class="p">(</span><span class="s1">&#39;gaz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaz_count</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaz_split</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biword_count</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">HP_fix_gaz_emb</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_use_gaz</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_use_count</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tagScheme</span> <span class="o">=</span> <span class="s2">&quot;NoSeg&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char_features</span> <span class="o">=</span> <span class="s2">&quot;LSTM&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_texts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_texts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_texts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_texts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_Ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_Ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_Ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_Ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_split_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_split_index</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_bigram</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_emb_dim</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biword_emb_dim</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char_emb_dim</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaz_emb_dim</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaz_dropout</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretrain_word_embedding</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretrain_biword_embedding</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretrain_gaz_embedding</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_alphabet_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biword_alphabet_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char_alphabet_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># hyperparameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_iteration</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_batch_size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_char_hidden_dim</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_hidden_dim</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_dropout</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_lstm_layer</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_bilstm</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_use_char</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_gpu</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_lr</span> <span class="o">=</span> <span class="mf">0.015</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_lr_decay</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_clip</span> <span class="o">=</span> <span class="mf">5.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_momentum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HP_num_layer</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="nf">show_data_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DATA SUMMARY START:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Tag          scheme: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tagScheme</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     MAX SENTENCE LENGTH: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MAX_SENTENCE_LENGTH</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     MAX   WORD   LENGTH: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MAX_WORD_LENGTH</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Number   normalized: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_normalized</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Use          bigram: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_bigram</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Word  alphabet size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">word_alphabet_size</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Biword alphabet size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">biword_alphabet_size</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Char  alphabet size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char_alphabet_size</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Gaz   alphabet size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaz_alphabet</span><span class="o">.</span><span class="n">size</span><span class="p">()))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Label alphabet size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet_size</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Word embedding size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">word_emb_dim</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Biword embedding size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">biword_emb_dim</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Char embedding size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">char_emb_dim</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Gaz embedding size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaz_emb_dim</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Norm     word   emb: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_word_emb</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Norm     biword emb: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_biword_emb</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Norm     gaz    emb: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_gaz_emb</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Norm   gaz  dropout: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gaz_dropout</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Train instance number: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_texts</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Dev   instance number: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dev_texts</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Test  instance number: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_texts</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">refresh_label_alphabet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_file</span><span class="p">):</span>
        <span class="n">old_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">in_lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">in_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">pairs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">startS</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">startB</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;S-&quot;</span> <span class="ow">in</span> <span class="n">label</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">startS</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="s2">&quot;B-&quot;</span> <span class="ow">in</span> <span class="n">label</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">startB</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">startB</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">startS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagScheme</span> <span class="o">=</span> <span class="s2">&quot;BMES&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagScheme</span> <span class="o">=</span> <span class="s2">&quot;BIO&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_alphabet</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refresh label alphabet finished: old:</span><span class="si">%s</span><span class="s2"> -&gt; new:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">old_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet_size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">build_alphabet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_file</span><span class="p">):</span>
        <span class="n">in_lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">seqlen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">in_lines</span><span class="p">)):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">in_lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">pairs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_normalized</span><span class="p">:</span>
                    <span class="n">word</span> <span class="o">=</span> <span class="n">normalize_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">word_alphabet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_lines</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">biword</span> <span class="o">=</span> <span class="n">word</span> <span class="o">+</span> <span class="n">in_lines</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">biword</span> <span class="o">=</span> <span class="n">word</span> <span class="o">+</span> <span class="n">NULLKEY</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">biword_alphabet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">biword</span><span class="p">)</span>
                <span class="c1"># biword_index = self.biword_alphabet.get_index(biword)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">biword_count</span><span class="p">[</span><span class="n">biword</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biword_count</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">biword</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">char_alphabet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

                <span class="n">seqlen</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seqlen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_alphabet_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_alphabet</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biword_alphabet_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biword_alphabet</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char_alphabet_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">char_alphabet</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">startS</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">startB</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_alphabet</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;S-&quot;</span> <span class="ow">in</span> <span class="n">label</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">startS</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="s2">&quot;B-&quot;</span> <span class="ow">in</span> <span class="n">label</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">startB</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">startB</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">startS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagScheme</span> <span class="o">=</span> <span class="s2">&quot;BMES&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagScheme</span> <span class="o">=</span> <span class="s2">&quot;BIO&quot;</span>

    <span class="k">def</span> <span class="nf">build_gaz_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gaz_file</span><span class="p">):</span>
        <span class="c1"># build gaz file,initial read gaz embedding file</span>
        <span class="k">if</span> <span class="n">gaz_file</span><span class="p">:</span>
            <span class="n">fins</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">gaz_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">fin</span> <span class="ow">in</span> <span class="n">fins</span><span class="p">:</span>
                <span class="n">fin</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">fin</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gaz</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="s2">&quot;one_source&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load gaz file: &quot;</span><span class="p">,</span> <span class="n">gaz_file</span><span class="p">,</span> <span class="s2">&quot; total size:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaz</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gaz file is None, load nothing&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_decoded_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">predict_results</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">sent_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predict_results</span><span class="p">)</span>
        <span class="n">content_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span>
            <span class="n">content_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_texts</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="n">content_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_texts</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;dev&#39;</span><span class="p">:</span>
            <span class="n">content_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_texts</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
            <span class="n">content_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_texts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: illegal name during writing predict result, name should be within train/dev/test/raw !&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">sent_num</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">content_list</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sent_num</span><span class="p">):</span>
            <span class="n">sent_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predict_results</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">idy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sent_length</span><span class="p">):</span>
                <span class="c1"># content_list[idx] is a list with [word, char, label]</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content_list</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">idy</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">predict_results</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">idy</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predict </span><span class="si">%s</span><span class="s2"> result has been written into file. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">output_file</span><span class="p">))</span>
</code></pre></div>
<hr />
<ul>
<li>1.3: functions.py代码实现</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">utils.alphabet</span> <span class="kn">import</span> <span class="n">Alphabet</span>
<span class="kn">from</span> <span class="nn">transformers.tokenization_bert</span> <span class="kn">import</span> <span class="n">BertTokenizer</span>

<span class="n">NULLKEY</span> <span class="o">=</span> <span class="s2">&quot;-null-&quot;</span>


<span class="k">def</span> <span class="nf">normalize_word</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="n">new_word</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">new_word</span> <span class="o">+=</span> <span class="s1">&#39;0&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_word</span> <span class="o">+=</span> <span class="n">char</span>
    <span class="k">return</span> <span class="n">new_word</span>


<span class="k">def</span> <span class="nf">read_instance_with_gaz</span><span class="p">(</span><span class="n">num_layer</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">gaz</span><span class="p">,</span> <span class="n">word_alphabet</span><span class="p">,</span> <span class="n">biword_alphabet</span><span class="p">,</span> <span class="n">biword_count</span><span class="p">,</span> <span class="n">char_alphabet</span><span class="p">,</span>
                           <span class="n">gaz_alphabet</span><span class="p">,</span> <span class="n">gaz_count</span><span class="p">,</span> <span class="n">gaz_split</span><span class="p">,</span> <span class="n">label_alphabet</span><span class="p">,</span> <span class="n">number_normalized</span><span class="p">,</span> <span class="n">max_sent_length</span><span class="p">,</span>
                           <span class="n">char_padding_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">char_padding_symbol</span><span class="o">=</span><span class="s1">&#39;&lt;/pad&gt;&#39;</span><span class="p">):</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">BertTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;bert-base-chinese&#39;</span><span class="p">,</span> <span class="n">do_lower_case</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">in_lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">instence_texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">instence_Ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">biwords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">word_Ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">biword_Ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">char_Ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">label_Ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">in_lines</span><span class="p">)):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">in_lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">number_normalized</span><span class="p">:</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">normalize_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_lines</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">biword</span> <span class="o">=</span> <span class="n">word</span> <span class="o">+</span> <span class="n">in_lines</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">biword</span> <span class="o">=</span> <span class="n">word</span> <span class="o">+</span> <span class="n">NULLKEY</span>
            <span class="n">biwords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">biword</span><span class="p">)</span>
            <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">word_Ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_alphabet</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
            <span class="n">biword_index</span> <span class="o">=</span> <span class="n">biword_alphabet</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">biword</span><span class="p">)</span>
            <span class="n">biword_Ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">biword_index</span><span class="p">)</span>
            <span class="n">label_Ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_alphabet</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="n">char_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">char_Id</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
                <span class="n">char_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">char_padding_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">char_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">char_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">char_number</span> <span class="o">&lt;</span> <span class="n">char_padding_size</span><span class="p">:</span>
                    <span class="n">char_list</span> <span class="o">=</span> <span class="n">char_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">char_padding_symbol</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">char_padding_size</span> <span class="o">-</span> <span class="n">char_number</span><span class="p">)</span>
                <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">char_list</span><span class="p">)</span> <span class="o">==</span> <span class="n">char_padding_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># not padding</span>
                <span class="k">pass</span>
            <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">char_list</span><span class="p">:</span>
                <span class="n">char_Id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_alphabet</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
            <span class="n">chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_list</span><span class="p">)</span>
            <span class="n">char_Ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_Id</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">max_sent_length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_sent_length</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">gaz_Ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">layergazmasks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">gazchar_masks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">w_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>

                <span class="n">gazs</span> <span class="o">=</span> <span class="p">[[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                        <span class="nb">range</span><span class="p">(</span><span class="n">w_length</span><span class="p">)]</span>  <span class="c1"># gazs:[c1,c2,...,cn]  ci:[B,M,E,S]  B/M/E/S :[w_id1,w_id2,...]  None:0</span>
                <span class="n">gazs_count</span> <span class="o">=</span> <span class="p">[[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w_length</span><span class="p">)]</span>

                <span class="n">gaz_char_Id</span> <span class="o">=</span> <span class="p">[[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                               <span class="nb">range</span><span class="p">(</span><span class="n">w_length</span><span class="p">)]</span>  <span class="c1"># gazs:[c1,c2,...,cn]  ci:[B,M,E,S]  B/M/E/S :[[w1c1,w1c2,...],[],...]</span>

                <span class="n">max_gazlist</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">max_gazcharlen</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w_length</span><span class="p">):</span>

                    <span class="n">matched_list</span> <span class="o">=</span> <span class="n">gaz</span><span class="o">.</span><span class="n">enumerateMatchList</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">idx</span><span class="p">:])</span>
                    <span class="n">matched_length</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">matched_list</span><span class="p">]</span>
                    <span class="n">matched_Id</span> <span class="o">=</span> <span class="p">[</span><span class="n">gaz_alphabet</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">matched_list</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">matched_length</span><span class="p">:</span>
                        <span class="n">max_gazcharlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">matched_length</span><span class="p">),</span> <span class="n">max_gazcharlen</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_Id</span><span class="p">)):</span>
                        <span class="n">gaz_chars</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">g</span> <span class="o">=</span> <span class="n">matched_list</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
                            <span class="n">gaz_chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_alphabet</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">matched_length</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Single</span>
                            <span class="n">gazs</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_Id</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>
                            <span class="n">gazs_count</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">gaz_char_Id</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaz_chars</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">gazs</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_Id</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>  <span class="c1"># Begin</span>
                            <span class="n">gazs_count</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaz_count</span><span class="p">[</span><span class="n">matched_Id</span><span class="p">[</span><span class="n">w</span><span class="p">]])</span>
                            <span class="n">gaz_char_Id</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaz_chars</span><span class="p">)</span>
                            <span class="n">wlen</span> <span class="o">=</span> <span class="n">matched_length</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
                            <span class="n">gazs</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">wlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_Id</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>  <span class="c1"># End</span>
                            <span class="n">gazs_count</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">wlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaz_count</span><span class="p">[</span><span class="n">matched_Id</span><span class="p">[</span><span class="n">w</span><span class="p">]])</span>
                            <span class="n">gaz_char_Id</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">wlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaz_chars</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wlen</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
                                <span class="n">gazs</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_Id</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>  <span class="c1"># Middle</span>
                                <span class="n">gazs_count</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaz_count</span><span class="p">[</span><span class="n">matched_Id</span><span class="p">[</span><span class="n">w</span><span class="p">]])</span>
                                <span class="n">gaz_char_Id</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaz_chars</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">gazs</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">]:</span>
                            <span class="n">gazs</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">gazs_count</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">gaz_char_Id</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

                        <span class="n">max_gazlist</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gazs</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">]),</span> <span class="n">max_gazlist</span><span class="p">)</span>

                    <span class="n">matched_Id</span> <span class="o">=</span> <span class="p">[</span><span class="n">gaz_alphabet</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">matched_list</span><span class="p">]</span>  <span class="c1"># 词号</span>
                    <span class="k">if</span> <span class="n">matched_Id</span><span class="p">:</span>
                        <span class="n">gaz_Ids</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">matched_Id</span><span class="p">,</span> <span class="n">matched_length</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">gaz_Ids</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

                <span class="c1"># batch_size = 1</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w_length</span><span class="p">):</span>
                    <span class="n">gazmask</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">gazcharmask</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                        <span class="n">label_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gazs</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">])</span>
                        <span class="n">count_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gazs_count</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">count_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">count_set</span><span class="p">:</span>
                            <span class="n">gazs_count</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">label_len</span>

                        <span class="n">mask</span> <span class="o">=</span> <span class="n">label_len</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">mask</span> <span class="o">+=</span> <span class="p">(</span><span class="n">max_gazlist</span> <span class="o">-</span> <span class="n">label_len</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                        <span class="n">gazs</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">max_gazlist</span> <span class="o">-</span> <span class="n">label_len</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># padding</span>
                        <span class="n">gazs_count</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">max_gazlist</span> <span class="o">-</span> <span class="n">label_len</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># padding</span>

                        <span class="n">char_mask</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gaz_char_Id</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">])):</span>
                            <span class="n">glen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gaz_char_Id</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">][</span><span class="n">g</span><span class="p">])</span>
                            <span class="n">charmask</span> <span class="o">=</span> <span class="n">glen</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">charmask</span> <span class="o">+=</span> <span class="p">(</span><span class="n">max_gazcharlen</span> <span class="o">-</span> <span class="n">glen</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">char_mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">charmask</span><span class="p">)</span>
                            <span class="n">gaz_char_Id</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">][</span><span class="n">g</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">max_gazcharlen</span> <span class="o">-</span> <span class="n">glen</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">gaz_char_Id</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">max_gazlist</span> <span class="o">-</span> <span class="n">label_len</span><span class="p">)</span> <span class="o">*</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_gazcharlen</span><span class="p">)]]</span>
                        <span class="n">char_mask</span> <span class="o">+=</span> <span class="p">(</span><span class="n">max_gazlist</span> <span class="o">-</span> <span class="n">label_len</span><span class="p">)</span> <span class="o">*</span> <span class="p">[[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_gazcharlen</span><span class="p">)]]</span>

                        <span class="n">gazmask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                        <span class="n">gazcharmask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char_mask</span><span class="p">)</span>
                    <span class="n">layergazmasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gazmask</span><span class="p">)</span>
                    <span class="n">gazchar_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gazcharmask</span><span class="p">)</span>

                <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;[CLS]&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">words</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;[SEP]&#39;</span><span class="p">]</span>
                <span class="n">bert_text_ids</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">convert_tokens_to_ids</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>

                <span class="n">instence_texts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">words</span><span class="p">,</span> <span class="n">biwords</span><span class="p">,</span> <span class="n">chars</span><span class="p">,</span> <span class="n">gazs</span><span class="p">,</span> <span class="n">labels</span><span class="p">])</span>
                <span class="n">instence_Ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">word_Ids</span><span class="p">,</span> <span class="n">biword_Ids</span><span class="p">,</span> <span class="n">char_Ids</span><span class="p">,</span> <span class="n">gaz_Ids</span><span class="p">,</span> <span class="n">label_Ids</span><span class="p">,</span> <span class="n">gazs</span><span class="p">,</span> <span class="n">gazs_count</span><span class="p">,</span> <span class="n">gaz_char_Id</span><span class="p">,</span> <span class="n">layergazmasks</span><span class="p">,</span>
                     <span class="n">gazchar_masks</span><span class="p">,</span> <span class="n">bert_text_ids</span><span class="p">])</span>

            <span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">biwords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">word_Ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">biword_Ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">char_Ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">label_Ids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">instence_texts</span><span class="p">,</span> <span class="n">instence_Ids</span>
</code></pre></div>
<hr />
<ul>
<li>1.4: gazetteer.py代码实现</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">utils.trie</span> <span class="kn">import</span> <span class="n">Trie</span>


<span class="k">class</span> <span class="nc">Gazetteer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trie</span> <span class="o">=</span> <span class="n">Trie</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ent2type</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1">## word list to type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ent2id</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;&lt;UNK&gt;&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>  <span class="c1">## word list to id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">enumerateMatchList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">:</span>
            <span class="n">word_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_list</span><span class="p">]</span>
        <span class="n">match_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trie</span><span class="o">.</span><span class="n">enumerateMatch</span><span class="p">(</span><span class="n">word_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">match_list</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_list</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">:</span>
            <span class="n">word_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trie</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">string</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ent2type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ent2type</span><span class="p">[</span><span class="n">string</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span>
        <span class="k">if</span> <span class="n">string</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ent2id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ent2id</span><span class="p">[</span><span class="n">string</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ent2id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">searchId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">:</span>
            <span class="n">word_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_list</span><span class="p">]</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">string</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ent2id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ent2id</span><span class="p">[</span><span class="n">string</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ent2id</span><span class="p">[</span><span class="s2">&quot;&lt;UNK&gt;&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">searchType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">:</span>
            <span class="n">word_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_list</span><span class="p">]</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">string</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ent2type</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ent2type</span><span class="p">[</span><span class="n">string</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error in finding entity type at gazetteer.py, exit program! String:&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ent2type</span><span class="p">)</span>
</code></pre></div>
<hr />
<ul>
<li>1.5: metric.py代码实现</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sys</span>


<span class="c1"># input as sentence level labels</span>
<span class="k">def</span> <span class="nf">get_ner_fmeasure</span><span class="p">(</span><span class="n">golden_lists</span><span class="p">,</span> <span class="n">predict_lists</span><span class="p">,</span> <span class="n">label_type</span><span class="o">=</span><span class="s2">&quot;BMES&quot;</span><span class="p">,</span> <span class="n">printnum</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">sent_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">golden_lists</span><span class="p">)</span>
    <span class="n">golden_full</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">predict_full</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">right_full</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">right_tag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">all_tag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sent_num</span><span class="p">):</span>
        <span class="c1"># word_list = sentence_lists[idx]</span>
        <span class="n">golden_list</span> <span class="o">=</span> <span class="n">golden_lists</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">predict_list</span> <span class="o">=</span> <span class="n">predict_lists</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">golden_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">golden_list</span><span class="p">[</span><span class="n">idy</span><span class="p">]</span> <span class="o">==</span> <span class="n">predict_list</span><span class="p">[</span><span class="n">idy</span><span class="p">]:</span>
                <span class="n">right_tag</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">all_tag</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">golden_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label_type</span> <span class="o">==</span> <span class="s2">&quot;BMES&quot;</span><span class="p">:</span>
            <span class="n">gold_matrix</span> <span class="o">=</span> <span class="n">get_ner_BMES</span><span class="p">(</span><span class="n">golden_list</span><span class="p">)</span>
            <span class="n">pred_matrix</span> <span class="o">=</span> <span class="n">get_ner_BMES</span><span class="p">(</span><span class="n">predict_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gold_matrix</span> <span class="o">=</span> <span class="n">get_ner_BIO</span><span class="p">(</span><span class="n">golden_list</span><span class="p">)</span>
            <span class="n">pred_matrix</span> <span class="o">=</span> <span class="n">get_ner_BIO</span><span class="p">(</span><span class="n">predict_list</span><span class="p">)</span>
        <span class="c1"># print &quot;gold&quot;, gold_matrix</span>
        <span class="c1"># print &quot;pred&quot;, pred_matrix</span>
        <span class="n">right_ner</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">gold_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pred_matrix</span><span class="p">)))</span>
        <span class="n">golden_full</span> <span class="o">+=</span> <span class="n">gold_matrix</span>
        <span class="n">predict_full</span> <span class="o">+=</span> <span class="n">pred_matrix</span>
        <span class="n">right_full</span> <span class="o">+=</span> <span class="n">right_ner</span>
    <span class="n">right_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_full</span><span class="p">)</span>
    <span class="n">golden_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">golden_full</span><span class="p">)</span>
    <span class="n">predict_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predict_full</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">predict_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="p">(</span><span class="n">right_num</span> <span class="o">+</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">predict_num</span>
    <span class="k">if</span> <span class="n">golden_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">recall</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">recall</span> <span class="o">=</span> <span class="p">(</span><span class="n">right_num</span> <span class="o">+</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">golden_num</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">precision</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">recall</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">precision</span> <span class="o">+</span> <span class="n">recall</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">f_measure</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f_measure</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">precision</span> <span class="o">*</span> <span class="n">recall</span> <span class="o">/</span> <span class="p">(</span><span class="n">precision</span> <span class="o">+</span> <span class="n">recall</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">right_tag</span> <span class="o">+</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">all_tag</span>
    <span class="c1"># print &quot;Accuracy: &quot;, right_tag,&quot;/&quot;,all_tag,&quot;=&quot;,accuracy</span>
    <span class="k">if</span> <span class="n">printnum</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gold_num = &quot;</span><span class="p">,</span> <span class="n">golden_num</span><span class="p">,</span> <span class="s2">&quot; pred_num = &quot;</span><span class="p">,</span> <span class="n">predict_num</span><span class="p">,</span> <span class="s2">&quot; right_num = &quot;</span><span class="p">,</span> <span class="n">right_num</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">f_measure</span>


<span class="k">def</span> <span class="nf">reverse_style</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
    <span class="n">target_position</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span>
    <span class="n">input_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>
    <span class="n">output_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="p">[</span><span class="n">target_position</span><span class="p">:</span><span class="n">input_len</span><span class="p">]</span> <span class="o">+</span> <span class="n">input_string</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">target_position</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output_string</span>


<span class="k">def</span> <span class="nf">get_ner_BMES</span><span class="p">(</span><span class="n">label_list</span><span class="p">):</span>
    <span class="c1"># list_len = len(word_list)</span>
    <span class="c1"># assert(list_len == len(label_list)), &quot;word list size unmatch with label list&quot;</span>
    <span class="n">list_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span>
    <span class="n">begin_label</span> <span class="o">=</span> <span class="s1">&#39;B-&#39;</span>
    <span class="n">end_label</span> <span class="o">=</span> <span class="s1">&#39;E-&#39;</span>
    <span class="n">single_label</span> <span class="o">=</span> <span class="s1">&#39;S-&#39;</span>
    <span class="n">whole_tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">index_tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">tag_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stand_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">list_len</span><span class="p">):</span>
        <span class="c1"># wordlabel = word_list[i]</span>
        <span class="n">current_label</span> <span class="o">=</span> <span class="n">label_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">label_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">begin_label</span> <span class="ow">in</span> <span class="n">current_label</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index_tag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">whole_tag</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">whole_tag</span> <span class="o">=</span> <span class="n">current_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">begin_label</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">index_tag</span> <span class="o">=</span> <span class="n">current_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">begin_label</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">single_label</span> <span class="ow">in</span> <span class="n">current_label</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index_tag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">whole_tag</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">whole_tag</span> <span class="o">=</span> <span class="n">current_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">single_label</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">whole_tag</span><span class="p">)</span>
            <span class="n">whole_tag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">index_tag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">end_label</span> <span class="ow">in</span> <span class="n">current_label</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index_tag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">whole_tag</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">whole_tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">index_tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">if</span> <span class="n">whole_tag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">index_tag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">whole_tag</span><span class="p">)</span>

    <span class="n">tag_list_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag_list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tag_list_len</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tag_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
            <span class="n">insert_list</span> <span class="o">=</span> <span class="n">reverse_style</span><span class="p">(</span><span class="n">tag_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">stand_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">insert_list</span><span class="p">)</span>
    <span class="c1"># print stand_matrix</span>
    <span class="k">return</span> <span class="n">stand_matrix</span>


<span class="k">def</span> <span class="nf">get_ner_BIO</span><span class="p">(</span><span class="n">label_list</span><span class="p">):</span>
    <span class="c1"># list_len = len(word_list)</span>
    <span class="c1"># assert(list_len == len(label_list)), &quot;word list size unmatch with label list&quot;</span>
    <span class="n">list_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span>
    <span class="n">begin_label</span> <span class="o">=</span> <span class="s1">&#39;B-&#39;</span>
    <span class="n">inside_label</span> <span class="o">=</span> <span class="s1">&#39;I-&#39;</span>
    <span class="n">whole_tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">index_tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">tag_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stand_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">list_len</span><span class="p">):</span>
        <span class="c1"># wordlabel = word_list[i]</span>
        <span class="n">current_label</span> <span class="o">=</span> <span class="n">label_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">begin_label</span> <span class="ow">in</span> <span class="n">current_label</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index_tag</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">whole_tag</span> <span class="o">=</span> <span class="n">current_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">begin_label</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">index_tag</span> <span class="o">=</span> <span class="n">current_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">begin_label</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">whole_tag</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">whole_tag</span> <span class="o">=</span> <span class="n">current_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">begin_label</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">index_tag</span> <span class="o">=</span> <span class="n">current_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">begin_label</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">inside_label</span> <span class="ow">in</span> <span class="n">current_label</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">inside_label</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">index_tag</span><span class="p">:</span>
                <span class="n">whole_tag</span> <span class="o">=</span> <span class="n">whole_tag</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">whole_tag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">index_tag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">whole_tag</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">whole_tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">index_tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">whole_tag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">index_tag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">whole_tag</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">whole_tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">index_tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">whole_tag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">index_tag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">whole_tag</span><span class="p">)</span>
    <span class="n">tag_list_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag_list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tag_list_len</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tag_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
            <span class="n">insert_list</span> <span class="o">=</span> <span class="n">reverse_style</span><span class="p">(</span><span class="n">tag_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">stand_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">insert_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stand_matrix</span>


<span class="k">def</span> <span class="nf">readSentence</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
    <span class="n">in_lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sentence</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">in_lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">sentence</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pair</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">sentence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sentences</span><span class="p">,</span> <span class="n">labels</span>
</code></pre></div>
<hr />
<h4 id="2">第2步: 构建模型类的代码<a class="headerlink" href="#2" title="Permanent link">&para;</a></h4>
<ul>
<li>代码路径: /home/ec2-user/code/ner/soft-lexicon/model/gazlstm.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">model.crf</span> <span class="kn">import</span> <span class="n">CRF</span>
<span class="kn">from</span> <span class="nn">model.layers</span> <span class="kn">import</span> <span class="n">NERmodel</span>
<span class="kn">from</span> <span class="nn">transformers.modeling_bert</span> <span class="kn">import</span> <span class="n">BertModel</span>


<span class="k">class</span> <span class="nc">GazLSTM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GazLSTM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_gpu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_biword</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">use_bigram</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_hidden_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaz_alphabet</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">gaz_alphabet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaz_emb_dim</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">gaz_emb_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_emb_dim</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">word_emb_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biword_emb_dim</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">biword_emb_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_char</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_use_char</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bilstm_flag</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_bilstm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm_layer</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_lstm_layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_count</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_use_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_layer</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_num_layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">model_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_bert</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">use_bert</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaz_emb_dim</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">pretrain_gaz_embedding</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaz_emb_dim</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_char</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_emb_dim</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">pretrain_word_embedding</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_emb_dim</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gaz_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">gaz_alphabet</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaz_emb_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">word_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">word_alphabet</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_emb_dim</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_biword</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biword_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">biword_alphabet</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">biword_emb_dim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">pretrain_gaz_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gaz_embedding</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">pretrain_gaz_embedding</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gaz_embedding</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_embedding</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">gaz_alphabet</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaz_emb_dim</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">pretrain_word_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word_embedding</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">pretrain_word_embedding</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word_embedding</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_embedding</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">word_alphabet</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_emb_dim</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_biword</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">pretrain_biword_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">biword_embedding</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">pretrain_biword_embedding</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">biword_embedding</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_embedding</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">biword_alphabet</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_emb_dim</span><span class="p">)))</span>

        <span class="n">char_feature_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_emb_dim</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaz_emb_dim</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_biword</span><span class="p">:</span>
            <span class="n">char_feature_dim</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biword_emb_dim</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bert</span><span class="p">:</span>
            <span class="n">char_feature_dim</span> <span class="o">=</span> <span class="n">char_feature_dim</span> <span class="o">+</span> <span class="mi">768</span>

        <span class="c1"># lstm model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;lstm&#39;</span><span class="p">:</span>
            <span class="n">lstm_hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bilstm_flag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NERmodel</span> <span class="o">=</span> <span class="n">NERmodel</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;lstm&#39;</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">char_feature_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">lstm_hidden</span><span class="p">,</span>
                                     <span class="n">num_layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lstm_layer</span><span class="p">,</span> <span class="n">biflag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bilstm_flag</span><span class="p">)</span>

        <span class="c1"># cnn model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;cnn&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NERmodel</span> <span class="o">=</span> <span class="n">NERmodel</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;cnn&#39;</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">char_feature_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span>
                                     <span class="n">num_layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layer</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">HP_dropout</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>

        <span class="c1"># attention model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;transformer&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NERmodel</span> <span class="o">=</span> <span class="n">NERmodel</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="s1">&#39;transformer&#39;</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">char_feature_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span>
                                     <span class="n">num_layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layer</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">HP_dropout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">HP_dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden2tag</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">label_alphabet_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crf</span> <span class="o">=</span> <span class="n">CRF</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">label_alphabet_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bert</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bert_encoder</span> <span class="o">=</span> <span class="n">BertModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;bert-base-chinese&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gaz_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaz_embedding</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">word_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_embedding</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_biword</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">biword_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biword_embedding</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NERmodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NERmodel</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden2tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden2tag</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crf</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bert</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bert_encoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_encoder</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gaz_list</span><span class="p">,</span> <span class="n">word_inputs</span><span class="p">,</span> <span class="n">biword_inputs</span><span class="p">,</span> <span class="n">layer_gaz</span><span class="p">,</span> <span class="n">gaz_count</span><span class="p">,</span> <span class="n">gaz_chars</span><span class="p">,</span> <span class="n">gaz_mask_input</span><span class="p">,</span>
                 <span class="n">gazchar_mask_input</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">word_seq_lengths</span><span class="p">,</span> <span class="n">batch_bert</span><span class="p">,</span> <span class="n">bert_mask</span><span class="p">):</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">word_inputs</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="n">word_inputs</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">max_gaz_num</span> <span class="o">=</span> <span class="n">layer_gaz</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gaz_match</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">word_embs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_embedding</span><span class="p">(</span><span class="n">word_inputs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_biword</span><span class="p">:</span>
            <span class="n">biword_embs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biword_embedding</span><span class="p">(</span><span class="n">biword_inputs</span><span class="p">)</span>
            <span class="n">word_embs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">word_embs</span><span class="p">,</span> <span class="n">biword_embs</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">!=</span> <span class="s1">&#39;transformer&#39;</span><span class="p">:</span>
            <span class="n">word_inputs_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">word_embs</span><span class="p">)</span>  <span class="c1"># (b,l,we)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">word_inputs_d</span> <span class="o">=</span> <span class="n">word_embs</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_char</span><span class="p">:</span>
            <span class="n">gazchar_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_embedding</span><span class="p">(</span><span class="n">gaz_chars</span><span class="p">)</span>
            <span class="n">gazchar_mask</span> <span class="o">=</span> <span class="n">gazchar_mask_input</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_emb_dim</span><span class="p">)</span>
            <span class="n">gazchar_embeds</span> <span class="o">=</span> <span class="n">gazchar_embeds</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">masked_fill_</span><span class="p">(</span><span class="n">gazchar_mask</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">bool</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># (b,l,4,gl,cl,ce)</span>

            <span class="c1"># gazchar_mask_input:(b,l,4,gl,cl)</span>
            <span class="n">gaz_charnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">gazchar_mask_input</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># (b,l,4,gl,1)</span>
            <span class="n">gaz_charnum</span> <span class="o">=</span> <span class="n">gaz_charnum</span> <span class="o">+</span> <span class="p">(</span><span class="n">gaz_charnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
            <span class="n">gaz_embeds</span> <span class="o">=</span> <span class="n">gazchar_embeds</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">gaz_charnum</span>  <span class="c1"># (b,l,4,gl,ce)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">!=</span> <span class="s1">&#39;transformer&#39;</span><span class="p">:</span>
                <span class="n">gaz_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">gaz_embeds</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gaz_embeds</span> <span class="o">=</span> <span class="n">gaz_embeds</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># use gaz embedding</span>
            <span class="n">gaz_embeds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaz_embedding</span><span class="p">(</span><span class="n">layer_gaz</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">!=</span> <span class="s1">&#39;transformer&#39;</span><span class="p">:</span>
                <span class="n">gaz_embeds_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">gaz_embeds</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gaz_embeds_d</span> <span class="o">=</span> <span class="n">gaz_embeds</span>
            <span class="n">gaz_mask</span> <span class="o">=</span> <span class="n">gaz_mask_input</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaz_emb_dim</span><span class="p">)</span>
            <span class="n">gaz_embeds</span> <span class="o">=</span> <span class="n">gaz_embeds_d</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">masked_fill_</span><span class="p">(</span><span class="n">gaz_mask</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">bool</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># (b,l,4,g,ge)  ge:gaz_embed_dim</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_count</span><span class="p">:</span>
            <span class="n">count_sum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gaz_count</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (b,l,4,gn)</span>
            <span class="n">count_sum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">count_sum</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (b,l,1,1)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">gaz_count</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">count_sum</span><span class="p">)</span>  <span class="c1"># (b,l,4,g)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="mi">4</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">gaz_embeds</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">gaz_embeds</span>  <span class="c1"># (b,l,4,g,e)</span>
            <span class="n">gaz_embeds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gaz_embeds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># (b,l,4,e)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">gaz_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">gaz_mask_input</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># (b,l,4,1)</span>
            <span class="n">gaz_embeds</span> <span class="o">=</span> <span class="n">gaz_embeds</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">gaz_num</span>  <span class="c1"># (b,l,4,ge)/(b,l,4,1)</span>

        <span class="n">gaz_embeds_cat</span> <span class="o">=</span> <span class="n">gaz_embeds</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (b,l,4*ge)</span>

        <span class="n">word_input_cat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">word_inputs_d</span><span class="p">,</span> <span class="n">gaz_embeds_cat</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (b,l,we+4*ge)</span>

        <span class="c1"># cat bert feature</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bert</span><span class="p">:</span>
            <span class="n">seg_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bert_mask</span><span class="o">.</span><span class="n">size</span><span class="p">())</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bert_encoder</span><span class="p">(</span><span class="n">batch_bert</span><span class="p">,</span> <span class="n">bert_mask</span><span class="p">,</span> <span class="n">seg_id</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">word_input_cat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">word_input_cat</span><span class="p">,</span> <span class="n">outputs</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">feature_out_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NERmodel</span><span class="p">(</span><span class="n">word_input_cat</span><span class="p">)</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden2tag</span><span class="p">(</span><span class="n">feature_out_d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tags</span><span class="p">,</span> <span class="n">gaz_match</span>

    <span class="k">def</span> <span class="nf">neg_log_likelihood_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gaz_list</span><span class="p">,</span> <span class="n">word_inputs</span><span class="p">,</span> <span class="n">biword_inputs</span><span class="p">,</span> <span class="n">word_seq_lengths</span><span class="p">,</span> <span class="n">layer_gaz</span><span class="p">,</span> <span class="n">gaz_count</span><span class="p">,</span>
                                <span class="n">gaz_chars</span><span class="p">,</span> <span class="n">gaz_mask</span><span class="p">,</span> <span class="n">gazchar_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">batch_label</span><span class="p">,</span> <span class="n">batch_bert</span><span class="p">,</span> <span class="n">bert_mask</span><span class="p">):</span>

        <span class="n">tags</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tags</span><span class="p">(</span><span class="n">gaz_list</span><span class="p">,</span> <span class="n">word_inputs</span><span class="p">,</span> <span class="n">biword_inputs</span><span class="p">,</span> <span class="n">layer_gaz</span><span class="p">,</span> <span class="n">gaz_count</span><span class="p">,</span> <span class="n">gaz_chars</span><span class="p">,</span> <span class="n">gaz_mask</span><span class="p">,</span>
                                <span class="n">gazchar_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">word_seq_lengths</span><span class="p">,</span> <span class="n">batch_bert</span><span class="p">,</span> <span class="n">bert_mask</span><span class="p">)</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crf</span><span class="o">.</span><span class="n">neg_log_likelihood_loss</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">batch_label</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">,</span> <span class="n">tag_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crf</span><span class="o">.</span><span class="n">_viterbi_decode</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">tag_seq</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gaz_list</span><span class="p">,</span> <span class="n">word_inputs</span><span class="p">,</span> <span class="n">biword_inputs</span><span class="p">,</span> <span class="n">word_seq_lengths</span><span class="p">,</span> <span class="n">layer_gaz</span><span class="p">,</span> <span class="n">gaz_count</span><span class="p">,</span> <span class="n">gaz_chars</span><span class="p">,</span> <span class="n">gaz_mask</span><span class="p">,</span>
                <span class="n">gazchar_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">batch_bert</span><span class="p">,</span> <span class="n">bert_mask</span><span class="p">):</span>

        <span class="n">tags</span><span class="p">,</span> <span class="n">gaz_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tags</span><span class="p">(</span><span class="n">gaz_list</span><span class="p">,</span> <span class="n">word_inputs</span><span class="p">,</span> <span class="n">biword_inputs</span><span class="p">,</span> <span class="n">layer_gaz</span><span class="p">,</span> <span class="n">gaz_count</span><span class="p">,</span> <span class="n">gaz_chars</span><span class="p">,</span> <span class="n">gaz_mask</span><span class="p">,</span>
                                        <span class="n">gazchar_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">word_seq_lengths</span><span class="p">,</span> <span class="n">batch_bert</span><span class="p">,</span> <span class="n">bert_mask</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">,</span> <span class="n">tag_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crf</span><span class="o">.</span><span class="n">_viterbi_decode</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tag_seq</span><span class="p">,</span> <span class="n">gaz_match</span>
</code></pre></div>
<hr />
<ul>
<li>代码路径: /models/zhudejun/paper/information_extraction/ner/soft-lexicon/model/layers.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">torch.autograd</span> <span class="k">as</span> <span class="nn">autograd</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>


<span class="k">class</span> <span class="nc">CNNmodel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_layer</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CNNmodel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span> <span class="o">=</span> <span class="n">input_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_layer</span> <span class="o">=</span> <span class="n">num_layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="n">gpu</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cnn_layer0</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnn_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                           <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cnn_layer0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnn_layer0</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cnn_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnn_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_feature</span><span class="p">):</span>
        <span class="n">input_feature</span> <span class="o">=</span> <span class="n">input_feature</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">cnn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnn_layer0</span><span class="p">(</span><span class="n">input_feature</span><span class="p">)</span>  <span class="c1"># (b,h,l)</span>
        <span class="n">cnn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cnn_output</span><span class="p">)</span>
        <span class="n">cnn_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">cnn_output</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_layer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">cnn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnn_layers</span><span class="p">[</span><span class="n">layer</span><span class="p">](</span><span class="n">cnn_output</span><span class="p">)</span>
            <span class="n">cnn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cnn_output</span><span class="p">)</span>
            <span class="n">cnn_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">cnn_output</span><span class="p">)</span>

        <span class="n">cnn_output</span> <span class="o">=</span> <span class="n">cnn_output</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cnn_output</span>


<span class="k">def</span> <span class="nf">clones</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="s2">&quot;Produce N identical layers.&quot;</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>


<span class="k">class</span> <span class="nc">LayerNorm</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="s2">&quot;Construct a layernorm module (See citation for details).&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LayerNorm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_2</span>


<span class="k">class</span> <span class="nc">SublayerConnection</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A residual connection followed by a layer norm.</span>
<span class="sd">    Note for code simplicity the norm is first as opposed to last.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SublayerConnection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">LayerNorm</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">sublayer</span><span class="p">):</span>
        <span class="s2">&quot;Apply residual connection to any sublayer with the same size.&quot;</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">sublayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>


<span class="k">class</span> <span class="nc">EncoderLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="s2">&quot;Encoder is made up of self-attn and feed forward (defined below)&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">self_attn</span><span class="p">,</span> <span class="n">feed_forward</span><span class="p">,</span> <span class="n">dropout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EncoderLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span> <span class="o">=</span> <span class="n">self_attn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feed_forward</span> <span class="o">=</span> <span class="n">feed_forward</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sublayer</span> <span class="o">=</span> <span class="n">clones</span><span class="p">(</span><span class="n">SublayerConnection</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="s2">&quot;Follow Figure 1 (left) for connections.&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sublayer</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">bool</span><span class="p">()))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sublayer</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_forward</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">attention</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Compute &#39;Scaled Dot Product Attention&#39;&quot;</span>
    <span class="n">d_k</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d_k</span><span class="p">)</span>  <span class="c1"># (b,h,l,d) * (b,h,d,l)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">bool</span><span class="p">(),</span> <span class="o">-</span><span class="mf">1e9</span><span class="p">)</span>
    <span class="n">p_attn</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dropout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p_attn</span> <span class="o">=</span> <span class="n">dropout</span><span class="p">(</span><span class="n">p_attn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">p_attn</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">p_attn</span>  <span class="c1"># (b,h,l,l) * (b,h,l,d) = (b,h,l,d)</span>


<span class="k">class</span> <span class="nc">MultiHeadedAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="s2">&quot;Take in model size and number of heads.&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MultiHeadedAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">d_model</span> <span class="o">%</span> <span class="n">h</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="c1"># We assume d_v always equals d_k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span> <span class="o">=</span> <span class="n">d_model</span> <span class="o">//</span> <span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linears</span> <span class="o">=</span> <span class="n">clones</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Implements Figure 2&quot;</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Same mask applied to all h heads.</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>
        <span class="n">nbatches</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># 1) Do all the linear projections in batch from d_model =&gt; h x d_k</span>
        <span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> \
            <span class="p">[</span><span class="n">l</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">nbatches</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linears</span><span class="p">,</span> <span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))]</span>

        <span class="c1"># 2) Apply attention on all the projected vectors in batch.</span>
        <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">attention</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>

        <span class="c1"># 3) &quot;Concat&quot; using a view and apply a final linear.</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">nbatches</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linears</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PositionwiseFeedForward</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="s2">&quot;Implements FFN equation.&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PositionwiseFeedForward</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_ff</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_1</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>


<span class="k">class</span> <span class="nc">PositionalEncoding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="s2">&quot;Implement the PE function.&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">5000</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PositionalEncoding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>

        <span class="c1"># Compute the positional encodings once in log space.</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">max_len</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">div_term</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span>
                             <span class="o">-</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10000.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_model</span><span class="p">))</span>
        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>
        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;pe&#39;</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pe</span><span class="p">[:,</span> <span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span>
                                  <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AttentionModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="s2">&quot;Core encoder is a stack of N layers&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_input</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">num_layer</span><span class="p">,</span> <span class="n">dropout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span>
        <span class="c1"># attn0 = MultiHeadedAttention(head, d_input, d_model)</span>
        <span class="n">attn</span> <span class="o">=</span> <span class="n">MultiHeadedAttention</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">PositionwiseFeedForward</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
        <span class="c1"># position = PositionalEncoding(d_model, dropout)</span>
        <span class="c1"># layer0 = EncoderLayer(d_model, c(attn0), c(ff), dropout)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">EncoderLayer</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="n">attn</span><span class="p">),</span> <span class="n">c</span><span class="p">(</span><span class="n">ff</span><span class="p">),</span> <span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">clones</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">num_layer</span><span class="p">)</span>
        <span class="c1"># layerlist = [copy.deepcopy(layer0),]</span>
        <span class="c1"># for _ in range(num_layer-1):</span>
        <span class="c1">#     layerlist.append(copy.deepcopy(layer))</span>
        <span class="c1"># self.layers = nn.ModuleList(layerlist)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">LayerNorm</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">posi</span> <span class="o">=</span> <span class="n">PositionalEncoding</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input2model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_input</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="s2">&quot;Pass the input (and mask) through each layer in turn.&quot;</span>
        <span class="c1"># x: embedding (b,l,we)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">posi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input2model</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">bool</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NERmodel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_layer</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">biflag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NERmodel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">model_type</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;cnn&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cnn</span> <span class="o">=</span> <span class="n">CNNmodel</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_layer</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">gpu</span><span class="p">)</span>
        <span class="c1"># attention model</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;transformer&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attention_model</span> <span class="o">=</span> <span class="n">AttentionModel</span><span class="p">(</span><span class="n">d_input</span><span class="o">=</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">d_model</span><span class="o">=</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">d_ff</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                                  <span class="n">num_layer</span><span class="o">=</span><span class="n">num_layer</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;lstm&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">num_layer</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="n">biflag</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;cnn&#39;</span><span class="p">:</span>
            <span class="n">feature_out_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cnn</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;transformer&#39;</span><span class="p">:</span>
            <span class="n">feature_out_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_model</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;lstm&#39;</span>
            <span class="n">hidden</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">feature_out</span><span class="p">,</span> <span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>
            <span class="n">feature_out_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">feature_out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feature_out_d</span>
</code></pre></div>
<hr />
<h4 id="3">第3步: 主函数代码的实现<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<ul>
<li>代码路径: /home/ec2-user/code/ner/soft-lexicon/main.py</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">predict_check</span><span class="p">(</span><span class="n">pred_variable</span><span class="p">,</span> <span class="n">gold_variable</span><span class="p">,</span> <span class="n">mask_variable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        input:</span>
<span class="sd">            pred_variable (batch_size, sent_len): pred tag result, in numpy format</span>
<span class="sd">            gold_variable (batch_size, sent_len): gold result variable</span>
<span class="sd">            mask_variable (batch_size, sent_len): mask variable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred_variable</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">gold</span> <span class="o">=</span> <span class="n">gold_variable</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_variable</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">overlaped</span> <span class="o">=</span> <span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">gold</span><span class="p">)</span>
    <span class="n">right_token</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">overlaped</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">total_token</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">right_token</span><span class="p">,</span> <span class="n">total_token</span>

<span class="k">def</span> <span class="nf">recover_label</span><span class="p">(</span><span class="n">pred_variable</span><span class="p">,</span> <span class="n">gold_variable</span><span class="p">,</span> <span class="n">mask_variable</span><span class="p">,</span> <span class="n">label_alphabet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        input:</span>
<span class="sd">            pred_variable (batch_size, sent_len): pred tag result</span>
<span class="sd">            gold_variable (batch_size, sent_len): gold result variable</span>
<span class="sd">            mask_variable (batch_size, sent_len): mask variable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">gold_variable</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">seq_len</span> <span class="o">=</span> <span class="n">gold_variable</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_variable</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">pred_tag</span> <span class="o">=</span> <span class="n">pred_variable</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">gold_tag</span> <span class="o">=</span> <span class="n">gold_variable</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pred_label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gold_label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_alphabet</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pred_tag</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">idy</span><span class="p">]))</span> <span class="k">for</span> <span class="n">idy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq_len</span><span class="p">)</span> <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">idy</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">gold</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_alphabet</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="n">gold_tag</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">idy</span><span class="p">])</span> <span class="k">for</span> <span class="n">idy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq_len</span><span class="p">)</span> <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">idy</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">gold</span><span class="p">))</span>
        <span class="n">pred_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="n">gold_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gold</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pred_label</span><span class="p">,</span> <span class="n">gold_label</span>


<span class="k">def</span> <span class="nf">print_batchword</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">batch_word</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;labels/batchwords.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_word</span><span class="p">)):</span>
            <span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">batch_word</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">word_alphabet</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">words</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">save_data_setting</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">save_file</span><span class="p">):</span>
    <span class="n">new_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># remove input instances</span>
    <span class="n">new_data</span><span class="o">.</span><span class="n">train_texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_data</span><span class="o">.</span><span class="n">dev_texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_data</span><span class="o">.</span><span class="n">test_texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_data</span><span class="o">.</span><span class="n">raw_texts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">new_data</span><span class="o">.</span><span class="n">train_Ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_data</span><span class="o">.</span><span class="n">dev_Ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_data</span><span class="o">.</span><span class="n">test_Ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_data</span><span class="o">.</span><span class="n">raw_Ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># save data settings</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data setting saved to file: &quot;</span><span class="p">,</span> <span class="n">save_file</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_data_setting</span><span class="p">(</span><span class="n">save_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data setting loaded from file: &quot;</span><span class="p">,</span> <span class="n">save_file</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">show_data_summary</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">lr_decay</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">decay_rate</span><span class="p">,</span> <span class="n">init_lr</span><span class="p">):</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">init_lr</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">decay_rate</span><span class="p">)</span> <span class="o">**</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Learning rate is setted as:&quot;</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span>
        <span class="n">param_group</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lr</span>
    <span class="k">return</span> <span class="n">optimizer</span>


<span class="k">def</span> <span class="nf">set_seed</span><span class="p">(</span><span class="n">seed_num</span><span class="o">=</span><span class="mi">1023</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed_num</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed_num</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed_num</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">train_Ids</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;dev&quot;</span><span class="p">:</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dev_Ids</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">test_Ids</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_Ids</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: wrong evaluate name,&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">pred_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gold_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># set model in eval model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">train_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
    <span class="n">total_batch</span> <span class="o">=</span> <span class="n">train_num</span> <span class="o">//</span> <span class="n">batch_size</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">gazes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_batch</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">batch_id</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">train_num</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">train_num</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">instances</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">gaz_list</span><span class="p">,</span> <span class="n">batch_word</span><span class="p">,</span> <span class="n">batch_biword</span><span class="p">,</span> <span class="n">batch_wordlen</span><span class="p">,</span> <span class="n">batch_label</span><span class="p">,</span> <span class="n">layer_gaz</span><span class="p">,</span> <span class="n">gaz_count</span><span class="p">,</span> <span class="n">gaz_chars</span><span class="p">,</span> <span class="n">gaz_mask</span><span class="p">,</span> <span class="n">gazchar_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">batch_bert</span><span class="p">,</span> <span class="n">bert_mask</span> <span class="o">=</span> <span class="n">batchify_with_label</span><span class="p">(</span>
                <span class="n">instance</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_gpu</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_num_layer</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">tag_seq</span><span class="p">,</span> <span class="n">gaz_match</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">gaz_list</span><span class="p">,</span> <span class="n">batch_word</span><span class="p">,</span> <span class="n">batch_biword</span><span class="p">,</span> <span class="n">batch_wordlen</span><span class="p">,</span> <span class="n">layer_gaz</span><span class="p">,</span> <span class="n">gaz_count</span><span class="p">,</span>
                                       <span class="n">gaz_chars</span><span class="p">,</span> <span class="n">gaz_mask</span><span class="p">,</span> <span class="n">gazchar_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">batch_bert</span><span class="p">,</span> <span class="n">bert_mask</span><span class="p">)</span>

            <span class="n">gaz_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">gaz_alphabet</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">batchlist</span> <span class="ow">in</span> <span class="n">gaz_match</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batchlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span>
                        <span class="n">batchlist</span><span class="p">]</span>
            <span class="n">gazes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gaz_list</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;dev&quot;</span><span class="p">:</span>
                <span class="n">pred_label</span><span class="p">,</span> <span class="n">gold_label</span> <span class="o">=</span> <span class="n">recover_label</span><span class="p">(</span><span class="n">tag_seq</span><span class="p">,</span> <span class="n">batch_label</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">label_alphabet</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pred_label</span><span class="p">,</span> <span class="n">gold_label</span> <span class="o">=</span> <span class="n">recover_label</span><span class="p">(</span><span class="n">tag_seq</span><span class="p">,</span> <span class="n">batch_label</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">label_alphabet</span><span class="p">)</span>
            <span class="n">pred_results</span> <span class="o">+=</span> <span class="n">pred_label</span>
            <span class="n">gold_results</span> <span class="o">+=</span> <span class="n">gold_label</span>
    <span class="n">decode_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="n">speed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">/</span> <span class="n">decode_time</span>
    <span class="n">acc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">get_ner_fmeasure</span><span class="p">(</span><span class="n">gold_results</span><span class="p">,</span> <span class="n">pred_results</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">tagScheme</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">speed</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pred_results</span><span class="p">,</span> <span class="n">gazes</span>


<span class="k">def</span> <span class="nf">get_text_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caption</span><span class="p">):</span>
    <span class="n">caption_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">caption</span><span class="p">)</span>
    <span class="n">caption_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;[CLS]&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">caption_tokens</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;[SEP]&#39;</span><span class="p">]</span>
    <span class="n">caption_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">convert_tokens_to_ids</span><span class="p">(</span><span class="n">caption_tokens</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">caption_ids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">:</span>
        <span class="n">caption_ids</span> <span class="o">=</span> <span class="n">caption_ids</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">caption_ids</span> <span class="o">=</span> <span class="n">caption_ids</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">caption_ids</span><span class="p">))</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">caption_ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">caption</span>


<span class="k">def</span> <span class="nf">batchify_with_label</span><span class="p">(</span><span class="n">input_batch_list</span><span class="p">,</span> <span class="n">gpu</span><span class="p">,</span> <span class="n">num_layer</span><span class="p">,</span> <span class="n">volatile_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_batch_list</span><span class="p">)</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">input_batch_list</span><span class="p">]</span>
    <span class="n">biwords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">input_batch_list</span><span class="p">]</span>
    <span class="n">gazs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">input_batch_list</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">input_batch_list</span><span class="p">]</span>
    <span class="n">layer_gazs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">input_batch_list</span><span class="p">]</span>
    <span class="n">gaz_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">input_batch_list</span><span class="p">]</span>
    <span class="n">gaz_chars</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">input_batch_list</span><span class="p">]</span>
    <span class="n">gaz_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">input_batch_list</span><span class="p">]</span>
    <span class="n">gazchar_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">input_batch_list</span><span class="p">]</span>
    <span class="c1"># bert tokens</span>
    <span class="n">bert_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">input_batch_list</span><span class="p">]</span>

    <span class="n">word_seq_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">words</span><span class="p">)))</span>
    <span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">word_seq_lengths</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">word_seq_tensor</span> <span class="o">=</span> <span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">)))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="n">biword_seq_tensor</span> <span class="o">=</span> <span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">)))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="n">label_seq_tensor</span> <span class="o">=</span> <span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">)))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">)))</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span>
    <span class="c1"># bert seq tensor</span>
    <span class="n">bert_seq_tensor</span> <span class="o">=</span> <span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_seq_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="n">bert_mask</span> <span class="o">=</span> <span class="n">autograd</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_seq_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>

    <span class="n">gaz_num</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">layer_gazs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)]</span>
    <span class="n">max_gaz_num</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gaz_num</span><span class="p">)</span>
    <span class="n">layer_gaz_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">max_gaz_num</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="n">gaz_count_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">max_gaz_num</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">gaz_len</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">gaz_chars</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)]</span>
    <span class="n">max_gaz_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gaz_len</span><span class="p">)</span>
    <span class="n">gaz_chars_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">max_gaz_num</span><span class="p">,</span> <span class="n">max_gaz_len</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="n">gaz_mask_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">max_gaz_num</span><span class="p">)</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span>
    <span class="n">gazchar_mask_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">max_seq_len</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">max_gaz_num</span><span class="p">,</span> <span class="n">max_gaz_len</span><span class="p">)</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">bert_id</span><span class="p">,</span> <span class="n">biseq</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">seqlen</span><span class="p">,</span> <span class="n">layergaz</span><span class="p">,</span> <span class="n">gazmask</span><span class="p">,</span> <span class="n">gazcount</span><span class="p">,</span> <span class="n">gazchar</span><span class="p">,</span> <span class="n">gazchar_mask</span><span class="p">,</span> <span class="n">gaznum</span><span class="p">,</span>
            <span class="n">gazlen</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">bert_ids</span><span class="p">,</span> <span class="n">biwords</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">word_seq_lengths</span><span class="p">,</span> <span class="n">layer_gazs</span><span class="p">,</span> <span class="n">gaz_mask</span><span class="p">,</span> <span class="n">gaz_count</span><span class="p">,</span> <span class="n">gaz_chars</span><span class="p">,</span>
            <span class="n">gazchar_mask</span><span class="p">,</span> <span class="n">gaz_num</span><span class="p">,</span> <span class="n">gaz_len</span><span class="p">)):</span>
        <span class="n">word_seq_tensor</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">seqlen</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">biword_seq_tensor</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">seqlen</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">biseq</span><span class="p">)</span>
        <span class="n">label_seq_tensor</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">seqlen</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">layer_gaz_tensor</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">seqlen</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">gaznum</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">layergaz</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">seqlen</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">seqlen</span><span class="p">))</span>
        <span class="n">bert_mask</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">seqlen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">seqlen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">gaz_mask_tensor</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">seqlen</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">gaznum</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ByteTensor</span><span class="p">(</span><span class="n">gazmask</span><span class="p">)</span>
        <span class="n">gaz_count_tensor</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">seqlen</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">gaznum</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">gazcount</span><span class="p">)</span>
        <span class="n">gaz_count_tensor</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">seqlen</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">gaz_chars_tensor</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">seqlen</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">gaznum</span><span class="p">,</span> <span class="p">:</span><span class="n">gazlen</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">gazchar</span><span class="p">)</span>
        <span class="n">gazchar_mask_tensor</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">seqlen</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">gaznum</span><span class="p">,</span> <span class="p">:</span><span class="n">gazlen</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ByteTensor</span><span class="p">(</span><span class="n">gazchar_mask</span><span class="p">)</span>
        <span class="c1"># bert</span>
        <span class="n">bert_seq_tensor</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">seqlen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">bert_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gpu</span><span class="p">:</span>
        <span class="n">word_seq_tensor</span> <span class="o">=</span> <span class="n">word_seq_tensor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">biword_seq_tensor</span> <span class="o">=</span> <span class="n">biword_seq_tensor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">word_seq_lengths</span> <span class="o">=</span> <span class="n">word_seq_lengths</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">label_seq_tensor</span> <span class="o">=</span> <span class="n">label_seq_tensor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">layer_gaz_tensor</span> <span class="o">=</span> <span class="n">layer_gaz_tensor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">gaz_chars_tensor</span> <span class="o">=</span> <span class="n">gaz_chars_tensor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">gaz_mask_tensor</span> <span class="o">=</span> <span class="n">gaz_mask_tensor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">gazchar_mask_tensor</span> <span class="o">=</span> <span class="n">gazchar_mask_tensor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">gaz_count_tensor</span> <span class="o">=</span> <span class="n">gaz_count_tensor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">bert_seq_tensor</span> <span class="o">=</span> <span class="n">bert_seq_tensor</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">bert_mask</span> <span class="o">=</span> <span class="n">bert_mask</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

    <span class="c1"># print(bert_seq_tensor.type())</span>
    <span class="k">return</span> <span class="n">gazs</span><span class="p">,</span> <span class="n">word_seq_tensor</span><span class="p">,</span> <span class="n">biword_seq_tensor</span><span class="p">,</span> <span class="n">word_seq_lengths</span><span class="p">,</span> <span class="n">label_seq_tensor</span><span class="p">,</span> <span class="n">layer_gaz_tensor</span><span class="p">,</span> <span class="n">gaz_count_tensor</span><span class="p">,</span> <span class="n">gaz_chars_tensor</span><span class="p">,</span> <span class="n">gaz_mask_tensor</span><span class="p">,</span> <span class="n">gazchar_mask_tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bert_seq_tensor</span><span class="p">,</span> <span class="n">bert_mask</span>


<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">save_model_dir</span><span class="p">,</span> <span class="n">seg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training with </span><span class="si">{}</span><span class="s2"> model.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">model_type</span><span class="p">))</span>
    <span class="c1"># data.show_data_summary()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SeqModel</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;finish building model.&quot;</span><span class="p">)</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adamax</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">HP_lr</span><span class="p">)</span>

    <span class="n">best_dev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">best_dev_p</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">best_dev_r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">best_test</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">best_test_p</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">best_test_r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># start training</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">HP_iteration</span><span class="p">):</span>
        <span class="n">epoch_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">temp_start</span> <span class="o">=</span> <span class="n">epoch_start</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Epoch: </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_iteration</span><span class="p">)))</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">lr_decay</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_lr_decay</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_lr</span><span class="p">)</span>
        <span class="n">instance_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sample_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">right_token</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">whole_token</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">train_Ids</span><span class="p">)</span>
        <span class="c1"># set model in train model</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_batch_size</span>
        <span class="n">batch_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">train_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">train_Ids</span><span class="p">)</span>
        <span class="n">total_batch</span> <span class="o">=</span> <span class="n">train_num</span> <span class="o">//</span> <span class="n">batch_size</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">batch_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_batch</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">batch_id</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">train_num</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">train_num</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">train_Ids</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">train_texts</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">gaz_list</span><span class="p">,</span> <span class="n">batch_word</span><span class="p">,</span> <span class="n">batch_biword</span><span class="p">,</span> <span class="n">batch_wordlen</span><span class="p">,</span> <span class="n">batch_label</span><span class="p">,</span> <span class="n">layer_gaz</span><span class="p">,</span> <span class="n">gaz_count</span><span class="p">,</span> <span class="n">gaz_chars</span><span class="p">,</span> <span class="n">gaz_mask</span><span class="p">,</span> <span class="n">gazchar_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">batch_bert</span><span class="p">,</span> <span class="n">bert_mask</span> <span class="o">=</span> <span class="n">batchify_with_label</span><span class="p">(</span>
                <span class="n">instance</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_gpu</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_num_layer</span><span class="p">)</span>

            <span class="n">instance_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">loss</span><span class="p">,</span> <span class="n">tag_seq</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">neg_log_likelihood_loss</span><span class="p">(</span><span class="n">gaz_list</span><span class="p">,</span> <span class="n">batch_word</span><span class="p">,</span> <span class="n">batch_biword</span><span class="p">,</span> <span class="n">batch_wordlen</span><span class="p">,</span> <span class="n">layer_gaz</span><span class="p">,</span>
                                                          <span class="n">gaz_count</span><span class="p">,</span> <span class="n">gaz_chars</span><span class="p">,</span> <span class="n">gaz_mask</span><span class="p">,</span> <span class="n">gazchar_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
                                                          <span class="n">batch_label</span><span class="p">,</span> <span class="n">batch_bert</span><span class="p">,</span> <span class="n">bert_mask</span><span class="p">)</span>

            <span class="n">right</span><span class="p">,</span> <span class="n">whole</span> <span class="o">=</span> <span class="n">predict_check</span><span class="p">(</span><span class="n">tag_seq</span><span class="p">,</span> <span class="n">batch_label</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">right_token</span> <span class="o">+=</span> <span class="n">right</span>
            <span class="n">whole_token</span> <span class="o">+=</span> <span class="n">whole</span>
            <span class="n">sample_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">data</span>
            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">data</span>
            <span class="n">batch_loss</span> <span class="o">+=</span> <span class="n">loss</span>

            <span class="k">if</span> <span class="n">end</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">temp_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">temp_cost</span> <span class="o">=</span> <span class="n">temp_time</span> <span class="o">-</span> <span class="n">temp_start</span>
                <span class="n">temp_start</span> <span class="o">=</span> <span class="n">temp_time</span>
                <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;     Instance: </span><span class="si">%s</span><span class="s2">; Time: </span><span class="si">%.2f</span><span class="s2">s; loss: </span><span class="si">%.4f</span><span class="s2">; acc: </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">=</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">end</span><span class="p">,</span> <span class="n">temp_cost</span><span class="p">,</span> <span class="n">sample_loss</span><span class="p">,</span> <span class="n">right_token</span><span class="p">,</span> <span class="n">whole_token</span><span class="p">,</span> <span class="p">(</span><span class="n">right_token</span> <span class="o">+</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">/</span> <span class="n">whole_token</span><span class="p">)))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">sample_loss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">%</span> <span class="n">data</span><span class="o">.</span><span class="n">HP_batch_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">batch_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">batch_loss</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">temp_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">temp_cost</span> <span class="o">=</span> <span class="n">temp_time</span> <span class="o">-</span> <span class="n">temp_start</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;     Instance: </span><span class="si">%s</span><span class="s2">; Time: </span><span class="si">%.2f</span><span class="s2">s; loss: </span><span class="si">%.4f</span><span class="s2">; acc: </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">=</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">end</span><span class="p">,</span> <span class="n">temp_cost</span><span class="p">,</span> <span class="n">sample_loss</span><span class="p">,</span> <span class="n">right_token</span><span class="p">,</span> <span class="n">whole_token</span><span class="p">,</span> <span class="p">(</span><span class="n">right_token</span> <span class="o">+</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">/</span> <span class="n">whole_token</span><span class="p">)))</span>
        <span class="n">epoch_finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">epoch_cost</span> <span class="o">=</span> <span class="n">epoch_finish</span> <span class="o">-</span> <span class="n">epoch_start</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Epoch: </span><span class="si">%s</span><span class="s2"> training finished. Time: </span><span class="si">%.2f</span><span class="s2">s, speed: </span><span class="si">%.2f</span><span class="s2">st/s,  total loss: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">idx</span><span class="p">,</span> <span class="n">epoch_cost</span><span class="p">,</span> <span class="n">train_num</span> <span class="o">/</span> <span class="n">epoch_cost</span><span class="p">,</span> <span class="n">total_loss</span><span class="p">)))</span>

        <span class="n">speed</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pred_labels</span><span class="p">,</span> <span class="n">gazs</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="s2">&quot;dev&quot;</span><span class="p">)</span>
        <span class="n">dev_finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">dev_cost</span> <span class="o">=</span> <span class="n">dev_finish</span> <span class="o">-</span> <span class="n">epoch_finish</span>

        <span class="k">if</span> <span class="n">seg</span><span class="p">:</span>
            <span class="n">current_score</span> <span class="o">=</span> <span class="n">f</span>
            <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Dev: time: </span><span class="si">%.2f</span><span class="s2">s, speed: </span><span class="si">%.2f</span><span class="s2">st/s; acc: </span><span class="si">%.4f</span><span class="s2">, p: </span><span class="si">%.4f</span><span class="s2">, r: </span><span class="si">%.4f</span><span class="s2">, f: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">dev_cost</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_score</span> <span class="o">=</span> <span class="n">acc</span>
            <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Dev: time: </span><span class="si">%.2f</span><span class="s2">s speed: </span><span class="si">%.2f</span><span class="s2">st/s; acc: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dev_cost</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">acc</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">current_score</span> <span class="o">&gt;</span> <span class="n">best_dev</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seg</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exceed previous best f score:&quot;</span><span class="p">,</span> <span class="n">best_dev</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exceed previous best acc score:&quot;</span><span class="p">,</span> <span class="n">best_dev</span><span class="p">)</span>

            <span class="n">model_name</span> <span class="o">=</span> <span class="n">save_model_dir</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="c1"># best_dev = current_score</span>
            <span class="n">best_dev_p</span> <span class="o">=</span> <span class="n">p</span>
            <span class="n">best_dev_r</span> <span class="o">=</span> <span class="n">r</span>

        <span class="c1"># ## decode test</span>
        <span class="n">speed</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pred_labels</span><span class="p">,</span> <span class="n">gazs</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">)</span>
        <span class="n">test_finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">test_cost</span> <span class="o">=</span> <span class="n">test_finish</span> <span class="o">-</span> <span class="n">dev_finish</span>
        <span class="k">if</span> <span class="n">seg</span><span class="p">:</span>
            <span class="n">current_test_score</span> <span class="o">=</span> <span class="n">f</span>
            <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Test: time: </span><span class="si">%.2f</span><span class="s2">s, speed: </span><span class="si">%.2f</span><span class="s2">st/s; acc: </span><span class="si">%.4f</span><span class="s2">, p: </span><span class="si">%.4f</span><span class="s2">, r: </span><span class="si">%.4f</span><span class="s2">, f: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">test_cost</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_test_score</span> <span class="o">=</span> <span class="n">acc</span>
            <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Test: time: </span><span class="si">%.2f</span><span class="s2">s, speed: </span><span class="si">%.2f</span><span class="s2">st/s; acc: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_cost</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">acc</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">current_score</span> <span class="o">&gt;</span> <span class="n">best_dev</span><span class="p">:</span>
            <span class="n">best_dev</span> <span class="o">=</span> <span class="n">current_score</span>
            <span class="n">best_test</span> <span class="o">=</span> <span class="n">current_test_score</span>
            <span class="n">best_test_p</span> <span class="o">=</span> <span class="n">p</span>
            <span class="n">best_test_r</span> <span class="o">=</span> <span class="n">r</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best dev score: p:</span><span class="si">{}</span><span class="s2">, r:</span><span class="si">{}</span><span class="s2">, f:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_dev_p</span><span class="p">,</span> <span class="n">best_dev_r</span><span class="p">,</span> <span class="n">best_dev</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test score: p:</span><span class="si">{}</span><span class="s2">, r:</span><span class="si">{}</span><span class="s2">, f:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_test_p</span><span class="p">,</span> <span class="n">best_test_r</span><span class="p">,</span> <span class="n">best_test</span><span class="p">))</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">result_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">save_model_dir</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Best dev score: p:</span><span class="si">{}</span><span class="s2">, r:</span><span class="si">{}</span><span class="s2">, f:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_dev_p</span><span class="p">,</span> <span class="n">best_dev_r</span><span class="p">,</span> <span class="n">best_dev</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Test score: p:</span><span class="si">{}</span><span class="s2">, r:</span><span class="si">{}</span><span class="s2">, f:</span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_test_p</span><span class="p">,</span> <span class="n">best_test_r</span><span class="p">,</span> <span class="n">best_test</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">load_model_decode</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">gpu</span><span class="p">,</span> <span class="n">seg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">data</span><span class="o">.</span><span class="n">HP_gpu</span> <span class="o">=</span> <span class="n">gpu</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load Model from file: &quot;</span><span class="p">,</span> <span class="n">model_dir</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SeqModel</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_dir</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;Decode </span><span class="si">%s</span><span class="s2"> data ...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">)))</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">speed</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pred_results</span><span class="p">,</span> <span class="n">gazs</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">time_cost</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="k">if</span> <span class="n">seg</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: time:</span><span class="si">%.2f</span><span class="s2">s, speed:</span><span class="si">%.2f</span><span class="s2">st/s; acc: </span><span class="si">%.4f</span><span class="s2">, p: </span><span class="si">%.4f</span><span class="s2">, r: </span><span class="si">%.4f</span><span class="s2">, f: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">time_cost</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: time:</span><span class="si">%.2f</span><span class="s2">s, speed:</span><span class="si">%.2f</span><span class="s2">st/s; acc: </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">time_cost</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">acc</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">pred_results</span>


<span class="k">def</span> <span class="nf">print_results</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">modelname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">toprint</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sen</span> <span class="ow">in</span> <span class="n">pred</span><span class="p">:</span>
        <span class="n">sen</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sen</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">toprint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sen</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">modelname</span> <span class="o">+</span> <span class="s1">&#39;_labels.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">toprint</span><span class="p">)</span>
</code></pre></div>
<hr />
<h4 id="4">第4步: 训练与测试脚本<a class="headerlink" href="#4" title="Permanent link">&para;</a></h4>
<ul>
<li>训练脚本: /home/ec2-user/code/ner/soft-lexicon/train.sh</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">python</span> <span class="n">main</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">train</span> <span class="n">data</span><span class="o">/</span><span class="n">ResumeNER</span><span class="o">/</span><span class="n">train</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">bmes</span> <span class="o">--</span><span class="n">dev</span> <span class="n">data</span><span class="o">/</span><span class="n">ResumeNER</span><span class="o">/</span><span class="n">dev</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">bmes</span> <span class="o">--</span><span class="n">test</span> <span class="n">data</span><span class="o">/</span><span class="n">ResumeNER</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">bmes</span> <span class="o">--</span><span class="n">modelname</span> <span class="n">ResumeNER</span> <span class="o">--</span><span class="n">savedset</span> <span class="n">data</span><span class="o">/</span><span class="n">data</span><span class="o">.</span><span class="n">dset</span>
</code></pre></div>
<hr />
<ul>
<li>测试脚本: /home/ec2-user/code/ner/soft-lexicon/test.sh</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">python</span> <span class="n">main</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">test</span> <span class="n">data</span><span class="o">/</span><span class="n">ResumeNER</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">bmes</span> <span class="o">--</span><span class="n">modelname</span> <span class="n">ResumeNER</span> <span class="o">--</span><span class="n">savedset</span> <span class="n">data</span><span class="o">/</span><span class="n">data</span><span class="o">.</span><span class="n">dset</span>
</code></pre></div>
<hr />
<h4 id="5">第5步: 模型的训练<a class="headerlink" href="#5" title="Permanent link">&para;</a></h4>
<ul>
<li>调用:</li>
</ul>
<div class="highlight"><pre><span></span><code>sh train.sh
</code></pre></div>
<hr />
<ul>
<li>输出结果:</li>
</ul>
<div class="highlight"><pre><span></span><code>Loading processed train data
data.use_biword= False
Training with lstm model.
build batched crf...
finish building model.
Epoch: 0/100
 Learning rate is setted as: 0.0015
     Instance: 500; Time: 32.52s; loss: 6444.8052; acc: 21720.0/23426.0=0.9272
     Instance: 1000; Time: 30.42s; loss: 3167.6731; acc: 42567.0/45188.0=0.9420
     Instance: 1500; Time: 30.38s; loss: 2078.1272; acc: 63642.0/66928.0=0.9509
     Instance: 1999; Time: 32.58s; loss: 1800.6085; acc: 86516.0/90371.0=0.9573
Epoch: 0 training finished. Time: 125.90s, speed: 15.88st/s,  total loss: tensor(13491.2178, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1044  right_num =  860
Dev: time: 4.59s, speed: 115.96st/s; acc: 0.9660, p: 0.8238, r: 0.8382, f: 0.8309
Exceed previous best f score: -1
gold_num =  1026  pred_num =  1044  right_num =  860
Test: time: 4.58s, speed: 117.17st/s; acc: 0.9660, p: 0.8238, r: 0.8382, f: 0.8309
Best dev score: p:0.8237547892720306, r:0.8382066276803118, f:0.8309178743961353
Test score: p:0.8237547892720306, r:0.8382066276803118, f:0.8309178743961353
Epoch: 1/100
 Learning rate is setted as: 0.001425
     Instance: 500; Time: 30.69s; loss: 1172.0479; acc: 21708.0/22138.0=0.9806
     Instance: 1000; Time: 30.97s; loss: 1389.0051; acc: 43721.0/44522.0=0.9820
     Instance: 1500; Time: 31.34s; loss: 1115.4781; acc: 66035.0/67218.0=0.9824
     Instance: 1999; Time: 32.04s; loss: 991.1306; acc: 88852.0/90371.0=0.9832
Epoch: 1 training finished. Time: 125.04s, speed: 15.99st/s,  total loss: tensor(4667.6572, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1059  right_num =  922
Dev: time: 4.55s, speed: 116.99st/s; acc: 0.9761, p: 0.8706, r: 0.8986, f: 0.8844
Exceed previous best f score: 0.8309178743961353
gold_num =  1026  pred_num =  1059  right_num =  922
Test: time: 4.59s, speed: 116.86st/s; acc: 0.9761, p: 0.8706, r: 0.8986, f: 0.8844
Best dev score: p:0.8706326723323891, r:0.898635477582846, f:0.8844124700239807
Test score: p:0.8706326723323891, r:0.898635477582846, f:0.8844124700239807
Epoch: 2/100
 Learning rate is setted as: 0.00135375
     Instance: 500; Time: 30.50s; loss: 1005.5997; acc: 21713.0/21989.0=0.9874
     Instance: 1000; Time: 32.26s; loss: 812.4775; acc: 44653.0/45218.0=0.9875
     Instance: 1500; Time: 30.83s; loss: 613.4433; acc: 66666.0/67473.0=0.9880
     Instance: 1999; Time: 31.60s; loss: 657.8646; acc: 89294.0/90371.0=0.9881
Epoch: 2 training finished. Time: 125.19s, speed: 15.97st/s,  total loss: tensor(3089.3857, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  944  right_num =  916
Dev: time: 4.54s, speed: 117.28st/s; acc: 0.9832, p: 0.9703, r: 0.8928, f: 0.9299
Exceed previous best f score: 0.8844124700239807
gold_num =  1026  pred_num =  944  right_num =  916
Test: time: 4.57s, speed: 117.25st/s; acc: 0.9832, p: 0.9703, r: 0.8928, f: 0.9299
Best dev score: p:0.9703389830508474, r:0.8927875243664717, f:0.9299492385786802
Test score: p:0.9703389830508474, r:0.8927875243664717, f:0.9299492385786802
Epoch: 3/100
 Learning rate is setted as: 0.0012860624999999999
     Instance: 500; Time: 31.68s; loss: 403.6226; acc: 22831.0/22985.0=0.9933
     Instance: 1000; Time: 30.65s; loss: 794.4869; acc: 44707.0/45127.0=0.9907
     Instance: 1500; Time: 30.32s; loss: 544.4160; acc: 66367.0/67016.0=0.9903
     Instance: 1999; Time: 32.27s; loss: 545.2573; acc: 89498.0/90371.0=0.9903
Epoch: 3 training finished. Time: 124.93s, speed: 16.00st/s,  total loss: tensor(2287.7854, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1086  right_num =  983
Dev: time: 4.56s, speed: 116.88st/s; acc: 0.9847, p: 0.9052, r: 0.9581, f: 0.9309
Exceed previous best f score: 0.9299492385786802
gold_num =  1026  pred_num =  1086  right_num =  983
Test: time: 4.58s, speed: 117.16st/s; acc: 0.9847, p: 0.9052, r: 0.9581, f: 0.9309
Best dev score: p:0.9051565377532228, r:0.9580896686159844, f:0.9308712121212122
Test score: p:0.9051565377532228, r:0.9580896686159844, f:0.9308712121212122
Epoch: 4/100
 Learning rate is setted as: 0.0012217593749999998
     Instance: 500; Time: 31.63s; loss: 430.0888; acc: 22695.0/22871.0=0.9923
     Instance: 1000; Time: 30.07s; loss: 396.8073; acc: 44065.0/44404.0=0.9924
     Instance: 1500; Time: 31.81s; loss: 561.2547; acc: 66870.0/67412.0=0.9920
     Instance: 1999; Time: 31.80s; loss: 382.0838; acc: 89671.0/90371.0=0.9923
Epoch: 4 training finished. Time: 125.31s, speed: 15.95st/s,  total loss: tensor(1770.2340, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1035  right_num =  976
Dev: time: 4.53s, speed: 117.55st/s; acc: 0.9872, p: 0.9430, r: 0.9513, f: 0.9471
Exceed previous best f score: 0.9308712121212122
gold_num =  1026  pred_num =  1035  right_num =  976
Test: time: 4.55s, speed: 117.74st/s; acc: 0.9872, p: 0.9430, r: 0.9513, f: 0.9471
Best dev score: p:0.9429951690821256, r:0.9512670565302144, f:0.9471130519165454
Test score: p:0.9429951690821256, r:0.9512670565302144, f:0.9471130519165454
Epoch: 5/100
 Learning rate is setted as: 0.0011606714062499996
     Instance: 500; Time: 31.05s; loss: 476.5773; acc: 22253.0/22429.0=0.9922
     Instance: 1000; Time: 31.19s; loss: 347.2917; acc: 44649.0/44970.0=0.9929
     Instance: 1500; Time: 31.67s; loss: 251.4872; acc: 67279.0/67724.0=0.9934
     Instance: 1999; Time: 31.51s; loss: 402.8557; acc: 89768.0/90371.0=0.9933
Epoch: 5 training finished. Time: 125.42s, speed: 15.94st/s,  total loss: tensor(1478.2144, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1093  right_num =  1006
Dev: time: 4.52s, speed: 117.85st/s; acc: 0.9883, p: 0.9204, r: 0.9805, f: 0.9495
Exceed previous best f score: 0.9471130519165454
gold_num =  1026  pred_num =  1093  right_num =  1006
Test: time: 4.55s, speed: 117.84st/s; acc: 0.9883, p: 0.9204, r: 0.9805, f: 0.9495
Best dev score: p:0.9204025617566332, r:0.9805068226120858, f:0.9495044832468145
Test score: p:0.9204025617566332, r:0.9805068226120858, f:0.9495044832468145
Epoch: 6/100
 Learning rate is setted as: 0.0011026378359374996
     Instance: 500; Time: 30.73s; loss: 262.0597; acc: 22079.0/22186.0=0.9952
     Instance: 1000; Time: 32.20s; loss: 478.9395; acc: 45099.0/45386.0=0.9937
     Instance: 1500; Time: 32.35s; loss: 300.3384; acc: 68196.0/68619.0=0.9938
     Instance: 1999; Time: 30.45s; loss: 234.9602; acc: 89839.0/90371.0=0.9941
Epoch: 6 training finished. Time: 125.73s, speed: 15.90st/s,  total loss: tensor(1276.2983, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1041  right_num =  993
Dev: time: 4.51s, speed: 117.94st/s; acc: 0.9901, p: 0.9539, r: 0.9678, f: 0.9608
Exceed previous best f score: 0.9495044832468145
gold_num =  1026  pred_num =  1041  right_num =  993
Test: time: 4.54s, speed: 118.11st/s; acc: 0.9901, p: 0.9539, r: 0.9678, f: 0.9608
Best dev score: p:0.9538904899135446, r:0.9678362573099415, f:0.9608127721335267
Test score: p:0.9538904899135446, r:0.9678362573099415, f:0.9608127721335267
Epoch: 7/100
 Learning rate is setted as: 0.0010475059441406246
     Instance: 500; Time: 32.10s; loss: 325.9810; acc: 23012.0/23160.0=0.9936
     Instance: 1000; Time: 31.01s; loss: 345.6270; acc: 45099.0/45378.0=0.9939
     Instance: 1500; Time: 30.36s; loss: 232.4619; acc: 66770.0/67140.0=0.9945
     Instance: 1999; Time: 31.99s; loss: 206.1491; acc: 89900.0/90371.0=0.9948
Epoch: 7 training finished. Time: 125.46s, speed: 15.93st/s,  total loss: tensor(1110.2185, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1027  right_num =  995
Dev: time: 4.52s, speed: 117.89st/s; acc: 0.9918, p: 0.9688, r: 0.9698, f: 0.9693
Exceed previous best f score: 0.9608127721335267
gold_num =  1026  pred_num =  1027  right_num =  995
Test: time: 4.55s, speed: 117.85st/s; acc: 0.9918, p: 0.9688, r: 0.9698, f: 0.9693
Best dev score: p:0.9688412852969815, r:0.969785575048733, f:0.9693132001948369
Test score: p:0.9688412852969815, r:0.969785575048733, f:0.9693132001948369
Epoch: 8/100
 Learning rate is setted as: 0.0009951306469335934
     Instance: 500; Time: 30.15s; loss: 145.6180; acc: 21728.0/21791.0=0.9971
     Instance: 1000; Time: 31.16s; loss: 179.2465; acc: 44238.0/44364.0=0.9972
     Instance: 1500; Time: 31.83s; loss: 358.9080; acc: 67124.0/67392.0=0.9960
     Instance: 1999; Time: 31.94s; loss: 207.7906; acc: 90002.0/90371.0=0.9959
Epoch: 8 training finished. Time: 125.08s, speed: 15.98st/s,  total loss: tensor(891.5626, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1010  right_num =  991
Dev: time: 4.53s, speed: 117.62st/s; acc: 0.9921, p: 0.9812, r: 0.9659, f: 0.9735
Exceed previous best f score: 0.9693132001948369
gold_num =  1026  pred_num =  1010  right_num =  991
Test: time: 4.56s, speed: 117.50st/s; acc: 0.9921, p: 0.9812, r: 0.9659, f: 0.9735
Best dev score: p:0.9811881188118812, r:0.9658869395711501, f:0.9734774066797642
Test score: p:0.9811881188118812, r:0.9658869395711501, f:0.9734774066797642
Epoch: 9/100
 Learning rate is setted as: 0.0009453741145869137
     Instance: 500; Time: 31.15s; loss: 138.0381; acc: 22476.0/22555.0=0.9965
     Instance: 1000; Time: 32.52s; loss: 178.7251; acc: 45873.0/46036.0=0.9965
     Instance: 1500; Time: 31.77s; loss: 158.4235; acc: 68650.0/68897.0=0.9964
     Instance: 1999; Time: 29.93s; loss: 303.3596; acc: 89993.0/90371.0=0.9958
Epoch: 9 training finished. Time: 125.36s, speed: 15.95st/s,  total loss: tensor(778.5462, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1074  right_num =  1010
Dev: time: 4.50s, speed: 118.26st/s; acc: 0.9905, p: 0.9404, r: 0.9844, f: 0.9619
gold_num =  1026  pred_num =  1074  right_num =  1010
Test: time: 4.50s, speed: 118.24st/s; acc: 0.9905, p: 0.9404, r: 0.9844, f: 0.9619
Best dev score: p:0.9811881188118812, r:0.9658869395711501, f:0.9734774066797642
Test score: p:0.9811881188118812, r:0.9658869395711501, f:0.9734774066797642
Epoch: 10/100
 Learning rate is setted as: 0.000898105408857568
     Instance: 500; Time: 30.77s; loss: 185.2131; acc: 22130.0/22219.0=0.9960
     Instance: 1000; Time: 31.61s; loss: 170.6009; acc: 44944.0/45115.0=0.9962
     Instance: 1500; Time: 30.81s; loss: 338.3507; acc: 66986.0/67311.0=0.9952
     Instance: 1999; Time: 31.91s; loss: 98.8729; acc: 90000.0/90371.0=0.9959
Epoch: 10 training finished. Time: 125.10s, speed: 15.98st/s,  total loss: tensor(793.0366, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1040  right_num =  1006
Dev: time: 4.54s, speed: 117.18st/s; acc: 0.9926, p: 0.9673, r: 0.9805, f: 0.9739
Exceed previous best f score: 0.9734774066797642
gold_num =  1026  pred_num =  1040  right_num =  1006
Test: time: 4.58s, speed: 117.11st/s; acc: 0.9926, p: 0.9673, r: 0.9805, f: 0.9739
Best dev score: p:0.9673076923076923, r:0.9805068226120858, f:0.973862536302033
Test score: p:0.9673076923076923, r:0.9805068226120858, f:0.973862536302033
Epoch: 11/100
 Learning rate is setted as: 0.0008532001384146896
     Instance: 500; Time: 32.79s; loss: 127.8185; acc: 23598.0/23661.0=0.9973
     Instance: 1000; Time: 30.19s; loss: 93.6887; acc: 45117.0/45227.0=0.9976
     Instance: 1500; Time: 31.18s; loss: 346.0098; acc: 67379.0/67649.0=0.9960
     Instance: 1999; Time: 31.40s; loss: 128.3599; acc: 90036.0/90371.0=0.9963
Epoch: 11 training finished. Time: 125.57s, speed: 15.92st/s,  total loss: tensor(695.8771, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1044  right_num =  1006
Dev: time: 4.52s, speed: 117.92st/s; acc: 0.9926, p: 0.9636, r: 0.9805, f: 0.9720
gold_num =  1026  pred_num =  1044  right_num =  1006
Test: time: 4.51s, speed: 117.99st/s; acc: 0.9926, p: 0.9636, r: 0.9805, f: 0.9720
Best dev score: p:0.9673076923076923, r:0.9805068226120858, f:0.973862536302033
Test score: p:0.9673076923076923, r:0.9805068226120858, f:0.973862536302033
Epoch: 12/100
 Learning rate is setted as: 0.000810540131493955
     Instance: 500; Time: 31.66s; loss: 100.7936; acc: 22946.0/22989.0=0.9981
     Instance: 1000; Time: 31.42s; loss: 144.7101; acc: 45592.0/45712.0=0.9974
     Instance: 1500; Time: 30.43s; loss: 118.6685; acc: 67384.0/67560.0=0.9974
     Instance: 1999; Time: 31.69s; loss: 211.4471; acc: 90094.0/90371.0=0.9969
Epoch: 12 training finished. Time: 125.20s, speed: 15.97st/s,  total loss: tensor(575.6193, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1070  right_num =  1011
Dev: time: 4.52s, speed: 117.76st/s; acc: 0.9895, p: 0.9449, r: 0.9854, f: 0.9647
gold_num =  1026  pred_num =  1070  right_num =  1011
Test: time: 4.52s, speed: 117.67st/s; acc: 0.9895, p: 0.9449, r: 0.9854, f: 0.9647
Best dev score: p:0.9673076923076923, r:0.9805068226120858, f:0.973862536302033
Test score: p:0.9673076923076923, r:0.9805068226120858, f:0.973862536302033
Epoch: 13/100
 Learning rate is setted as: 0.0007700131249192573
     Instance: 500; Time: 30.08s; loss: 81.7210; acc: 21509.0/21544.0=0.9984
     Instance: 1000; Time: 31.09s; loss: 80.9707; acc: 43756.0/43829.0=0.9983
     Instance: 1500; Time: 32.41s; loss: 87.4174; acc: 67061.0/67178.0=0.9983
     Instance: 1999; Time: 32.24s; loss: 293.8628; acc: 90114.0/90371.0=0.9972
Epoch: 13 training finished. Time: 125.82s, speed: 15.89st/s,  total loss: tensor(543.9722, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1034  right_num =  1010
Dev: time: 4.51s, speed: 118.14st/s; acc: 0.9944, p: 0.9768, r: 0.9844, f: 0.9806
Exceed previous best f score: 0.973862536302033
gold_num =  1026  pred_num =  1034  right_num =  1010
Test: time: 4.55s, speed: 117.89st/s; acc: 0.9944, p: 0.9768, r: 0.9844, f: 0.9806
Best dev score: p:0.97678916827853, r:0.9844054580896686, f:0.9805825242718447
Test score: p:0.97678916827853, r:0.9844054580896686, f:0.9805825242718447
Epoch: 14/100
 Learning rate is setted as: 0.0007315124686732943
     Instance: 500; Time: 31.85s; loss: 87.1234; acc: 22878.0/22919.0=0.9982
     Instance: 1000; Time: 30.23s; loss: 94.5787; acc: 44529.0/44614.0=0.9981
     Instance: 1500; Time: 31.13s; loss: 76.8431; acc: 67039.0/67169.0=0.9981
     Instance: 1999; Time: 32.10s; loss: 156.5844; acc: 90155.0/90371.0=0.9976
Epoch: 14 training finished. Time: 125.31s, speed: 15.95st/s,  total loss: tensor(415.1297, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1043  right_num =  1014
Dev: time: 4.53s, speed: 117.54st/s; acc: 0.9941, p: 0.9722, r: 0.9883, f: 0.9802
gold_num =  1026  pred_num =  1043  right_num =  1014
Test: time: 4.53s, speed: 117.41st/s; acc: 0.9941, p: 0.9722, r: 0.9883, f: 0.9802
Best dev score: p:0.97678916827853, r:0.9844054580896686, f:0.9805825242718447
Test score: p:0.97678916827853, r:0.9844054580896686, f:0.9805825242718447
Epoch: 15/100
 Learning rate is setted as: 0.0006949368452396295
     Instance: 500; Time: 31.66s; loss: 244.4252; acc: 22714.0/22827.0=0.9950
     Instance: 1000; Time: 31.72s; loss: 93.6701; acc: 45398.0/45558.0=0.9965
     Instance: 1500; Time: 31.31s; loss: 81.0918; acc: 67734.0/67935.0=0.9970
     Instance: 1999; Time: 31.39s; loss: 74.4658; acc: 90132.0/90371.0=0.9974
Epoch: 15 training finished. Time: 126.09s, speed: 15.85st/s,  total loss: tensor(493.6528, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1029  right_num =  1008
Dev: time: 4.52s, speed: 117.79st/s; acc: 0.9945, p: 0.9796, r: 0.9825, f: 0.9810
Exceed previous best f score: 0.9805825242718447
gold_num =  1026  pred_num =  1029  right_num =  1008
Test: time: 4.56s, speed: 117.55st/s; acc: 0.9945, p: 0.9796, r: 0.9825, f: 0.9810
Best dev score: p:0.9795918367346939, r:0.9824561403508771, f:0.981021897810219
Test score: p:0.9795918367346939, r:0.9824561403508771, f:0.981021897810219
Epoch: 16/100
 Learning rate is setted as: 0.000660190002977648
     Instance: 500; Time: 31.77s; loss: 61.9987; acc: 22716.0/22752.0=0.9984
     Instance: 1000; Time: 31.52s; loss: 116.4953; acc: 45145.0/45245.0=0.9978
     Instance: 1500; Time: 30.96s; loss: 189.4300; acc: 67209.0/67403.0=0.9971
     Instance: 1999; Time: 31.70s; loss: 78.8190; acc: 90139.0/90371.0=0.9974
Epoch: 16 training finished. Time: 125.94s, speed: 15.87st/s,  total loss: tensor(446.7428, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1025  right_num =  1006
Dev: time: 4.55s, speed: 117.12st/s; acc: 0.9945, p: 0.9815, r: 0.9805, f: 0.9810
gold_num =  1026  pred_num =  1025  right_num =  1006
Test: time: 4.52s, speed: 117.67st/s; acc: 0.9945, p: 0.9815, r: 0.9805, f: 0.9810
Best dev score: p:0.9795918367346939, r:0.9824561403508771, f:0.981021897810219
Test score: p:0.9795918367346939, r:0.9824561403508771, f:0.981021897810219
Epoch: 17/100
 Learning rate is setted as: 0.0006271805028287656
     Instance: 500; Time: 30.86s; loss: 63.2982; acc: 22168.0/22201.0=0.9985
     Instance: 1000; Time: 30.91s; loss: 126.2816; acc: 44340.0/44464.0=0.9972
     Instance: 1500; Time: 30.83s; loss: 64.3312; acc: 66554.0/66713.0=0.9976
     Instance: 1999; Time: 32.72s; loss: 110.6324; acc: 90159.0/90371.0=0.9977
Epoch: 17 training finished. Time: 125.31s, speed: 15.95st/s,  total loss: tensor(364.5435, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1038  right_num =  1012
Dev: time: 4.60s, speed: 115.66st/s; acc: 0.9943, p: 0.9750, r: 0.9864, f: 0.9806
gold_num =  1026  pred_num =  1038  right_num =  1012
Test: time: 4.59s, speed: 116.02st/s; acc: 0.9943, p: 0.9750, r: 0.9864, f: 0.9806
Best dev score: p:0.9795918367346939, r:0.9824561403508771, f:0.981021897810219
Test score: p:0.9795918367346939, r:0.9824561403508771, f:0.981021897810219
Epoch: 18/100
 Learning rate is setted as: 0.0005958214776873273
     Instance: 500; Time: 30.93s; loss: 131.2264; acc: 22098.0/22176.0=0.9965
     Instance: 1000; Time: 30.89s; loss: 73.0984; acc: 44383.0/44492.0=0.9976
     Instance: 1500; Time: 31.22s; loss: 42.7435; acc: 66946.0/67074.0=0.9981
     Instance: 1999; Time: 32.11s; loss: 79.4446; acc: 90198.0/90371.0=0.9981
Epoch: 18 training finished. Time: 125.15s, speed: 15.97st/s,  total loss: tensor(326.5130, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1011  right_num =  998
Dev: time: 4.53s, speed: 117.67st/s; acc: 0.9941, p: 0.9871, r: 0.9727, f: 0.9799
gold_num =  1026  pred_num =  1011  right_num =  998
Test: time: 4.53s, speed: 117.62st/s; acc: 0.9941, p: 0.9871, r: 0.9727, f: 0.9799
Best dev score: p:0.9795918367346939, r:0.9824561403508771, f:0.981021897810219
Test score: p:0.9795918367346939, r:0.9824561403508771, f:0.981021897810219
Epoch: 19/100
 Learning rate is setted as: 0.0005660304038029609
     Instance: 500; Time: 31.59s; loss: 52.7217; acc: 22897.0/22920.0=0.9990
     Instance: 1000; Time: 31.10s; loss: 198.4854; acc: 45232.0/45347.0=0.9975
     Instance: 1500; Time: 31.76s; loss: 62.1483; acc: 68046.0/68191.0=0.9979
     Instance: 1999; Time: 30.82s; loss: 64.5167; acc: 90188.0/90371.0=0.9980
Epoch: 19 training finished. Time: 125.27s, speed: 15.96st/s,  total loss: tensor(377.8722, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1045  right_num =  1016
Dev: time: 4.52s, speed: 117.86st/s; acc: 0.9944, p: 0.9722, r: 0.9903, f: 0.9812
Exceed previous best f score: 0.981021897810219
gold_num =  1026  pred_num =  1045  right_num =  1016
Test: time: 4.55s, speed: 117.94st/s; acc: 0.9944, p: 0.9722, r: 0.9903, f: 0.9812
Best dev score: p:0.9722488038277513, r:0.9902534113060428, f:0.9811685176243361
Test score: p:0.9722488038277513, r:0.9902534113060428, f:0.9811685176243361
Epoch: 20/100
 Learning rate is setted as: 0.0005377288836128128
     Instance: 500; Time: 31.84s; loss: 95.1913; acc: 23041.0/23102.0=0.9974
     Instance: 1000; Time: 29.55s; loss: 47.7070; acc: 44288.0/44371.0=0.9981
     Instance: 1500; Time: 32.16s; loss: 65.6617; acc: 67602.0/67718.0=0.9983
     Instance: 1999; Time: 31.32s; loss: 72.9049; acc: 90226.0/90371.0=0.9984
Epoch: 20 training finished. Time: 124.86s, speed: 16.01st/s,  total loss: tensor(281.4650, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1023  right_num =  1006
Dev: time: 4.54s, speed: 117.30st/s; acc: 0.9946, p: 0.9834, r: 0.9805, f: 0.9819
Exceed previous best f score: 0.9811685176243361
gold_num =  1026  pred_num =  1023  right_num =  1006
Test: time: 4.57s, speed: 117.33st/s; acc: 0.9946, p: 0.9834, r: 0.9805, f: 0.9819
Best dev score: p:0.9833822091886608, r:0.9805068226120858, f:0.9819424109321621
Test score: p:0.9833822091886608, r:0.9805068226120858, f:0.9819424109321621


......
......
......
......
......
......


Epoch: 90/100
 Learning rate is setted as: 1.4832547064488426e-05
     Instance: 500; Time: 32.04s; loss: 24.2524; acc: 23116.0/23131.0=0.9994
     Instance: 1000; Time: 31.03s; loss: 19.0902; acc: 45323.0/45349.0=0.9994
     Instance: 1500; Time: 32.69s; loss: 36.7891; acc: 68823.0/68869.0=0.9993
     Instance: 1999; Time: 30.16s; loss: 24.1088; acc: 90307.0/90371.0=0.9993
Epoch: 90 training finished. Time: 125.93s, speed: 15.87st/s,  total loss: tensor(104.2405, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1040  right_num =  1024
Dev: time: 4.57s, speed: 116.48st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
gold_num =  1026  pred_num =  1040  right_num =  1024
Test: time: 4.57s, speed: 116.51st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
Best dev score: p:0.9846153846153847, r:0.9980506822612085, f:0.9912875121006777
Test score: p:0.9846153846153847, r:0.9980506822612085, f:0.9912875121006777
Epoch: 91/100
 Learning rate is setted as: 1.4090919711264e-05
     Instance: 500; Time: 32.25s; loss: 19.7567; acc: 23080.0/23086.0=0.9997
     Instance: 1000; Time: 30.20s; loss: 32.0599; acc: 44758.0/44783.0=0.9994
     Instance: 1500; Time: 31.94s; loss: 9.9867; acc: 67778.0/67803.0=0.9996
     Instance: 1999; Time: 31.45s; loss: 26.3107; acc: 90328.0/90371.0=0.9995
Epoch: 91 training finished. Time: 125.84s, speed: 15.89st/s,  total loss: tensor(88.1140, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1040  right_num =  1024
Dev: time: 4.60s, speed: 115.75st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
gold_num =  1026  pred_num =  1040  right_num =  1024
Test: time: 4.59s, speed: 115.96st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
Best dev score: p:0.9846153846153847, r:0.9980506822612085, f:0.9912875121006777
Test score: p:0.9846153846153847, r:0.9980506822612085, f:0.9912875121006777
Epoch: 92/100
 Learning rate is setted as: 1.3386373725700803e-05
     Instance: 500; Time: 32.52s; loss: 38.6252; acc: 23335.0/23361.0=0.9989
     Instance: 1000; Time: 32.01s; loss: 18.8413; acc: 46320.0/46358.0=0.9992
     Instance: 1500; Time: 30.23s; loss: 10.8565; acc: 67986.0/68026.0=0.9994
     Instance: 1999; Time: 31.26s; loss: 24.7076; acc: 90316.0/90371.0=0.9994
Epoch: 92 training finished. Time: 126.02s, speed: 15.86st/s,  total loss: tensor(93.0306, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1040  right_num =  1024
Dev: time: 4.55s, speed: 117.03st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
gold_num =  1026  pred_num =  1040  right_num =  1024
Test: time: 4.55s, speed: 117.09st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
Best dev score: p:0.9846153846153847, r:0.9980506822612085, f:0.9912875121006777
Test score: p:0.9846153846153847, r:0.9980506822612085, f:0.9912875121006777
Epoch: 93/100
 Learning rate is setted as: 1.2717055039415761e-05
     Instance: 500; Time: 31.41s; loss: 43.6084; acc: 22583.0/22612.0=0.9987
     Instance: 1000; Time: 31.97s; loss: 16.5049; acc: 45712.0/45747.0=0.9992
     Instance: 1500; Time: 31.36s; loss: 30.4766; acc: 68166.0/68222.0=0.9992
     Instance: 1999; Time: 31.01s; loss: 15.8847; acc: 90307.0/90371.0=0.9993
Epoch: 93 training finished. Time: 125.75s, speed: 15.90st/s,  total loss: tensor(106.4745, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1038  right_num =  1024
Dev: time: 4.57s, speed: 116.39st/s; acc: 0.9972, p: 0.9865, r: 0.9981, f: 0.9922
Exceed previous best f score: 0.9912875121006777
gold_num =  1026  pred_num =  1038  right_num =  1024
Test: time: 4.55s, speed: 117.91st/s; acc: 0.9972, p: 0.9865, r: 0.9981, f: 0.9922
Best dev score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Test score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Epoch: 94/100
 Learning rate is setted as: 1.2081202287444973e-05
     Instance: 500; Time: 31.96s; loss: 33.8862; acc: 23115.0/23138.0=0.9990
     Instance: 1000; Time: 30.13s; loss: 7.8426; acc: 44838.0/44862.0=0.9995
     Instance: 1500; Time: 30.85s; loss: 54.5449; acc: 67080.0/67141.0=0.9991
     Instance: 1999; Time: 32.18s; loss: 17.7653; acc: 90308.0/90371.0=0.9993
Epoch: 94 training finished. Time: 125.12s, speed: 15.98st/s,  total loss: tensor(114.0390, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1040  right_num =  1024
Dev: time: 4.52s, speed: 117.68st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
gold_num =  1026  pred_num =  1040  right_num =  1024
Test: time: 4.53s, speed: 117.63st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
Best dev score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Test score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Epoch: 95/100
 Learning rate is setted as: 1.1477142173072723e-05
     Instance: 500; Time: 32.72s; loss: 18.1870; acc: 23747.0/23760.0=0.9995
     Instance: 1000; Time: 30.51s; loss: 19.2969; acc: 45707.0/45728.0=0.9995
     Instance: 1500; Time: 31.00s; loss: 32.6200; acc: 67997.0/68033.0=0.9995
     Instance: 1999; Time: 30.85s; loss: 33.8846; acc: 90313.0/90371.0=0.9994
Epoch: 95 training finished. Time: 125.08s, speed: 15.98st/s,  total loss: tensor(103.9886, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1040  right_num =  1024
Dev: time: 4.53s, speed: 117.52st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
gold_num =  1026  pred_num =  1040  right_num =  1024
Test: time: 4.54s, speed: 117.25st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
Best dev score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Test score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Epoch: 96/100
 Learning rate is setted as: 1.0903285064419087e-05
     Instance: 500; Time: 30.00s; loss: 6.9263; acc: 21548.0/21550.0=0.9999
     Instance: 1000; Time: 32.30s; loss: 29.8059; acc: 44736.0/44756.0=0.9996
     Instance: 1500; Time: 32.04s; loss: 10.8405; acc: 67736.0/67759.0=0.9997
     Instance: 1999; Time: 31.53s; loss: 27.1229; acc: 90340.0/90371.0=0.9997
Epoch: 96 training finished. Time: 125.88s, speed: 15.88st/s,  total loss: tensor(74.6956, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1040  right_num =  1024
Dev: time: 4.52s, speed: 117.91st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
gold_num =  1026  pred_num =  1040  right_num =  1024
Test: time: 4.52s, speed: 117.68st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
Best dev score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Test score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Epoch: 97/100
 Learning rate is setted as: 1.0358120811198132e-05
     Instance: 500; Time: 30.54s; loss: 17.3246; acc: 22084.0/22091.0=0.9997
     Instance: 1000; Time: 30.07s; loss: 28.2827; acc: 43779.0/43806.0=0.9994
     Instance: 1500; Time: 32.11s; loss: 20.7174; acc: 67004.0/67037.0=0.9995
     Instance: 1999; Time: 32.38s; loss: 24.8686; acc: 90326.0/90371.0=0.9995
Epoch: 97 training finished. Time: 125.10s, speed: 15.98st/s,  total loss: tensor(91.1934, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1040  right_num =  1024
Dev: time: 4.54s, speed: 117.32st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
gold_num =  1026  pred_num =  1040  right_num =  1024
Test: time: 4.53s, speed: 117.44st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
Best dev score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Test score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Epoch: 98/100
 Learning rate is setted as: 9.840214770638225e-06
     Instance: 500; Time: 31.66s; loss: 16.9288; acc: 22965.0/22976.0=0.9995
     Instance: 1000; Time: 32.19s; loss: 15.7932; acc: 46301.0/46319.0=0.9996
     Instance: 1500; Time: 30.15s; loss: 13.8526; acc: 68054.0/68078.0=0.9996
     Instance: 1999; Time: 30.90s; loss: 34.6453; acc: 90327.0/90371.0=0.9995
Epoch: 98 training finished. Time: 124.90s, speed: 16.01st/s,  total loss: tensor(81.2200, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1040  right_num =  1024
Dev: time: 4.58s, speed: 116.30st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
gold_num =  1026  pred_num =  1040  right_num =  1024
Test: time: 4.58s, speed: 116.27st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
Best dev score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Test score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Epoch: 99/100
 Learning rate is setted as: 9.348204032106314e-06
     Instance: 500; Time: 32.17s; loss: 39.2616; acc: 23105.0/23122.0=0.9993
     Instance: 1000; Time: 32.35s; loss: 13.0373; acc: 46368.0/46387.0=0.9996
     Instance: 1500; Time: 30.69s; loss: 20.9561; acc: 68285.0/68309.0=0.9996
     Instance: 1999; Time: 30.82s; loss: 17.9313; acc: 90343.0/90371.0=0.9997
Epoch: 99 training finished. Time: 126.03s, speed: 15.86st/s,  total loss: tensor(91.1863, device=&#39;cuda:0&#39;)
gold_num =  1026  pred_num =  1040  right_num =  1024
Dev: time: 4.58s, speed: 116.20st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
gold_num =  1026  pred_num =  1040  right_num =  1024
Test: time: 4.59s, speed: 116.02st/s; acc: 0.9970, p: 0.9846, r: 0.9981, f: 0.9913
Best dev score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
Test score: p:0.9865125240847784, r:0.9980506822612085, f:0.9922480620155038
</code></pre></div>
<hr />
<hr />
<h3 id="_2">小节总结<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ul>
<li>本小节学习了Soft-lexicon模型的架构和代码实现.</li>
</ul>
<hr />
<hr />
<hr />
<hr />

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="11_1.html" class="md-footer__link md-footer__link--prev" aria-label="上一页: 11.1 TENER模型" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              11.1 TENER模型
            </div>
          </div>
        </a>
      
      
        
        <a href="13_1.html" class="md-footer__link md-footer__link--next" aria-label="下一页: 13.1 基于CNN的关系抽取模型" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              13.1 基于CNN的关系抽取模型
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": ".", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "search": "assets/javascripts/workers/search.092fa1f6.min.js"}</script>
    
    
      <script src="assets/javascripts/bundle.5a9542cf.min.js"></script>
      
        <script src="js/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>